<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
<head>
<meta http-equiv="Content-Type"
content="text/html; charset=iso-8859-1" />
<meta name="GENERATOR" content="GNU source-highlight 1.9
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite" />
<title>../src/jdmarker.c</title>
</head>
<body style="background-color: #FFFFFF; color: #000000; a: #0000EE; a.visited: #551A8B; a.active: #FF0000">
<pre>
<tt>
<a name="line1">0001: </a><span style="font-style: italic"><span style="color: #9A1900">/*</span></span>
<a name="line2">0002: </a><span style="font-style: italic"><span style="color: #9A1900"> * jdmarker.c</span></span>
<a name="line3">0003: </a><span style="font-style: italic"><span style="color: #9A1900"> *</span></span>
<a name="line4">0004: </a><span style="font-style: italic"><span style="color: #9A1900"> * Copyright (C) 1991-1998, Thomas G. Lane.</span></span>
<a name="line5">0005: </a><span style="font-style: italic"><span style="color: #9A1900"> * This file is part of the Independent JPEG Group's software.</span></span>
<a name="line6">0006: </a><span style="font-style: italic"><span style="color: #9A1900"> * For conditions of distribution and use, see the accompanying README file.</span></span>
<a name="line7">0007: </a><span style="font-style: italic"><span style="color: #9A1900"> *</span></span>
<a name="line8">0008: </a><span style="font-style: italic"><span style="color: #9A1900"> * This file contains routines to decode JPEG datastream markers.</span></span>
<a name="line9">0009: </a><span style="font-style: italic"><span style="color: #9A1900"> * Most of the complexity arises from our desire to support input</span></span>
<a name="line10">0010: </a><span style="font-style: italic"><span style="color: #9A1900"> * suspension: if not all of the data for a marker is available,</span></span>
<a name="line11">0011: </a><span style="font-style: italic"><span style="color: #9A1900"> * we must exit back to the application.  On resumption, we reprocess</span></span>
<a name="line12">0012: </a><span style="font-style: italic"><span style="color: #9A1900"> * the marker.</span></span>
<a name="line13">0013: </a><span style="font-style: italic"><span style="color: #9A1900"> */</span></span>
<a name="line14">0014: </a>
<a name="line15">0015: </a><span style="font-weight: bold"><span style="color: #000080">#define</span></span> JPEG_INTERNALS
<a name="line16">0016: </a><span style="font-weight: bold"><span style="color: #000080">#include</span></span> <span style="color: #FF0000">"jinclude.h"</span>
<a name="line17">0017: </a><span style="font-weight: bold"><span style="color: #000080">#include</span></span> <span style="color: #FF0000">"jpeglib.h"</span>
<a name="line18">0018: </a>
<a name="line19">0019: </a>
<a name="line20">0020: </a><span style="font-weight: bold"><span style="color: #0000FF">typedef</span></span> <span style="font-weight: bold"><span style="color: #0000FF">enum</span></span> <span style="color: #FF0000">{</span>                  <span style="font-style: italic"><span style="color: #9A1900">/* JPEG marker codes */</span></span>
<a name="line21">0021: </a>  M_SOF0  <span style="color: #990000">=</span> <span style="color: #993399">0xc0</span><span style="color: #990000">,</span>
<a name="line22">0022: </a>  M_SOF1  <span style="color: #990000">=</span> <span style="color: #993399">0xc1</span><span style="color: #990000">,</span>
<a name="line23">0023: </a>  M_SOF2  <span style="color: #990000">=</span> <span style="color: #993399">0xc2</span><span style="color: #990000">,</span>
<a name="line24">0024: </a>  M_SOF3  <span style="color: #990000">=</span> <span style="color: #993399">0xc3</span><span style="color: #990000">,</span>
<a name="line25">0025: </a>  
<a name="line26">0026: </a>  M_SOF5  <span style="color: #990000">=</span> <span style="color: #993399">0xc5</span><span style="color: #990000">,</span>
<a name="line27">0027: </a>  M_SOF6  <span style="color: #990000">=</span> <span style="color: #993399">0xc6</span><span style="color: #990000">,</span>
<a name="line28">0028: </a>  M_SOF7  <span style="color: #990000">=</span> <span style="color: #993399">0xc7</span><span style="color: #990000">,</span>
<a name="line29">0029: </a>  
<a name="line30">0030: </a>  M_JPG   <span style="color: #990000">=</span> <span style="color: #993399">0xc8</span><span style="color: #990000">,</span>
<a name="line31">0031: </a>  M_SOF9  <span style="color: #990000">=</span> <span style="color: #993399">0xc9</span><span style="color: #990000">,</span>
<a name="line32">0032: </a>  M_SOF10 <span style="color: #990000">=</span> <span style="color: #993399">0xca</span><span style="color: #990000">,</span>
<a name="line33">0033: </a>  M_SOF11 <span style="color: #990000">=</span> <span style="color: #993399">0xcb</span><span style="color: #990000">,</span>
<a name="line34">0034: </a>  
<a name="line35">0035: </a>  M_SOF13 <span style="color: #990000">=</span> <span style="color: #993399">0xcd</span><span style="color: #990000">,</span>
<a name="line36">0036: </a>  M_SOF14 <span style="color: #990000">=</span> <span style="color: #993399">0xce</span><span style="color: #990000">,</span>
<a name="line37">0037: </a>  M_SOF15 <span style="color: #990000">=</span> <span style="color: #993399">0xcf</span><span style="color: #990000">,</span>
<a name="line38">0038: </a>  
<a name="line39">0039: </a>  M_DHT   <span style="color: #990000">=</span> <span style="color: #993399">0xc4</span><span style="color: #990000">,</span>
<a name="line40">0040: </a>  
<a name="line41">0041: </a>  M_DAC   <span style="color: #990000">=</span> <span style="color: #993399">0xcc</span><span style="color: #990000">,</span>
<a name="line42">0042: </a>  
<a name="line43">0043: </a>  M_RST0  <span style="color: #990000">=</span> <span style="color: #993399">0xd0</span><span style="color: #990000">,</span>
<a name="line44">0044: </a>  M_RST1  <span style="color: #990000">=</span> <span style="color: #993399">0xd1</span><span style="color: #990000">,</span>
<a name="line45">0045: </a>  M_RST2  <span style="color: #990000">=</span> <span style="color: #993399">0xd2</span><span style="color: #990000">,</span>
<a name="line46">0046: </a>  M_RST3  <span style="color: #990000">=</span> <span style="color: #993399">0xd3</span><span style="color: #990000">,</span>
<a name="line47">0047: </a>  M_RST4  <span style="color: #990000">=</span> <span style="color: #993399">0xd4</span><span style="color: #990000">,</span>
<a name="line48">0048: </a>  M_RST5  <span style="color: #990000">=</span> <span style="color: #993399">0xd5</span><span style="color: #990000">,</span>
<a name="line49">0049: </a>  M_RST6  <span style="color: #990000">=</span> <span style="color: #993399">0xd6</span><span style="color: #990000">,</span>
<a name="line50">0050: </a>  M_RST7  <span style="color: #990000">=</span> <span style="color: #993399">0xd7</span><span style="color: #990000">,</span>
<a name="line51">0051: </a>  
<a name="line52">0052: </a>  M_SOI   <span style="color: #990000">=</span> <span style="color: #993399">0xd8</span><span style="color: #990000">,</span>
<a name="line53">0053: </a>  M_EOI   <span style="color: #990000">=</span> <span style="color: #993399">0xd9</span><span style="color: #990000">,</span>
<a name="line54">0054: </a>  M_SOS   <span style="color: #990000">=</span> <span style="color: #993399">0xda</span><span style="color: #990000">,</span>
<a name="line55">0055: </a>  M_DQT   <span style="color: #990000">=</span> <span style="color: #993399">0xdb</span><span style="color: #990000">,</span>
<a name="line56">0056: </a>  M_DNL   <span style="color: #990000">=</span> <span style="color: #993399">0xdc</span><span style="color: #990000">,</span>
<a name="line57">0057: </a>  M_DRI   <span style="color: #990000">=</span> <span style="color: #993399">0xdd</span><span style="color: #990000">,</span>
<a name="line58">0058: </a>  M_DHP   <span style="color: #990000">=</span> <span style="color: #993399">0xde</span><span style="color: #990000">,</span>
<a name="line59">0059: </a>  M_EXP   <span style="color: #990000">=</span> <span style="color: #993399">0xdf</span><span style="color: #990000">,</span>
<a name="line60">0060: </a>  
<a name="line61">0061: </a>  M_APP0  <span style="color: #990000">=</span> <span style="color: #993399">0xe0</span><span style="color: #990000">,</span>
<a name="line62">0062: </a>  M_APP1  <span style="color: #990000">=</span> <span style="color: #993399">0xe1</span><span style="color: #990000">,</span>
<a name="line63">0063: </a>  M_APP2  <span style="color: #990000">=</span> <span style="color: #993399">0xe2</span><span style="color: #990000">,</span>
<a name="line64">0064: </a>  M_APP3  <span style="color: #990000">=</span> <span style="color: #993399">0xe3</span><span style="color: #990000">,</span>
<a name="line65">0065: </a>  M_APP4  <span style="color: #990000">=</span> <span style="color: #993399">0xe4</span><span style="color: #990000">,</span>
<a name="line66">0066: </a>  M_APP5  <span style="color: #990000">=</span> <span style="color: #993399">0xe5</span><span style="color: #990000">,</span>
<a name="line67">0067: </a>  M_APP6  <span style="color: #990000">=</span> <span style="color: #993399">0xe6</span><span style="color: #990000">,</span>
<a name="line68">0068: </a>  M_APP7  <span style="color: #990000">=</span> <span style="color: #993399">0xe7</span><span style="color: #990000">,</span>
<a name="line69">0069: </a>  M_APP8  <span style="color: #990000">=</span> <span style="color: #993399">0xe8</span><span style="color: #990000">,</span>
<a name="line70">0070: </a>  M_APP9  <span style="color: #990000">=</span> <span style="color: #993399">0xe9</span><span style="color: #990000">,</span>
<a name="line71">0071: </a>  M_APP10 <span style="color: #990000">=</span> <span style="color: #993399">0xea</span><span style="color: #990000">,</span>
<a name="line72">0072: </a>  M_APP11 <span style="color: #990000">=</span> <span style="color: #993399">0xeb</span><span style="color: #990000">,</span>
<a name="line73">0073: </a>  M_APP12 <span style="color: #990000">=</span> <span style="color: #993399">0xec</span><span style="color: #990000">,</span>
<a name="line74">0074: </a>  M_APP13 <span style="color: #990000">=</span> <span style="color: #993399">0xed</span><span style="color: #990000">,</span>
<a name="line75">0075: </a>  M_APP14 <span style="color: #990000">=</span> <span style="color: #993399">0xee</span><span style="color: #990000">,</span>
<a name="line76">0076: </a>  M_APP15 <span style="color: #990000">=</span> <span style="color: #993399">0xef</span><span style="color: #990000">,</span>
<a name="line77">0077: </a>  
<a name="line78">0078: </a>  M_JPG0  <span style="color: #990000">=</span> <span style="color: #993399">0xf0</span><span style="color: #990000">,</span>
<a name="line79">0079: </a>  M_JPG13 <span style="color: #990000">=</span> <span style="color: #993399">0xfd</span><span style="color: #990000">,</span>
<a name="line80">0080: </a>  M_COM   <span style="color: #990000">=</span> <span style="color: #993399">0xfe</span><span style="color: #990000">,</span>
<a name="line81">0081: </a>  
<a name="line82">0082: </a>  M_TEM   <span style="color: #990000">=</span> <span style="color: #993399">0x01</span><span style="color: #990000">,</span>
<a name="line83">0083: </a>  
<a name="line84">0084: </a>  M_ERROR <span style="color: #990000">=</span> <span style="color: #993399">0x100</span>
<a name="line85">0085: </a><span style="color: #FF0000">}</span> JPEG_MARKER<span style="color: #990000">;</span>
<a name="line86">0086: </a>
<a name="line87">0087: </a>
<a name="line88">0088: </a><span style="font-style: italic"><span style="color: #9A1900">/* Private state */</span></span>
<a name="line89">0089: </a>
<a name="line90">0090: </a><span style="font-weight: bold"><span style="color: #0000FF">typedef</span></span> <span style="font-weight: bold"><span style="color: #0000FF">struct</span></span> <span style="color: #FF0000">{</span>
<a name="line91">0091: </a>  <span style="font-weight: bold"><span style="color: #0000FF">struct</span></span> jpeg_marker_reader pub<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">/* public fields */</span></span>
<a name="line92">0092: </a>
<a name="line93">0093: </a>  <span style="font-style: italic"><span style="color: #9A1900">/* Application-overridable marker processing methods */</span></span>
<a name="line94">0094: </a>  jpeg_marker_parser_method process_COM<span style="color: #990000">;</span>
<a name="line95">0095: </a>  jpeg_marker_parser_method process_APPn<span style="color: #990000">[</span><span style="color: #993399">16</span><span style="color: #990000">]</span><span style="color: #990000">;</span>
<a name="line96">0096: </a>
<a name="line97">0097: </a>  <span style="font-style: italic"><span style="color: #9A1900">/* Limit on marker data length to save for each marker type */</span></span>
<a name="line98">0098: </a>  <span style="color: #009900">unsigned</span> <span style="color: #009900">int</span> length_limit_COM<span style="color: #990000">;</span>
<a name="line99">0099: </a>  <span style="color: #009900">unsigned</span> <span style="color: #009900">int</span> length_limit_APPn<span style="color: #990000">[</span><span style="color: #993399">16</span><span style="color: #990000">]</span><span style="color: #990000">;</span>
<a name="line100">0100: </a>
<a name="line101">0101: </a>  <span style="font-style: italic"><span style="color: #9A1900">/* Status of COM/APPn marker saving */</span></span>
<a name="line102">0102: </a>  jpeg_saved_marker_ptr cur_marker<span style="color: #990000">;</span>     <span style="font-style: italic"><span style="color: #9A1900">/* NULL if not processing a marker */</span></span>
<a name="line103">0103: </a>  <span style="color: #009900">unsigned</span> <span style="color: #009900">int</span> bytes_read<span style="color: #990000">;</span>              <span style="font-style: italic"><span style="color: #9A1900">/* data bytes read so far in marker */</span></span>
<a name="line104">0104: </a>  <span style="font-style: italic"><span style="color: #9A1900">/* Note: cur_marker is not linked into marker_list until it's all read. */</span></span>
<a name="line105">0105: </a><span style="color: #FF0000">}</span> my_marker_reader<span style="color: #990000">;</span>
<a name="line106">0106: </a>
<a name="line107">0107: </a><span style="font-weight: bold"><span style="color: #0000FF">typedef</span></span> my_marker_reader <span style="color: #990000">*</span> my_marker_ptr<span style="color: #990000">;</span>
<a name="line108">0108: </a>
<a name="line109">0109: </a>
<a name="line110">0110: </a><span style="font-style: italic"><span style="color: #9A1900">/*</span></span>
<a name="line111">0111: </a><span style="font-style: italic"><span style="color: #9A1900"> * Macros for fetching data from the data source module.</span></span>
<a name="line112">0112: </a><span style="font-style: italic"><span style="color: #9A1900"> *</span></span>
<a name="line113">0113: </a><span style="font-style: italic"><span style="color: #9A1900"> * At all times, cinfo-&gt;src-&gt;next_input_byte and -&gt;bytes_in_buffer reflect</span></span>
<a name="line114">0114: </a><span style="font-style: italic"><span style="color: #9A1900"> * the current restart point; we update them only when we have reached a</span></span>
<a name="line115">0115: </a><span style="font-style: italic"><span style="color: #9A1900"> * suitable place to restart if a suspension occurs.</span></span>
<a name="line116">0116: </a><span style="font-style: italic"><span style="color: #9A1900"> */</span></span>
<a name="line117">0117: </a>
<a name="line118">0118: </a><span style="font-style: italic"><span style="color: #9A1900">/* Declare and initialize local copies of input pointer/count */</span></span>
<a name="line119">0119: </a><span style="font-weight: bold"><span style="color: #000080">#define</span></span> <span style="font-weight: bold"><span style="color: #000000">INPUT_VARS</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">)</span>  <span style="color: #990000">\</span>
<a name="line120">0120: </a>        <span style="font-weight: bold"><span style="color: #0000FF">struct</span></span> jpeg_source_mgr <span style="color: #990000">*</span> datasrc <span style="color: #990000">=</span> <span style="color: #990000">(</span>cinfo<span style="color: #990000">)</span><span style="color: #990000">-</span><span style="color: #990000">&gt;</span>src<span style="color: #990000">;</span>  <span style="color: #990000">\</span>
<a name="line121">0121: </a>        <span style="font-weight: bold"><span style="color: #0000FF">const</span></span> JOCTET <span style="color: #990000">*</span> next_input_byte <span style="color: #990000">=</span> datasrc<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>next_input_byte<span style="color: #990000">;</span>  <span style="color: #990000">\</span>
<a name="line122">0122: </a>        size_t bytes_in_buffer <span style="color: #990000">=</span> datasrc<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>bytes_in_buffer
<a name="line123">0123: </a>
<a name="line124">0124: </a><span style="font-style: italic"><span style="color: #9A1900">/* Unload the local copies --- do this only at a restart boundary */</span></span>
<a name="line125">0125: </a><span style="font-weight: bold"><span style="color: #000080">#define</span></span> <span style="font-weight: bold"><span style="color: #000000">INPUT_SYNC</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">)</span>  <span style="color: #990000">\</span>
<a name="line126">0126: </a>        <span style="color: #990000">(</span> datasrc<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>next_input_byte <span style="color: #990000">=</span> next_input_byte<span style="color: #990000">,</span>  <span style="color: #990000">\</span>
<a name="line127">0127: </a>          datasrc<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>bytes_in_buffer <span style="color: #990000">=</span> bytes_in_buffer <span style="color: #990000">)</span>
<a name="line128">0128: </a>
<a name="line129">0129: </a><span style="font-style: italic"><span style="color: #9A1900">/* Reload the local copies --- used only in MAKE_BYTE_AVAIL */</span></span>
<a name="line130">0130: </a><span style="font-weight: bold"><span style="color: #000080">#define</span></span> <span style="font-weight: bold"><span style="color: #000000">INPUT_RELOAD</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">)</span>  <span style="color: #990000">\</span>
<a name="line131">0131: </a>        <span style="color: #990000">(</span> next_input_byte <span style="color: #990000">=</span> datasrc<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>next_input_byte<span style="color: #990000">,</span>  <span style="color: #990000">\</span>
<a name="line132">0132: </a>          bytes_in_buffer <span style="color: #990000">=</span> datasrc<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>bytes_in_buffer <span style="color: #990000">)</span>
<a name="line133">0133: </a>
<a name="line134">0134: </a><span style="font-style: italic"><span style="color: #9A1900">/* Internal macro for INPUT_BYTE and INPUT_2BYTES: make a byte available.</span></span>
<a name="line135">0135: </a><span style="font-style: italic"><span style="color: #9A1900"> * Note we do *not* do INPUT_SYNC before calling fill_input_buffer,</span></span>
<a name="line136">0136: </a><span style="font-style: italic"><span style="color: #9A1900"> * but we must reload the local copies after a successful fill.</span></span>
<a name="line137">0137: </a><span style="font-style: italic"><span style="color: #9A1900"> */</span></span>
<a name="line138">0138: </a><span style="font-weight: bold"><span style="color: #000080">#define</span></span> <span style="font-weight: bold"><span style="color: #000000">MAKE_BYTE_AVAIL</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span>action<span style="color: #990000">)</span>  <span style="color: #990000">\</span>
<a name="line139">0139: </a>        <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>bytes_in_buffer <span style="color: #990000">=</span><span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>  <span style="color: #990000">\</span>
<a name="line140">0140: </a>          <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span><span style="color: #990000">!</span> <span style="color: #990000">(</span><span style="color: #990000">*</span>datasrc<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>fill_input_buffer<span style="color: #990000">)</span> <span style="color: #990000">(</span>cinfo<span style="color: #990000">)</span><span style="color: #990000">)</span>  <span style="color: #990000">\</span>
<a name="line141">0141: </a>            <span style="color: #FF0000">{</span> action<span style="color: #990000">;</span> <span style="color: #FF0000">}</span>  <span style="color: #990000">\</span>
<a name="line142">0142: </a>          <span style="font-weight: bold"><span style="color: #000000">INPUT_RELOAD</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">)</span><span style="color: #990000">;</span>  <span style="color: #990000">\</span>
<a name="line143">0143: </a>        <span style="color: #FF0000">}</span>
<a name="line144">0144: </a>
<a name="line145">0145: </a><span style="font-style: italic"><span style="color: #9A1900">/* Read a byte into variable V.</span></span>
<a name="line146">0146: </a><span style="font-style: italic"><span style="color: #9A1900"> * If must suspend, take the specified action (typically "return FALSE").</span></span>
<a name="line147">0147: </a><span style="font-style: italic"><span style="color: #9A1900"> */</span></span>
<a name="line148">0148: </a><span style="font-weight: bold"><span style="color: #000080">#define</span></span> <span style="font-weight: bold"><span style="color: #000000">INPUT_BYTE</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span>V<span style="color: #990000">,</span>action<span style="color: #990000">)</span>  <span style="color: #990000">\</span>
<a name="line149">0149: </a>        <span style="font-weight: bold"><span style="color: #000000">MAKESTMT</span></span><span style="color: #990000">(</span> <span style="font-weight: bold"><span style="color: #000000">MAKE_BYTE_AVAIL</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span>action<span style="color: #990000">)</span><span style="color: #990000">;</span> <span style="color: #990000">\</span>
<a name="line150">0150: </a>                  bytes_in_buffer<span style="color: #990000">-</span><span style="color: #990000">-</span><span style="color: #990000">;</span> <span style="color: #990000">\</span>
<a name="line151">0151: </a>                  V <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">GETJOCTET</span></span><span style="color: #990000">(</span><span style="color: #990000">*</span>next_input_byte<span style="color: #990000">+</span><span style="color: #990000">+</span><span style="color: #990000">)</span><span style="color: #990000">;</span> <span style="color: #990000">)</span>
<a name="line152">0152: </a>
<a name="line153">0153: </a><span style="font-style: italic"><span style="color: #9A1900">/* As above, but read two bytes interpreted as an unsigned 16-bit integer.</span></span>
<a name="line154">0154: </a><span style="font-style: italic"><span style="color: #9A1900"> * V should be declared unsigned int or perhaps INT32.</span></span>
<a name="line155">0155: </a><span style="font-style: italic"><span style="color: #9A1900"> */</span></span>
<a name="line156">0156: </a><span style="font-weight: bold"><span style="color: #000080">#define</span></span> <span style="font-weight: bold"><span style="color: #000000">INPUT_2BYTES</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span>V<span style="color: #990000">,</span>action<span style="color: #990000">)</span>  <span style="color: #990000">\</span>
<a name="line157">0157: </a>        <span style="font-weight: bold"><span style="color: #000000">MAKESTMT</span></span><span style="color: #990000">(</span> <span style="font-weight: bold"><span style="color: #000000">MAKE_BYTE_AVAIL</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span>action<span style="color: #990000">)</span><span style="color: #990000">;</span> <span style="color: #990000">\</span>
<a name="line158">0158: </a>                  bytes_in_buffer<span style="color: #990000">-</span><span style="color: #990000">-</span><span style="color: #990000">;</span> <span style="color: #990000">\</span>
<a name="line159">0159: </a>                  V <span style="color: #990000">=</span> <span style="color: #990000">(</span><span style="color: #990000">(</span><span style="color: #009900">unsigned</span> <span style="color: #009900">int</span><span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #000000">GETJOCTET</span></span><span style="color: #990000">(</span><span style="color: #990000">*</span>next_input_byte<span style="color: #990000">+</span><span style="color: #990000">+</span><span style="color: #990000">)</span><span style="color: #990000">)</span> <span style="color: #990000">&lt;</span><span style="color: #990000">&lt;</span> <span style="color: #993399">8</span><span style="color: #990000">;</span> <span style="color: #990000">\</span>
<a name="line160">0160: </a>                  <span style="font-weight: bold"><span style="color: #000000">MAKE_BYTE_AVAIL</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span>action<span style="color: #990000">)</span><span style="color: #990000">;</span> <span style="color: #990000">\</span>
<a name="line161">0161: </a>                  bytes_in_buffer<span style="color: #990000">-</span><span style="color: #990000">-</span><span style="color: #990000">;</span> <span style="color: #990000">\</span>
<a name="line162">0162: </a>                  V <span style="color: #990000">+</span><span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">GETJOCTET</span></span><span style="color: #990000">(</span><span style="color: #990000">*</span>next_input_byte<span style="color: #990000">+</span><span style="color: #990000">+</span><span style="color: #990000">)</span><span style="color: #990000">;</span> <span style="color: #990000">)</span>
<a name="line163">0163: </a>
<a name="line164">0164: </a>
<a name="line165">0165: </a><span style="font-style: italic"><span style="color: #9A1900">/*</span></span>
<a name="line166">0166: </a><span style="font-style: italic"><span style="color: #9A1900"> * Routines to process JPEG markers.</span></span>
<a name="line167">0167: </a><span style="font-style: italic"><span style="color: #9A1900"> *</span></span>
<a name="line168">0168: </a><span style="font-style: italic"><span style="color: #9A1900"> * Entry condition: JPEG marker itself has been read and its code saved</span></span>
<a name="line169">0169: </a><span style="font-style: italic"><span style="color: #9A1900"> *   in cinfo-&gt;unread_marker; input restart point is just after the marker.</span></span>
<a name="line170">0170: </a><span style="font-style: italic"><span style="color: #9A1900"> *</span></span>
<a name="line171">0171: </a><span style="font-style: italic"><span style="color: #9A1900"> * Exit: if return TRUE, have read and processed any parameters, and have</span></span>
<a name="line172">0172: </a><span style="font-style: italic"><span style="color: #9A1900"> *   updated the restart point to point after the parameters.</span></span>
<a name="line173">0173: </a><span style="font-style: italic"><span style="color: #9A1900"> *   If return FALSE, was forced to suspend before reaching end of</span></span>
<a name="line174">0174: </a><span style="font-style: italic"><span style="color: #9A1900"> *   marker parameters; restart point has not been moved.  Same routine</span></span>
<a name="line175">0175: </a><span style="font-style: italic"><span style="color: #9A1900"> *   will be called again after application supplies more input data.</span></span>
<a name="line176">0176: </a><span style="font-style: italic"><span style="color: #9A1900"> *</span></span>
<a name="line177">0177: </a><span style="font-style: italic"><span style="color: #9A1900"> * This approach to suspension assumes that all of a marker's parameters</span></span>
<a name="line178">0178: </a><span style="font-style: italic"><span style="color: #9A1900"> * can fit into a single input bufferload.  This should hold for "normal"</span></span>
<a name="line179">0179: </a><span style="font-style: italic"><span style="color: #9A1900"> * markers.  Some COM/APPn markers might have large parameter segments</span></span>
<a name="line180">0180: </a><span style="font-style: italic"><span style="color: #9A1900"> * that might not fit.  If we are simply dropping such a marker, we use</span></span>
<a name="line181">0181: </a><span style="font-style: italic"><span style="color: #9A1900"> * skip_input_data to get past it, and thereby put the problem on the</span></span>
<a name="line182">0182: </a><span style="font-style: italic"><span style="color: #9A1900"> * source manager's shoulders.  If we are saving the marker's contents</span></span>
<a name="line183">0183: </a><span style="font-style: italic"><span style="color: #9A1900"> * into memory, we use a slightly different convention: when forced to</span></span>
<a name="line184">0184: </a><span style="font-style: italic"><span style="color: #9A1900"> * suspend, the marker processor updates the restart point to the end of</span></span>
<a name="line185">0185: </a><span style="font-style: italic"><span style="color: #9A1900"> * what it's consumed (ie, the end of the buffer) before returning FALSE.</span></span>
<a name="line186">0186: </a><span style="font-style: italic"><span style="color: #9A1900"> * On resumption, cinfo-&gt;unread_marker still contains the marker code,</span></span>
<a name="line187">0187: </a><span style="font-style: italic"><span style="color: #9A1900"> * but the data source will point to the next chunk of marker data.</span></span>
<a name="line188">0188: </a><span style="font-style: italic"><span style="color: #9A1900"> * The marker processor must retain internal state to deal with this.</span></span>
<a name="line189">0189: </a><span style="font-style: italic"><span style="color: #9A1900"> *</span></span>
<a name="line190">0190: </a><span style="font-style: italic"><span style="color: #9A1900"> * Note that we don't bother to avoid duplicate trace messages if a</span></span>
<a name="line191">0191: </a><span style="font-style: italic"><span style="color: #9A1900"> * suspension occurs within marker parameters.  Other side effects</span></span>
<a name="line192">0192: </a><span style="font-style: italic"><span style="color: #9A1900"> * require more care.</span></span>
<a name="line193">0193: </a><span style="font-style: italic"><span style="color: #9A1900"> */</span></span>
<a name="line194">0194: </a>
<a name="line195">0195: </a>
<a name="line196">0196: </a><span style="font-weight: bold"><span style="color: #000000">LOCAL</span></span><span style="color: #990000">(</span>boolean<span style="color: #990000">)</span>
<a name="line197">0197: </a><span style="font-weight: bold"><span style="color: #000000">get_soi</span></span> <span style="color: #990000">(</span>j_decompress_ptr cinfo<span style="color: #990000">)</span>
<a name="line198">0198: </a><span style="font-style: italic"><span style="color: #9A1900">/* Process an SOI marker */</span></span>
<a name="line199">0199: </a><span style="color: #FF0000">{</span>
<a name="line200">0200: </a>  <span style="color: #009900">int</span> i<span style="color: #990000">;</span>
<a name="line201">0201: </a>  
<a name="line202">0202: </a>  <span style="font-weight: bold"><span style="color: #000000">TRACEMS</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> <span style="color: #993399">1</span><span style="color: #990000">,</span> JTRC_SOI<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line203">0203: </a>
<a name="line204">0204: </a>  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>marker<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>saw_SOI<span style="color: #990000">)</span>
<a name="line205">0205: </a>    <span style="font-weight: bold"><span style="color: #000000">ERREXIT</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> JERR_SOI_DUPLICATE<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line206">0206: </a>
<a name="line207">0207: </a>  <span style="font-style: italic"><span style="color: #9A1900">/* Reset all parameters that are defined to be reset by SOI */</span></span>
<a name="line208">0208: </a>
<a name="line209">0209: </a>  <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> <span style="color: #990000">(</span>i <span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">;</span> i <span style="color: #990000">&lt;</span> NUM_ARITH_TBLS<span style="color: #990000">;</span> i<span style="color: #990000">+</span><span style="color: #990000">+</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line210">0210: </a>    cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>arith_dc_L<span style="color: #990000">[</span>i<span style="color: #990000">]</span> <span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">;</span>
<a name="line211">0211: </a>    cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>arith_dc_U<span style="color: #990000">[</span>i<span style="color: #990000">]</span> <span style="color: #990000">=</span> <span style="color: #993399">1</span><span style="color: #990000">;</span>
<a name="line212">0212: </a>    cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>arith_ac_K<span style="color: #990000">[</span>i<span style="color: #990000">]</span> <span style="color: #990000">=</span> <span style="color: #993399">5</span><span style="color: #990000">;</span>
<a name="line213">0213: </a>  <span style="color: #FF0000">}</span>
<a name="line214">0214: </a>  cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>restart_interval <span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">;</span>
<a name="line215">0215: </a>
<a name="line216">0216: </a>  <span style="font-style: italic"><span style="color: #9A1900">/* Set initial assumptions for colorspace etc */</span></span>
<a name="line217">0217: </a>
<a name="line218">0218: </a>  cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>jpeg_color_space <span style="color: #990000">=</span> JCS_UNKNOWN<span style="color: #990000">;</span>
<a name="line219">0219: </a>  cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>CCIR601_sampling <span style="color: #990000">=</span> FALSE<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">/* Assume non-CCIR sampling??? */</span></span>
<a name="line220">0220: </a>
<a name="line221">0221: </a>  cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>saw_JFIF_marker <span style="color: #990000">=</span> FALSE<span style="color: #990000">;</span>
<a name="line222">0222: </a>  cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>JFIF_major_version <span style="color: #990000">=</span> <span style="color: #993399">1</span><span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">/* set default JFIF APP0 values */</span></span>
<a name="line223">0223: </a>  cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>JFIF_minor_version <span style="color: #990000">=</span> <span style="color: #993399">1</span><span style="color: #990000">;</span>
<a name="line224">0224: </a>  cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>density_unit <span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">;</span>
<a name="line225">0225: </a>  cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>X_density <span style="color: #990000">=</span> <span style="color: #993399">1</span><span style="color: #990000">;</span>
<a name="line226">0226: </a>  cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>Y_density <span style="color: #990000">=</span> <span style="color: #993399">1</span><span style="color: #990000">;</span>
<a name="line227">0227: </a>  cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>saw_Adobe_marker <span style="color: #990000">=</span> FALSE<span style="color: #990000">;</span>
<a name="line228">0228: </a>  cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>Adobe_transform <span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">;</span>
<a name="line229">0229: </a>
<a name="line230">0230: </a>  cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>marker<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>saw_SOI <span style="color: #990000">=</span> TRUE<span style="color: #990000">;</span>
<a name="line231">0231: </a>
<a name="line232">0232: </a>  <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> TRUE<span style="color: #990000">;</span>
<a name="line233">0233: </a><span style="color: #FF0000">}</span>
<a name="line234">0234: </a>
<a name="line235">0235: </a>
<a name="line236">0236: </a><span style="font-weight: bold"><span style="color: #000000">LOCAL</span></span><span style="color: #990000">(</span>boolean<span style="color: #990000">)</span>
<a name="line237">0237: </a><span style="font-weight: bold"><span style="color: #000000">get_sof</span></span> <span style="color: #990000">(</span>j_decompress_ptr cinfo<span style="color: #990000">,</span> boolean is_prog<span style="color: #990000">,</span> boolean is_arith<span style="color: #990000">)</span>
<a name="line238">0238: </a><span style="font-style: italic"><span style="color: #9A1900">/* Process a SOFn marker */</span></span>
<a name="line239">0239: </a><span style="color: #FF0000">{</span>
<a name="line240">0240: </a>  INT32 length<span style="color: #990000">;</span>
<a name="line241">0241: </a>  <span style="color: #009900">int</span> c<span style="color: #990000">,</span> ci<span style="color: #990000">;</span>
<a name="line242">0242: </a>  jpeg_component_info <span style="color: #990000">*</span> compptr<span style="color: #990000">;</span>
<a name="line243">0243: </a>  <span style="font-weight: bold"><span style="color: #000000">INPUT_VARS</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line244">0244: </a>
<a name="line245">0245: </a>  cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>progressive_mode <span style="color: #990000">=</span> is_prog<span style="color: #990000">;</span>
<a name="line246">0246: </a>  cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>arith_code <span style="color: #990000">=</span> is_arith<span style="color: #990000">;</span>
<a name="line247">0247: </a>
<a name="line248">0248: </a>  <span style="font-weight: bold"><span style="color: #000000">INPUT_2BYTES</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> length<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> FALSE<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line249">0249: </a>
<a name="line250">0250: </a>  <span style="font-weight: bold"><span style="color: #000000">INPUT_BYTE</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>data_precision<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> FALSE<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line251">0251: </a>  <span style="font-weight: bold"><span style="color: #000000">INPUT_2BYTES</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>image_height<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> FALSE<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line252">0252: </a>  <span style="font-weight: bold"><span style="color: #000000">INPUT_2BYTES</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>image_width<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> FALSE<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line253">0253: </a>  <span style="font-weight: bold"><span style="color: #000000">INPUT_BYTE</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>num_components<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> FALSE<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line254">0254: </a>
<a name="line255">0255: </a>  length <span style="color: #990000">-</span><span style="color: #990000">=</span> <span style="color: #993399">8</span><span style="color: #990000">;</span>
<a name="line256">0256: </a>
<a name="line257">0257: </a>  <span style="font-weight: bold"><span style="color: #000000">TRACEMS4</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> <span style="color: #993399">1</span><span style="color: #990000">,</span> JTRC_SOF<span style="color: #990000">,</span> cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>unread_marker<span style="color: #990000">,</span>
<a name="line258">0258: </a>           <span style="color: #990000">(</span><span style="color: #009900">int</span><span style="color: #990000">)</span> cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>image_width<span style="color: #990000">,</span> <span style="color: #990000">(</span><span style="color: #009900">int</span><span style="color: #990000">)</span> cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>image_height<span style="color: #990000">,</span>
<a name="line259">0259: </a>           cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>num_components<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line260">0260: </a>
<a name="line261">0261: </a>  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>marker<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>saw_SOF<span style="color: #990000">)</span>
<a name="line262">0262: </a>    <span style="font-weight: bold"><span style="color: #000000">ERREXIT</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> JERR_SOF_DUPLICATE<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line263">0263: </a>
<a name="line264">0264: </a>  <span style="font-style: italic"><span style="color: #9A1900">/* We don't support files in which the image height is initially specified */</span></span>
<a name="line265">0265: </a>  <span style="font-style: italic"><span style="color: #9A1900">/* as 0 and is later redefined by DNL.  As long as we have to check that,  */</span></span>
<a name="line266">0266: </a>  <span style="font-style: italic"><span style="color: #9A1900">/* might as well have a general sanity check. */</span></span>
<a name="line267">0267: </a>  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>image_height <span style="color: #990000">&lt;</span><span style="color: #990000">=</span> <span style="color: #993399">0</span> <span style="color: #990000">|</span><span style="color: #990000">|</span> cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>image_width <span style="color: #990000">&lt;</span><span style="color: #990000">=</span> <span style="color: #993399">0</span>
<a name="line268">0268: </a>      <span style="color: #990000">|</span><span style="color: #990000">|</span> cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>num_components <span style="color: #990000">&lt;</span><span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">)</span>
<a name="line269">0269: </a>    <span style="font-weight: bold"><span style="color: #000000">ERREXIT</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> JERR_EMPTY_IMAGE<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line270">0270: </a>
<a name="line271">0271: </a>  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>length <span style="color: #990000">!</span><span style="color: #990000">=</span> <span style="color: #990000">(</span>cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>num_components <span style="color: #990000">*</span> <span style="color: #993399">3</span><span style="color: #990000">)</span><span style="color: #990000">)</span>
<a name="line272">0272: </a>    <span style="font-weight: bold"><span style="color: #000000">ERREXIT</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> JERR_BAD_LENGTH<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line273">0273: </a>
<a name="line274">0274: </a>  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>comp_info <span style="color: #990000">=</span><span style="color: #990000">=</span> NULL<span style="color: #990000">)</span> <span style="font-style: italic"><span style="color: #9A1900">/* do only once, even if suspend */</span></span>
<a name="line275">0275: </a>    cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>comp_info <span style="color: #990000">=</span> <span style="color: #990000">(</span>jpeg_component_info <span style="color: #990000">*</span><span style="color: #990000">)</span> <span style="color: #990000">(</span><span style="color: #990000">*</span>cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>mem<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>alloc_small<span style="color: #990000">)</span>
<a name="line276">0276: </a>                        <span style="color: #990000">(</span><span style="color: #990000">(</span>j_common_ptr<span style="color: #990000">)</span> cinfo<span style="color: #990000">,</span> JPOOL_IMAGE<span style="color: #990000">,</span>
<a name="line277">0277: </a>                         cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>num_components <span style="color: #990000">*</span> <span style="font-weight: bold"><span style="color: #000000">SIZEOF</span></span><span style="color: #990000">(</span>jpeg_component_info<span style="color: #990000">)</span><span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line278">0278: </a>  
<a name="line279">0279: </a>  <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> <span style="color: #990000">(</span>ci <span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">,</span> compptr <span style="color: #990000">=</span> cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>comp_info<span style="color: #990000">;</span> ci <span style="color: #990000">&lt;</span> cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>num_components<span style="color: #990000">;</span>
<a name="line280">0280: </a>       ci<span style="color: #990000">+</span><span style="color: #990000">+</span><span style="color: #990000">,</span> compptr<span style="color: #990000">+</span><span style="color: #990000">+</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line281">0281: </a>    compptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>component_index <span style="color: #990000">=</span> ci<span style="color: #990000">;</span>
<a name="line282">0282: </a>    <span style="font-weight: bold"><span style="color: #000000">INPUT_BYTE</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> compptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>component_id<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> FALSE<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line283">0283: </a>    <span style="font-weight: bold"><span style="color: #000000">INPUT_BYTE</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> c<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> FALSE<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line284">0284: </a>    compptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>h_samp_factor <span style="color: #990000">=</span> <span style="color: #990000">(</span>c <span style="color: #990000">&gt;</span><span style="color: #990000">&gt;</span> <span style="color: #993399">4</span><span style="color: #990000">)</span> <span style="color: #990000">&amp;</span> <span style="color: #993399">15</span><span style="color: #990000">;</span>
<a name="line285">0285: </a>    compptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>v_samp_factor <span style="color: #990000">=</span> <span style="color: #990000">(</span>c     <span style="color: #990000">)</span> <span style="color: #990000">&amp;</span> <span style="color: #993399">15</span><span style="color: #990000">;</span>
<a name="line286">0286: </a>    <span style="font-weight: bold"><span style="color: #000000">INPUT_BYTE</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> compptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>quant_tbl_no<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> FALSE<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line287">0287: </a>
<a name="line288">0288: </a>    <span style="font-weight: bold"><span style="color: #000000">TRACEMS4</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> <span style="color: #993399">1</span><span style="color: #990000">,</span> JTRC_SOF_COMPONENT<span style="color: #990000">,</span>
<a name="line289">0289: </a>             compptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>component_id<span style="color: #990000">,</span> compptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>h_samp_factor<span style="color: #990000">,</span>
<a name="line290">0290: </a>             compptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>v_samp_factor<span style="color: #990000">,</span> compptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>quant_tbl_no<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line291">0291: </a>  <span style="color: #FF0000">}</span>
<a name="line292">0292: </a>
<a name="line293">0293: </a>  cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>marker<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>saw_SOF <span style="color: #990000">=</span> TRUE<span style="color: #990000">;</span>
<a name="line294">0294: </a>
<a name="line295">0295: </a>  <span style="font-weight: bold"><span style="color: #000000">INPUT_SYNC</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line296">0296: </a>  <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> TRUE<span style="color: #990000">;</span>
<a name="line297">0297: </a><span style="color: #FF0000">}</span>
<a name="line298">0298: </a>
<a name="line299">0299: </a>
<a name="line300">0300: </a><span style="font-weight: bold"><span style="color: #000000">LOCAL</span></span><span style="color: #990000">(</span>boolean<span style="color: #990000">)</span>
<a name="line301">0301: </a><span style="font-weight: bold"><span style="color: #000000">get_sos</span></span> <span style="color: #990000">(</span>j_decompress_ptr cinfo<span style="color: #990000">)</span>
<a name="line302">0302: </a><span style="font-style: italic"><span style="color: #9A1900">/* Process a SOS marker */</span></span>
<a name="line303">0303: </a><span style="color: #FF0000">{</span>
<a name="line304">0304: </a>  INT32 length<span style="color: #990000">;</span>
<a name="line305">0305: </a>  <span style="color: #009900">int</span> i<span style="color: #990000">,</span> ci<span style="color: #990000">,</span> n<span style="color: #990000">,</span> c<span style="color: #990000">,</span> cc<span style="color: #990000">;</span>
<a name="line306">0306: </a>  jpeg_component_info <span style="color: #990000">*</span> compptr<span style="color: #990000">;</span>
<a name="line307">0307: </a>  <span style="font-weight: bold"><span style="color: #000000">INPUT_VARS</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line308">0308: </a>
<a name="line309">0309: </a>  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span><span style="color: #990000">!</span> cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>marker<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>saw_SOF<span style="color: #990000">)</span>
<a name="line310">0310: </a>    <span style="font-weight: bold"><span style="color: #000000">ERREXIT</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> JERR_SOS_NO_SOF<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line311">0311: </a>
<a name="line312">0312: </a>  <span style="font-weight: bold"><span style="color: #000000">INPUT_2BYTES</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> length<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> FALSE<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line313">0313: </a>
<a name="line314">0314: </a>  <span style="font-weight: bold"><span style="color: #000000">INPUT_BYTE</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> n<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> FALSE<span style="color: #990000">)</span><span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">/* Number of components */</span></span>
<a name="line315">0315: </a>
<a name="line316">0316: </a>  <span style="font-weight: bold"><span style="color: #000000">TRACEMS1</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> <span style="color: #993399">1</span><span style="color: #990000">,</span> JTRC_SOS<span style="color: #990000">,</span> n<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line317">0317: </a>
<a name="line318">0318: </a>  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>length <span style="color: #990000">!</span><span style="color: #990000">=</span> <span style="color: #990000">(</span>n <span style="color: #990000">*</span> <span style="color: #993399">2</span> <span style="color: #990000">+</span> <span style="color: #993399">6</span><span style="color: #990000">)</span> <span style="color: #990000">|</span><span style="color: #990000">|</span> n <span style="color: #990000">&lt;</span> <span style="color: #993399">1</span> <span style="color: #990000">|</span><span style="color: #990000">|</span> n <span style="color: #990000">&gt;</span> MAX_COMPS_IN_SCAN<span style="color: #990000">)</span>
<a name="line319">0319: </a>    <span style="font-weight: bold"><span style="color: #000000">ERREXIT</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> JERR_BAD_LENGTH<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line320">0320: </a>
<a name="line321">0321: </a>  cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>comps_in_scan <span style="color: #990000">=</span> n<span style="color: #990000">;</span>
<a name="line322">0322: </a>
<a name="line323">0323: </a>  <span style="font-style: italic"><span style="color: #9A1900">/* Collect the component-spec parameters */</span></span>
<a name="line324">0324: </a>
<a name="line325">0325: </a>  <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> <span style="color: #990000">(</span>i <span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">;</span> i <span style="color: #990000">&lt;</span> n<span style="color: #990000">;</span> i<span style="color: #990000">+</span><span style="color: #990000">+</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line326">0326: </a>    <span style="font-weight: bold"><span style="color: #000000">INPUT_BYTE</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> cc<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> FALSE<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line327">0327: </a>    <span style="font-weight: bold"><span style="color: #000000">INPUT_BYTE</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> c<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> FALSE<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line328">0328: </a>    
<a name="line329">0329: </a>    <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> <span style="color: #990000">(</span>ci <span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">,</span> compptr <span style="color: #990000">=</span> cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>comp_info<span style="color: #990000">;</span> ci <span style="color: #990000">&lt;</span> cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>num_components<span style="color: #990000">;</span>
<a name="line330">0330: </a>         ci<span style="color: #990000">+</span><span style="color: #990000">+</span><span style="color: #990000">,</span> compptr<span style="color: #990000">+</span><span style="color: #990000">+</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line331">0331: </a>      <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>cc <span style="color: #990000">=</span><span style="color: #990000">=</span> compptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>component_id<span style="color: #990000">)</span>
<a name="line332">0332: </a>        <span style="font-weight: bold"><span style="color: #0000FF">goto</span></span> id_found<span style="color: #990000">;</span>
<a name="line333">0333: </a>    <span style="color: #FF0000">}</span>
<a name="line334">0334: </a>
<a name="line335">0335: </a>    <span style="font-weight: bold"><span style="color: #000000">ERREXIT1</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> JERR_BAD_COMPONENT_ID<span style="color: #990000">,</span> cc<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line336">0336: </a>
<a name="line337">0337: </a>  id_found<span style="color: #990000">:</span>
<a name="line338">0338: </a>
<a name="line339">0339: </a>    cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>cur_comp_info<span style="color: #990000">[</span>i<span style="color: #990000">]</span> <span style="color: #990000">=</span> compptr<span style="color: #990000">;</span>
<a name="line340">0340: </a>    compptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>dc_tbl_no <span style="color: #990000">=</span> <span style="color: #990000">(</span>c <span style="color: #990000">&gt;</span><span style="color: #990000">&gt;</span> <span style="color: #993399">4</span><span style="color: #990000">)</span> <span style="color: #990000">&amp;</span> <span style="color: #993399">15</span><span style="color: #990000">;</span>
<a name="line341">0341: </a>    compptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>ac_tbl_no <span style="color: #990000">=</span> <span style="color: #990000">(</span>c     <span style="color: #990000">)</span> <span style="color: #990000">&amp;</span> <span style="color: #993399">15</span><span style="color: #990000">;</span>
<a name="line342">0342: </a>    
<a name="line343">0343: </a>    <span style="font-weight: bold"><span style="color: #000000">TRACEMS3</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> <span style="color: #993399">1</span><span style="color: #990000">,</span> JTRC_SOS_COMPONENT<span style="color: #990000">,</span> cc<span style="color: #990000">,</span>
<a name="line344">0344: </a>             compptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>dc_tbl_no<span style="color: #990000">,</span> compptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>ac_tbl_no<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line345">0345: </a>  <span style="color: #FF0000">}</span>
<a name="line346">0346: </a>
<a name="line347">0347: </a>  <span style="font-style: italic"><span style="color: #9A1900">/* Collect the additional scan parameters Ss, Se, Ah/Al. */</span></span>
<a name="line348">0348: </a>  <span style="font-weight: bold"><span style="color: #000000">INPUT_BYTE</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> c<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> FALSE<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line349">0349: </a>  cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>Ss <span style="color: #990000">=</span> c<span style="color: #990000">;</span>
<a name="line350">0350: </a>  <span style="font-weight: bold"><span style="color: #000000">INPUT_BYTE</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> c<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> FALSE<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line351">0351: </a>  cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>Se <span style="color: #990000">=</span> c<span style="color: #990000">;</span>
<a name="line352">0352: </a>  <span style="font-weight: bold"><span style="color: #000000">INPUT_BYTE</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> c<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> FALSE<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line353">0353: </a>  cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>Ah <span style="color: #990000">=</span> <span style="color: #990000">(</span>c <span style="color: #990000">&gt;</span><span style="color: #990000">&gt;</span> <span style="color: #993399">4</span><span style="color: #990000">)</span> <span style="color: #990000">&amp;</span> <span style="color: #993399">15</span><span style="color: #990000">;</span>
<a name="line354">0354: </a>  cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>Al <span style="color: #990000">=</span> <span style="color: #990000">(</span>c     <span style="color: #990000">)</span> <span style="color: #990000">&amp;</span> <span style="color: #993399">15</span><span style="color: #990000">;</span>
<a name="line355">0355: </a>
<a name="line356">0356: </a>  <span style="font-weight: bold"><span style="color: #000000">TRACEMS4</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> <span style="color: #993399">1</span><span style="color: #990000">,</span> JTRC_SOS_PARAMS<span style="color: #990000">,</span> cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>Ss<span style="color: #990000">,</span> cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>Se<span style="color: #990000">,</span>
<a name="line357">0357: </a>           cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>Ah<span style="color: #990000">,</span> cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>Al<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line358">0358: </a>
<a name="line359">0359: </a>  <span style="font-style: italic"><span style="color: #9A1900">/* Prepare to scan data &amp; restart markers */</span></span>
<a name="line360">0360: </a>  cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>marker<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>next_restart_num <span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">;</span>
<a name="line361">0361: </a>
<a name="line362">0362: </a>  <span style="font-style: italic"><span style="color: #9A1900">/* Count another SOS marker */</span></span>
<a name="line363">0363: </a>  cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>input_scan_number<span style="color: #990000">+</span><span style="color: #990000">+</span><span style="color: #990000">;</span>
<a name="line364">0364: </a>
<a name="line365">0365: </a>  <span style="font-weight: bold"><span style="color: #000000">INPUT_SYNC</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line366">0366: </a>  <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> TRUE<span style="color: #990000">;</span>
<a name="line367">0367: </a><span style="color: #FF0000">}</span>
<a name="line368">0368: </a>
<a name="line369">0369: </a>
<a name="line370">0370: </a><span style="font-weight: bold"><span style="color: #000080">#ifdef</span></span> D_ARITH_CODING_SUPPORTED
<a name="line371">0371: </a>
<a name="line372">0372: </a><span style="font-weight: bold"><span style="color: #000000">LOCAL</span></span><span style="color: #990000">(</span>boolean<span style="color: #990000">)</span>
<a name="line373">0373: </a><span style="font-weight: bold"><span style="color: #000000">get_dac</span></span> <span style="color: #990000">(</span>j_decompress_ptr cinfo<span style="color: #990000">)</span>
<a name="line374">0374: </a><span style="font-style: italic"><span style="color: #9A1900">/* Process a DAC marker */</span></span>
<a name="line375">0375: </a><span style="color: #FF0000">{</span>
<a name="line376">0376: </a>  INT32 length<span style="color: #990000">;</span>
<a name="line377">0377: </a>  <span style="color: #009900">int</span> index<span style="color: #990000">,</span> val<span style="color: #990000">;</span>
<a name="line378">0378: </a>  <span style="font-weight: bold"><span style="color: #000000">INPUT_VARS</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line379">0379: </a>
<a name="line380">0380: </a>  <span style="font-weight: bold"><span style="color: #000000">INPUT_2BYTES</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> length<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> FALSE<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line381">0381: </a>  length <span style="color: #990000">-</span><span style="color: #990000">=</span> <span style="color: #993399">2</span><span style="color: #990000">;</span>
<a name="line382">0382: </a>  
<a name="line383">0383: </a>  <span style="font-weight: bold"><span style="color: #0000FF">while</span></span> <span style="color: #990000">(</span>length <span style="color: #990000">&gt;</span> <span style="color: #993399">0</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line384">0384: </a>    <span style="font-weight: bold"><span style="color: #000000">INPUT_BYTE</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> index<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> FALSE<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line385">0385: </a>    <span style="font-weight: bold"><span style="color: #000000">INPUT_BYTE</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> val<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> FALSE<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line386">0386: </a>
<a name="line387">0387: </a>    length <span style="color: #990000">-</span><span style="color: #990000">=</span> <span style="color: #993399">2</span><span style="color: #990000">;</span>
<a name="line388">0388: </a>
<a name="line389">0389: </a>    <span style="font-weight: bold"><span style="color: #000000">TRACEMS2</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> <span style="color: #993399">1</span><span style="color: #990000">,</span> JTRC_DAC<span style="color: #990000">,</span> index<span style="color: #990000">,</span> val<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line390">0390: </a>
<a name="line391">0391: </a>    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>index <span style="color: #990000">&lt;</span> <span style="color: #993399">0</span> <span style="color: #990000">|</span><span style="color: #990000">|</span> index <span style="color: #990000">&gt;</span><span style="color: #990000">=</span> <span style="color: #990000">(</span><span style="color: #993399">2</span><span style="color: #990000">*</span>NUM_ARITH_TBLS<span style="color: #990000">)</span><span style="color: #990000">)</span>
<a name="line392">0392: </a>      <span style="font-weight: bold"><span style="color: #000000">ERREXIT1</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> JERR_DAC_INDEX<span style="color: #990000">,</span> index<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line393">0393: </a>
<a name="line394">0394: </a>    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>index <span style="color: #990000">&gt;</span><span style="color: #990000">=</span> NUM_ARITH_TBLS<span style="color: #990000">)</span> <span style="color: #FF0000">{</span> <span style="font-style: italic"><span style="color: #9A1900">/* define AC table */</span></span>
<a name="line395">0395: </a>      cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>arith_ac_K<span style="color: #990000">[</span>index<span style="color: #990000">-</span>NUM_ARITH_TBLS<span style="color: #990000">]</span> <span style="color: #990000">=</span> <span style="color: #990000">(</span>UINT8<span style="color: #990000">)</span> val<span style="color: #990000">;</span>
<a name="line396">0396: </a>    <span style="color: #FF0000">}</span> <span style="font-weight: bold"><span style="color: #0000FF">else</span></span> <span style="color: #FF0000">{</span>                    <span style="font-style: italic"><span style="color: #9A1900">/* define DC table */</span></span>
<a name="line397">0397: </a>      cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>arith_dc_L<span style="color: #990000">[</span>index<span style="color: #990000">]</span> <span style="color: #990000">=</span> <span style="color: #990000">(</span>UINT8<span style="color: #990000">)</span> <span style="color: #990000">(</span>val <span style="color: #990000">&amp;</span> <span style="color: #993399">0x0F</span><span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line398">0398: </a>      cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>arith_dc_U<span style="color: #990000">[</span>index<span style="color: #990000">]</span> <span style="color: #990000">=</span> <span style="color: #990000">(</span>UINT8<span style="color: #990000">)</span> <span style="color: #990000">(</span>val <span style="color: #990000">&gt;</span><span style="color: #990000">&gt;</span> <span style="color: #993399">4</span><span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line399">0399: </a>      <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>arith_dc_L<span style="color: #990000">[</span>index<span style="color: #990000">]</span> <span style="color: #990000">&gt;</span> cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>arith_dc_U<span style="color: #990000">[</span>index<span style="color: #990000">]</span><span style="color: #990000">)</span>
<a name="line400">0400: </a>        <span style="font-weight: bold"><span style="color: #000000">ERREXIT1</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> JERR_DAC_VALUE<span style="color: #990000">,</span> val<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line401">0401: </a>    <span style="color: #FF0000">}</span>
<a name="line402">0402: </a>  <span style="color: #FF0000">}</span>
<a name="line403">0403: </a>
<a name="line404">0404: </a>  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>length <span style="color: #990000">!</span><span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">)</span>
<a name="line405">0405: </a>    <span style="font-weight: bold"><span style="color: #000000">ERREXIT</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> JERR_BAD_LENGTH<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line406">0406: </a>
<a name="line407">0407: </a>  <span style="font-weight: bold"><span style="color: #000000">INPUT_SYNC</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line408">0408: </a>  <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> TRUE<span style="color: #990000">;</span>
<a name="line409">0409: </a><span style="color: #FF0000">}</span>
<a name="line410">0410: </a>
<a name="line411">0411: </a><span style="font-weight: bold"><span style="color: #000080">#else</span></span> <span style="font-style: italic"><span style="color: #9A1900">/* ! D_ARITH_CODING_SUPPORTED */</span></span>
<a name="line412">0412: </a>
<a name="line413">0413: </a><span style="font-weight: bold"><span style="color: #000080">#define</span></span> <span style="font-weight: bold"><span style="color: #000000">get_dac</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">)</span>  <span style="font-weight: bold"><span style="color: #000000">skip_variable</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">)</span>
<a name="line414">0414: </a>
<a name="line415">0415: </a><span style="font-weight: bold"><span style="color: #000080">#endif</span></span> <span style="font-style: italic"><span style="color: #9A1900">/* D_ARITH_CODING_SUPPORTED */</span></span>
<a name="line416">0416: </a>
<a name="line417">0417: </a>
<a name="line418">0418: </a><span style="font-weight: bold"><span style="color: #000000">LOCAL</span></span><span style="color: #990000">(</span>boolean<span style="color: #990000">)</span>
<a name="line419">0419: </a><span style="font-weight: bold"><span style="color: #000000">get_dht</span></span> <span style="color: #990000">(</span>j_decompress_ptr cinfo<span style="color: #990000">)</span>
<a name="line420">0420: </a><span style="font-style: italic"><span style="color: #9A1900">/* Process a DHT marker */</span></span>
<a name="line421">0421: </a><span style="color: #FF0000">{</span>
<a name="line422">0422: </a>  INT32 length<span style="color: #990000">;</span>
<a name="line423">0423: </a>  UINT8 bits<span style="color: #990000">[</span><span style="color: #993399">17</span><span style="color: #990000">]</span><span style="color: #990000">;</span>
<a name="line424">0424: </a>  UINT8 huffval<span style="color: #990000">[</span><span style="color: #993399">256</span><span style="color: #990000">]</span><span style="color: #990000">;</span>
<a name="line425">0425: </a>  <span style="color: #009900">int</span> i<span style="color: #990000">,</span> index<span style="color: #990000">,</span> count<span style="color: #990000">;</span>
<a name="line426">0426: </a>  JHUFF_TBL <span style="color: #990000">*</span><span style="color: #990000">*</span>htblptr<span style="color: #990000">;</span>
<a name="line427">0427: </a>  <span style="font-weight: bold"><span style="color: #000000">INPUT_VARS</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line428">0428: </a>
<a name="line429">0429: </a>  <span style="font-weight: bold"><span style="color: #000000">INPUT_2BYTES</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> length<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> FALSE<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line430">0430: </a>  length <span style="color: #990000">-</span><span style="color: #990000">=</span> <span style="color: #993399">2</span><span style="color: #990000">;</span>
<a name="line431">0431: </a>  
<a name="line432">0432: </a>  <span style="font-weight: bold"><span style="color: #0000FF">while</span></span> <span style="color: #990000">(</span>length <span style="color: #990000">&gt;</span> <span style="color: #993399">16</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line433">0433: </a>    <span style="font-weight: bold"><span style="color: #000000">INPUT_BYTE</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> index<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> FALSE<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line434">0434: </a>
<a name="line435">0435: </a>    <span style="font-weight: bold"><span style="color: #000000">TRACEMS1</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> <span style="color: #993399">1</span><span style="color: #990000">,</span> JTRC_DHT<span style="color: #990000">,</span> index<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line436">0436: </a>      
<a name="line437">0437: </a>    bits<span style="color: #990000">[</span><span style="color: #993399">0</span><span style="color: #990000">]</span> <span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">;</span>
<a name="line438">0438: </a>    count <span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">;</span>
<a name="line439">0439: </a>    <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> <span style="color: #990000">(</span>i <span style="color: #990000">=</span> <span style="color: #993399">1</span><span style="color: #990000">;</span> i <span style="color: #990000">&lt;</span><span style="color: #990000">=</span> <span style="color: #993399">16</span><span style="color: #990000">;</span> i<span style="color: #990000">+</span><span style="color: #990000">+</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line440">0440: </a>      <span style="font-weight: bold"><span style="color: #000000">INPUT_BYTE</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> bits<span style="color: #990000">[</span>i<span style="color: #990000">]</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> FALSE<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line441">0441: </a>      count <span style="color: #990000">+</span><span style="color: #990000">=</span> bits<span style="color: #990000">[</span>i<span style="color: #990000">]</span><span style="color: #990000">;</span>
<a name="line442">0442: </a>    <span style="color: #FF0000">}</span>
<a name="line443">0443: </a>
<a name="line444">0444: </a>    length <span style="color: #990000">-</span><span style="color: #990000">=</span> <span style="color: #993399">1</span> <span style="color: #990000">+</span> <span style="color: #993399">16</span><span style="color: #990000">;</span>
<a name="line445">0445: </a>
<a name="line446">0446: </a>    <span style="font-weight: bold"><span style="color: #000000">TRACEMS8</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> <span style="color: #993399">2</span><span style="color: #990000">,</span> JTRC_HUFFBITS<span style="color: #990000">,</span>
<a name="line447">0447: </a>             bits<span style="color: #990000">[</span><span style="color: #993399">1</span><span style="color: #990000">]</span><span style="color: #990000">,</span> bits<span style="color: #990000">[</span><span style="color: #993399">2</span><span style="color: #990000">]</span><span style="color: #990000">,</span> bits<span style="color: #990000">[</span><span style="color: #993399">3</span><span style="color: #990000">]</span><span style="color: #990000">,</span> bits<span style="color: #990000">[</span><span style="color: #993399">4</span><span style="color: #990000">]</span><span style="color: #990000">,</span>
<a name="line448">0448: </a>             bits<span style="color: #990000">[</span><span style="color: #993399">5</span><span style="color: #990000">]</span><span style="color: #990000">,</span> bits<span style="color: #990000">[</span><span style="color: #993399">6</span><span style="color: #990000">]</span><span style="color: #990000">,</span> bits<span style="color: #990000">[</span><span style="color: #993399">7</span><span style="color: #990000">]</span><span style="color: #990000">,</span> bits<span style="color: #990000">[</span><span style="color: #993399">8</span><span style="color: #990000">]</span><span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line449">0449: </a>    <span style="font-weight: bold"><span style="color: #000000">TRACEMS8</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> <span style="color: #993399">2</span><span style="color: #990000">,</span> JTRC_HUFFBITS<span style="color: #990000">,</span>
<a name="line450">0450: </a>             bits<span style="color: #990000">[</span><span style="color: #993399">9</span><span style="color: #990000">]</span><span style="color: #990000">,</span> bits<span style="color: #990000">[</span><span style="color: #993399">10</span><span style="color: #990000">]</span><span style="color: #990000">,</span> bits<span style="color: #990000">[</span><span style="color: #993399">11</span><span style="color: #990000">]</span><span style="color: #990000">,</span> bits<span style="color: #990000">[</span><span style="color: #993399">12</span><span style="color: #990000">]</span><span style="color: #990000">,</span>
<a name="line451">0451: </a>             bits<span style="color: #990000">[</span><span style="color: #993399">13</span><span style="color: #990000">]</span><span style="color: #990000">,</span> bits<span style="color: #990000">[</span><span style="color: #993399">14</span><span style="color: #990000">]</span><span style="color: #990000">,</span> bits<span style="color: #990000">[</span><span style="color: #993399">15</span><span style="color: #990000">]</span><span style="color: #990000">,</span> bits<span style="color: #990000">[</span><span style="color: #993399">16</span><span style="color: #990000">]</span><span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line452">0452: </a>
<a name="line453">0453: </a>    <span style="font-style: italic"><span style="color: #9A1900">/* Here we just do minimal validation of the counts to avoid walking</span></span>
<a name="line454">0454: </a><span style="font-style: italic"><span style="color: #9A1900">     * off the end of our table space.  jdhuff.c will check more carefully.</span></span>
<a name="line455">0455: </a><span style="font-style: italic"><span style="color: #9A1900">     */</span></span>
<a name="line456">0456: </a>    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>count <span style="color: #990000">&gt;</span> <span style="color: #993399">256</span> <span style="color: #990000">|</span><span style="color: #990000">|</span> <span style="color: #990000">(</span><span style="color: #990000">(</span>INT32<span style="color: #990000">)</span> count<span style="color: #990000">)</span> <span style="color: #990000">&gt;</span> length<span style="color: #990000">)</span>
<a name="line457">0457: </a>      <span style="font-weight: bold"><span style="color: #000000">ERREXIT</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> JERR_BAD_HUFF_TABLE<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line458">0458: </a>
<a name="line459">0459: </a>    <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> <span style="color: #990000">(</span>i <span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">;</span> i <span style="color: #990000">&lt;</span> count<span style="color: #990000">;</span> i<span style="color: #990000">+</span><span style="color: #990000">+</span><span style="color: #990000">)</span>
<a name="line460">0460: </a>      <span style="font-weight: bold"><span style="color: #000000">INPUT_BYTE</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> huffval<span style="color: #990000">[</span>i<span style="color: #990000">]</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> FALSE<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line461">0461: </a>
<a name="line462">0462: </a>    length <span style="color: #990000">-</span><span style="color: #990000">=</span> count<span style="color: #990000">;</span>
<a name="line463">0463: </a>
<a name="line464">0464: </a>    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>index <span style="color: #990000">&amp;</span> <span style="color: #993399">0x10</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>         <span style="font-style: italic"><span style="color: #9A1900">/* AC table definition */</span></span>
<a name="line465">0465: </a>      index <span style="color: #990000">-</span><span style="color: #990000">=</span> <span style="color: #993399">0x10</span><span style="color: #990000">;</span>
<a name="line466">0466: </a>      htblptr <span style="color: #990000">=</span> <span style="color: #990000">&amp;</span>cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>ac_huff_tbl_ptrs<span style="color: #990000">[</span>index<span style="color: #990000">]</span><span style="color: #990000">;</span>
<a name="line467">0467: </a>    <span style="color: #FF0000">}</span> <span style="font-weight: bold"><span style="color: #0000FF">else</span></span> <span style="color: #FF0000">{</span>                    <span style="font-style: italic"><span style="color: #9A1900">/* DC table definition */</span></span>
<a name="line468">0468: </a>      htblptr <span style="color: #990000">=</span> <span style="color: #990000">&amp;</span>cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>dc_huff_tbl_ptrs<span style="color: #990000">[</span>index<span style="color: #990000">]</span><span style="color: #990000">;</span>
<a name="line469">0469: </a>    <span style="color: #FF0000">}</span>
<a name="line470">0470: </a>
<a name="line471">0471: </a>    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>index <span style="color: #990000">&lt;</span> <span style="color: #993399">0</span> <span style="color: #990000">|</span><span style="color: #990000">|</span> index <span style="color: #990000">&gt;</span><span style="color: #990000">=</span> NUM_HUFF_TBLS<span style="color: #990000">)</span>
<a name="line472">0472: </a>      <span style="font-weight: bold"><span style="color: #000000">ERREXIT1</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> JERR_DHT_INDEX<span style="color: #990000">,</span> index<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line473">0473: </a>
<a name="line474">0474: </a>    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span><span style="color: #990000">*</span>htblptr <span style="color: #990000">=</span><span style="color: #990000">=</span> NULL<span style="color: #990000">)</span>
<a name="line475">0475: </a>      <span style="color: #990000">*</span>htblptr <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">jpeg_alloc_huff_table</span></span><span style="color: #990000">(</span><span style="color: #990000">(</span>j_common_ptr<span style="color: #990000">)</span> cinfo<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line476">0476: </a>  
<a name="line477">0477: </a>    <span style="font-weight: bold"><span style="color: #000000">MEMCOPY</span></span><span style="color: #990000">(</span><span style="color: #990000">(</span><span style="color: #990000">*</span>htblptr<span style="color: #990000">)</span><span style="color: #990000">-</span><span style="color: #990000">&gt;</span>bits<span style="color: #990000">,</span> bits<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #000000">SIZEOF</span></span><span style="color: #990000">(</span><span style="color: #990000">(</span><span style="color: #990000">*</span>htblptr<span style="color: #990000">)</span><span style="color: #990000">-</span><span style="color: #990000">&gt;</span>bits<span style="color: #990000">)</span><span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line478">0478: </a>    <span style="font-weight: bold"><span style="color: #000000">MEMCOPY</span></span><span style="color: #990000">(</span><span style="color: #990000">(</span><span style="color: #990000">*</span>htblptr<span style="color: #990000">)</span><span style="color: #990000">-</span><span style="color: #990000">&gt;</span>huffval<span style="color: #990000">,</span> huffval<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #000000">SIZEOF</span></span><span style="color: #990000">(</span><span style="color: #990000">(</span><span style="color: #990000">*</span>htblptr<span style="color: #990000">)</span><span style="color: #990000">-</span><span style="color: #990000">&gt;</span>huffval<span style="color: #990000">)</span><span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line479">0479: </a>  <span style="color: #FF0000">}</span>
<a name="line480">0480: </a>
<a name="line481">0481: </a>  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>length <span style="color: #990000">!</span><span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">)</span>
<a name="line482">0482: </a>    <span style="font-weight: bold"><span style="color: #000000">ERREXIT</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> JERR_BAD_LENGTH<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line483">0483: </a>
<a name="line484">0484: </a>  <span style="font-weight: bold"><span style="color: #000000">INPUT_SYNC</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line485">0485: </a>  <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> TRUE<span style="color: #990000">;</span>
<a name="line486">0486: </a><span style="color: #FF0000">}</span>
<a name="line487">0487: </a>
<a name="line488">0488: </a>
<a name="line489">0489: </a><span style="font-weight: bold"><span style="color: #000000">LOCAL</span></span><span style="color: #990000">(</span>boolean<span style="color: #990000">)</span>
<a name="line490">0490: </a><span style="font-weight: bold"><span style="color: #000000">get_dqt</span></span> <span style="color: #990000">(</span>j_decompress_ptr cinfo<span style="color: #990000">)</span>
<a name="line491">0491: </a><span style="font-style: italic"><span style="color: #9A1900">/* Process a DQT marker */</span></span>
<a name="line492">0492: </a><span style="color: #FF0000">{</span>
<a name="line493">0493: </a>  INT32 length<span style="color: #990000">;</span>
<a name="line494">0494: </a>  <span style="color: #009900">int</span> n<span style="color: #990000">,</span> i<span style="color: #990000">,</span> prec<span style="color: #990000">;</span>
<a name="line495">0495: </a>  <span style="color: #009900">unsigned</span> <span style="color: #009900">int</span> tmp<span style="color: #990000">;</span>
<a name="line496">0496: </a>  JQUANT_TBL <span style="color: #990000">*</span>quant_ptr<span style="color: #990000">;</span>
<a name="line497">0497: </a>  <span style="font-weight: bold"><span style="color: #000000">INPUT_VARS</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line498">0498: </a>
<a name="line499">0499: </a>  <span style="font-weight: bold"><span style="color: #000000">INPUT_2BYTES</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> length<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> FALSE<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line500">0500: </a>  length <span style="color: #990000">-</span><span style="color: #990000">=</span> <span style="color: #993399">2</span><span style="color: #990000">;</span>
<a name="line501">0501: </a>
<a name="line502">0502: </a>  <span style="font-weight: bold"><span style="color: #0000FF">while</span></span> <span style="color: #990000">(</span>length <span style="color: #990000">&gt;</span> <span style="color: #993399">0</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line503">0503: </a>    <span style="font-weight: bold"><span style="color: #000000">INPUT_BYTE</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> n<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> FALSE<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line504">0504: </a>    prec <span style="color: #990000">=</span> n <span style="color: #990000">&gt;</span><span style="color: #990000">&gt;</span> <span style="color: #993399">4</span><span style="color: #990000">;</span>
<a name="line505">0505: </a>    n <span style="color: #990000">&amp;</span><span style="color: #990000">=</span> <span style="color: #993399">0x0F</span><span style="color: #990000">;</span>
<a name="line506">0506: </a>
<a name="line507">0507: </a>    <span style="font-weight: bold"><span style="color: #000000">TRACEMS2</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> <span style="color: #993399">1</span><span style="color: #990000">,</span> JTRC_DQT<span style="color: #990000">,</span> n<span style="color: #990000">,</span> prec<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line508">0508: </a>
<a name="line509">0509: </a>    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>n <span style="color: #990000">&gt;</span><span style="color: #990000">=</span> NUM_QUANT_TBLS<span style="color: #990000">)</span>
<a name="line510">0510: </a>      <span style="font-weight: bold"><span style="color: #000000">ERREXIT1</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> JERR_DQT_INDEX<span style="color: #990000">,</span> n<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line511">0511: </a>      
<a name="line512">0512: </a>    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>quant_tbl_ptrs<span style="color: #990000">[</span>n<span style="color: #990000">]</span> <span style="color: #990000">=</span><span style="color: #990000">=</span> NULL<span style="color: #990000">)</span>
<a name="line513">0513: </a>      cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>quant_tbl_ptrs<span style="color: #990000">[</span>n<span style="color: #990000">]</span> <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">jpeg_alloc_quant_table</span></span><span style="color: #990000">(</span><span style="color: #990000">(</span>j_common_ptr<span style="color: #990000">)</span> cinfo<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line514">0514: </a>    quant_ptr <span style="color: #990000">=</span> cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>quant_tbl_ptrs<span style="color: #990000">[</span>n<span style="color: #990000">]</span><span style="color: #990000">;</span>
<a name="line515">0515: </a>
<a name="line516">0516: </a>    <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> <span style="color: #990000">(</span>i <span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">;</span> i <span style="color: #990000">&lt;</span> DCTSIZE2<span style="color: #990000">;</span> i<span style="color: #990000">+</span><span style="color: #990000">+</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line517">0517: </a>      <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>prec<span style="color: #990000">)</span>
<a name="line518">0518: </a>        <span style="font-weight: bold"><span style="color: #000000">INPUT_2BYTES</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> tmp<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> FALSE<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line519">0519: </a>      <span style="font-weight: bold"><span style="color: #0000FF">else</span></span>
<a name="line520">0520: </a>        <span style="font-weight: bold"><span style="color: #000000">INPUT_BYTE</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> tmp<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> FALSE<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line521">0521: </a>      <span style="font-style: italic"><span style="color: #9A1900">/* We convert the zigzag-order table to natural array order. */</span></span>
<a name="line522">0522: </a>      quant_ptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>quantval<span style="color: #990000">[</span>jpeg_natural_order<span style="color: #990000">[</span>i<span style="color: #990000">]</span><span style="color: #990000">]</span> <span style="color: #990000">=</span> <span style="color: #990000">(</span>UINT16<span style="color: #990000">)</span> tmp<span style="color: #990000">;</span>
<a name="line523">0523: </a>    <span style="color: #FF0000">}</span>
<a name="line524">0524: </a>
<a name="line525">0525: </a>    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>err<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>trace_level <span style="color: #990000">&gt;</span><span style="color: #990000">=</span> <span style="color: #993399">2</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line526">0526: </a>      <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> <span style="color: #990000">(</span>i <span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">;</span> i <span style="color: #990000">&lt;</span> DCTSIZE2<span style="color: #990000">;</span> i <span style="color: #990000">+</span><span style="color: #990000">=</span> <span style="color: #993399">8</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line527">0527: </a>        <span style="font-weight: bold"><span style="color: #000000">TRACEMS8</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> <span style="color: #993399">2</span><span style="color: #990000">,</span> JTRC_QUANTVALS<span style="color: #990000">,</span>
<a name="line528">0528: </a>                 quant_ptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>quantval<span style="color: #990000">[</span>i<span style="color: #990000">]</span><span style="color: #990000">,</span>   quant_ptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>quantval<span style="color: #990000">[</span>i<span style="color: #990000">+</span><span style="color: #993399">1</span><span style="color: #990000">]</span><span style="color: #990000">,</span>
<a name="line529">0529: </a>                 quant_ptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>quantval<span style="color: #990000">[</span>i<span style="color: #990000">+</span><span style="color: #993399">2</span><span style="color: #990000">]</span><span style="color: #990000">,</span> quant_ptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>quantval<span style="color: #990000">[</span>i<span style="color: #990000">+</span><span style="color: #993399">3</span><span style="color: #990000">]</span><span style="color: #990000">,</span>
<a name="line530">0530: </a>                 quant_ptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>quantval<span style="color: #990000">[</span>i<span style="color: #990000">+</span><span style="color: #993399">4</span><span style="color: #990000">]</span><span style="color: #990000">,</span> quant_ptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>quantval<span style="color: #990000">[</span>i<span style="color: #990000">+</span><span style="color: #993399">5</span><span style="color: #990000">]</span><span style="color: #990000">,</span>
<a name="line531">0531: </a>                 quant_ptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>quantval<span style="color: #990000">[</span>i<span style="color: #990000">+</span><span style="color: #993399">6</span><span style="color: #990000">]</span><span style="color: #990000">,</span> quant_ptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>quantval<span style="color: #990000">[</span>i<span style="color: #990000">+</span><span style="color: #993399">7</span><span style="color: #990000">]</span><span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line532">0532: </a>      <span style="color: #FF0000">}</span>
<a name="line533">0533: </a>    <span style="color: #FF0000">}</span>
<a name="line534">0534: </a>
<a name="line535">0535: </a>    length <span style="color: #990000">-</span><span style="color: #990000">=</span> DCTSIZE2<span style="color: #990000">+</span><span style="color: #993399">1</span><span style="color: #990000">;</span>
<a name="line536">0536: </a>    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>prec<span style="color: #990000">)</span> length <span style="color: #990000">-</span><span style="color: #990000">=</span> DCTSIZE2<span style="color: #990000">;</span>
<a name="line537">0537: </a>  <span style="color: #FF0000">}</span>
<a name="line538">0538: </a>
<a name="line539">0539: </a>  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>length <span style="color: #990000">!</span><span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">)</span>
<a name="line540">0540: </a>    <span style="font-weight: bold"><span style="color: #000000">ERREXIT</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> JERR_BAD_LENGTH<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line541">0541: </a>
<a name="line542">0542: </a>  <span style="font-weight: bold"><span style="color: #000000">INPUT_SYNC</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line543">0543: </a>  <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> TRUE<span style="color: #990000">;</span>
<a name="line544">0544: </a><span style="color: #FF0000">}</span>
<a name="line545">0545: </a>
<a name="line546">0546: </a>
<a name="line547">0547: </a><span style="font-weight: bold"><span style="color: #000000">LOCAL</span></span><span style="color: #990000">(</span>boolean<span style="color: #990000">)</span>
<a name="line548">0548: </a><span style="font-weight: bold"><span style="color: #000000">get_dri</span></span> <span style="color: #990000">(</span>j_decompress_ptr cinfo<span style="color: #990000">)</span>
<a name="line549">0549: </a><span style="font-style: italic"><span style="color: #9A1900">/* Process a DRI marker */</span></span>
<a name="line550">0550: </a><span style="color: #FF0000">{</span>
<a name="line551">0551: </a>  INT32 length<span style="color: #990000">;</span>
<a name="line552">0552: </a>  <span style="color: #009900">unsigned</span> <span style="color: #009900">int</span> tmp<span style="color: #990000">;</span>
<a name="line553">0553: </a>  <span style="font-weight: bold"><span style="color: #000000">INPUT_VARS</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line554">0554: </a>
<a name="line555">0555: </a>  <span style="font-weight: bold"><span style="color: #000000">INPUT_2BYTES</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> length<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> FALSE<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line556">0556: </a>  
<a name="line557">0557: </a>  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>length <span style="color: #990000">!</span><span style="color: #990000">=</span> <span style="color: #993399">4</span><span style="color: #990000">)</span>
<a name="line558">0558: </a>    <span style="font-weight: bold"><span style="color: #000000">ERREXIT</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> JERR_BAD_LENGTH<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line559">0559: </a>
<a name="line560">0560: </a>  <span style="font-weight: bold"><span style="color: #000000">INPUT_2BYTES</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> tmp<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> FALSE<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line561">0561: </a>
<a name="line562">0562: </a>  <span style="font-weight: bold"><span style="color: #000000">TRACEMS1</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> <span style="color: #993399">1</span><span style="color: #990000">,</span> JTRC_DRI<span style="color: #990000">,</span> tmp<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line563">0563: </a>
<a name="line564">0564: </a>  cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>restart_interval <span style="color: #990000">=</span> tmp<span style="color: #990000">;</span>
<a name="line565">0565: </a>
<a name="line566">0566: </a>  <span style="font-weight: bold"><span style="color: #000000">INPUT_SYNC</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line567">0567: </a>  <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> TRUE<span style="color: #990000">;</span>
<a name="line568">0568: </a><span style="color: #FF0000">}</span>
<a name="line569">0569: </a>
<a name="line570">0570: </a>
<a name="line571">0571: </a><span style="font-style: italic"><span style="color: #9A1900">/*</span></span>
<a name="line572">0572: </a><span style="font-style: italic"><span style="color: #9A1900"> * Routines for processing APPn and COM markers.</span></span>
<a name="line573">0573: </a><span style="font-style: italic"><span style="color: #9A1900"> * These are either saved in memory or discarded, per application request.</span></span>
<a name="line574">0574: </a><span style="font-style: italic"><span style="color: #9A1900"> * APP0 and APP14 are specially checked to see if they are</span></span>
<a name="line575">0575: </a><span style="font-style: italic"><span style="color: #9A1900"> * JFIF and Adobe markers, respectively.</span></span>
<a name="line576">0576: </a><span style="font-style: italic"><span style="color: #9A1900"> */</span></span>
<a name="line577">0577: </a>
<a name="line578">0578: </a><span style="font-weight: bold"><span style="color: #000080">#define</span></span> APP0_DATA_LEN   <span style="color: #993399">14</span>      <span style="font-style: italic"><span style="color: #9A1900">/* Length of interesting data in APP0 */</span></span>
<a name="line579">0579: </a><span style="font-weight: bold"><span style="color: #000080">#define</span></span> APP14_DATA_LEN  <span style="color: #993399">12</span>      <span style="font-style: italic"><span style="color: #9A1900">/* Length of interesting data in APP14 */</span></span>
<a name="line580">0580: </a><span style="font-weight: bold"><span style="color: #000080">#define</span></span> APPN_DATA_LEN   <span style="color: #993399">14</span>      <span style="font-style: italic"><span style="color: #9A1900">/* Must be the largest of the above!! */</span></span>
<a name="line581">0581: </a>
<a name="line582">0582: </a>
<a name="line583">0583: </a><span style="font-weight: bold"><span style="color: #000000">LOCAL</span></span><span style="color: #990000">(</span><span style="color: #009900">void</span><span style="color: #990000">)</span>
<a name="line584">0584: </a><span style="font-weight: bold"><span style="color: #000000">examine_app0</span></span> <span style="color: #990000">(</span>j_decompress_ptr cinfo<span style="color: #990000">,</span> JOCTET FAR <span style="color: #990000">*</span> data<span style="color: #990000">,</span>
<a name="line585">0585: </a>              <span style="color: #009900">unsigned</span> <span style="color: #009900">int</span> datalen<span style="color: #990000">,</span> INT32 remaining<span style="color: #990000">)</span>
<a name="line586">0586: </a><span style="font-style: italic"><span style="color: #9A1900">/* Examine first few bytes from an APP0.</span></span>
<a name="line587">0587: </a><span style="font-style: italic"><span style="color: #9A1900"> * Take appropriate action if it is a JFIF marker.</span></span>
<a name="line588">0588: </a><span style="font-style: italic"><span style="color: #9A1900"> * datalen is # of bytes at data[], remaining is length of rest of marker data.</span></span>
<a name="line589">0589: </a><span style="font-style: italic"><span style="color: #9A1900"> */</span></span>
<a name="line590">0590: </a><span style="color: #FF0000">{</span>
<a name="line591">0591: </a>  INT32 totallen <span style="color: #990000">=</span> <span style="color: #990000">(</span>INT32<span style="color: #990000">)</span> datalen <span style="color: #990000">+</span> remaining<span style="color: #990000">;</span>
<a name="line592">0592: </a>
<a name="line593">0593: </a>  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>datalen <span style="color: #990000">&gt;</span><span style="color: #990000">=</span> APP0_DATA_LEN <span style="color: #990000">&amp;</span><span style="color: #990000">&amp;</span>
<a name="line594">0594: </a>      <span style="font-weight: bold"><span style="color: #000000">GETJOCTET</span></span><span style="color: #990000">(</span>data<span style="color: #990000">[</span><span style="color: #993399">0</span><span style="color: #990000">]</span><span style="color: #990000">)</span> <span style="color: #990000">=</span><span style="color: #990000">=</span> <span style="color: #993399">0x4A</span> <span style="color: #990000">&amp;</span><span style="color: #990000">&amp;</span>
<a name="line595">0595: </a>      <span style="font-weight: bold"><span style="color: #000000">GETJOCTET</span></span><span style="color: #990000">(</span>data<span style="color: #990000">[</span><span style="color: #993399">1</span><span style="color: #990000">]</span><span style="color: #990000">)</span> <span style="color: #990000">=</span><span style="color: #990000">=</span> <span style="color: #993399">0x46</span> <span style="color: #990000">&amp;</span><span style="color: #990000">&amp;</span>
<a name="line596">0596: </a>      <span style="font-weight: bold"><span style="color: #000000">GETJOCTET</span></span><span style="color: #990000">(</span>data<span style="color: #990000">[</span><span style="color: #993399">2</span><span style="color: #990000">]</span><span style="color: #990000">)</span> <span style="color: #990000">=</span><span style="color: #990000">=</span> <span style="color: #993399">0x49</span> <span style="color: #990000">&amp;</span><span style="color: #990000">&amp;</span>
<a name="line597">0597: </a>      <span style="font-weight: bold"><span style="color: #000000">GETJOCTET</span></span><span style="color: #990000">(</span>data<span style="color: #990000">[</span><span style="color: #993399">3</span><span style="color: #990000">]</span><span style="color: #990000">)</span> <span style="color: #990000">=</span><span style="color: #990000">=</span> <span style="color: #993399">0x46</span> <span style="color: #990000">&amp;</span><span style="color: #990000">&amp;</span>
<a name="line598">0598: </a>      <span style="font-weight: bold"><span style="color: #000000">GETJOCTET</span></span><span style="color: #990000">(</span>data<span style="color: #990000">[</span><span style="color: #993399">4</span><span style="color: #990000">]</span><span style="color: #990000">)</span> <span style="color: #990000">=</span><span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line599">0599: </a>    <span style="font-style: italic"><span style="color: #9A1900">/* Found JFIF APP0 marker: save info */</span></span>
<a name="line600">0600: </a>    cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>saw_JFIF_marker <span style="color: #990000">=</span> TRUE<span style="color: #990000">;</span>
<a name="line601">0601: </a>    cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>JFIF_major_version <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">GETJOCTET</span></span><span style="color: #990000">(</span>data<span style="color: #990000">[</span><span style="color: #993399">5</span><span style="color: #990000">]</span><span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line602">0602: </a>    cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>JFIF_minor_version <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">GETJOCTET</span></span><span style="color: #990000">(</span>data<span style="color: #990000">[</span><span style="color: #993399">6</span><span style="color: #990000">]</span><span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line603">0603: </a>    cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>density_unit <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">GETJOCTET</span></span><span style="color: #990000">(</span>data<span style="color: #990000">[</span><span style="color: #993399">7</span><span style="color: #990000">]</span><span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line604">0604: </a>    cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>X_density <span style="color: #990000">=</span> <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #000000">GETJOCTET</span></span><span style="color: #990000">(</span>data<span style="color: #990000">[</span><span style="color: #993399">8</span><span style="color: #990000">]</span><span style="color: #990000">)</span> <span style="color: #990000">&lt;</span><span style="color: #990000">&lt;</span> <span style="color: #993399">8</span><span style="color: #990000">)</span> <span style="color: #990000">+</span> <span style="font-weight: bold"><span style="color: #000000">GETJOCTET</span></span><span style="color: #990000">(</span>data<span style="color: #990000">[</span><span style="color: #993399">9</span><span style="color: #990000">]</span><span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line605">0605: </a>    cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>Y_density <span style="color: #990000">=</span> <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #000000">GETJOCTET</span></span><span style="color: #990000">(</span>data<span style="color: #990000">[</span><span style="color: #993399">10</span><span style="color: #990000">]</span><span style="color: #990000">)</span> <span style="color: #990000">&lt;</span><span style="color: #990000">&lt;</span> <span style="color: #993399">8</span><span style="color: #990000">)</span> <span style="color: #990000">+</span> <span style="font-weight: bold"><span style="color: #000000">GETJOCTET</span></span><span style="color: #990000">(</span>data<span style="color: #990000">[</span><span style="color: #993399">11</span><span style="color: #990000">]</span><span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line606">0606: </a>    <span style="font-style: italic"><span style="color: #9A1900">/* Check version.</span></span>
<a name="line607">0607: </a><span style="font-style: italic"><span style="color: #9A1900">     * Major version must be 1, anything else signals an incompatible change.</span></span>
<a name="line608">0608: </a><span style="font-style: italic"><span style="color: #9A1900">     * (We used to treat this as an error, but now it's a nonfatal warning,</span></span>
<a name="line609">0609: </a><span style="font-style: italic"><span style="color: #9A1900">     * because some bozo at Hijaak couldn't read the spec.)</span></span>
<a name="line610">0610: </a><span style="font-style: italic"><span style="color: #9A1900">     * Minor version should be 0..2, but process anyway if newer.</span></span>
<a name="line611">0611: </a><span style="font-style: italic"><span style="color: #9A1900">     */</span></span>
<a name="line612">0612: </a>    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>JFIF_major_version <span style="color: #990000">!</span><span style="color: #990000">=</span> <span style="color: #993399">1</span><span style="color: #990000">)</span>
<a name="line613">0613: </a>      <span style="font-weight: bold"><span style="color: #000000">WARNMS2</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> JWRN_JFIF_MAJOR<span style="color: #990000">,</span>
<a name="line614">0614: </a>              cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>JFIF_major_version<span style="color: #990000">,</span> cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>JFIF_minor_version<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line615">0615: </a>    <span style="font-style: italic"><span style="color: #9A1900">/* Generate trace messages */</span></span>
<a name="line616">0616: </a>    <span style="font-weight: bold"><span style="color: #000000">TRACEMS5</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> <span style="color: #993399">1</span><span style="color: #990000">,</span> JTRC_JFIF<span style="color: #990000">,</span>
<a name="line617">0617: </a>             cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>JFIF_major_version<span style="color: #990000">,</span> cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>JFIF_minor_version<span style="color: #990000">,</span>
<a name="line618">0618: </a>             cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>X_density<span style="color: #990000">,</span> cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>Y_density<span style="color: #990000">,</span> cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>density_unit<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line619">0619: </a>    <span style="font-style: italic"><span style="color: #9A1900">/* Validate thumbnail dimensions and issue appropriate messages */</span></span>
<a name="line620">0620: </a>    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #000000">GETJOCTET</span></span><span style="color: #990000">(</span>data<span style="color: #990000">[</span><span style="color: #993399">12</span><span style="color: #990000">]</span><span style="color: #990000">)</span> <span style="color: #990000">|</span> <span style="font-weight: bold"><span style="color: #000000">GETJOCTET</span></span><span style="color: #990000">(</span>data<span style="color: #990000">[</span><span style="color: #993399">13</span><span style="color: #990000">]</span><span style="color: #990000">)</span><span style="color: #990000">)</span>
<a name="line621">0621: </a>      <span style="font-weight: bold"><span style="color: #000000">TRACEMS2</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> <span style="color: #993399">1</span><span style="color: #990000">,</span> JTRC_JFIF_THUMBNAIL<span style="color: #990000">,</span>
<a name="line622">0622: </a>               <span style="font-weight: bold"><span style="color: #000000">GETJOCTET</span></span><span style="color: #990000">(</span>data<span style="color: #990000">[</span><span style="color: #993399">12</span><span style="color: #990000">]</span><span style="color: #990000">)</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #000000">GETJOCTET</span></span><span style="color: #990000">(</span>data<span style="color: #990000">[</span><span style="color: #993399">13</span><span style="color: #990000">]</span><span style="color: #990000">)</span><span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line623">0623: </a>    totallen <span style="color: #990000">-</span><span style="color: #990000">=</span> APP0_DATA_LEN<span style="color: #990000">;</span>
<a name="line624">0624: </a>    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>totallen <span style="color: #990000">!</span><span style="color: #990000">=</span>
<a name="line625">0625: </a>        <span style="color: #990000">(</span><span style="color: #990000">(</span>INT32<span style="color: #990000">)</span><span style="font-weight: bold"><span style="color: #000000">GETJOCTET</span></span><span style="color: #990000">(</span>data<span style="color: #990000">[</span><span style="color: #993399">12</span><span style="color: #990000">]</span><span style="color: #990000">)</span> <span style="color: #990000">*</span> <span style="color: #990000">(</span>INT32<span style="color: #990000">)</span><span style="font-weight: bold"><span style="color: #000000">GETJOCTET</span></span><span style="color: #990000">(</span>data<span style="color: #990000">[</span><span style="color: #993399">13</span><span style="color: #990000">]</span><span style="color: #990000">)</span> <span style="color: #990000">*</span> <span style="color: #990000">(</span>INT32<span style="color: #990000">)</span> <span style="color: #993399">3</span><span style="color: #990000">)</span><span style="color: #990000">)</span>
<a name="line626">0626: </a>      <span style="font-weight: bold"><span style="color: #000000">TRACEMS1</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> <span style="color: #993399">1</span><span style="color: #990000">,</span> JTRC_JFIF_BADTHUMBNAILSIZE<span style="color: #990000">,</span> <span style="color: #990000">(</span><span style="color: #009900">int</span><span style="color: #990000">)</span> totallen<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line627">0627: </a>  <span style="color: #FF0000">}</span> <span style="font-weight: bold"><span style="color: #0000FF">else</span></span> <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>datalen <span style="color: #990000">&gt;</span><span style="color: #990000">=</span> <span style="color: #993399">6</span> <span style="color: #990000">&amp;</span><span style="color: #990000">&amp;</span>
<a name="line628">0628: </a>      <span style="font-weight: bold"><span style="color: #000000">GETJOCTET</span></span><span style="color: #990000">(</span>data<span style="color: #990000">[</span><span style="color: #993399">0</span><span style="color: #990000">]</span><span style="color: #990000">)</span> <span style="color: #990000">=</span><span style="color: #990000">=</span> <span style="color: #993399">0x4A</span> <span style="color: #990000">&amp;</span><span style="color: #990000">&amp;</span>
<a name="line629">0629: </a>      <span style="font-weight: bold"><span style="color: #000000">GETJOCTET</span></span><span style="color: #990000">(</span>data<span style="color: #990000">[</span><span style="color: #993399">1</span><span style="color: #990000">]</span><span style="color: #990000">)</span> <span style="color: #990000">=</span><span style="color: #990000">=</span> <span style="color: #993399">0x46</span> <span style="color: #990000">&amp;</span><span style="color: #990000">&amp;</span>
<a name="line630">0630: </a>      <span style="font-weight: bold"><span style="color: #000000">GETJOCTET</span></span><span style="color: #990000">(</span>data<span style="color: #990000">[</span><span style="color: #993399">2</span><span style="color: #990000">]</span><span style="color: #990000">)</span> <span style="color: #990000">=</span><span style="color: #990000">=</span> <span style="color: #993399">0x58</span> <span style="color: #990000">&amp;</span><span style="color: #990000">&amp;</span>
<a name="line631">0631: </a>      <span style="font-weight: bold"><span style="color: #000000">GETJOCTET</span></span><span style="color: #990000">(</span>data<span style="color: #990000">[</span><span style="color: #993399">3</span><span style="color: #990000">]</span><span style="color: #990000">)</span> <span style="color: #990000">=</span><span style="color: #990000">=</span> <span style="color: #993399">0x58</span> <span style="color: #990000">&amp;</span><span style="color: #990000">&amp;</span>
<a name="line632">0632: </a>      <span style="font-weight: bold"><span style="color: #000000">GETJOCTET</span></span><span style="color: #990000">(</span>data<span style="color: #990000">[</span><span style="color: #993399">4</span><span style="color: #990000">]</span><span style="color: #990000">)</span> <span style="color: #990000">=</span><span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line633">0633: </a>    <span style="font-style: italic"><span style="color: #9A1900">/* Found JFIF "JFXX" extension APP0 marker */</span></span>
<a name="line634">0634: </a>    <span style="font-style: italic"><span style="color: #9A1900">/* The library doesn't actually do anything with these,</span></span>
<a name="line635">0635: </a><span style="font-style: italic"><span style="color: #9A1900">     * but we try to produce a helpful trace message.</span></span>
<a name="line636">0636: </a><span style="font-style: italic"><span style="color: #9A1900">     */</span></span>
<a name="line637">0637: </a>    <span style="font-weight: bold"><span style="color: #0000FF">switch</span></span> <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #000000">GETJOCTET</span></span><span style="color: #990000">(</span>data<span style="color: #990000">[</span><span style="color: #993399">5</span><span style="color: #990000">]</span><span style="color: #990000">)</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line638">0638: </a>    <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> <span style="color: #993399">0x10</span><span style="color: #990000">:</span>
<a name="line639">0639: </a>      <span style="font-weight: bold"><span style="color: #000000">TRACEMS1</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> <span style="color: #993399">1</span><span style="color: #990000">,</span> JTRC_THUMB_JPEG<span style="color: #990000">,</span> <span style="color: #990000">(</span><span style="color: #009900">int</span><span style="color: #990000">)</span> totallen<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line640">0640: </a>      <span style="font-weight: bold"><span style="color: #0000FF">break</span></span><span style="color: #990000">;</span>
<a name="line641">0641: </a>    <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> <span style="color: #993399">0x11</span><span style="color: #990000">:</span>
<a name="line642">0642: </a>      <span style="font-weight: bold"><span style="color: #000000">TRACEMS1</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> <span style="color: #993399">1</span><span style="color: #990000">,</span> JTRC_THUMB_PALETTE<span style="color: #990000">,</span> <span style="color: #990000">(</span><span style="color: #009900">int</span><span style="color: #990000">)</span> totallen<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line643">0643: </a>      <span style="font-weight: bold"><span style="color: #0000FF">break</span></span><span style="color: #990000">;</span>
<a name="line644">0644: </a>    <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> <span style="color: #993399">0x13</span><span style="color: #990000">:</span>
<a name="line645">0645: </a>      <span style="font-weight: bold"><span style="color: #000000">TRACEMS1</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> <span style="color: #993399">1</span><span style="color: #990000">,</span> JTRC_THUMB_RGB<span style="color: #990000">,</span> <span style="color: #990000">(</span><span style="color: #009900">int</span><span style="color: #990000">)</span> totallen<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line646">0646: </a>      <span style="font-weight: bold"><span style="color: #0000FF">break</span></span><span style="color: #990000">;</span>
<a name="line647">0647: </a>    <span style="font-weight: bold"><span style="color: #0000FF">default</span></span><span style="color: #990000">:</span>
<a name="line648">0648: </a>      <span style="font-weight: bold"><span style="color: #000000">TRACEMS2</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> <span style="color: #993399">1</span><span style="color: #990000">,</span> JTRC_JFIF_EXTENSION<span style="color: #990000">,</span>
<a name="line649">0649: </a>               <span style="font-weight: bold"><span style="color: #000000">GETJOCTET</span></span><span style="color: #990000">(</span>data<span style="color: #990000">[</span><span style="color: #993399">5</span><span style="color: #990000">]</span><span style="color: #990000">)</span><span style="color: #990000">,</span> <span style="color: #990000">(</span><span style="color: #009900">int</span><span style="color: #990000">)</span> totallen<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line650">0650: </a>      <span style="font-weight: bold"><span style="color: #0000FF">break</span></span><span style="color: #990000">;</span>
<a name="line651">0651: </a>    <span style="color: #FF0000">}</span>
<a name="line652">0652: </a>  <span style="color: #FF0000">}</span> <span style="font-weight: bold"><span style="color: #0000FF">else</span></span> <span style="color: #FF0000">{</span>
<a name="line653">0653: </a>    <span style="font-style: italic"><span style="color: #9A1900">/* Start of APP0 does not match "JFIF" or "JFXX", or too short */</span></span>
<a name="line654">0654: </a>    <span style="font-weight: bold"><span style="color: #000000">TRACEMS1</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> <span style="color: #993399">1</span><span style="color: #990000">,</span> JTRC_APP0<span style="color: #990000">,</span> <span style="color: #990000">(</span><span style="color: #009900">int</span><span style="color: #990000">)</span> totallen<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line655">0655: </a>  <span style="color: #FF0000">}</span>
<a name="line656">0656: </a><span style="color: #FF0000">}</span>
<a name="line657">0657: </a>
<a name="line658">0658: </a>
<a name="line659">0659: </a><span style="font-weight: bold"><span style="color: #000000">LOCAL</span></span><span style="color: #990000">(</span><span style="color: #009900">void</span><span style="color: #990000">)</span>
<a name="line660">0660: </a><span style="font-weight: bold"><span style="color: #000000">examine_app14</span></span> <span style="color: #990000">(</span>j_decompress_ptr cinfo<span style="color: #990000">,</span> JOCTET FAR <span style="color: #990000">*</span> data<span style="color: #990000">,</span>
<a name="line661">0661: </a>               <span style="color: #009900">unsigned</span> <span style="color: #009900">int</span> datalen<span style="color: #990000">,</span> INT32 remaining<span style="color: #990000">)</span>
<a name="line662">0662: </a><span style="font-style: italic"><span style="color: #9A1900">/* Examine first few bytes from an APP14.</span></span>
<a name="line663">0663: </a><span style="font-style: italic"><span style="color: #9A1900"> * Take appropriate action if it is an Adobe marker.</span></span>
<a name="line664">0664: </a><span style="font-style: italic"><span style="color: #9A1900"> * datalen is # of bytes at data[], remaining is length of rest of marker data.</span></span>
<a name="line665">0665: </a><span style="font-style: italic"><span style="color: #9A1900"> */</span></span>
<a name="line666">0666: </a><span style="color: #FF0000">{</span>
<a name="line667">0667: </a>  <span style="color: #009900">unsigned</span> <span style="color: #009900">int</span> version<span style="color: #990000">,</span> flags0<span style="color: #990000">,</span> flags1<span style="color: #990000">,</span> transform<span style="color: #990000">;</span>
<a name="line668">0668: </a>
<a name="line669">0669: </a>  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>datalen <span style="color: #990000">&gt;</span><span style="color: #990000">=</span> APP14_DATA_LEN <span style="color: #990000">&amp;</span><span style="color: #990000">&amp;</span>
<a name="line670">0670: </a>      <span style="font-weight: bold"><span style="color: #000000">GETJOCTET</span></span><span style="color: #990000">(</span>data<span style="color: #990000">[</span><span style="color: #993399">0</span><span style="color: #990000">]</span><span style="color: #990000">)</span> <span style="color: #990000">=</span><span style="color: #990000">=</span> <span style="color: #993399">0x41</span> <span style="color: #990000">&amp;</span><span style="color: #990000">&amp;</span>
<a name="line671">0671: </a>      <span style="font-weight: bold"><span style="color: #000000">GETJOCTET</span></span><span style="color: #990000">(</span>data<span style="color: #990000">[</span><span style="color: #993399">1</span><span style="color: #990000">]</span><span style="color: #990000">)</span> <span style="color: #990000">=</span><span style="color: #990000">=</span> <span style="color: #993399">0x64</span> <span style="color: #990000">&amp;</span><span style="color: #990000">&amp;</span>
<a name="line672">0672: </a>      <span style="font-weight: bold"><span style="color: #000000">GETJOCTET</span></span><span style="color: #990000">(</span>data<span style="color: #990000">[</span><span style="color: #993399">2</span><span style="color: #990000">]</span><span style="color: #990000">)</span> <span style="color: #990000">=</span><span style="color: #990000">=</span> <span style="color: #993399">0x6F</span> <span style="color: #990000">&amp;</span><span style="color: #990000">&amp;</span>
<a name="line673">0673: </a>      <span style="font-weight: bold"><span style="color: #000000">GETJOCTET</span></span><span style="color: #990000">(</span>data<span style="color: #990000">[</span><span style="color: #993399">3</span><span style="color: #990000">]</span><span style="color: #990000">)</span> <span style="color: #990000">=</span><span style="color: #990000">=</span> <span style="color: #993399">0x62</span> <span style="color: #990000">&amp;</span><span style="color: #990000">&amp;</span>
<a name="line674">0674: </a>      <span style="font-weight: bold"><span style="color: #000000">GETJOCTET</span></span><span style="color: #990000">(</span>data<span style="color: #990000">[</span><span style="color: #993399">4</span><span style="color: #990000">]</span><span style="color: #990000">)</span> <span style="color: #990000">=</span><span style="color: #990000">=</span> <span style="color: #993399">0x65</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line675">0675: </a>    <span style="font-style: italic"><span style="color: #9A1900">/* Found Adobe APP14 marker */</span></span>
<a name="line676">0676: </a>    version <span style="color: #990000">=</span> <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #000000">GETJOCTET</span></span><span style="color: #990000">(</span>data<span style="color: #990000">[</span><span style="color: #993399">5</span><span style="color: #990000">]</span><span style="color: #990000">)</span> <span style="color: #990000">&lt;</span><span style="color: #990000">&lt;</span> <span style="color: #993399">8</span><span style="color: #990000">)</span> <span style="color: #990000">+</span> <span style="font-weight: bold"><span style="color: #000000">GETJOCTET</span></span><span style="color: #990000">(</span>data<span style="color: #990000">[</span><span style="color: #993399">6</span><span style="color: #990000">]</span><span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line677">0677: </a>    flags0 <span style="color: #990000">=</span> <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #000000">GETJOCTET</span></span><span style="color: #990000">(</span>data<span style="color: #990000">[</span><span style="color: #993399">7</span><span style="color: #990000">]</span><span style="color: #990000">)</span> <span style="color: #990000">&lt;</span><span style="color: #990000">&lt;</span> <span style="color: #993399">8</span><span style="color: #990000">)</span> <span style="color: #990000">+</span> <span style="font-weight: bold"><span style="color: #000000">GETJOCTET</span></span><span style="color: #990000">(</span>data<span style="color: #990000">[</span><span style="color: #993399">8</span><span style="color: #990000">]</span><span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line678">0678: </a>    flags1 <span style="color: #990000">=</span> <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #000000">GETJOCTET</span></span><span style="color: #990000">(</span>data<span style="color: #990000">[</span><span style="color: #993399">9</span><span style="color: #990000">]</span><span style="color: #990000">)</span> <span style="color: #990000">&lt;</span><span style="color: #990000">&lt;</span> <span style="color: #993399">8</span><span style="color: #990000">)</span> <span style="color: #990000">+</span> <span style="font-weight: bold"><span style="color: #000000">GETJOCTET</span></span><span style="color: #990000">(</span>data<span style="color: #990000">[</span><span style="color: #993399">10</span><span style="color: #990000">]</span><span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line679">0679: </a>    transform <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">GETJOCTET</span></span><span style="color: #990000">(</span>data<span style="color: #990000">[</span><span style="color: #993399">11</span><span style="color: #990000">]</span><span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line680">0680: </a>    <span style="font-weight: bold"><span style="color: #000000">TRACEMS4</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> <span style="color: #993399">1</span><span style="color: #990000">,</span> JTRC_ADOBE<span style="color: #990000">,</span> version<span style="color: #990000">,</span> flags0<span style="color: #990000">,</span> flags1<span style="color: #990000">,</span> transform<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line681">0681: </a>    cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>saw_Adobe_marker <span style="color: #990000">=</span> TRUE<span style="color: #990000">;</span>
<a name="line682">0682: </a>    cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>Adobe_transform <span style="color: #990000">=</span> <span style="color: #990000">(</span>UINT8<span style="color: #990000">)</span> transform<span style="color: #990000">;</span>
<a name="line683">0683: </a>  <span style="color: #FF0000">}</span> <span style="font-weight: bold"><span style="color: #0000FF">else</span></span> <span style="color: #FF0000">{</span>
<a name="line684">0684: </a>    <span style="font-style: italic"><span style="color: #9A1900">/* Start of APP14 does not match "Adobe", or too short */</span></span>
<a name="line685">0685: </a>    <span style="font-weight: bold"><span style="color: #000000">TRACEMS1</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> <span style="color: #993399">1</span><span style="color: #990000">,</span> JTRC_APP14<span style="color: #990000">,</span> <span style="color: #990000">(</span><span style="color: #009900">int</span><span style="color: #990000">)</span> <span style="color: #990000">(</span>datalen <span style="color: #990000">+</span> remaining<span style="color: #990000">)</span><span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line686">0686: </a>  <span style="color: #FF0000">}</span>
<a name="line687">0687: </a><span style="color: #FF0000">}</span>
<a name="line688">0688: </a>
<a name="line689">0689: </a>
<a name="line690">0690: </a><span style="font-weight: bold"><span style="color: #000000">METHODDEF</span></span><span style="color: #990000">(</span>boolean<span style="color: #990000">)</span>
<a name="line691">0691: </a><span style="font-weight: bold"><span style="color: #000000">get_interesting_appn</span></span> <span style="color: #990000">(</span>j_decompress_ptr cinfo<span style="color: #990000">)</span>
<a name="line692">0692: </a><span style="font-style: italic"><span style="color: #9A1900">/* Process an APP0 or APP14 marker without saving it */</span></span>
<a name="line693">0693: </a><span style="color: #FF0000">{</span>
<a name="line694">0694: </a>  INT32 length<span style="color: #990000">;</span>
<a name="line695">0695: </a>  JOCTET b<span style="color: #990000">[</span>APPN_DATA_LEN<span style="color: #990000">]</span><span style="color: #990000">;</span>
<a name="line696">0696: </a>  <span style="color: #009900">unsigned</span> <span style="color: #009900">int</span> i<span style="color: #990000">,</span> numtoread<span style="color: #990000">;</span>
<a name="line697">0697: </a>  <span style="font-weight: bold"><span style="color: #000000">INPUT_VARS</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line698">0698: </a>
<a name="line699">0699: </a>  <span style="font-weight: bold"><span style="color: #000000">INPUT_2BYTES</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> length<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> FALSE<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line700">0700: </a>  length <span style="color: #990000">-</span><span style="color: #990000">=</span> <span style="color: #993399">2</span><span style="color: #990000">;</span>
<a name="line701">0701: </a>
<a name="line702">0702: </a>  <span style="font-style: italic"><span style="color: #9A1900">/* get the interesting part of the marker data */</span></span>
<a name="line703">0703: </a>  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>length <span style="color: #990000">&gt;</span><span style="color: #990000">=</span> APPN_DATA_LEN<span style="color: #990000">)</span>
<a name="line704">0704: </a>    numtoread <span style="color: #990000">=</span> APPN_DATA_LEN<span style="color: #990000">;</span>
<a name="line705">0705: </a>  <span style="font-weight: bold"><span style="color: #0000FF">else</span></span> <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>length <span style="color: #990000">&gt;</span> <span style="color: #993399">0</span><span style="color: #990000">)</span>
<a name="line706">0706: </a>    numtoread <span style="color: #990000">=</span> <span style="color: #990000">(</span><span style="color: #009900">unsigned</span> <span style="color: #009900">int</span><span style="color: #990000">)</span> length<span style="color: #990000">;</span>
<a name="line707">0707: </a>  <span style="font-weight: bold"><span style="color: #0000FF">else</span></span>
<a name="line708">0708: </a>    numtoread <span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">;</span>
<a name="line709">0709: </a>  <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> <span style="color: #990000">(</span>i <span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">;</span> i <span style="color: #990000">&lt;</span> numtoread<span style="color: #990000">;</span> i<span style="color: #990000">+</span><span style="color: #990000">+</span><span style="color: #990000">)</span>
<a name="line710">0710: </a>    <span style="font-weight: bold"><span style="color: #000000">INPUT_BYTE</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> b<span style="color: #990000">[</span>i<span style="color: #990000">]</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> FALSE<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line711">0711: </a>  length <span style="color: #990000">-</span><span style="color: #990000">=</span> numtoread<span style="color: #990000">;</span>
<a name="line712">0712: </a>
<a name="line713">0713: </a>  <span style="font-style: italic"><span style="color: #9A1900">/* process it */</span></span>
<a name="line714">0714: </a>  <span style="font-weight: bold"><span style="color: #0000FF">switch</span></span> <span style="color: #990000">(</span>cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>unread_marker<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line715">0715: </a>  <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> M_APP0<span style="color: #990000">:</span>
<a name="line716">0716: </a>    <span style="font-weight: bold"><span style="color: #000000">examine_app0</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> <span style="color: #990000">(</span>JOCTET FAR <span style="color: #990000">*</span><span style="color: #990000">)</span> b<span style="color: #990000">,</span> numtoread<span style="color: #990000">,</span> length<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line717">0717: </a>    <span style="font-weight: bold"><span style="color: #0000FF">break</span></span><span style="color: #990000">;</span>
<a name="line718">0718: </a>  <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> M_APP14<span style="color: #990000">:</span>
<a name="line719">0719: </a>    <span style="font-weight: bold"><span style="color: #000000">examine_app14</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> <span style="color: #990000">(</span>JOCTET FAR <span style="color: #990000">*</span><span style="color: #990000">)</span> b<span style="color: #990000">,</span> numtoread<span style="color: #990000">,</span> length<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line720">0720: </a>    <span style="font-weight: bold"><span style="color: #0000FF">break</span></span><span style="color: #990000">;</span>
<a name="line721">0721: </a>  <span style="font-weight: bold"><span style="color: #0000FF">default</span></span><span style="color: #990000">:</span>
<a name="line722">0722: </a>    <span style="font-style: italic"><span style="color: #9A1900">/* can't get here unless jpeg_save_markers chooses wrong processor */</span></span>
<a name="line723">0723: </a>    <span style="font-weight: bold"><span style="color: #000000">ERREXIT1</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> JERR_UNKNOWN_MARKER<span style="color: #990000">,</span> cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>unread_marker<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line724">0724: </a>    <span style="font-weight: bold"><span style="color: #0000FF">break</span></span><span style="color: #990000">;</span>
<a name="line725">0725: </a>  <span style="color: #FF0000">}</span>
<a name="line726">0726: </a>
<a name="line727">0727: </a>  <span style="font-style: italic"><span style="color: #9A1900">/* skip any remaining data -- could be lots */</span></span>
<a name="line728">0728: </a>  <span style="font-weight: bold"><span style="color: #000000">INPUT_SYNC</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line729">0729: </a>  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>length <span style="color: #990000">&gt;</span> <span style="color: #993399">0</span><span style="color: #990000">)</span>
<a name="line730">0730: </a>    <span style="color: #990000">(</span><span style="color: #990000">*</span>cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>src<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>skip_input_data<span style="color: #990000">)</span> <span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> <span style="color: #990000">(</span><span style="color: #009900">long</span><span style="color: #990000">)</span> length<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line731">0731: </a>
<a name="line732">0732: </a>  <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> TRUE<span style="color: #990000">;</span>
<a name="line733">0733: </a><span style="color: #FF0000">}</span>
<a name="line734">0734: </a>
<a name="line735">0735: </a>
<a name="line736">0736: </a><span style="font-weight: bold"><span style="color: #000080">#ifdef</span></span> SAVE_MARKERS_SUPPORTED
<a name="line737">0737: </a>
<a name="line738">0738: </a><span style="font-weight: bold"><span style="color: #000000">METHODDEF</span></span><span style="color: #990000">(</span>boolean<span style="color: #990000">)</span>
<a name="line739">0739: </a><span style="font-weight: bold"><span style="color: #000000">save_marker</span></span> <span style="color: #990000">(</span>j_decompress_ptr cinfo<span style="color: #990000">)</span>
<a name="line740">0740: </a><span style="font-style: italic"><span style="color: #9A1900">/* Save an APPn or COM marker into the marker list */</span></span>
<a name="line741">0741: </a><span style="color: #FF0000">{</span>
<a name="line742">0742: </a>  my_marker_ptr marker <span style="color: #990000">=</span> <span style="color: #990000">(</span>my_marker_ptr<span style="color: #990000">)</span> cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>marker<span style="color: #990000">;</span>
<a name="line743">0743: </a>  jpeg_saved_marker_ptr cur_marker <span style="color: #990000">=</span> marker<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>cur_marker<span style="color: #990000">;</span>
<a name="line744">0744: </a>  <span style="color: #009900">unsigned</span> <span style="color: #009900">int</span> bytes_read<span style="color: #990000">,</span> data_length<span style="color: #990000">;</span>
<a name="line745">0745: </a>  JOCTET FAR <span style="color: #990000">*</span> data<span style="color: #990000">;</span>
<a name="line746">0746: </a>  INT32 length <span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">;</span>
<a name="line747">0747: </a>  <span style="font-weight: bold"><span style="color: #000000">INPUT_VARS</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line748">0748: </a>
<a name="line749">0749: </a>  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>cur_marker <span style="color: #990000">=</span><span style="color: #990000">=</span> NULL<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line750">0750: </a>    <span style="font-style: italic"><span style="color: #9A1900">/* begin reading a marker */</span></span>
<a name="line751">0751: </a>    <span style="font-weight: bold"><span style="color: #000000">INPUT_2BYTES</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> length<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> FALSE<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line752">0752: </a>    length <span style="color: #990000">-</span><span style="color: #990000">=</span> <span style="color: #993399">2</span><span style="color: #990000">;</span>
<a name="line753">0753: </a>    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>length <span style="color: #990000">&gt;</span><span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>          <span style="font-style: italic"><span style="color: #9A1900">/* watch out for bogus length word */</span></span>
<a name="line754">0754: </a>      <span style="font-style: italic"><span style="color: #9A1900">/* figure out how much we want to save */</span></span>
<a name="line755">0755: </a>      <span style="color: #009900">unsigned</span> <span style="color: #009900">int</span> limit<span style="color: #990000">;</span>
<a name="line756">0756: </a>      <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>unread_marker <span style="color: #990000">=</span><span style="color: #990000">=</span> <span style="color: #990000">(</span><span style="color: #009900">int</span><span style="color: #990000">)</span> M_COM<span style="color: #990000">)</span>
<a name="line757">0757: </a>        limit <span style="color: #990000">=</span> marker<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>length_limit_COM<span style="color: #990000">;</span>
<a name="line758">0758: </a>      <span style="font-weight: bold"><span style="color: #0000FF">else</span></span>
<a name="line759">0759: </a>        limit <span style="color: #990000">=</span> marker<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>length_limit_APPn<span style="color: #990000">[</span>cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>unread_marker <span style="color: #990000">-</span> <span style="color: #990000">(</span><span style="color: #009900">int</span><span style="color: #990000">)</span> M_APP0<span style="color: #990000">]</span><span style="color: #990000">;</span>
<a name="line760">0760: </a>      <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span><span style="color: #990000">(</span><span style="color: #009900">unsigned</span> <span style="color: #009900">int</span><span style="color: #990000">)</span> length <span style="color: #990000">&lt;</span> limit<span style="color: #990000">)</span>
<a name="line761">0761: </a>        limit <span style="color: #990000">=</span> <span style="color: #990000">(</span><span style="color: #009900">unsigned</span> <span style="color: #009900">int</span><span style="color: #990000">)</span> length<span style="color: #990000">;</span>
<a name="line762">0762: </a>      <span style="font-style: italic"><span style="color: #9A1900">/* allocate and initialize the marker item */</span></span>
<a name="line763">0763: </a>      cur_marker <span style="color: #990000">=</span> <span style="color: #990000">(</span>jpeg_saved_marker_ptr<span style="color: #990000">)</span>
<a name="line764">0764: </a>        <span style="color: #990000">(</span><span style="color: #990000">*</span>cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>mem<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>alloc_large<span style="color: #990000">)</span> <span style="color: #990000">(</span><span style="color: #990000">(</span>j_common_ptr<span style="color: #990000">)</span> cinfo<span style="color: #990000">,</span> JPOOL_IMAGE<span style="color: #990000">,</span>
<a name="line765">0765: </a>                                    <span style="font-weight: bold"><span style="color: #000000">SIZEOF</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">struct</span></span> jpeg_marker_struct<span style="color: #990000">)</span> <span style="color: #990000">+</span> limit<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line766">0766: </a>      cur_marker<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>next <span style="color: #990000">=</span> NULL<span style="color: #990000">;</span>
<a name="line767">0767: </a>      cur_marker<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>marker <span style="color: #990000">=</span> <span style="color: #990000">(</span>UINT8<span style="color: #990000">)</span> cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>unread_marker<span style="color: #990000">;</span>
<a name="line768">0768: </a>      cur_marker<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>original_length <span style="color: #990000">=</span> <span style="color: #990000">(</span><span style="color: #009900">unsigned</span> <span style="color: #009900">int</span><span style="color: #990000">)</span> length<span style="color: #990000">;</span>
<a name="line769">0769: </a>      cur_marker<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>data_length <span style="color: #990000">=</span> limit<span style="color: #990000">;</span>
<a name="line770">0770: </a>      <span style="font-style: italic"><span style="color: #9A1900">/* data area is just beyond the jpeg_marker_struct */</span></span>
<a name="line771">0771: </a>      data <span style="color: #990000">=</span> cur_marker<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>data <span style="color: #990000">=</span> <span style="color: #990000">(</span>JOCTET FAR <span style="color: #990000">*</span><span style="color: #990000">)</span> <span style="color: #990000">(</span>cur_marker <span style="color: #990000">+</span> <span style="color: #993399">1</span><span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line772">0772: </a>      marker<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>cur_marker <span style="color: #990000">=</span> cur_marker<span style="color: #990000">;</span>
<a name="line773">0773: </a>      marker<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>bytes_read <span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">;</span>
<a name="line774">0774: </a>      bytes_read <span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">;</span>
<a name="line775">0775: </a>      data_length <span style="color: #990000">=</span> limit<span style="color: #990000">;</span>
<a name="line776">0776: </a>    <span style="color: #FF0000">}</span> <span style="font-weight: bold"><span style="color: #0000FF">else</span></span> <span style="color: #FF0000">{</span>
<a name="line777">0777: </a>      <span style="font-style: italic"><span style="color: #9A1900">/* deal with bogus length word */</span></span>
<a name="line778">0778: </a>      bytes_read <span style="color: #990000">=</span> data_length <span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">;</span>
<a name="line779">0779: </a>      data <span style="color: #990000">=</span> NULL<span style="color: #990000">;</span>
<a name="line780">0780: </a>    <span style="color: #FF0000">}</span>
<a name="line781">0781: </a>  <span style="color: #FF0000">}</span> <span style="font-weight: bold"><span style="color: #0000FF">else</span></span> <span style="color: #FF0000">{</span>
<a name="line782">0782: </a>    <span style="font-style: italic"><span style="color: #9A1900">/* resume reading a marker */</span></span>
<a name="line783">0783: </a>    bytes_read <span style="color: #990000">=</span> marker<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>bytes_read<span style="color: #990000">;</span>
<a name="line784">0784: </a>    data_length <span style="color: #990000">=</span> cur_marker<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>data_length<span style="color: #990000">;</span>
<a name="line785">0785: </a>    data <span style="color: #990000">=</span> cur_marker<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>data <span style="color: #990000">+</span> bytes_read<span style="color: #990000">;</span>
<a name="line786">0786: </a>  <span style="color: #FF0000">}</span>
<a name="line787">0787: </a>
<a name="line788">0788: </a>  <span style="font-weight: bold"><span style="color: #0000FF">while</span></span> <span style="color: #990000">(</span>bytes_read <span style="color: #990000">&lt;</span> data_length<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line789">0789: </a>    <span style="font-weight: bold"><span style="color: #000000">INPUT_SYNC</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">)</span><span style="color: #990000">;</span>          <span style="font-style: italic"><span style="color: #9A1900">/* move the restart point to here */</span></span>
<a name="line790">0790: </a>    marker<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>bytes_read <span style="color: #990000">=</span> bytes_read<span style="color: #990000">;</span>
<a name="line791">0791: </a>    <span style="font-style: italic"><span style="color: #9A1900">/* If there's not at least one byte in buffer, suspend */</span></span>
<a name="line792">0792: </a>    <span style="font-weight: bold"><span style="color: #000000">MAKE_BYTE_AVAIL</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> FALSE<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line793">0793: </a>    <span style="font-style: italic"><span style="color: #9A1900">/* Copy bytes with reasonable rapidity */</span></span>
<a name="line794">0794: </a>    <span style="font-weight: bold"><span style="color: #0000FF">while</span></span> <span style="color: #990000">(</span>bytes_read <span style="color: #990000">&lt;</span> data_length <span style="color: #990000">&amp;</span><span style="color: #990000">&amp;</span> bytes_in_buffer <span style="color: #990000">&gt;</span> <span style="color: #993399">0</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line795">0795: </a>      <span style="color: #990000">*</span>data<span style="color: #990000">+</span><span style="color: #990000">+</span> <span style="color: #990000">=</span> <span style="color: #990000">*</span>next_input_byte<span style="color: #990000">+</span><span style="color: #990000">+</span><span style="color: #990000">;</span>
<a name="line796">0796: </a>      bytes_in_buffer<span style="color: #990000">-</span><span style="color: #990000">-</span><span style="color: #990000">;</span>
<a name="line797">0797: </a>      bytes_read<span style="color: #990000">+</span><span style="color: #990000">+</span><span style="color: #990000">;</span>
<a name="line798">0798: </a>    <span style="color: #FF0000">}</span>
<a name="line799">0799: </a>  <span style="color: #FF0000">}</span>
<a name="line800">0800: </a>
<a name="line801">0801: </a>  <span style="font-style: italic"><span style="color: #9A1900">/* Done reading what we want to read */</span></span>
<a name="line802">0802: </a>  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>cur_marker <span style="color: #990000">!</span><span style="color: #990000">=</span> NULL<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>     <span style="font-style: italic"><span style="color: #9A1900">/* will be NULL if bogus length word */</span></span>
<a name="line803">0803: </a>    <span style="font-style: italic"><span style="color: #9A1900">/* Add new marker to end of list */</span></span>
<a name="line804">0804: </a>    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>marker_list <span style="color: #990000">=</span><span style="color: #990000">=</span> NULL<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line805">0805: </a>      cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>marker_list <span style="color: #990000">=</span> cur_marker<span style="color: #990000">;</span>
<a name="line806">0806: </a>    <span style="color: #FF0000">}</span> <span style="font-weight: bold"><span style="color: #0000FF">else</span></span> <span style="color: #FF0000">{</span>
<a name="line807">0807: </a>      jpeg_saved_marker_ptr prev <span style="color: #990000">=</span> cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>marker_list<span style="color: #990000">;</span>
<a name="line808">0808: </a>      <span style="font-weight: bold"><span style="color: #0000FF">while</span></span> <span style="color: #990000">(</span>prev<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>next <span style="color: #990000">!</span><span style="color: #990000">=</span> NULL<span style="color: #990000">)</span>
<a name="line809">0809: </a>        prev <span style="color: #990000">=</span> prev<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>next<span style="color: #990000">;</span>
<a name="line810">0810: </a>      prev<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>next <span style="color: #990000">=</span> cur_marker<span style="color: #990000">;</span>
<a name="line811">0811: </a>    <span style="color: #FF0000">}</span>
<a name="line812">0812: </a>    <span style="font-style: italic"><span style="color: #9A1900">/* Reset pointer &amp; calc remaining data length */</span></span>
<a name="line813">0813: </a>    data <span style="color: #990000">=</span> cur_marker<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>data<span style="color: #990000">;</span>
<a name="line814">0814: </a>    length <span style="color: #990000">=</span> cur_marker<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>original_length <span style="color: #990000">-</span> data_length<span style="color: #990000">;</span>
<a name="line815">0815: </a>  <span style="color: #FF0000">}</span>
<a name="line816">0816: </a>  <span style="font-style: italic"><span style="color: #9A1900">/* Reset to initial state for next marker */</span></span>
<a name="line817">0817: </a>  marker<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>cur_marker <span style="color: #990000">=</span> NULL<span style="color: #990000">;</span>
<a name="line818">0818: </a>
<a name="line819">0819: </a>  <span style="font-style: italic"><span style="color: #9A1900">/* Process the marker if interesting; else just make a generic trace msg */</span></span>
<a name="line820">0820: </a>  <span style="font-weight: bold"><span style="color: #0000FF">switch</span></span> <span style="color: #990000">(</span>cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>unread_marker<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line821">0821: </a>  <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> M_APP0<span style="color: #990000">:</span>
<a name="line822">0822: </a>    <span style="font-weight: bold"><span style="color: #000000">examine_app0</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> data<span style="color: #990000">,</span> data_length<span style="color: #990000">,</span> length<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line823">0823: </a>    <span style="font-weight: bold"><span style="color: #0000FF">break</span></span><span style="color: #990000">;</span>
<a name="line824">0824: </a>  <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> M_APP14<span style="color: #990000">:</span>
<a name="line825">0825: </a>    <span style="font-weight: bold"><span style="color: #000000">examine_app14</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> data<span style="color: #990000">,</span> data_length<span style="color: #990000">,</span> length<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line826">0826: </a>    <span style="font-weight: bold"><span style="color: #0000FF">break</span></span><span style="color: #990000">;</span>
<a name="line827">0827: </a>  <span style="font-weight: bold"><span style="color: #0000FF">default</span></span><span style="color: #990000">:</span>
<a name="line828">0828: </a>    <span style="font-weight: bold"><span style="color: #000000">TRACEMS2</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> <span style="color: #993399">1</span><span style="color: #990000">,</span> JTRC_MISC_MARKER<span style="color: #990000">,</span> cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>unread_marker<span style="color: #990000">,</span>
<a name="line829">0829: </a>             <span style="color: #990000">(</span><span style="color: #009900">int</span><span style="color: #990000">)</span> <span style="color: #990000">(</span>data_length <span style="color: #990000">+</span> length<span style="color: #990000">)</span><span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line830">0830: </a>    <span style="font-weight: bold"><span style="color: #0000FF">break</span></span><span style="color: #990000">;</span>
<a name="line831">0831: </a>  <span style="color: #FF0000">}</span>
<a name="line832">0832: </a>
<a name="line833">0833: </a>  <span style="font-style: italic"><span style="color: #9A1900">/* skip any remaining data -- could be lots */</span></span>
<a name="line834">0834: </a>  <span style="font-weight: bold"><span style="color: #000000">INPUT_SYNC</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">)</span><span style="color: #990000">;</span>            <span style="font-style: italic"><span style="color: #9A1900">/* do before skip_input_data */</span></span>
<a name="line835">0835: </a>  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>length <span style="color: #990000">&gt;</span> <span style="color: #993399">0</span><span style="color: #990000">)</span>
<a name="line836">0836: </a>    <span style="color: #990000">(</span><span style="color: #990000">*</span>cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>src<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>skip_input_data<span style="color: #990000">)</span> <span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> <span style="color: #990000">(</span><span style="color: #009900">long</span><span style="color: #990000">)</span> length<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line837">0837: </a>
<a name="line838">0838: </a>  <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> TRUE<span style="color: #990000">;</span>
<a name="line839">0839: </a><span style="color: #FF0000">}</span>
<a name="line840">0840: </a>
<a name="line841">0841: </a><span style="font-weight: bold"><span style="color: #000080">#endif</span></span> <span style="font-style: italic"><span style="color: #9A1900">/* SAVE_MARKERS_SUPPORTED */</span></span>
<a name="line842">0842: </a>
<a name="line843">0843: </a>
<a name="line844">0844: </a><span style="font-weight: bold"><span style="color: #000000">METHODDEF</span></span><span style="color: #990000">(</span>boolean<span style="color: #990000">)</span>
<a name="line845">0845: </a><span style="font-weight: bold"><span style="color: #000000">skip_variable</span></span> <span style="color: #990000">(</span>j_decompress_ptr cinfo<span style="color: #990000">)</span>
<a name="line846">0846: </a><span style="font-style: italic"><span style="color: #9A1900">/* Skip over an unknown or uninteresting variable-length marker */</span></span>
<a name="line847">0847: </a><span style="color: #FF0000">{</span>
<a name="line848">0848: </a>  INT32 length<span style="color: #990000">;</span>
<a name="line849">0849: </a>  <span style="font-weight: bold"><span style="color: #000000">INPUT_VARS</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line850">0850: </a>
<a name="line851">0851: </a>  <span style="font-weight: bold"><span style="color: #000000">INPUT_2BYTES</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> length<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> FALSE<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line852">0852: </a>  length <span style="color: #990000">-</span><span style="color: #990000">=</span> <span style="color: #993399">2</span><span style="color: #990000">;</span>
<a name="line853">0853: </a>  
<a name="line854">0854: </a>  <span style="font-weight: bold"><span style="color: #000000">TRACEMS2</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> <span style="color: #993399">1</span><span style="color: #990000">,</span> JTRC_MISC_MARKER<span style="color: #990000">,</span> cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>unread_marker<span style="color: #990000">,</span> <span style="color: #990000">(</span><span style="color: #009900">int</span><span style="color: #990000">)</span> length<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line855">0855: </a>
<a name="line856">0856: </a>  <span style="font-weight: bold"><span style="color: #000000">INPUT_SYNC</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">)</span><span style="color: #990000">;</span>            <span style="font-style: italic"><span style="color: #9A1900">/* do before skip_input_data */</span></span>
<a name="line857">0857: </a>  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>length <span style="color: #990000">&gt;</span> <span style="color: #993399">0</span><span style="color: #990000">)</span>
<a name="line858">0858: </a>    <span style="color: #990000">(</span><span style="color: #990000">*</span>cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>src<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>skip_input_data<span style="color: #990000">)</span> <span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> <span style="color: #990000">(</span><span style="color: #009900">long</span><span style="color: #990000">)</span> length<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line859">0859: </a>
<a name="line860">0860: </a>  <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> TRUE<span style="color: #990000">;</span>
<a name="line861">0861: </a><span style="color: #FF0000">}</span>
<a name="line862">0862: </a>
<a name="line863">0863: </a>
<a name="line864">0864: </a><span style="font-style: italic"><span style="color: #9A1900">/*</span></span>
<a name="line865">0865: </a><span style="font-style: italic"><span style="color: #9A1900"> * Find the next JPEG marker, save it in cinfo-&gt;unread_marker.</span></span>
<a name="line866">0866: </a><span style="font-style: italic"><span style="color: #9A1900"> * Returns FALSE if had to suspend before reaching a marker;</span></span>
<a name="line867">0867: </a><span style="font-style: italic"><span style="color: #9A1900"> * in that case cinfo-&gt;unread_marker is unchanged.</span></span>
<a name="line868">0868: </a><span style="font-style: italic"><span style="color: #9A1900"> *</span></span>
<a name="line869">0869: </a><span style="font-style: italic"><span style="color: #9A1900"> * Note that the result might not be a valid marker code,</span></span>
<a name="line870">0870: </a><span style="font-style: italic"><span style="color: #9A1900"> * but it will never be 0 or FF.</span></span>
<a name="line871">0871: </a><span style="font-style: italic"><span style="color: #9A1900"> */</span></span>
<a name="line872">0872: </a>
<a name="line873">0873: </a><span style="font-weight: bold"><span style="color: #000000">LOCAL</span></span><span style="color: #990000">(</span>boolean<span style="color: #990000">)</span>
<a name="line874">0874: </a><span style="font-weight: bold"><span style="color: #000000">next_marker</span></span> <span style="color: #990000">(</span>j_decompress_ptr cinfo<span style="color: #990000">)</span>
<a name="line875">0875: </a><span style="color: #FF0000">{</span>
<a name="line876">0876: </a>  <span style="color: #009900">int</span> c<span style="color: #990000">;</span>
<a name="line877">0877: </a>  <span style="font-weight: bold"><span style="color: #000000">INPUT_VARS</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line878">0878: </a>
<a name="line879">0879: </a>  <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> <span style="color: #990000">(</span><span style="color: #990000">;</span><span style="color: #990000">;</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line880">0880: </a>    <span style="font-weight: bold"><span style="color: #000000">INPUT_BYTE</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> c<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> FALSE<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line881">0881: </a>    <span style="font-style: italic"><span style="color: #9A1900">/* Skip any non-FF bytes.</span></span>
<a name="line882">0882: </a><span style="font-style: italic"><span style="color: #9A1900">     * This may look a bit inefficient, but it will not occur in a valid file.</span></span>
<a name="line883">0883: </a><span style="font-style: italic"><span style="color: #9A1900">     * We sync after each discarded byte so that a suspending data source</span></span>
<a name="line884">0884: </a><span style="font-style: italic"><span style="color: #9A1900">     * can discard the byte from its buffer.</span></span>
<a name="line885">0885: </a><span style="font-style: italic"><span style="color: #9A1900">     */</span></span>
<a name="line886">0886: </a>    <span style="font-weight: bold"><span style="color: #0000FF">while</span></span> <span style="color: #990000">(</span>c <span style="color: #990000">!</span><span style="color: #990000">=</span> <span style="color: #993399">0xFF</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line887">0887: </a>      cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>marker<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>discarded_bytes<span style="color: #990000">+</span><span style="color: #990000">+</span><span style="color: #990000">;</span>
<a name="line888">0888: </a>      <span style="font-weight: bold"><span style="color: #000000">INPUT_SYNC</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line889">0889: </a>      <span style="font-weight: bold"><span style="color: #000000">INPUT_BYTE</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> c<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> FALSE<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line890">0890: </a>    <span style="color: #FF0000">}</span>
<a name="line891">0891: </a>    <span style="font-style: italic"><span style="color: #9A1900">/* This loop swallows any duplicate FF bytes.  Extra FFs are legal as</span></span>
<a name="line892">0892: </a><span style="font-style: italic"><span style="color: #9A1900">     * pad bytes, so don't count them in discarded_bytes.  We assume there</span></span>
<a name="line893">0893: </a><span style="font-style: italic"><span style="color: #9A1900">     * will not be so many consecutive FF bytes as to overflow a suspending</span></span>
<a name="line894">0894: </a><span style="font-style: italic"><span style="color: #9A1900">     * data source's input buffer.</span></span>
<a name="line895">0895: </a><span style="font-style: italic"><span style="color: #9A1900">     */</span></span>
<a name="line896">0896: </a>    <span style="font-weight: bold"><span style="color: #0000FF">do</span></span> <span style="color: #FF0000">{</span>
<a name="line897">0897: </a>      <span style="font-weight: bold"><span style="color: #000000">INPUT_BYTE</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> c<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> FALSE<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line898">0898: </a>    <span style="color: #FF0000">}</span> <span style="font-weight: bold"><span style="color: #0000FF">while</span></span> <span style="color: #990000">(</span>c <span style="color: #990000">=</span><span style="color: #990000">=</span> <span style="color: #993399">0xFF</span><span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line899">0899: </a>    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>c <span style="color: #990000">!</span><span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">)</span>
<a name="line900">0900: </a>      <span style="font-weight: bold"><span style="color: #0000FF">break</span></span><span style="color: #990000">;</span>                    <span style="font-style: italic"><span style="color: #9A1900">/* found a valid marker, exit loop */</span></span>
<a name="line901">0901: </a>    <span style="font-style: italic"><span style="color: #9A1900">/* Reach here if we found a stuffed-zero data sequence (FF/00).</span></span>
<a name="line902">0902: </a><span style="font-style: italic"><span style="color: #9A1900">     * Discard it and loop back to try again.</span></span>
<a name="line903">0903: </a><span style="font-style: italic"><span style="color: #9A1900">     */</span></span>
<a name="line904">0904: </a>    cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>marker<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>discarded_bytes <span style="color: #990000">+</span><span style="color: #990000">=</span> <span style="color: #993399">2</span><span style="color: #990000">;</span>
<a name="line905">0905: </a>    <span style="font-weight: bold"><span style="color: #000000">INPUT_SYNC</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line906">0906: </a>  <span style="color: #FF0000">}</span>
<a name="line907">0907: </a>
<a name="line908">0908: </a>  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>marker<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>discarded_bytes <span style="color: #990000">!</span><span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line909">0909: </a>    <span style="font-weight: bold"><span style="color: #000000">WARNMS2</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> JWRN_EXTRANEOUS_DATA<span style="color: #990000">,</span> cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>marker<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>discarded_bytes<span style="color: #990000">,</span> c<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line910">0910: </a>    cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>marker<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>discarded_bytes <span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">;</span>
<a name="line911">0911: </a>  <span style="color: #FF0000">}</span>
<a name="line912">0912: </a>
<a name="line913">0913: </a>  cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>unread_marker <span style="color: #990000">=</span> c<span style="color: #990000">;</span>
<a name="line914">0914: </a>
<a name="line915">0915: </a>  <span style="font-weight: bold"><span style="color: #000000">INPUT_SYNC</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line916">0916: </a>  <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> TRUE<span style="color: #990000">;</span>
<a name="line917">0917: </a><span style="color: #FF0000">}</span>
<a name="line918">0918: </a>
<a name="line919">0919: </a>
<a name="line920">0920: </a><span style="font-weight: bold"><span style="color: #000000">LOCAL</span></span><span style="color: #990000">(</span>boolean<span style="color: #990000">)</span>
<a name="line921">0921: </a><span style="font-weight: bold"><span style="color: #000000">first_marker</span></span> <span style="color: #990000">(</span>j_decompress_ptr cinfo<span style="color: #990000">)</span>
<a name="line922">0922: </a><span style="font-style: italic"><span style="color: #9A1900">/* Like next_marker, but used to obtain the initial SOI marker. */</span></span>
<a name="line923">0923: </a><span style="font-style: italic"><span style="color: #9A1900">/* For this marker, we do not allow preceding garbage or fill; otherwise,</span></span>
<a name="line924">0924: </a><span style="font-style: italic"><span style="color: #9A1900"> * we might well scan an entire input file before realizing it ain't JPEG.</span></span>
<a name="line925">0925: </a><span style="font-style: italic"><span style="color: #9A1900"> * If an application wants to process non-JFIF files, it must seek to the</span></span>
<a name="line926">0926: </a><span style="font-style: italic"><span style="color: #9A1900"> * SOI before calling the JPEG library.</span></span>
<a name="line927">0927: </a><span style="font-style: italic"><span style="color: #9A1900"> */</span></span>
<a name="line928">0928: </a><span style="color: #FF0000">{</span>
<a name="line929">0929: </a>  <span style="color: #009900">int</span> c<span style="color: #990000">,</span> c2<span style="color: #990000">;</span>
<a name="line930">0930: </a>  <span style="font-weight: bold"><span style="color: #000000">INPUT_VARS</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line931">0931: </a>
<a name="line932">0932: </a>  <span style="font-weight: bold"><span style="color: #000000">INPUT_BYTE</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> c<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> FALSE<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line933">0933: </a>  <span style="font-weight: bold"><span style="color: #000000">INPUT_BYTE</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> c2<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> FALSE<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line934">0934: </a>  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>c <span style="color: #990000">!</span><span style="color: #990000">=</span> <span style="color: #993399">0xFF</span> <span style="color: #990000">|</span><span style="color: #990000">|</span> c2 <span style="color: #990000">!</span><span style="color: #990000">=</span> <span style="color: #990000">(</span><span style="color: #009900">int</span><span style="color: #990000">)</span> M_SOI<span style="color: #990000">)</span>
<a name="line935">0935: </a>    <span style="font-weight: bold"><span style="color: #000000">ERREXIT2</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> JERR_NO_SOI<span style="color: #990000">,</span> c<span style="color: #990000">,</span> c2<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line936">0936: </a>
<a name="line937">0937: </a>  cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>unread_marker <span style="color: #990000">=</span> c2<span style="color: #990000">;</span>
<a name="line938">0938: </a>
<a name="line939">0939: </a>  <span style="font-weight: bold"><span style="color: #000000">INPUT_SYNC</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line940">0940: </a>  <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> TRUE<span style="color: #990000">;</span>
<a name="line941">0941: </a><span style="color: #FF0000">}</span>
<a name="line942">0942: </a>
<a name="line943">0943: </a>
<a name="line944">0944: </a><span style="font-style: italic"><span style="color: #9A1900">/*</span></span>
<a name="line945">0945: </a><span style="font-style: italic"><span style="color: #9A1900"> * Read markers until SOS or EOI.</span></span>
<a name="line946">0946: </a><span style="font-style: italic"><span style="color: #9A1900"> *</span></span>
<a name="line947">0947: </a><span style="font-style: italic"><span style="color: #9A1900"> * Returns same codes as are defined for jpeg_consume_input:</span></span>
<a name="line948">0948: </a><span style="font-style: italic"><span style="color: #9A1900"> * JPEG_SUSPENDED, JPEG_REACHED_SOS, or JPEG_REACHED_EOI.</span></span>
<a name="line949">0949: </a><span style="font-style: italic"><span style="color: #9A1900"> */</span></span>
<a name="line950">0950: </a>
<a name="line951">0951: </a><span style="font-weight: bold"><span style="color: #000000">METHODDEF</span></span><span style="color: #990000">(</span><span style="color: #009900">int</span><span style="color: #990000">)</span>
<a name="line952">0952: </a><span style="font-weight: bold"><span style="color: #000000">read_markers</span></span> <span style="color: #990000">(</span>j_decompress_ptr cinfo<span style="color: #990000">)</span>
<a name="line953">0953: </a><span style="color: #FF0000">{</span>
<a name="line954">0954: </a>  <span style="font-style: italic"><span style="color: #9A1900">/* Outer loop repeats once for each marker. */</span></span>
<a name="line955">0955: </a>  <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> <span style="color: #990000">(</span><span style="color: #990000">;</span><span style="color: #990000">;</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line956">0956: </a>    <span style="font-style: italic"><span style="color: #9A1900">/* Collect the marker proper, unless we already did. */</span></span>
<a name="line957">0957: </a>    <span style="font-style: italic"><span style="color: #9A1900">/* NB: first_marker() enforces the requirement that SOI appear first. */</span></span>
<a name="line958">0958: </a>    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>unread_marker <span style="color: #990000">=</span><span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line959">0959: </a>      <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span><span style="color: #990000">!</span> cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>marker<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>saw_SOI<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line960">0960: </a>        <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span><span style="color: #990000">!</span> <span style="font-weight: bold"><span style="color: #000000">first_marker</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">)</span><span style="color: #990000">)</span>
<a name="line961">0961: </a>          <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> JPEG_SUSPENDED<span style="color: #990000">;</span>
<a name="line962">0962: </a>      <span style="color: #FF0000">}</span> <span style="font-weight: bold"><span style="color: #0000FF">else</span></span> <span style="color: #FF0000">{</span>
<a name="line963">0963: </a>        <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span><span style="color: #990000">!</span> <span style="font-weight: bold"><span style="color: #000000">next_marker</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">)</span><span style="color: #990000">)</span>
<a name="line964">0964: </a>          <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> JPEG_SUSPENDED<span style="color: #990000">;</span>
<a name="line965">0965: </a>      <span style="color: #FF0000">}</span>
<a name="line966">0966: </a>    <span style="color: #FF0000">}</span>
<a name="line967">0967: </a>    <span style="font-style: italic"><span style="color: #9A1900">/* At this point cinfo-&gt;unread_marker contains the marker code and the</span></span>
<a name="line968">0968: </a><span style="font-style: italic"><span style="color: #9A1900">     * input point is just past the marker proper, but before any parameters.</span></span>
<a name="line969">0969: </a><span style="font-style: italic"><span style="color: #9A1900">     * A suspension will cause us to return with this state still true.</span></span>
<a name="line970">0970: </a><span style="font-style: italic"><span style="color: #9A1900">     */</span></span>
<a name="line971">0971: </a>    <span style="font-weight: bold"><span style="color: #0000FF">switch</span></span> <span style="color: #990000">(</span>cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>unread_marker<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line972">0972: </a>    <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> M_SOI<span style="color: #990000">:</span>
<a name="line973">0973: </a>      <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span><span style="color: #990000">!</span> <span style="font-weight: bold"><span style="color: #000000">get_soi</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">)</span><span style="color: #990000">)</span>
<a name="line974">0974: </a>        <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> JPEG_SUSPENDED<span style="color: #990000">;</span>
<a name="line975">0975: </a>      <span style="font-weight: bold"><span style="color: #0000FF">break</span></span><span style="color: #990000">;</span>
<a name="line976">0976: </a>
<a name="line977">0977: </a>    <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> M_SOF0<span style="color: #990000">:</span>                <span style="font-style: italic"><span style="color: #9A1900">/* Baseline */</span></span>
<a name="line978">0978: </a>    <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> M_SOF1<span style="color: #990000">:</span>                <span style="font-style: italic"><span style="color: #9A1900">/* Extended sequential, Huffman */</span></span>
<a name="line979">0979: </a>      <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span><span style="color: #990000">!</span> <span style="font-weight: bold"><span style="color: #000000">get_sof</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> FALSE<span style="color: #990000">,</span> FALSE<span style="color: #990000">)</span><span style="color: #990000">)</span>
<a name="line980">0980: </a>        <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> JPEG_SUSPENDED<span style="color: #990000">;</span>
<a name="line981">0981: </a>      <span style="font-weight: bold"><span style="color: #0000FF">break</span></span><span style="color: #990000">;</span>
<a name="line982">0982: </a>
<a name="line983">0983: </a>    <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> M_SOF2<span style="color: #990000">:</span>                <span style="font-style: italic"><span style="color: #9A1900">/* Progressive, Huffman */</span></span>
<a name="line984">0984: </a>      <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span><span style="color: #990000">!</span> <span style="font-weight: bold"><span style="color: #000000">get_sof</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> TRUE<span style="color: #990000">,</span> FALSE<span style="color: #990000">)</span><span style="color: #990000">)</span>
<a name="line985">0985: </a>        <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> JPEG_SUSPENDED<span style="color: #990000">;</span>
<a name="line986">0986: </a>      <span style="font-weight: bold"><span style="color: #0000FF">break</span></span><span style="color: #990000">;</span>
<a name="line987">0987: </a>
<a name="line988">0988: </a>    <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> M_SOF9<span style="color: #990000">:</span>                <span style="font-style: italic"><span style="color: #9A1900">/* Extended sequential, arithmetic */</span></span>
<a name="line989">0989: </a>      <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span><span style="color: #990000">!</span> <span style="font-weight: bold"><span style="color: #000000">get_sof</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> FALSE<span style="color: #990000">,</span> TRUE<span style="color: #990000">)</span><span style="color: #990000">)</span>
<a name="line990">0990: </a>        <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> JPEG_SUSPENDED<span style="color: #990000">;</span>
<a name="line991">0991: </a>      <span style="font-weight: bold"><span style="color: #0000FF">break</span></span><span style="color: #990000">;</span>
<a name="line992">0992: </a>
<a name="line993">0993: </a>    <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> M_SOF10<span style="color: #990000">:</span>               <span style="font-style: italic"><span style="color: #9A1900">/* Progressive, arithmetic */</span></span>
<a name="line994">0994: </a>      <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span><span style="color: #990000">!</span> <span style="font-weight: bold"><span style="color: #000000">get_sof</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> TRUE<span style="color: #990000">,</span> TRUE<span style="color: #990000">)</span><span style="color: #990000">)</span>
<a name="line995">0995: </a>        <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> JPEG_SUSPENDED<span style="color: #990000">;</span>
<a name="line996">0996: </a>      <span style="font-weight: bold"><span style="color: #0000FF">break</span></span><span style="color: #990000">;</span>
<a name="line997">0997: </a>
<a name="line998">0998: </a>    <span style="font-style: italic"><span style="color: #9A1900">/* Currently unsupported SOFn types */</span></span>
<a name="line999">0999: </a>    <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> M_SOF3<span style="color: #990000">:</span>                <span style="font-style: italic"><span style="color: #9A1900">/* Lossless, Huffman */</span></span>
<a name="line1000">1000: </a>    <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> M_SOF5<span style="color: #990000">:</span>                <span style="font-style: italic"><span style="color: #9A1900">/* Differential sequential, Huffman */</span></span>
<a name="line1001">1001: </a>    <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> M_SOF6<span style="color: #990000">:</span>                <span style="font-style: italic"><span style="color: #9A1900">/* Differential progressive, Huffman */</span></span>
<a name="line1002">1002: </a>    <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> M_SOF7<span style="color: #990000">:</span>                <span style="font-style: italic"><span style="color: #9A1900">/* Differential lossless, Huffman */</span></span>
<a name="line1003">1003: </a>    <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> M_JPG<span style="color: #990000">:</span>                 <span style="font-style: italic"><span style="color: #9A1900">/* Reserved for JPEG extensions */</span></span>
<a name="line1004">1004: </a>    <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> M_SOF11<span style="color: #990000">:</span>               <span style="font-style: italic"><span style="color: #9A1900">/* Lossless, arithmetic */</span></span>
<a name="line1005">1005: </a>    <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> M_SOF13<span style="color: #990000">:</span>               <span style="font-style: italic"><span style="color: #9A1900">/* Differential sequential, arithmetic */</span></span>
<a name="line1006">1006: </a>    <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> M_SOF14<span style="color: #990000">:</span>               <span style="font-style: italic"><span style="color: #9A1900">/* Differential progressive, arithmetic */</span></span>
<a name="line1007">1007: </a>    <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> M_SOF15<span style="color: #990000">:</span>               <span style="font-style: italic"><span style="color: #9A1900">/* Differential lossless, arithmetic */</span></span>
<a name="line1008">1008: </a>      <span style="font-weight: bold"><span style="color: #000000">ERREXIT1</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> JERR_SOF_UNSUPPORTED<span style="color: #990000">,</span> cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>unread_marker<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line1009">1009: </a>      <span style="font-weight: bold"><span style="color: #0000FF">break</span></span><span style="color: #990000">;</span>
<a name="line1010">1010: </a>
<a name="line1011">1011: </a>    <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> M_SOS<span style="color: #990000">:</span>
<a name="line1012">1012: </a>      <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span><span style="color: #990000">!</span> <span style="font-weight: bold"><span style="color: #000000">get_sos</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">)</span><span style="color: #990000">)</span>
<a name="line1013">1013: </a>        <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> JPEG_SUSPENDED<span style="color: #990000">;</span>
<a name="line1014">1014: </a>      cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>unread_marker <span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">/* processed the marker */</span></span>
<a name="line1015">1015: </a>      <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> JPEG_REACHED_SOS<span style="color: #990000">;</span>
<a name="line1016">1016: </a>    
<a name="line1017">1017: </a>    <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> M_EOI<span style="color: #990000">:</span>
<a name="line1018">1018: </a>      <span style="font-weight: bold"><span style="color: #000000">TRACEMS</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> <span style="color: #993399">1</span><span style="color: #990000">,</span> JTRC_EOI<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line1019">1019: </a>      cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>unread_marker <span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">/* processed the marker */</span></span>
<a name="line1020">1020: </a>      <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> JPEG_REACHED_EOI<span style="color: #990000">;</span>
<a name="line1021">1021: </a>      
<a name="line1022">1022: </a>    <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> M_DAC<span style="color: #990000">:</span>
<a name="line1023">1023: </a>      <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span><span style="color: #990000">!</span> <span style="font-weight: bold"><span style="color: #000000">get_dac</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">)</span><span style="color: #990000">)</span>
<a name="line1024">1024: </a>        <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> JPEG_SUSPENDED<span style="color: #990000">;</span>
<a name="line1025">1025: </a>      <span style="font-weight: bold"><span style="color: #0000FF">break</span></span><span style="color: #990000">;</span>
<a name="line1026">1026: </a>      
<a name="line1027">1027: </a>    <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> M_DHT<span style="color: #990000">:</span>
<a name="line1028">1028: </a>      <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span><span style="color: #990000">!</span> <span style="font-weight: bold"><span style="color: #000000">get_dht</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">)</span><span style="color: #990000">)</span>
<a name="line1029">1029: </a>        <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> JPEG_SUSPENDED<span style="color: #990000">;</span>
<a name="line1030">1030: </a>      <span style="font-weight: bold"><span style="color: #0000FF">break</span></span><span style="color: #990000">;</span>
<a name="line1031">1031: </a>      
<a name="line1032">1032: </a>    <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> M_DQT<span style="color: #990000">:</span>
<a name="line1033">1033: </a>      <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span><span style="color: #990000">!</span> <span style="font-weight: bold"><span style="color: #000000">get_dqt</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">)</span><span style="color: #990000">)</span>
<a name="line1034">1034: </a>        <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> JPEG_SUSPENDED<span style="color: #990000">;</span>
<a name="line1035">1035: </a>      <span style="font-weight: bold"><span style="color: #0000FF">break</span></span><span style="color: #990000">;</span>
<a name="line1036">1036: </a>      
<a name="line1037">1037: </a>    <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> M_DRI<span style="color: #990000">:</span>
<a name="line1038">1038: </a>      <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span><span style="color: #990000">!</span> <span style="font-weight: bold"><span style="color: #000000">get_dri</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">)</span><span style="color: #990000">)</span>
<a name="line1039">1039: </a>        <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> JPEG_SUSPENDED<span style="color: #990000">;</span>
<a name="line1040">1040: </a>      <span style="font-weight: bold"><span style="color: #0000FF">break</span></span><span style="color: #990000">;</span>
<a name="line1041">1041: </a>      
<a name="line1042">1042: </a>    <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> M_APP0<span style="color: #990000">:</span>
<a name="line1043">1043: </a>    <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> M_APP1<span style="color: #990000">:</span>
<a name="line1044">1044: </a>    <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> M_APP2<span style="color: #990000">:</span>
<a name="line1045">1045: </a>    <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> M_APP3<span style="color: #990000">:</span>
<a name="line1046">1046: </a>    <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> M_APP4<span style="color: #990000">:</span>
<a name="line1047">1047: </a>    <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> M_APP5<span style="color: #990000">:</span>
<a name="line1048">1048: </a>    <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> M_APP6<span style="color: #990000">:</span>
<a name="line1049">1049: </a>    <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> M_APP7<span style="color: #990000">:</span>
<a name="line1050">1050: </a>    <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> M_APP8<span style="color: #990000">:</span>
<a name="line1051">1051: </a>    <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> M_APP9<span style="color: #990000">:</span>
<a name="line1052">1052: </a>    <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> M_APP10<span style="color: #990000">:</span>
<a name="line1053">1053: </a>    <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> M_APP11<span style="color: #990000">:</span>
<a name="line1054">1054: </a>    <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> M_APP12<span style="color: #990000">:</span>
<a name="line1055">1055: </a>    <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> M_APP13<span style="color: #990000">:</span>
<a name="line1056">1056: </a>    <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> M_APP14<span style="color: #990000">:</span>
<a name="line1057">1057: </a>    <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> M_APP15<span style="color: #990000">:</span>
<a name="line1058">1058: </a>      <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span><span style="color: #990000">!</span> <span style="color: #990000">(</span><span style="color: #990000">*</span><span style="color: #990000">(</span><span style="color: #990000">(</span>my_marker_ptr<span style="color: #990000">)</span> cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>marker<span style="color: #990000">)</span><span style="color: #990000">-</span><span style="color: #990000">&gt;</span>process_APPn<span style="color: #990000">[</span>
<a name="line1059">1059: </a>                cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>unread_marker <span style="color: #990000">-</span> <span style="color: #990000">(</span><span style="color: #009900">int</span><span style="color: #990000">)</span> M_APP0<span style="color: #990000">]</span><span style="color: #990000">)</span> <span style="color: #990000">(</span>cinfo<span style="color: #990000">)</span><span style="color: #990000">)</span>
<a name="line1060">1060: </a>        <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> JPEG_SUSPENDED<span style="color: #990000">;</span>
<a name="line1061">1061: </a>      <span style="font-weight: bold"><span style="color: #0000FF">break</span></span><span style="color: #990000">;</span>
<a name="line1062">1062: </a>      
<a name="line1063">1063: </a>    <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> M_COM<span style="color: #990000">:</span>
<a name="line1064">1064: </a>      <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span><span style="color: #990000">!</span> <span style="color: #990000">(</span><span style="color: #990000">*</span><span style="color: #990000">(</span><span style="color: #990000">(</span>my_marker_ptr<span style="color: #990000">)</span> cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>marker<span style="color: #990000">)</span><span style="color: #990000">-</span><span style="color: #990000">&gt;</span>process_COM<span style="color: #990000">)</span> <span style="color: #990000">(</span>cinfo<span style="color: #990000">)</span><span style="color: #990000">)</span>
<a name="line1065">1065: </a>        <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> JPEG_SUSPENDED<span style="color: #990000">;</span>
<a name="line1066">1066: </a>      <span style="font-weight: bold"><span style="color: #0000FF">break</span></span><span style="color: #990000">;</span>
<a name="line1067">1067: </a>
<a name="line1068">1068: </a>    <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> M_RST0<span style="color: #990000">:</span>                <span style="font-style: italic"><span style="color: #9A1900">/* these are all parameterless */</span></span>
<a name="line1069">1069: </a>    <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> M_RST1<span style="color: #990000">:</span>
<a name="line1070">1070: </a>    <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> M_RST2<span style="color: #990000">:</span>
<a name="line1071">1071: </a>    <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> M_RST3<span style="color: #990000">:</span>
<a name="line1072">1072: </a>    <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> M_RST4<span style="color: #990000">:</span>
<a name="line1073">1073: </a>    <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> M_RST5<span style="color: #990000">:</span>
<a name="line1074">1074: </a>    <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> M_RST6<span style="color: #990000">:</span>
<a name="line1075">1075: </a>    <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> M_RST7<span style="color: #990000">:</span>
<a name="line1076">1076: </a>    <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> M_TEM<span style="color: #990000">:</span>
<a name="line1077">1077: </a>      <span style="font-weight: bold"><span style="color: #000000">TRACEMS1</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> <span style="color: #993399">1</span><span style="color: #990000">,</span> JTRC_PARMLESS_MARKER<span style="color: #990000">,</span> cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>unread_marker<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line1078">1078: </a>      <span style="font-weight: bold"><span style="color: #0000FF">break</span></span><span style="color: #990000">;</span>
<a name="line1079">1079: </a>
<a name="line1080">1080: </a>    <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> M_DNL<span style="color: #990000">:</span>                 <span style="font-style: italic"><span style="color: #9A1900">/* Ignore DNL ... perhaps the wrong thing */</span></span>
<a name="line1081">1081: </a>      <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span><span style="color: #990000">!</span> <span style="font-weight: bold"><span style="color: #000000">skip_variable</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">)</span><span style="color: #990000">)</span>
<a name="line1082">1082: </a>        <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> JPEG_SUSPENDED<span style="color: #990000">;</span>
<a name="line1083">1083: </a>      <span style="font-weight: bold"><span style="color: #0000FF">break</span></span><span style="color: #990000">;</span>
<a name="line1084">1084: </a>
<a name="line1085">1085: </a>    <span style="font-weight: bold"><span style="color: #0000FF">default</span></span><span style="color: #990000">:</span>                    <span style="font-style: italic"><span style="color: #9A1900">/* must be DHP, EXP, JPGn, or RESn */</span></span>
<a name="line1086">1086: </a>      <span style="font-style: italic"><span style="color: #9A1900">/* For now, we treat the reserved markers as fatal errors since they are</span></span>
<a name="line1087">1087: </a><span style="font-style: italic"><span style="color: #9A1900">       * likely to be used to signal incompatible JPEG Part 3 extensions.</span></span>
<a name="line1088">1088: </a><span style="font-style: italic"><span style="color: #9A1900">       * Once the JPEG 3 version-number marker is well defined, this code</span></span>
<a name="line1089">1089: </a><span style="font-style: italic"><span style="color: #9A1900">       * ought to change!</span></span>
<a name="line1090">1090: </a><span style="font-style: italic"><span style="color: #9A1900">       */</span></span>
<a name="line1091">1091: </a>      <span style="font-weight: bold"><span style="color: #000000">ERREXIT1</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> JERR_UNKNOWN_MARKER<span style="color: #990000">,</span> cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>unread_marker<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line1092">1092: </a>      <span style="font-weight: bold"><span style="color: #0000FF">break</span></span><span style="color: #990000">;</span>
<a name="line1093">1093: </a>    <span style="color: #FF0000">}</span>
<a name="line1094">1094: </a>    <span style="font-style: italic"><span style="color: #9A1900">/* Successfully processed marker, so reset state variable */</span></span>
<a name="line1095">1095: </a>    cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>unread_marker <span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">;</span>
<a name="line1096">1096: </a>  <span style="color: #FF0000">}</span> <span style="font-style: italic"><span style="color: #9A1900">/* end loop */</span></span>
<a name="line1097">1097: </a><span style="color: #FF0000">}</span>
<a name="line1098">1098: </a>
<a name="line1099">1099: </a>
<a name="line1100">1100: </a><span style="font-style: italic"><span style="color: #9A1900">/*</span></span>
<a name="line1101">1101: </a><span style="font-style: italic"><span style="color: #9A1900"> * Read a restart marker, which is expected to appear next in the datastream;</span></span>
<a name="line1102">1102: </a><span style="font-style: italic"><span style="color: #9A1900"> * if the marker is not there, take appropriate recovery action.</span></span>
<a name="line1103">1103: </a><span style="font-style: italic"><span style="color: #9A1900"> * Returns FALSE if suspension is required.</span></span>
<a name="line1104">1104: </a><span style="font-style: italic"><span style="color: #9A1900"> *</span></span>
<a name="line1105">1105: </a><span style="font-style: italic"><span style="color: #9A1900"> * This is called by the entropy decoder after it has read an appropriate</span></span>
<a name="line1106">1106: </a><span style="font-style: italic"><span style="color: #9A1900"> * number of MCUs.  cinfo-&gt;unread_marker may be nonzero if the entropy decoder</span></span>
<a name="line1107">1107: </a><span style="font-style: italic"><span style="color: #9A1900"> * has already read a marker from the data source.  Under normal conditions</span></span>
<a name="line1108">1108: </a><span style="font-style: italic"><span style="color: #9A1900"> * cinfo-&gt;unread_marker will be reset to 0 before returning; if not reset,</span></span>
<a name="line1109">1109: </a><span style="font-style: italic"><span style="color: #9A1900"> * it holds a marker which the decoder will be unable to read past.</span></span>
<a name="line1110">1110: </a><span style="font-style: italic"><span style="color: #9A1900"> */</span></span>
<a name="line1111">1111: </a>
<a name="line1112">1112: </a><span style="font-weight: bold"><span style="color: #000000">METHODDEF</span></span><span style="color: #990000">(</span>boolean<span style="color: #990000">)</span>
<a name="line1113">1113: </a><span style="font-weight: bold"><span style="color: #000000">read_restart_marker</span></span> <span style="color: #990000">(</span>j_decompress_ptr cinfo<span style="color: #990000">)</span>
<a name="line1114">1114: </a><span style="color: #FF0000">{</span>
<a name="line1115">1115: </a>  <span style="font-style: italic"><span style="color: #9A1900">/* Obtain a marker unless we already did. */</span></span>
<a name="line1116">1116: </a>  <span style="font-style: italic"><span style="color: #9A1900">/* Note that next_marker will complain if it skips any data. */</span></span>
<a name="line1117">1117: </a>  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>unread_marker <span style="color: #990000">=</span><span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line1118">1118: </a>    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span><span style="color: #990000">!</span> <span style="font-weight: bold"><span style="color: #000000">next_marker</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">)</span><span style="color: #990000">)</span>
<a name="line1119">1119: </a>      <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> FALSE<span style="color: #990000">;</span>
<a name="line1120">1120: </a>  <span style="color: #FF0000">}</span>
<a name="line1121">1121: </a>
<a name="line1122">1122: </a>  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>unread_marker <span style="color: #990000">=</span><span style="color: #990000">=</span>
<a name="line1123">1123: </a>      <span style="color: #990000">(</span><span style="color: #990000">(</span><span style="color: #009900">int</span><span style="color: #990000">)</span> M_RST0 <span style="color: #990000">+</span> cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>marker<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>next_restart_num<span style="color: #990000">)</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line1124">1124: </a>    <span style="font-style: italic"><span style="color: #9A1900">/* Normal case --- swallow the marker and let entropy decoder continue */</span></span>
<a name="line1125">1125: </a>    <span style="font-weight: bold"><span style="color: #000000">TRACEMS1</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> <span style="color: #993399">3</span><span style="color: #990000">,</span> JTRC_RST<span style="color: #990000">,</span> cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>marker<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>next_restart_num<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line1126">1126: </a>    cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>unread_marker <span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">;</span>
<a name="line1127">1127: </a>  <span style="color: #FF0000">}</span> <span style="font-weight: bold"><span style="color: #0000FF">else</span></span> <span style="color: #FF0000">{</span>
<a name="line1128">1128: </a>    <span style="font-style: italic"><span style="color: #9A1900">/* Uh-oh, the restart markers have been messed up. */</span></span>
<a name="line1129">1129: </a>    <span style="font-style: italic"><span style="color: #9A1900">/* Let the data source manager determine how to resync. */</span></span>
<a name="line1130">1130: </a>    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span><span style="color: #990000">!</span> <span style="color: #990000">(</span><span style="color: #990000">*</span>cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>src<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>resync_to_restart<span style="color: #990000">)</span> <span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span>
<a name="line1131">1131: </a>                                            cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>marker<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>next_restart_num<span style="color: #990000">)</span><span style="color: #990000">)</span>
<a name="line1132">1132: </a>      <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> FALSE<span style="color: #990000">;</span>
<a name="line1133">1133: </a>  <span style="color: #FF0000">}</span>
<a name="line1134">1134: </a>
<a name="line1135">1135: </a>  <span style="font-style: italic"><span style="color: #9A1900">/* Update next-restart state */</span></span>
<a name="line1136">1136: </a>  cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>marker<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>next_restart_num <span style="color: #990000">=</span> <span style="color: #990000">(</span>cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>marker<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>next_restart_num <span style="color: #990000">+</span> <span style="color: #993399">1</span><span style="color: #990000">)</span> <span style="color: #990000">&amp;</span> <span style="color: #993399">7</span><span style="color: #990000">;</span>
<a name="line1137">1137: </a>
<a name="line1138">1138: </a>  <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> TRUE<span style="color: #990000">;</span>
<a name="line1139">1139: </a><span style="color: #FF0000">}</span>
<a name="line1140">1140: </a>
<a name="line1141">1141: </a>
<a name="line1142">1142: </a><span style="font-style: italic"><span style="color: #9A1900">/*</span></span>
<a name="line1143">1143: </a><span style="font-style: italic"><span style="color: #9A1900"> * This is the default resync_to_restart method for data source managers</span></span>
<a name="line1144">1144: </a><span style="font-style: italic"><span style="color: #9A1900"> * to use if they don't have any better approach.  Some data source managers</span></span>
<a name="line1145">1145: </a><span style="font-style: italic"><span style="color: #9A1900"> * may be able to back up, or may have additional knowledge about the data</span></span>
<a name="line1146">1146: </a><span style="font-style: italic"><span style="color: #9A1900"> * which permits a more intelligent recovery strategy; such managers would</span></span>
<a name="line1147">1147: </a><span style="font-style: italic"><span style="color: #9A1900"> * presumably supply their own resync method.</span></span>
<a name="line1148">1148: </a><span style="font-style: italic"><span style="color: #9A1900"> *</span></span>
<a name="line1149">1149: </a><span style="font-style: italic"><span style="color: #9A1900"> * read_restart_marker calls resync_to_restart if it finds a marker other than</span></span>
<a name="line1150">1150: </a><span style="font-style: italic"><span style="color: #9A1900"> * the restart marker it was expecting.  (This code is *not* used unless</span></span>
<a name="line1151">1151: </a><span style="font-style: italic"><span style="color: #9A1900"> * a nonzero restart interval has been declared.)  cinfo-&gt;unread_marker is</span></span>
<a name="line1152">1152: </a><span style="font-style: italic"><span style="color: #9A1900"> * the marker code actually found (might be anything, except 0 or FF).</span></span>
<a name="line1153">1153: </a><span style="font-style: italic"><span style="color: #9A1900"> * The desired restart marker number (0..7) is passed as a parameter.</span></span>
<a name="line1154">1154: </a><span style="font-style: italic"><span style="color: #9A1900"> * This routine is supposed to apply whatever error recovery strategy seems</span></span>
<a name="line1155">1155: </a><span style="font-style: italic"><span style="color: #9A1900"> * appropriate in order to position the input stream to the next data segment.</span></span>
<a name="line1156">1156: </a><span style="font-style: italic"><span style="color: #9A1900"> * Note that cinfo-&gt;unread_marker is treated as a marker appearing before</span></span>
<a name="line1157">1157: </a><span style="font-style: italic"><span style="color: #9A1900"> * the current data-source input point; usually it should be reset to zero</span></span>
<a name="line1158">1158: </a><span style="font-style: italic"><span style="color: #9A1900"> * before returning.</span></span>
<a name="line1159">1159: </a><span style="font-style: italic"><span style="color: #9A1900"> * Returns FALSE if suspension is required.</span></span>
<a name="line1160">1160: </a><span style="font-style: italic"><span style="color: #9A1900"> *</span></span>
<a name="line1161">1161: </a><span style="font-style: italic"><span style="color: #9A1900"> * This implementation is substantially constrained by wanting to treat the</span></span>
<a name="line1162">1162: </a><span style="font-style: italic"><span style="color: #9A1900"> * input as a data stream; this means we can't back up.  Therefore, we have</span></span>
<a name="line1163">1163: </a><span style="font-style: italic"><span style="color: #9A1900"> * only the following actions to work with:</span></span>
<a name="line1164">1164: </a><span style="font-style: italic"><span style="color: #9A1900"> *   1. Simply discard the marker and let the entropy decoder resume at next</span></span>
<a name="line1165">1165: </a><span style="font-style: italic"><span style="color: #9A1900"> *      byte of file.</span></span>
<a name="line1166">1166: </a><span style="font-style: italic"><span style="color: #9A1900"> *   2. Read forward until we find another marker, discarding intervening</span></span>
<a name="line1167">1167: </a><span style="font-style: italic"><span style="color: #9A1900"> *      data.  (In theory we could look ahead within the current bufferload,</span></span>
<a name="line1168">1168: </a><span style="font-style: italic"><span style="color: #9A1900"> *      without having to discard data if we don't find the desired marker.</span></span>
<a name="line1169">1169: </a><span style="font-style: italic"><span style="color: #9A1900"> *      This idea is not implemented here, in part because it makes behavior</span></span>
<a name="line1170">1170: </a><span style="font-style: italic"><span style="color: #9A1900"> *      dependent on buffer size and chance buffer-boundary positions.)</span></span>
<a name="line1171">1171: </a><span style="font-style: italic"><span style="color: #9A1900"> *   3. Leave the marker unread (by failing to zero cinfo-&gt;unread_marker).</span></span>
<a name="line1172">1172: </a><span style="font-style: italic"><span style="color: #9A1900"> *      This will cause the entropy decoder to process an empty data segment,</span></span>
<a name="line1173">1173: </a><span style="font-style: italic"><span style="color: #9A1900"> *      inserting dummy zeroes, and then we will reprocess the marker.</span></span>
<a name="line1174">1174: </a><span style="font-style: italic"><span style="color: #9A1900"> *</span></span>
<a name="line1175">1175: </a><span style="font-style: italic"><span style="color: #9A1900"> * #2 is appropriate if we think the desired marker lies ahead, while #3 is</span></span>
<a name="line1176">1176: </a><span style="font-style: italic"><span style="color: #9A1900"> * appropriate if the found marker is a future restart marker (indicating</span></span>
<a name="line1177">1177: </a><span style="font-style: italic"><span style="color: #9A1900"> * that we have missed the desired restart marker, probably because it got</span></span>
<a name="line1178">1178: </a><span style="font-style: italic"><span style="color: #9A1900"> * corrupted).</span></span>
<a name="line1179">1179: </a><span style="font-style: italic"><span style="color: #9A1900"> * We apply #2 or #3 if the found marker is a restart marker no more than</span></span>
<a name="line1180">1180: </a><span style="font-style: italic"><span style="color: #9A1900"> * two counts behind or ahead of the expected one.  We also apply #2 if the</span></span>
<a name="line1181">1181: </a><span style="font-style: italic"><span style="color: #9A1900"> * found marker is not a legal JPEG marker code (it's certainly bogus data).</span></span>
<a name="line1182">1182: </a><span style="font-style: italic"><span style="color: #9A1900"> * If the found marker is a restart marker more than 2 counts away, we do #1</span></span>
<a name="line1183">1183: </a><span style="font-style: italic"><span style="color: #9A1900"> * (too much risk that the marker is erroneous; with luck we will be able to</span></span>
<a name="line1184">1184: </a><span style="font-style: italic"><span style="color: #9A1900"> * resync at some future point).</span></span>
<a name="line1185">1185: </a><span style="font-style: italic"><span style="color: #9A1900"> * For any valid non-restart JPEG marker, we apply #3.  This keeps us from</span></span>
<a name="line1186">1186: </a><span style="font-style: italic"><span style="color: #9A1900"> * overrunning the end of a scan.  An implementation limited to single-scan</span></span>
<a name="line1187">1187: </a><span style="font-style: italic"><span style="color: #9A1900"> * files might find it better to apply #2 for markers other than EOI, since</span></span>
<a name="line1188">1188: </a><span style="font-style: italic"><span style="color: #9A1900"> * any other marker would have to be bogus data in that case.</span></span>
<a name="line1189">1189: </a><span style="font-style: italic"><span style="color: #9A1900"> */</span></span>
<a name="line1190">1190: </a>
<a name="line1191">1191: </a><span style="font-weight: bold"><span style="color: #000000">GLOBAL</span></span><span style="color: #990000">(</span>boolean<span style="color: #990000">)</span>
<a name="line1192">1192: </a><span style="font-weight: bold"><span style="color: #000000">jpeg_resync_to_restart</span></span> <span style="color: #990000">(</span>j_decompress_ptr cinfo<span style="color: #990000">,</span> <span style="color: #009900">int</span> desired<span style="color: #990000">)</span>
<a name="line1193">1193: </a><span style="color: #FF0000">{</span>
<a name="line1194">1194: </a>  <span style="color: #009900">int</span> marker <span style="color: #990000">=</span> cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>unread_marker<span style="color: #990000">;</span>
<a name="line1195">1195: </a>  <span style="color: #009900">int</span> action <span style="color: #990000">=</span> <span style="color: #993399">1</span><span style="color: #990000">;</span>
<a name="line1196">1196: </a>  
<a name="line1197">1197: </a>  <span style="font-style: italic"><span style="color: #9A1900">/* Always put up a warning. */</span></span>
<a name="line1198">1198: </a>  <span style="font-weight: bold"><span style="color: #000000">WARNMS2</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> JWRN_MUST_RESYNC<span style="color: #990000">,</span> marker<span style="color: #990000">,</span> desired<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line1199">1199: </a>  
<a name="line1200">1200: </a>  <span style="font-style: italic"><span style="color: #9A1900">/* Outer loop handles repeated decision after scanning forward. */</span></span>
<a name="line1201">1201: </a>  <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> <span style="color: #990000">(</span><span style="color: #990000">;</span><span style="color: #990000">;</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line1202">1202: </a>    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>marker <span style="color: #990000">&lt;</span> <span style="color: #990000">(</span><span style="color: #009900">int</span><span style="color: #990000">)</span> M_SOF0<span style="color: #990000">)</span>
<a name="line1203">1203: </a>      action <span style="color: #990000">=</span> <span style="color: #993399">2</span><span style="color: #990000">;</span>               <span style="font-style: italic"><span style="color: #9A1900">/* invalid marker */</span></span>
<a name="line1204">1204: </a>    <span style="font-weight: bold"><span style="color: #0000FF">else</span></span> <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>marker <span style="color: #990000">&lt;</span> <span style="color: #990000">(</span><span style="color: #009900">int</span><span style="color: #990000">)</span> M_RST0 <span style="color: #990000">|</span><span style="color: #990000">|</span> marker <span style="color: #990000">&gt;</span> <span style="color: #990000">(</span><span style="color: #009900">int</span><span style="color: #990000">)</span> M_RST7<span style="color: #990000">)</span>
<a name="line1205">1205: </a>      action <span style="color: #990000">=</span> <span style="color: #993399">3</span><span style="color: #990000">;</span>               <span style="font-style: italic"><span style="color: #9A1900">/* valid non-restart marker */</span></span>
<a name="line1206">1206: </a>    <span style="font-weight: bold"><span style="color: #0000FF">else</span></span> <span style="color: #FF0000">{</span>
<a name="line1207">1207: </a>      <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>marker <span style="color: #990000">=</span><span style="color: #990000">=</span> <span style="color: #990000">(</span><span style="color: #990000">(</span><span style="color: #009900">int</span><span style="color: #990000">)</span> M_RST0 <span style="color: #990000">+</span> <span style="color: #990000">(</span><span style="color: #990000">(</span>desired<span style="color: #990000">+</span><span style="color: #993399">1</span><span style="color: #990000">)</span> <span style="color: #990000">&amp;</span> <span style="color: #993399">7</span><span style="color: #990000">)</span><span style="color: #990000">)</span> <span style="color: #990000">|</span><span style="color: #990000">|</span>
<a name="line1208">1208: </a>          marker <span style="color: #990000">=</span><span style="color: #990000">=</span> <span style="color: #990000">(</span><span style="color: #990000">(</span><span style="color: #009900">int</span><span style="color: #990000">)</span> M_RST0 <span style="color: #990000">+</span> <span style="color: #990000">(</span><span style="color: #990000">(</span>desired<span style="color: #990000">+</span><span style="color: #993399">2</span><span style="color: #990000">)</span> <span style="color: #990000">&amp;</span> <span style="color: #993399">7</span><span style="color: #990000">)</span><span style="color: #990000">)</span><span style="color: #990000">)</span>
<a name="line1209">1209: </a>        action <span style="color: #990000">=</span> <span style="color: #993399">3</span><span style="color: #990000">;</span>             <span style="font-style: italic"><span style="color: #9A1900">/* one of the next two expected restarts */</span></span>
<a name="line1210">1210: </a>      <span style="font-weight: bold"><span style="color: #0000FF">else</span></span> <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>marker <span style="color: #990000">=</span><span style="color: #990000">=</span> <span style="color: #990000">(</span><span style="color: #990000">(</span><span style="color: #009900">int</span><span style="color: #990000">)</span> M_RST0 <span style="color: #990000">+</span> <span style="color: #990000">(</span><span style="color: #990000">(</span>desired<span style="color: #990000">-</span><span style="color: #993399">1</span><span style="color: #990000">)</span> <span style="color: #990000">&amp;</span> <span style="color: #993399">7</span><span style="color: #990000">)</span><span style="color: #990000">)</span> <span style="color: #990000">|</span><span style="color: #990000">|</span>
<a name="line1211">1211: </a>               marker <span style="color: #990000">=</span><span style="color: #990000">=</span> <span style="color: #990000">(</span><span style="color: #990000">(</span><span style="color: #009900">int</span><span style="color: #990000">)</span> M_RST0 <span style="color: #990000">+</span> <span style="color: #990000">(</span><span style="color: #990000">(</span>desired<span style="color: #990000">-</span><span style="color: #993399">2</span><span style="color: #990000">)</span> <span style="color: #990000">&amp;</span> <span style="color: #993399">7</span><span style="color: #990000">)</span><span style="color: #990000">)</span><span style="color: #990000">)</span>
<a name="line1212">1212: </a>        action <span style="color: #990000">=</span> <span style="color: #993399">2</span><span style="color: #990000">;</span>             <span style="font-style: italic"><span style="color: #9A1900">/* a prior restart, so advance */</span></span>
<a name="line1213">1213: </a>      <span style="font-weight: bold"><span style="color: #0000FF">else</span></span>
<a name="line1214">1214: </a>        action <span style="color: #990000">=</span> <span style="color: #993399">1</span><span style="color: #990000">;</span>             <span style="font-style: italic"><span style="color: #9A1900">/* desired restart or too far away */</span></span>
<a name="line1215">1215: </a>    <span style="color: #FF0000">}</span>
<a name="line1216">1216: </a>    <span style="font-weight: bold"><span style="color: #000000">TRACEMS2</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> <span style="color: #993399">4</span><span style="color: #990000">,</span> JTRC_RECOVERY_ACTION<span style="color: #990000">,</span> marker<span style="color: #990000">,</span> action<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line1217">1217: </a>    <span style="font-weight: bold"><span style="color: #0000FF">switch</span></span> <span style="color: #990000">(</span>action<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line1218">1218: </a>    <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> <span style="color: #993399">1</span><span style="color: #990000">:</span>
<a name="line1219">1219: </a>      <span style="font-style: italic"><span style="color: #9A1900">/* Discard marker and let entropy decoder resume processing. */</span></span>
<a name="line1220">1220: </a>      cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>unread_marker <span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">;</span>
<a name="line1221">1221: </a>      <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> TRUE<span style="color: #990000">;</span>
<a name="line1222">1222: </a>    <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> <span style="color: #993399">2</span><span style="color: #990000">:</span>
<a name="line1223">1223: </a>      <span style="font-style: italic"><span style="color: #9A1900">/* Scan to the next marker, and repeat the decision loop. */</span></span>
<a name="line1224">1224: </a>      <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span><span style="color: #990000">!</span> <span style="font-weight: bold"><span style="color: #000000">next_marker</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">)</span><span style="color: #990000">)</span>
<a name="line1225">1225: </a>        <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> FALSE<span style="color: #990000">;</span>
<a name="line1226">1226: </a>      marker <span style="color: #990000">=</span> cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>unread_marker<span style="color: #990000">;</span>
<a name="line1227">1227: </a>      <span style="font-weight: bold"><span style="color: #0000FF">break</span></span><span style="color: #990000">;</span>
<a name="line1228">1228: </a>    <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> <span style="color: #993399">3</span><span style="color: #990000">:</span>
<a name="line1229">1229: </a>      <span style="font-style: italic"><span style="color: #9A1900">/* Return without advancing past this marker. */</span></span>
<a name="line1230">1230: </a>      <span style="font-style: italic"><span style="color: #9A1900">/* Entropy decoder will be forced to process an empty segment. */</span></span>
<a name="line1231">1231: </a>      <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> TRUE<span style="color: #990000">;</span>
<a name="line1232">1232: </a>    <span style="color: #FF0000">}</span>
<a name="line1233">1233: </a>  <span style="color: #FF0000">}</span> <span style="font-style: italic"><span style="color: #9A1900">/* end loop */</span></span>
<a name="line1234">1234: </a><span style="color: #FF0000">}</span>
<a name="line1235">1235: </a>
<a name="line1236">1236: </a>
<a name="line1237">1237: </a><span style="font-style: italic"><span style="color: #9A1900">/*</span></span>
<a name="line1238">1238: </a><span style="font-style: italic"><span style="color: #9A1900"> * Reset marker processing state to begin a fresh datastream.</span></span>
<a name="line1239">1239: </a><span style="font-style: italic"><span style="color: #9A1900"> */</span></span>
<a name="line1240">1240: </a>
<a name="line1241">1241: </a><span style="font-weight: bold"><span style="color: #000000">METHODDEF</span></span><span style="color: #990000">(</span><span style="color: #009900">void</span><span style="color: #990000">)</span>
<a name="line1242">1242: </a><span style="font-weight: bold"><span style="color: #000000">reset_marker_reader</span></span> <span style="color: #990000">(</span>j_decompress_ptr cinfo<span style="color: #990000">)</span>
<a name="line1243">1243: </a><span style="color: #FF0000">{</span>
<a name="line1244">1244: </a>  my_marker_ptr marker <span style="color: #990000">=</span> <span style="color: #990000">(</span>my_marker_ptr<span style="color: #990000">)</span> cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>marker<span style="color: #990000">;</span>
<a name="line1245">1245: </a>
<a name="line1246">1246: </a>  cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>comp_info <span style="color: #990000">=</span> NULL<span style="color: #990000">;</span>              <span style="font-style: italic"><span style="color: #9A1900">/* until allocated by get_sof */</span></span>
<a name="line1247">1247: </a>  cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>input_scan_number <span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">;</span>         <span style="font-style: italic"><span style="color: #9A1900">/* no SOS seen yet */</span></span>
<a name="line1248">1248: </a>  cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>unread_marker <span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">;</span>             <span style="font-style: italic"><span style="color: #9A1900">/* no pending marker */</span></span>
<a name="line1249">1249: </a>  marker<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>pub<span style="color: #990000">.</span>saw_SOI <span style="color: #990000">=</span> FALSE<span style="color: #990000">;</span>          <span style="font-style: italic"><span style="color: #9A1900">/* set internal state too */</span></span>
<a name="line1250">1250: </a>  marker<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>pub<span style="color: #990000">.</span>saw_SOF <span style="color: #990000">=</span> FALSE<span style="color: #990000">;</span>
<a name="line1251">1251: </a>  marker<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>pub<span style="color: #990000">.</span>discarded_bytes <span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">;</span>
<a name="line1252">1252: </a>  marker<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>cur_marker <span style="color: #990000">=</span> NULL<span style="color: #990000">;</span>
<a name="line1253">1253: </a><span style="color: #FF0000">}</span>
<a name="line1254">1254: </a>
<a name="line1255">1255: </a>
<a name="line1256">1256: </a><span style="font-style: italic"><span style="color: #9A1900">/*</span></span>
<a name="line1257">1257: </a><span style="font-style: italic"><span style="color: #9A1900"> * Initialize the marker reader module.</span></span>
<a name="line1258">1258: </a><span style="font-style: italic"><span style="color: #9A1900"> * This is called only once, when the decompression object is created.</span></span>
<a name="line1259">1259: </a><span style="font-style: italic"><span style="color: #9A1900"> */</span></span>
<a name="line1260">1260: </a>
<a name="line1261">1261: </a><span style="font-weight: bold"><span style="color: #000000">GLOBAL</span></span><span style="color: #990000">(</span><span style="color: #009900">void</span><span style="color: #990000">)</span>
<a name="line1262">1262: </a><span style="font-weight: bold"><span style="color: #000000">jinit_marker_reader</span></span> <span style="color: #990000">(</span>j_decompress_ptr cinfo<span style="color: #990000">)</span>
<a name="line1263">1263: </a><span style="color: #FF0000">{</span>
<a name="line1264">1264: </a>  my_marker_ptr marker<span style="color: #990000">;</span>
<a name="line1265">1265: </a>  <span style="color: #009900">int</span> i<span style="color: #990000">;</span>
<a name="line1266">1266: </a>
<a name="line1267">1267: </a>  <span style="font-style: italic"><span style="color: #9A1900">/* Create subobject in permanent pool */</span></span>
<a name="line1268">1268: </a>  marker <span style="color: #990000">=</span> <span style="color: #990000">(</span>my_marker_ptr<span style="color: #990000">)</span>
<a name="line1269">1269: </a>    <span style="color: #990000">(</span><span style="color: #990000">*</span>cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>mem<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>alloc_small<span style="color: #990000">)</span> <span style="color: #990000">(</span><span style="color: #990000">(</span>j_common_ptr<span style="color: #990000">)</span> cinfo<span style="color: #990000">,</span> JPOOL_PERMANENT<span style="color: #990000">,</span>
<a name="line1270">1270: </a>                                <span style="font-weight: bold"><span style="color: #000000">SIZEOF</span></span><span style="color: #990000">(</span>my_marker_reader<span style="color: #990000">)</span><span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line1271">1271: </a>  cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>marker <span style="color: #990000">=</span> <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">struct</span></span> jpeg_marker_reader <span style="color: #990000">*</span><span style="color: #990000">)</span> marker<span style="color: #990000">;</span>
<a name="line1272">1272: </a>  <span style="font-style: italic"><span style="color: #9A1900">/* Initialize public method pointers */</span></span>
<a name="line1273">1273: </a>  marker<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>pub<span style="color: #990000">.</span>reset_marker_reader <span style="color: #990000">=</span> reset_marker_reader<span style="color: #990000">;</span>
<a name="line1274">1274: </a>  marker<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>pub<span style="color: #990000">.</span>read_markers <span style="color: #990000">=</span> read_markers<span style="color: #990000">;</span>
<a name="line1275">1275: </a>  marker<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>pub<span style="color: #990000">.</span>read_restart_marker <span style="color: #990000">=</span> read_restart_marker<span style="color: #990000">;</span>
<a name="line1276">1276: </a>  <span style="font-style: italic"><span style="color: #9A1900">/* Initialize COM/APPn processing.</span></span>
<a name="line1277">1277: </a><span style="font-style: italic"><span style="color: #9A1900">   * By default, we examine and then discard APP0 and APP14,</span></span>
<a name="line1278">1278: </a><span style="font-style: italic"><span style="color: #9A1900">   * but simply discard COM and all other APPn.</span></span>
<a name="line1279">1279: </a><span style="font-style: italic"><span style="color: #9A1900">   */</span></span>
<a name="line1280">1280: </a>  marker<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>process_COM <span style="color: #990000">=</span> skip_variable<span style="color: #990000">;</span>
<a name="line1281">1281: </a>  marker<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>length_limit_COM <span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">;</span>
<a name="line1282">1282: </a>  <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> <span style="color: #990000">(</span>i <span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">;</span> i <span style="color: #990000">&lt;</span> <span style="color: #993399">16</span><span style="color: #990000">;</span> i<span style="color: #990000">+</span><span style="color: #990000">+</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line1283">1283: </a>    marker<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>process_APPn<span style="color: #990000">[</span>i<span style="color: #990000">]</span> <span style="color: #990000">=</span> skip_variable<span style="color: #990000">;</span>
<a name="line1284">1284: </a>    marker<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>length_limit_APPn<span style="color: #990000">[</span>i<span style="color: #990000">]</span> <span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">;</span>
<a name="line1285">1285: </a>  <span style="color: #FF0000">}</span>
<a name="line1286">1286: </a>  marker<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>process_APPn<span style="color: #990000">[</span><span style="color: #993399">0</span><span style="color: #990000">]</span> <span style="color: #990000">=</span> get_interesting_appn<span style="color: #990000">;</span>
<a name="line1287">1287: </a>  marker<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>process_APPn<span style="color: #990000">[</span><span style="color: #993399">14</span><span style="color: #990000">]</span> <span style="color: #990000">=</span> get_interesting_appn<span style="color: #990000">;</span>
<a name="line1288">1288: </a>  <span style="font-style: italic"><span style="color: #9A1900">/* Reset marker processing state */</span></span>
<a name="line1289">1289: </a>  <span style="font-weight: bold"><span style="color: #000000">reset_marker_reader</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line1290">1290: </a><span style="color: #FF0000">}</span>
<a name="line1291">1291: </a>
<a name="line1292">1292: </a>
<a name="line1293">1293: </a><span style="font-style: italic"><span style="color: #9A1900">/*</span></span>
<a name="line1294">1294: </a><span style="font-style: italic"><span style="color: #9A1900"> * Control saving of COM and APPn markers into marker_list.</span></span>
<a name="line1295">1295: </a><span style="font-style: italic"><span style="color: #9A1900"> */</span></span>
<a name="line1296">1296: </a>
<a name="line1297">1297: </a><span style="font-weight: bold"><span style="color: #000080">#ifdef</span></span> SAVE_MARKERS_SUPPORTED
<a name="line1298">1298: </a>
<a name="line1299">1299: </a><span style="font-weight: bold"><span style="color: #000000">GLOBAL</span></span><span style="color: #990000">(</span><span style="color: #009900">void</span><span style="color: #990000">)</span>
<a name="line1300">1300: </a><span style="font-weight: bold"><span style="color: #000000">jpeg_save_markers</span></span> <span style="color: #990000">(</span>j_decompress_ptr cinfo<span style="color: #990000">,</span> <span style="color: #009900">int</span> marker_code<span style="color: #990000">,</span>
<a name="line1301">1301: </a>                   <span style="color: #009900">unsigned</span> <span style="color: #009900">int</span> length_limit<span style="color: #990000">)</span>
<a name="line1302">1302: </a><span style="color: #FF0000">{</span>
<a name="line1303">1303: </a>  my_marker_ptr marker <span style="color: #990000">=</span> <span style="color: #990000">(</span>my_marker_ptr<span style="color: #990000">)</span> cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>marker<span style="color: #990000">;</span>
<a name="line1304">1304: </a>  <span style="color: #009900">long</span> maxlength<span style="color: #990000">;</span>
<a name="line1305">1305: </a>  jpeg_marker_parser_method processor<span style="color: #990000">;</span>
<a name="line1306">1306: </a>
<a name="line1307">1307: </a>  <span style="font-style: italic"><span style="color: #9A1900">/* Length limit mustn't be larger than what we can allocate</span></span>
<a name="line1308">1308: </a><span style="font-style: italic"><span style="color: #9A1900">   * (should only be a concern in a 16-bit environment).</span></span>
<a name="line1309">1309: </a><span style="font-style: italic"><span style="color: #9A1900">   */</span></span>
<a name="line1310">1310: </a>  maxlength <span style="color: #990000">=</span> cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>mem<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>max_alloc_chunk <span style="color: #990000">-</span> <span style="font-weight: bold"><span style="color: #000000">SIZEOF</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">struct</span></span> jpeg_marker_struct<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line1311">1311: </a>  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span><span style="color: #990000">(</span><span style="color: #990000">(</span><span style="color: #009900">long</span><span style="color: #990000">)</span> length_limit<span style="color: #990000">)</span> <span style="color: #990000">&gt;</span> maxlength<span style="color: #990000">)</span>
<a name="line1312">1312: </a>    length_limit <span style="color: #990000">=</span> <span style="color: #990000">(</span><span style="color: #009900">unsigned</span> <span style="color: #009900">int</span><span style="color: #990000">)</span> maxlength<span style="color: #990000">;</span>
<a name="line1313">1313: </a>
<a name="line1314">1314: </a>  <span style="font-style: italic"><span style="color: #9A1900">/* Choose processor routine to use.</span></span>
<a name="line1315">1315: </a><span style="font-style: italic"><span style="color: #9A1900">   * APP0/APP14 have special requirements.</span></span>
<a name="line1316">1316: </a><span style="font-style: italic"><span style="color: #9A1900">   */</span></span>
<a name="line1317">1317: </a>  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>length_limit<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line1318">1318: </a>    processor <span style="color: #990000">=</span> save_marker<span style="color: #990000">;</span>
<a name="line1319">1319: </a>    <span style="font-style: italic"><span style="color: #9A1900">/* If saving APP0/APP14, save at least enough for our internal use. */</span></span>
<a name="line1320">1320: </a>    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>marker_code <span style="color: #990000">=</span><span style="color: #990000">=</span> <span style="color: #990000">(</span><span style="color: #009900">int</span><span style="color: #990000">)</span> M_APP0 <span style="color: #990000">&amp;</span><span style="color: #990000">&amp;</span> length_limit <span style="color: #990000">&lt;</span> APP0_DATA_LEN<span style="color: #990000">)</span>
<a name="line1321">1321: </a>      length_limit <span style="color: #990000">=</span> APP0_DATA_LEN<span style="color: #990000">;</span>
<a name="line1322">1322: </a>    <span style="font-weight: bold"><span style="color: #0000FF">else</span></span> <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>marker_code <span style="color: #990000">=</span><span style="color: #990000">=</span> <span style="color: #990000">(</span><span style="color: #009900">int</span><span style="color: #990000">)</span> M_APP14 <span style="color: #990000">&amp;</span><span style="color: #990000">&amp;</span> length_limit <span style="color: #990000">&lt;</span> APP14_DATA_LEN<span style="color: #990000">)</span>
<a name="line1323">1323: </a>      length_limit <span style="color: #990000">=</span> APP14_DATA_LEN<span style="color: #990000">;</span>
<a name="line1324">1324: </a>  <span style="color: #FF0000">}</span> <span style="font-weight: bold"><span style="color: #0000FF">else</span></span> <span style="color: #FF0000">{</span>
<a name="line1325">1325: </a>    processor <span style="color: #990000">=</span> skip_variable<span style="color: #990000">;</span>
<a name="line1326">1326: </a>    <span style="font-style: italic"><span style="color: #9A1900">/* If discarding APP0/APP14, use our regular on-the-fly processor. */</span></span>
<a name="line1327">1327: </a>    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>marker_code <span style="color: #990000">=</span><span style="color: #990000">=</span> <span style="color: #990000">(</span><span style="color: #009900">int</span><span style="color: #990000">)</span> M_APP0 <span style="color: #990000">|</span><span style="color: #990000">|</span> marker_code <span style="color: #990000">=</span><span style="color: #990000">=</span> <span style="color: #990000">(</span><span style="color: #009900">int</span><span style="color: #990000">)</span> M_APP14<span style="color: #990000">)</span>
<a name="line1328">1328: </a>      processor <span style="color: #990000">=</span> get_interesting_appn<span style="color: #990000">;</span>
<a name="line1329">1329: </a>  <span style="color: #FF0000">}</span>
<a name="line1330">1330: </a>
<a name="line1331">1331: </a>  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>marker_code <span style="color: #990000">=</span><span style="color: #990000">=</span> <span style="color: #990000">(</span><span style="color: #009900">int</span><span style="color: #990000">)</span> M_COM<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line1332">1332: </a>    marker<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>process_COM <span style="color: #990000">=</span> processor<span style="color: #990000">;</span>
<a name="line1333">1333: </a>    marker<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>length_limit_COM <span style="color: #990000">=</span> length_limit<span style="color: #990000">;</span>
<a name="line1334">1334: </a>  <span style="color: #FF0000">}</span> <span style="font-weight: bold"><span style="color: #0000FF">else</span></span> <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>marker_code <span style="color: #990000">&gt;</span><span style="color: #990000">=</span> <span style="color: #990000">(</span><span style="color: #009900">int</span><span style="color: #990000">)</span> M_APP0 <span style="color: #990000">&amp;</span><span style="color: #990000">&amp;</span> marker_code <span style="color: #990000">&lt;</span><span style="color: #990000">=</span> <span style="color: #990000">(</span><span style="color: #009900">int</span><span style="color: #990000">)</span> M_APP15<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line1335">1335: </a>    marker<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>process_APPn<span style="color: #990000">[</span>marker_code <span style="color: #990000">-</span> <span style="color: #990000">(</span><span style="color: #009900">int</span><span style="color: #990000">)</span> M_APP0<span style="color: #990000">]</span> <span style="color: #990000">=</span> processor<span style="color: #990000">;</span>
<a name="line1336">1336: </a>    marker<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>length_limit_APPn<span style="color: #990000">[</span>marker_code <span style="color: #990000">-</span> <span style="color: #990000">(</span><span style="color: #009900">int</span><span style="color: #990000">)</span> M_APP0<span style="color: #990000">]</span> <span style="color: #990000">=</span> length_limit<span style="color: #990000">;</span>
<a name="line1337">1337: </a>  <span style="color: #FF0000">}</span> <span style="font-weight: bold"><span style="color: #0000FF">else</span></span>
<a name="line1338">1338: </a>    <span style="font-weight: bold"><span style="color: #000000">ERREXIT1</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> JERR_UNKNOWN_MARKER<span style="color: #990000">,</span> marker_code<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line1339">1339: </a><span style="color: #FF0000">}</span>
<a name="line1340">1340: </a>
<a name="line1341">1341: </a><span style="font-weight: bold"><span style="color: #000080">#endif</span></span> <span style="font-style: italic"><span style="color: #9A1900">/* SAVE_MARKERS_SUPPORTED */</span></span>
<a name="line1342">1342: </a>
<a name="line1343">1343: </a>
<a name="line1344">1344: </a><span style="font-style: italic"><span style="color: #9A1900">/*</span></span>
<a name="line1345">1345: </a><span style="font-style: italic"><span style="color: #9A1900"> * Install a special processing method for COM or APPn markers.</span></span>
<a name="line1346">1346: </a><span style="font-style: italic"><span style="color: #9A1900"> */</span></span>
<a name="line1347">1347: </a>
<a name="line1348">1348: </a><span style="font-weight: bold"><span style="color: #000000">GLOBAL</span></span><span style="color: #990000">(</span><span style="color: #009900">void</span><span style="color: #990000">)</span>
<a name="line1349">1349: </a><span style="font-weight: bold"><span style="color: #000000">jpeg_set_marker_processor</span></span> <span style="color: #990000">(</span>j_decompress_ptr cinfo<span style="color: #990000">,</span> <span style="color: #009900">int</span> marker_code<span style="color: #990000">,</span>
<a name="line1350">1350: </a>                           jpeg_marker_parser_method routine<span style="color: #990000">)</span>
<a name="line1351">1351: </a><span style="color: #FF0000">{</span>
<a name="line1352">1352: </a>  my_marker_ptr marker <span style="color: #990000">=</span> <span style="color: #990000">(</span>my_marker_ptr<span style="color: #990000">)</span> cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>marker<span style="color: #990000">;</span>
<a name="line1353">1353: </a>
<a name="line1354">1354: </a>  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>marker_code <span style="color: #990000">=</span><span style="color: #990000">=</span> <span style="color: #990000">(</span><span style="color: #009900">int</span><span style="color: #990000">)</span> M_COM<span style="color: #990000">)</span>
<a name="line1355">1355: </a>    marker<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>process_COM <span style="color: #990000">=</span> routine<span style="color: #990000">;</span>
<a name="line1356">1356: </a>  <span style="font-weight: bold"><span style="color: #0000FF">else</span></span> <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>marker_code <span style="color: #990000">&gt;</span><span style="color: #990000">=</span> <span style="color: #990000">(</span><span style="color: #009900">int</span><span style="color: #990000">)</span> M_APP0 <span style="color: #990000">&amp;</span><span style="color: #990000">&amp;</span> marker_code <span style="color: #990000">&lt;</span><span style="color: #990000">=</span> <span style="color: #990000">(</span><span style="color: #009900">int</span><span style="color: #990000">)</span> M_APP15<span style="color: #990000">)</span>
<a name="line1357">1357: </a>    marker<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>process_APPn<span style="color: #990000">[</span>marker_code <span style="color: #990000">-</span> <span style="color: #990000">(</span><span style="color: #009900">int</span><span style="color: #990000">)</span> M_APP0<span style="color: #990000">]</span> <span style="color: #990000">=</span> routine<span style="color: #990000">;</span>
<a name="line1358">1358: </a>  <span style="font-weight: bold"><span style="color: #0000FF">else</span></span>
<a name="line1359">1359: </a>    <span style="font-weight: bold"><span style="color: #000000">ERREXIT1</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> JERR_UNKNOWN_MARKER<span style="color: #990000">,</span> marker_code<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line1360">1360: </a><span style="color: #FF0000">}</span>
</tt>
</pre>
</body>
</html>
