<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
<head>
<meta http-equiv="Content-Type"
content="text/html; charset=iso-8859-1" />
<meta name="GENERATOR" content="GNU source-highlight 1.9
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite" />
<title>../src/jquant2.c</title>
</head>
<body style="background-color: #FFFFFF; color: #000000; a: #0000EE; a.visited: #551A8B; a.active: #FF0000">
<pre>
<tt>
<a name="line1">0001: </a><span style="font-style: italic"><span style="color: #9A1900">/*</span></span>
<a name="line2">0002: </a><span style="font-style: italic"><span style="color: #9A1900"> * jquant2.c</span></span>
<a name="line3">0003: </a><span style="font-style: italic"><span style="color: #9A1900"> *</span></span>
<a name="line4">0004: </a><span style="font-style: italic"><span style="color: #9A1900"> * Copyright (C) 1991-1996, Thomas G. Lane.</span></span>
<a name="line5">0005: </a><span style="font-style: italic"><span style="color: #9A1900"> * This file is part of the Independent JPEG Group's software.</span></span>
<a name="line6">0006: </a><span style="font-style: italic"><span style="color: #9A1900"> * For conditions of distribution and use, see the accompanying README file.</span></span>
<a name="line7">0007: </a><span style="font-style: italic"><span style="color: #9A1900"> *</span></span>
<a name="line8">0008: </a><span style="font-style: italic"><span style="color: #9A1900"> * This file contains 2-pass color quantization (color mapping) routines.</span></span>
<a name="line9">0009: </a><span style="font-style: italic"><span style="color: #9A1900"> * These routines provide selection of a custom color map for an image,</span></span>
<a name="line10">0010: </a><span style="font-style: italic"><span style="color: #9A1900"> * followed by mapping of the image to that color map, with optional</span></span>
<a name="line11">0011: </a><span style="font-style: italic"><span style="color: #9A1900"> * Floyd-Steinberg dithering.</span></span>
<a name="line12">0012: </a><span style="font-style: italic"><span style="color: #9A1900"> * It is also possible to use just the second pass to map to an arbitrary</span></span>
<a name="line13">0013: </a><span style="font-style: italic"><span style="color: #9A1900"> * externally-given color map.</span></span>
<a name="line14">0014: </a><span style="font-style: italic"><span style="color: #9A1900"> *</span></span>
<a name="line15">0015: </a><span style="font-style: italic"><span style="color: #9A1900"> * Note: ordered dithering is not supported, since there isn't any fast</span></span>
<a name="line16">0016: </a><span style="font-style: italic"><span style="color: #9A1900"> * way to compute intercolor distances; it's unclear that ordered dither's</span></span>
<a name="line17">0017: </a><span style="font-style: italic"><span style="color: #9A1900"> * fundamental assumptions even hold with an irregularly spaced color map.</span></span>
<a name="line18">0018: </a><span style="font-style: italic"><span style="color: #9A1900"> */</span></span>
<a name="line19">0019: </a>
<a name="line20">0020: </a><span style="font-weight: bold"><span style="color: #000080">#define</span></span> JPEG_INTERNALS
<a name="line21">0021: </a><span style="font-weight: bold"><span style="color: #000080">#include</span></span> <span style="color: #FF0000">"jinclude.h"</span>
<a name="line22">0022: </a><span style="font-weight: bold"><span style="color: #000080">#include</span></span> <span style="color: #FF0000">"jpeglib.h"</span>
<a name="line23">0023: </a>
<a name="line24">0024: </a><span style="font-weight: bold"><span style="color: #000080">#ifdef</span></span> QUANT_2PASS_SUPPORTED
<a name="line25">0025: </a>
<a name="line26">0026: </a>
<a name="line27">0027: </a><span style="font-style: italic"><span style="color: #9A1900">/*</span></span>
<a name="line28">0028: </a><span style="font-style: italic"><span style="color: #9A1900"> * This module implements the well-known Heckbert paradigm for color</span></span>
<a name="line29">0029: </a><span style="font-style: italic"><span style="color: #9A1900"> * quantization.  Most of the ideas used here can be traced back to</span></span>
<a name="line30">0030: </a><span style="font-style: italic"><span style="color: #9A1900"> * Heckbert's seminal paper</span></span>
<a name="line31">0031: </a><span style="font-style: italic"><span style="color: #9A1900"> *   Heckbert, Paul.  "Color Image Quantization for Frame Buffer Display",</span></span>
<a name="line32">0032: </a><span style="font-style: italic"><span style="color: #9A1900"> *   Proc. SIGGRAPH '82, Computer Graphics v.16 #3 (July 1982), pp 297-304.</span></span>
<a name="line33">0033: </a><span style="font-style: italic"><span style="color: #9A1900"> *</span></span>
<a name="line34">0034: </a><span style="font-style: italic"><span style="color: #9A1900"> * In the first pass over the image, we accumulate a histogram showing the</span></span>
<a name="line35">0035: </a><span style="font-style: italic"><span style="color: #9A1900"> * usage count of each possible color.  To keep the histogram to a reasonable</span></span>
<a name="line36">0036: </a><span style="font-style: italic"><span style="color: #9A1900"> * size, we reduce the precision of the input; typical practice is to retain</span></span>
<a name="line37">0037: </a><span style="font-style: italic"><span style="color: #9A1900"> * 5 or 6 bits per color, so that 8 or 4 different input values are counted</span></span>
<a name="line38">0038: </a><span style="font-style: italic"><span style="color: #9A1900"> * in the same histogram cell.</span></span>
<a name="line39">0039: </a><span style="font-style: italic"><span style="color: #9A1900"> *</span></span>
<a name="line40">0040: </a><span style="font-style: italic"><span style="color: #9A1900"> * Next, the color-selection step begins with a box representing the whole</span></span>
<a name="line41">0041: </a><span style="font-style: italic"><span style="color: #9A1900"> * color space, and repeatedly splits the "largest" remaining box until we</span></span>
<a name="line42">0042: </a><span style="font-style: italic"><span style="color: #9A1900"> * have as many boxes as desired colors.  Then the mean color in each</span></span>
<a name="line43">0043: </a><span style="font-style: italic"><span style="color: #9A1900"> * remaining box becomes one of the possible output colors.</span></span>
<a name="line44">0044: </a><span style="font-style: italic"><span style="color: #9A1900"> * </span></span>
<a name="line45">0045: </a><span style="font-style: italic"><span style="color: #9A1900"> * The second pass over the image maps each input pixel to the closest output</span></span>
<a name="line46">0046: </a><span style="font-style: italic"><span style="color: #9A1900"> * color (optionally after applying a Floyd-Steinberg dithering correction).</span></span>
<a name="line47">0047: </a><span style="font-style: italic"><span style="color: #9A1900"> * This mapping is logically trivial, but making it go fast enough requires</span></span>
<a name="line48">0048: </a><span style="font-style: italic"><span style="color: #9A1900"> * considerable care.</span></span>
<a name="line49">0049: </a><span style="font-style: italic"><span style="color: #9A1900"> *</span></span>
<a name="line50">0050: </a><span style="font-style: italic"><span style="color: #9A1900"> * Heckbert-style quantizers vary a good deal in their policies for choosing</span></span>
<a name="line51">0051: </a><span style="font-style: italic"><span style="color: #9A1900"> * the "largest" box and deciding where to cut it.  The particular policies</span></span>
<a name="line52">0052: </a><span style="font-style: italic"><span style="color: #9A1900"> * used here have proved out well in experimental comparisons, but better ones</span></span>
<a name="line53">0053: </a><span style="font-style: italic"><span style="color: #9A1900"> * may yet be found.</span></span>
<a name="line54">0054: </a><span style="font-style: italic"><span style="color: #9A1900"> *</span></span>
<a name="line55">0055: </a><span style="font-style: italic"><span style="color: #9A1900"> * In earlier versions of the IJG code, this module quantized in YCbCr color</span></span>
<a name="line56">0056: </a><span style="font-style: italic"><span style="color: #9A1900"> * space, processing the raw upsampled data without a color conversion step.</span></span>
<a name="line57">0057: </a><span style="font-style: italic"><span style="color: #9A1900"> * This allowed the color conversion math to be done only once per colormap</span></span>
<a name="line58">0058: </a><span style="font-style: italic"><span style="color: #9A1900"> * entry, not once per pixel.  However, that optimization precluded other</span></span>
<a name="line59">0059: </a><span style="font-style: italic"><span style="color: #9A1900"> * useful optimizations (such as merging color conversion with upsampling)</span></span>
<a name="line60">0060: </a><span style="font-style: italic"><span style="color: #9A1900"> * and it also interfered with desired capabilities such as quantizing to an</span></span>
<a name="line61">0061: </a><span style="font-style: italic"><span style="color: #9A1900"> * externally-supplied colormap.  We have therefore abandoned that approach.</span></span>
<a name="line62">0062: </a><span style="font-style: italic"><span style="color: #9A1900"> * The present code works in the post-conversion color space, typically RGB.</span></span>
<a name="line63">0063: </a><span style="font-style: italic"><span style="color: #9A1900"> *</span></span>
<a name="line64">0064: </a><span style="font-style: italic"><span style="color: #9A1900"> * To improve the visual quality of the results, we actually work in scaled</span></span>
<a name="line65">0065: </a><span style="font-style: italic"><span style="color: #9A1900"> * RGB space, giving G distances more weight than R, and R in turn more than</span></span>
<a name="line66">0066: </a><span style="font-style: italic"><span style="color: #9A1900"> * B.  To do everything in integer math, we must use integer scale factors.</span></span>
<a name="line67">0067: </a><span style="font-style: italic"><span style="color: #9A1900"> * The 2/3/1 scale factors used here correspond loosely to the relative</span></span>
<a name="line68">0068: </a><span style="font-style: italic"><span style="color: #9A1900"> * weights of the colors in the NTSC grayscale equation.</span></span>
<a name="line69">0069: </a><span style="font-style: italic"><span style="color: #9A1900"> * If you want to use this code to quantize a non-RGB color space, you'll</span></span>
<a name="line70">0070: </a><span style="font-style: italic"><span style="color: #9A1900"> * probably need to change these scale factors.</span></span>
<a name="line71">0071: </a><span style="font-style: italic"><span style="color: #9A1900"> */</span></span>
<a name="line72">0072: </a>
<a name="line73">0073: </a><span style="font-weight: bold"><span style="color: #000080">#define</span></span> R_SCALE <span style="color: #993399">2</span>               <span style="font-style: italic"><span style="color: #9A1900">/* scale R distances by this much */</span></span>
<a name="line74">0074: </a><span style="font-weight: bold"><span style="color: #000080">#define</span></span> G_SCALE <span style="color: #993399">3</span>               <span style="font-style: italic"><span style="color: #9A1900">/* scale G distances by this much */</span></span>
<a name="line75">0075: </a><span style="font-weight: bold"><span style="color: #000080">#define</span></span> B_SCALE <span style="color: #993399">1</span>               <span style="font-style: italic"><span style="color: #9A1900">/* and B by this much */</span></span>
<a name="line76">0076: </a>
<a name="line77">0077: </a><span style="font-style: italic"><span style="color: #9A1900">/* Relabel R/G/B as components 0/1/2, respecting the RGB ordering defined</span></span>
<a name="line78">0078: </a><span style="font-style: italic"><span style="color: #9A1900"> * in jmorecfg.h.  As the code stands, it will do the right thing for R,G,B</span></span>
<a name="line79">0079: </a><span style="font-style: italic"><span style="color: #9A1900"> * and B,G,R orders.  If you define some other weird order in jmorecfg.h,</span></span>
<a name="line80">0080: </a><span style="font-style: italic"><span style="color: #9A1900"> * you'll get compile errors until you extend this logic.  In that case</span></span>
<a name="line81">0081: </a><span style="font-style: italic"><span style="color: #9A1900"> * you'll probably want to tweak the histogram sizes too.</span></span>
<a name="line82">0082: </a><span style="font-style: italic"><span style="color: #9A1900"> */</span></span>
<a name="line83">0083: </a>
<a name="line84">0084: </a><span style="font-weight: bold"><span style="color: #000080">#if</span></span> RGB_RED <span style="color: #990000">=</span><span style="color: #990000">=</span> <span style="color: #993399">0</span>
<a name="line85">0085: </a><span style="font-weight: bold"><span style="color: #000080">#define</span></span> C0_SCALE R_SCALE
<a name="line86">0086: </a><span style="font-weight: bold"><span style="color: #000080">#endif</span></span>
<a name="line87">0087: </a><span style="font-weight: bold"><span style="color: #000080">#if</span></span> RGB_BLUE <span style="color: #990000">=</span><span style="color: #990000">=</span> <span style="color: #993399">0</span>
<a name="line88">0088: </a><span style="font-weight: bold"><span style="color: #000080">#define</span></span> C0_SCALE B_SCALE
<a name="line89">0089: </a><span style="font-weight: bold"><span style="color: #000080">#endif</span></span>
<a name="line90">0090: </a><span style="font-weight: bold"><span style="color: #000080">#if</span></span> RGB_GREEN <span style="color: #990000">=</span><span style="color: #990000">=</span> <span style="color: #993399">1</span>
<a name="line91">0091: </a><span style="font-weight: bold"><span style="color: #000080">#define</span></span> C1_SCALE G_SCALE
<a name="line92">0092: </a><span style="font-weight: bold"><span style="color: #000080">#endif</span></span>
<a name="line93">0093: </a><span style="font-weight: bold"><span style="color: #000080">#if</span></span> RGB_RED <span style="color: #990000">=</span><span style="color: #990000">=</span> <span style="color: #993399">2</span>
<a name="line94">0094: </a><span style="font-weight: bold"><span style="color: #000080">#define</span></span> C2_SCALE R_SCALE
<a name="line95">0095: </a><span style="font-weight: bold"><span style="color: #000080">#endif</span></span>
<a name="line96">0096: </a><span style="font-weight: bold"><span style="color: #000080">#if</span></span> RGB_BLUE <span style="color: #990000">=</span><span style="color: #990000">=</span> <span style="color: #993399">2</span>
<a name="line97">0097: </a><span style="font-weight: bold"><span style="color: #000080">#define</span></span> C2_SCALE B_SCALE
<a name="line98">0098: </a><span style="font-weight: bold"><span style="color: #000080">#endif</span></span>
<a name="line99">0099: </a>
<a name="line100">0100: </a>
<a name="line101">0101: </a><span style="font-style: italic"><span style="color: #9A1900">/*</span></span>
<a name="line102">0102: </a><span style="font-style: italic"><span style="color: #9A1900"> * First we have the histogram data structure and routines for creating it.</span></span>
<a name="line103">0103: </a><span style="font-style: italic"><span style="color: #9A1900"> *</span></span>
<a name="line104">0104: </a><span style="font-style: italic"><span style="color: #9A1900"> * The number of bits of precision can be adjusted by changing these symbols.</span></span>
<a name="line105">0105: </a><span style="font-style: italic"><span style="color: #9A1900"> * We recommend keeping 6 bits for G and 5 each for R and B.</span></span>
<a name="line106">0106: </a><span style="font-style: italic"><span style="color: #9A1900"> * If you have plenty of memory and cycles, 6 bits all around gives marginally</span></span>
<a name="line107">0107: </a><span style="font-style: italic"><span style="color: #9A1900"> * better results; if you are short of memory, 5 bits all around will save</span></span>
<a name="line108">0108: </a><span style="font-style: italic"><span style="color: #9A1900"> * some space but degrade the results.</span></span>
<a name="line109">0109: </a><span style="font-style: italic"><span style="color: #9A1900"> * To maintain a fully accurate histogram, we'd need to allocate a "long"</span></span>
<a name="line110">0110: </a><span style="font-style: italic"><span style="color: #9A1900"> * (preferably unsigned long) for each cell.  In practice this is overkill;</span></span>
<a name="line111">0111: </a><span style="font-style: italic"><span style="color: #9A1900"> * we can get by with 16 bits per cell.  Few of the cell counts will overflow,</span></span>
<a name="line112">0112: </a><span style="font-style: italic"><span style="color: #9A1900"> * and clamping those that do overflow to the maximum value will give close-</span></span>
<a name="line113">0113: </a><span style="font-style: italic"><span style="color: #9A1900"> * enough results.  This reduces the recommended histogram size from 256Kb</span></span>
<a name="line114">0114: </a><span style="font-style: italic"><span style="color: #9A1900"> * to 128Kb, which is a useful savings on PC-class machines.</span></span>
<a name="line115">0115: </a><span style="font-style: italic"><span style="color: #9A1900"> * (In the second pass the histogram space is re-used for pixel mapping data;</span></span>
<a name="line116">0116: </a><span style="font-style: italic"><span style="color: #9A1900"> * in that capacity, each cell must be able to store zero to the number of</span></span>
<a name="line117">0117: </a><span style="font-style: italic"><span style="color: #9A1900"> * desired colors.  16 bits/cell is plenty for that too.)</span></span>
<a name="line118">0118: </a><span style="font-style: italic"><span style="color: #9A1900"> * Since the JPEG code is intended to run in small memory model on 80x86</span></span>
<a name="line119">0119: </a><span style="font-style: italic"><span style="color: #9A1900"> * machines, we can't just allocate the histogram in one chunk.  Instead</span></span>
<a name="line120">0120: </a><span style="font-style: italic"><span style="color: #9A1900"> * of a true 3-D array, we use a row of pointers to 2-D arrays.  Each</span></span>
<a name="line121">0121: </a><span style="font-style: italic"><span style="color: #9A1900"> * pointer corresponds to a C0 value (typically 2^5 = 32 pointers) and</span></span>
<a name="line122">0122: </a><span style="font-style: italic"><span style="color: #9A1900"> * each 2-D array has 2^6*2^5 = 2048 or 2^6*2^6 = 4096 entries.  Note that</span></span>
<a name="line123">0123: </a><span style="font-style: italic"><span style="color: #9A1900"> * on 80x86 machines, the pointer row is in near memory but the actual</span></span>
<a name="line124">0124: </a><span style="font-style: italic"><span style="color: #9A1900"> * arrays are in far memory (same arrangement as we use for image arrays).</span></span>
<a name="line125">0125: </a><span style="font-style: italic"><span style="color: #9A1900"> */</span></span>
<a name="line126">0126: </a>
<a name="line127">0127: </a><span style="font-weight: bold"><span style="color: #000080">#define</span></span> <span style="font-weight: bold"><span style="color: #000000">MAXNUMCOLORS</span></span>  <span style="color: #990000">(</span>MAXJSAMPLE<span style="color: #990000">+</span><span style="color: #993399">1</span><span style="color: #990000">)</span> <span style="font-style: italic"><span style="color: #9A1900">/* maximum size of colormap */</span></span>
<a name="line128">0128: </a>
<a name="line129">0129: </a><span style="font-style: italic"><span style="color: #9A1900">/* These will do the right thing for either R,G,B or B,G,R color order,</span></span>
<a name="line130">0130: </a><span style="font-style: italic"><span style="color: #9A1900"> * but you may not like the results for other color orders.</span></span>
<a name="line131">0131: </a><span style="font-style: italic"><span style="color: #9A1900"> */</span></span>
<a name="line132">0132: </a><span style="font-weight: bold"><span style="color: #000080">#define</span></span> HIST_C0_BITS  <span style="color: #993399">5</span>         <span style="font-style: italic"><span style="color: #9A1900">/* bits of precision in R/B histogram */</span></span>
<a name="line133">0133: </a><span style="font-weight: bold"><span style="color: #000080">#define</span></span> HIST_C1_BITS  <span style="color: #993399">6</span>         <span style="font-style: italic"><span style="color: #9A1900">/* bits of precision in G histogram */</span></span>
<a name="line134">0134: </a><span style="font-weight: bold"><span style="color: #000080">#define</span></span> HIST_C2_BITS  <span style="color: #993399">5</span>         <span style="font-style: italic"><span style="color: #9A1900">/* bits of precision in B/R histogram */</span></span>
<a name="line135">0135: </a>
<a name="line136">0136: </a><span style="font-style: italic"><span style="color: #9A1900">/* Number of elements along histogram axes. */</span></span>
<a name="line137">0137: </a><span style="font-weight: bold"><span style="color: #000080">#define</span></span> <span style="font-weight: bold"><span style="color: #000000">HIST_C0_ELEMS</span></span>  <span style="color: #990000">(</span><span style="color: #993399">1</span><span style="color: #990000">&lt;</span><span style="color: #990000">&lt;</span>HIST_C0_BITS<span style="color: #990000">)</span>
<a name="line138">0138: </a><span style="font-weight: bold"><span style="color: #000080">#define</span></span> <span style="font-weight: bold"><span style="color: #000000">HIST_C1_ELEMS</span></span>  <span style="color: #990000">(</span><span style="color: #993399">1</span><span style="color: #990000">&lt;</span><span style="color: #990000">&lt;</span>HIST_C1_BITS<span style="color: #990000">)</span>
<a name="line139">0139: </a><span style="font-weight: bold"><span style="color: #000080">#define</span></span> <span style="font-weight: bold"><span style="color: #000000">HIST_C2_ELEMS</span></span>  <span style="color: #990000">(</span><span style="color: #993399">1</span><span style="color: #990000">&lt;</span><span style="color: #990000">&lt;</span>HIST_C2_BITS<span style="color: #990000">)</span>
<a name="line140">0140: </a>
<a name="line141">0141: </a><span style="font-style: italic"><span style="color: #9A1900">/* These are the amounts to shift an input value to get a histogram index. */</span></span>
<a name="line142">0142: </a><span style="font-weight: bold"><span style="color: #000080">#define</span></span> <span style="font-weight: bold"><span style="color: #000000">C0_SHIFT</span></span>  <span style="color: #990000">(</span>BITS_IN_JSAMPLE<span style="color: #990000">-</span>HIST_C0_BITS<span style="color: #990000">)</span>
<a name="line143">0143: </a><span style="font-weight: bold"><span style="color: #000080">#define</span></span> <span style="font-weight: bold"><span style="color: #000000">C1_SHIFT</span></span>  <span style="color: #990000">(</span>BITS_IN_JSAMPLE<span style="color: #990000">-</span>HIST_C1_BITS<span style="color: #990000">)</span>
<a name="line144">0144: </a><span style="font-weight: bold"><span style="color: #000080">#define</span></span> <span style="font-weight: bold"><span style="color: #000000">C2_SHIFT</span></span>  <span style="color: #990000">(</span>BITS_IN_JSAMPLE<span style="color: #990000">-</span>HIST_C2_BITS<span style="color: #990000">)</span>
<a name="line145">0145: </a>
<a name="line146">0146: </a>
<a name="line147">0147: </a><span style="font-weight: bold"><span style="color: #0000FF">typedef</span></span> UINT16 histcell<span style="color: #990000">;</span>        <span style="font-style: italic"><span style="color: #9A1900">/* histogram cell; prefer an unsigned type */</span></span>
<a name="line148">0148: </a>
<a name="line149">0149: </a><span style="font-weight: bold"><span style="color: #0000FF">typedef</span></span> histcell FAR <span style="color: #990000">*</span> histptr<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">/* for pointers to histogram cells */</span></span>
<a name="line150">0150: </a>
<a name="line151">0151: </a><span style="font-weight: bold"><span style="color: #0000FF">typedef</span></span> histcell hist1d<span style="color: #990000">[</span>HIST_C2_ELEMS<span style="color: #990000">]</span><span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">/* typedefs for the array */</span></span>
<a name="line152">0152: </a><span style="font-weight: bold"><span style="color: #0000FF">typedef</span></span> hist1d FAR <span style="color: #990000">*</span> hist2d<span style="color: #990000">;</span>    <span style="font-style: italic"><span style="color: #9A1900">/* type for the 2nd-level pointers */</span></span>
<a name="line153">0153: </a><span style="font-weight: bold"><span style="color: #0000FF">typedef</span></span> hist2d <span style="color: #990000">*</span> hist3d<span style="color: #990000">;</span>        <span style="font-style: italic"><span style="color: #9A1900">/* type for top-level pointer */</span></span>
<a name="line154">0154: </a>
<a name="line155">0155: </a>
<a name="line156">0156: </a><span style="font-style: italic"><span style="color: #9A1900">/* Declarations for Floyd-Steinberg dithering.</span></span>
<a name="line157">0157: </a><span style="font-style: italic"><span style="color: #9A1900"> *</span></span>
<a name="line158">0158: </a><span style="font-style: italic"><span style="color: #9A1900"> * Errors are accumulated into the array fserrors[], at a resolution of</span></span>
<a name="line159">0159: </a><span style="font-style: italic"><span style="color: #9A1900"> * 1/16th of a pixel count.  The error at a given pixel is propagated</span></span>
<a name="line160">0160: </a><span style="font-style: italic"><span style="color: #9A1900"> * to its not-yet-processed neighbors using the standard F-S fractions,</span></span>
<a name="line161">0161: </a><span style="font-style: italic"><span style="color: #9A1900"> *              ...     (here)  7/16</span></span>
<a name="line162">0162: </a><span style="font-style: italic"><span style="color: #9A1900"> *              3/16    5/16    1/16</span></span>
<a name="line163">0163: </a><span style="font-style: italic"><span style="color: #9A1900"> * We work left-to-right on even rows, right-to-left on odd rows.</span></span>
<a name="line164">0164: </a><span style="font-style: italic"><span style="color: #9A1900"> *</span></span>
<a name="line165">0165: </a><span style="font-style: italic"><span style="color: #9A1900"> * We can get away with a single array (holding one row's worth of errors)</span></span>
<a name="line166">0166: </a><span style="font-style: italic"><span style="color: #9A1900"> * by using it to store the current row's errors at pixel columns not yet</span></span>
<a name="line167">0167: </a><span style="font-style: italic"><span style="color: #9A1900"> * processed, but the next row's errors at columns already processed.  We</span></span>
<a name="line168">0168: </a><span style="font-style: italic"><span style="color: #9A1900"> * need only a few extra variables to hold the errors immediately around the</span></span>
<a name="line169">0169: </a><span style="font-style: italic"><span style="color: #9A1900"> * current column.  (If we are lucky, those variables are in registers, but</span></span>
<a name="line170">0170: </a><span style="font-style: italic"><span style="color: #9A1900"> * even if not, they're probably cheaper to access than array elements are.)</span></span>
<a name="line171">0171: </a><span style="font-style: italic"><span style="color: #9A1900"> *</span></span>
<a name="line172">0172: </a><span style="font-style: italic"><span style="color: #9A1900"> * The fserrors[] array has (#columns + 2) entries; the extra entry at</span></span>
<a name="line173">0173: </a><span style="font-style: italic"><span style="color: #9A1900"> * each end saves us from special-casing the first and last pixels.</span></span>
<a name="line174">0174: </a><span style="font-style: italic"><span style="color: #9A1900"> * Each entry is three values long, one value for each color component.</span></span>
<a name="line175">0175: </a><span style="font-style: italic"><span style="color: #9A1900"> *</span></span>
<a name="line176">0176: </a><span style="font-style: italic"><span style="color: #9A1900"> * Note: on a wide image, we might not have enough room in a PC's near data</span></span>
<a name="line177">0177: </a><span style="font-style: italic"><span style="color: #9A1900"> * segment to hold the error array; so it is allocated with alloc_large.</span></span>
<a name="line178">0178: </a><span style="font-style: italic"><span style="color: #9A1900"> */</span></span>
<a name="line179">0179: </a>
<a name="line180">0180: </a><span style="font-weight: bold"><span style="color: #000080">#if</span></span> BITS_IN_JSAMPLE <span style="color: #990000">=</span><span style="color: #990000">=</span> <span style="color: #993399">8</span>
<a name="line181">0181: </a><span style="font-weight: bold"><span style="color: #0000FF">typedef</span></span> INT16 FSERROR<span style="color: #990000">;</span>          <span style="font-style: italic"><span style="color: #9A1900">/* 16 bits should be enough */</span></span>
<a name="line182">0182: </a><span style="font-weight: bold"><span style="color: #0000FF">typedef</span></span> <span style="color: #009900">int</span> LOCFSERROR<span style="color: #990000">;</span>         <span style="font-style: italic"><span style="color: #9A1900">/* use 'int' for calculation temps */</span></span>
<a name="line183">0183: </a><span style="font-weight: bold"><span style="color: #000080">#else</span></span>
<a name="line184">0184: </a><span style="font-weight: bold"><span style="color: #0000FF">typedef</span></span> INT32 FSERROR<span style="color: #990000">;</span>          <span style="font-style: italic"><span style="color: #9A1900">/* may need more than 16 bits */</span></span>
<a name="line185">0185: </a><span style="font-weight: bold"><span style="color: #0000FF">typedef</span></span> INT32 LOCFSERROR<span style="color: #990000">;</span>       <span style="font-style: italic"><span style="color: #9A1900">/* be sure calculation temps are big enough */</span></span>
<a name="line186">0186: </a><span style="font-weight: bold"><span style="color: #000080">#endif</span></span>
<a name="line187">0187: </a>
<a name="line188">0188: </a><span style="font-weight: bold"><span style="color: #0000FF">typedef</span></span> FSERROR FAR <span style="color: #990000">*</span>FSERRPTR<span style="color: #990000">;</span>  <span style="font-style: italic"><span style="color: #9A1900">/* pointer to error array (in FAR storage!) */</span></span>
<a name="line189">0189: </a>
<a name="line190">0190: </a>
<a name="line191">0191: </a><span style="font-style: italic"><span style="color: #9A1900">/* Private subobject */</span></span>
<a name="line192">0192: </a>
<a name="line193">0193: </a><span style="font-weight: bold"><span style="color: #0000FF">typedef</span></span> <span style="font-weight: bold"><span style="color: #0000FF">struct</span></span> <span style="color: #FF0000">{</span>
<a name="line194">0194: </a>  <span style="font-weight: bold"><span style="color: #0000FF">struct</span></span> jpeg_color_quantizer pub<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">/* public fields */</span></span>
<a name="line195">0195: </a>
<a name="line196">0196: </a>  <span style="font-style: italic"><span style="color: #9A1900">/* Space for the eventually created colormap is stashed here */</span></span>
<a name="line197">0197: </a>  JSAMPARRAY sv_colormap<span style="color: #990000">;</span>       <span style="font-style: italic"><span style="color: #9A1900">/* colormap allocated at init time */</span></span>
<a name="line198">0198: </a>  <span style="color: #009900">int</span> desired<span style="color: #990000">;</span>                  <span style="font-style: italic"><span style="color: #9A1900">/* desired # of colors = size of colormap */</span></span>
<a name="line199">0199: </a>
<a name="line200">0200: </a>  <span style="font-style: italic"><span style="color: #9A1900">/* Variables for accumulating image statistics */</span></span>
<a name="line201">0201: </a>  hist3d histogram<span style="color: #990000">;</span>             <span style="font-style: italic"><span style="color: #9A1900">/* pointer to the histogram */</span></span>
<a name="line202">0202: </a>
<a name="line203">0203: </a>  boolean needs_zeroed<span style="color: #990000">;</span>         <span style="font-style: italic"><span style="color: #9A1900">/* TRUE if next pass must zero histogram */</span></span>
<a name="line204">0204: </a>
<a name="line205">0205: </a>  <span style="font-style: italic"><span style="color: #9A1900">/* Variables for Floyd-Steinberg dithering */</span></span>
<a name="line206">0206: </a>  FSERRPTR fserrors<span style="color: #990000">;</span>            <span style="font-style: italic"><span style="color: #9A1900">/* accumulated errors */</span></span>
<a name="line207">0207: </a>  boolean on_odd_row<span style="color: #990000">;</span>           <span style="font-style: italic"><span style="color: #9A1900">/* flag to remember which row we are on */</span></span>
<a name="line208">0208: </a>  <span style="color: #009900">int</span> <span style="color: #990000">*</span> error_limiter<span style="color: #990000">;</span>          <span style="font-style: italic"><span style="color: #9A1900">/* table for clamping the applied error */</span></span>
<a name="line209">0209: </a><span style="color: #FF0000">}</span> my_cquantizer<span style="color: #990000">;</span>
<a name="line210">0210: </a>
<a name="line211">0211: </a><span style="font-weight: bold"><span style="color: #0000FF">typedef</span></span> my_cquantizer <span style="color: #990000">*</span> my_cquantize_ptr<span style="color: #990000">;</span>
<a name="line212">0212: </a>
<a name="line213">0213: </a>
<a name="line214">0214: </a><span style="font-style: italic"><span style="color: #9A1900">/*</span></span>
<a name="line215">0215: </a><span style="font-style: italic"><span style="color: #9A1900"> * Prescan some rows of pixels.</span></span>
<a name="line216">0216: </a><span style="font-style: italic"><span style="color: #9A1900"> * In this module the prescan simply updates the histogram, which has been</span></span>
<a name="line217">0217: </a><span style="font-style: italic"><span style="color: #9A1900"> * initialized to zeroes by start_pass.</span></span>
<a name="line218">0218: </a><span style="font-style: italic"><span style="color: #9A1900"> * An output_buf parameter is required by the method signature, but no data</span></span>
<a name="line219">0219: </a><span style="font-style: italic"><span style="color: #9A1900"> * is actually output (in fact the buffer controller is probably passing a</span></span>
<a name="line220">0220: </a><span style="font-style: italic"><span style="color: #9A1900"> * NULL pointer).</span></span>
<a name="line221">0221: </a><span style="font-style: italic"><span style="color: #9A1900"> */</span></span>
<a name="line222">0222: </a>
<a name="line223">0223: </a><span style="font-weight: bold"><span style="color: #000000">METHODDEF</span></span><span style="color: #990000">(</span><span style="color: #009900">void</span><span style="color: #990000">)</span>
<a name="line224">0224: </a><span style="font-weight: bold"><span style="color: #000000">prescan_quantize</span></span> <span style="color: #990000">(</span>j_decompress_ptr cinfo<span style="color: #990000">,</span> JSAMPARRAY input_buf<span style="color: #990000">,</span>
<a name="line225">0225: </a>                  JSAMPARRAY output_buf<span style="color: #990000">,</span> <span style="color: #009900">int</span> num_rows<span style="color: #990000">)</span>
<a name="line226">0226: </a><span style="color: #FF0000">{</span>
<a name="line227">0227: </a>  my_cquantize_ptr cquantize <span style="color: #990000">=</span> <span style="color: #990000">(</span>my_cquantize_ptr<span style="color: #990000">)</span> cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>cquantize<span style="color: #990000">;</span>
<a name="line228">0228: </a>  <span style="font-weight: bold"><span style="color: #0000FF">register</span></span> JSAMPROW ptr<span style="color: #990000">;</span>
<a name="line229">0229: </a>  <span style="font-weight: bold"><span style="color: #0000FF">register</span></span> histptr histp<span style="color: #990000">;</span>
<a name="line230">0230: </a>  <span style="font-weight: bold"><span style="color: #0000FF">register</span></span> hist3d histogram <span style="color: #990000">=</span> cquantize<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>histogram<span style="color: #990000">;</span>
<a name="line231">0231: </a>  <span style="color: #009900">int</span> row<span style="color: #990000">;</span>
<a name="line232">0232: </a>  JDIMENSION col<span style="color: #990000">;</span>
<a name="line233">0233: </a>  JDIMENSION width <span style="color: #990000">=</span> cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>output_width<span style="color: #990000">;</span>
<a name="line234">0234: </a>
<a name="line235">0235: </a>  <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> <span style="color: #990000">(</span>row <span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">;</span> row <span style="color: #990000">&lt;</span> num_rows<span style="color: #990000">;</span> row<span style="color: #990000">+</span><span style="color: #990000">+</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line236">0236: </a>    ptr <span style="color: #990000">=</span> input_buf<span style="color: #990000">[</span>row<span style="color: #990000">]</span><span style="color: #990000">;</span>
<a name="line237">0237: </a>    <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> <span style="color: #990000">(</span>col <span style="color: #990000">=</span> width<span style="color: #990000">;</span> col <span style="color: #990000">&gt;</span> <span style="color: #993399">0</span><span style="color: #990000">;</span> col<span style="color: #990000">-</span><span style="color: #990000">-</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line238">0238: </a>      <span style="font-style: italic"><span style="color: #9A1900">/* get pixel value and index into the histogram */</span></span>
<a name="line239">0239: </a>      histp <span style="color: #990000">=</span> <span style="color: #990000">&amp;</span> histogram<span style="color: #990000">[</span><span style="font-weight: bold"><span style="color: #000000">GETJSAMPLE</span></span><span style="color: #990000">(</span>ptr<span style="color: #990000">[</span><span style="color: #993399">0</span><span style="color: #990000">]</span><span style="color: #990000">)</span> <span style="color: #990000">&gt;</span><span style="color: #990000">&gt;</span> C0_SHIFT<span style="color: #990000">]</span>
<a name="line240">0240: </a>                         <span style="color: #990000">[</span><span style="font-weight: bold"><span style="color: #000000">GETJSAMPLE</span></span><span style="color: #990000">(</span>ptr<span style="color: #990000">[</span><span style="color: #993399">1</span><span style="color: #990000">]</span><span style="color: #990000">)</span> <span style="color: #990000">&gt;</span><span style="color: #990000">&gt;</span> C1_SHIFT<span style="color: #990000">]</span>
<a name="line241">0241: </a>                         <span style="color: #990000">[</span><span style="font-weight: bold"><span style="color: #000000">GETJSAMPLE</span></span><span style="color: #990000">(</span>ptr<span style="color: #990000">[</span><span style="color: #993399">2</span><span style="color: #990000">]</span><span style="color: #990000">)</span> <span style="color: #990000">&gt;</span><span style="color: #990000">&gt;</span> C2_SHIFT<span style="color: #990000">]</span><span style="color: #990000">;</span>
<a name="line242">0242: </a>      <span style="font-style: italic"><span style="color: #9A1900">/* increment, check for overflow and undo increment if so. */</span></span>
<a name="line243">0243: </a>      <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span><span style="color: #990000">+</span><span style="color: #990000">+</span><span style="color: #990000">(</span><span style="color: #990000">*</span>histp<span style="color: #990000">)</span> <span style="color: #990000">&lt;</span><span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">)</span>
<a name="line244">0244: </a>        <span style="color: #990000">(</span><span style="color: #990000">*</span>histp<span style="color: #990000">)</span><span style="color: #990000">-</span><span style="color: #990000">-</span><span style="color: #990000">;</span>
<a name="line245">0245: </a>      ptr <span style="color: #990000">+</span><span style="color: #990000">=</span> <span style="color: #993399">3</span><span style="color: #990000">;</span>
<a name="line246">0246: </a>    <span style="color: #FF0000">}</span>
<a name="line247">0247: </a>  <span style="color: #FF0000">}</span>
<a name="line248">0248: </a><span style="color: #FF0000">}</span>
<a name="line249">0249: </a>
<a name="line250">0250: </a>
<a name="line251">0251: </a><span style="font-style: italic"><span style="color: #9A1900">/*</span></span>
<a name="line252">0252: </a><span style="font-style: italic"><span style="color: #9A1900"> * Next we have the really interesting routines: selection of a colormap</span></span>
<a name="line253">0253: </a><span style="font-style: italic"><span style="color: #9A1900"> * given the completed histogram.</span></span>
<a name="line254">0254: </a><span style="font-style: italic"><span style="color: #9A1900"> * These routines work with a list of "boxes", each representing a rectangular</span></span>
<a name="line255">0255: </a><span style="font-style: italic"><span style="color: #9A1900"> * subset of the input color space (to histogram precision).</span></span>
<a name="line256">0256: </a><span style="font-style: italic"><span style="color: #9A1900"> */</span></span>
<a name="line257">0257: </a>
<a name="line258">0258: </a><span style="font-weight: bold"><span style="color: #0000FF">typedef</span></span> <span style="font-weight: bold"><span style="color: #0000FF">struct</span></span> <span style="color: #FF0000">{</span>
<a name="line259">0259: </a>  <span style="font-style: italic"><span style="color: #9A1900">/* The bounds of the box (inclusive); expressed as histogram indexes */</span></span>
<a name="line260">0260: </a>  <span style="color: #009900">int</span> c0min<span style="color: #990000">,</span> c0max<span style="color: #990000">;</span>
<a name="line261">0261: </a>  <span style="color: #009900">int</span> c1min<span style="color: #990000">,</span> c1max<span style="color: #990000">;</span>
<a name="line262">0262: </a>  <span style="color: #009900">int</span> c2min<span style="color: #990000">,</span> c2max<span style="color: #990000">;</span>
<a name="line263">0263: </a>  <span style="font-style: italic"><span style="color: #9A1900">/* The volume (actually 2-norm) of the box */</span></span>
<a name="line264">0264: </a>  INT32 volume<span style="color: #990000">;</span>
<a name="line265">0265: </a>  <span style="font-style: italic"><span style="color: #9A1900">/* The number of nonzero histogram cells within this box */</span></span>
<a name="line266">0266: </a>  <span style="color: #009900">long</span> colorcount<span style="color: #990000">;</span>
<a name="line267">0267: </a><span style="color: #FF0000">}</span> box<span style="color: #990000">;</span>
<a name="line268">0268: </a>
<a name="line269">0269: </a><span style="font-weight: bold"><span style="color: #0000FF">typedef</span></span> box <span style="color: #990000">*</span> boxptr<span style="color: #990000">;</span>
<a name="line270">0270: </a>
<a name="line271">0271: </a>
<a name="line272">0272: </a><span style="font-weight: bold"><span style="color: #000000">LOCAL</span></span><span style="color: #990000">(</span>boxptr<span style="color: #990000">)</span>
<a name="line273">0273: </a><span style="font-weight: bold"><span style="color: #000000">find_biggest_color_pop</span></span> <span style="color: #990000">(</span>boxptr boxlist<span style="color: #990000">,</span> <span style="color: #009900">int</span> numboxes<span style="color: #990000">)</span>
<a name="line274">0274: </a><span style="font-style: italic"><span style="color: #9A1900">/* Find the splittable box with the largest color population */</span></span>
<a name="line275">0275: </a><span style="font-style: italic"><span style="color: #9A1900">/* Returns NULL if no splittable boxes remain */</span></span>
<a name="line276">0276: </a><span style="color: #FF0000">{</span>
<a name="line277">0277: </a>  <span style="font-weight: bold"><span style="color: #0000FF">register</span></span> boxptr boxp<span style="color: #990000">;</span>
<a name="line278">0278: </a>  <span style="font-weight: bold"><span style="color: #0000FF">register</span></span> <span style="color: #009900">int</span> i<span style="color: #990000">;</span>
<a name="line279">0279: </a>  <span style="font-weight: bold"><span style="color: #0000FF">register</span></span> <span style="color: #009900">long</span> maxc <span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">;</span>
<a name="line280">0280: </a>  boxptr which <span style="color: #990000">=</span> NULL<span style="color: #990000">;</span>
<a name="line281">0281: </a>  
<a name="line282">0282: </a>  <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> <span style="color: #990000">(</span>i <span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">,</span> boxp <span style="color: #990000">=</span> boxlist<span style="color: #990000">;</span> i <span style="color: #990000">&lt;</span> numboxes<span style="color: #990000">;</span> i<span style="color: #990000">+</span><span style="color: #990000">+</span><span style="color: #990000">,</span> boxp<span style="color: #990000">+</span><span style="color: #990000">+</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line283">0283: </a>    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>boxp<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>colorcount <span style="color: #990000">&gt;</span> maxc <span style="color: #990000">&amp;</span><span style="color: #990000">&amp;</span> boxp<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>volume <span style="color: #990000">&gt;</span> <span style="color: #993399">0</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line284">0284: </a>      which <span style="color: #990000">=</span> boxp<span style="color: #990000">;</span>
<a name="line285">0285: </a>      maxc <span style="color: #990000">=</span> boxp<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>colorcount<span style="color: #990000">;</span>
<a name="line286">0286: </a>    <span style="color: #FF0000">}</span>
<a name="line287">0287: </a>  <span style="color: #FF0000">}</span>
<a name="line288">0288: </a>  <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> which<span style="color: #990000">;</span>
<a name="line289">0289: </a><span style="color: #FF0000">}</span>
<a name="line290">0290: </a>
<a name="line291">0291: </a>
<a name="line292">0292: </a><span style="font-weight: bold"><span style="color: #000000">LOCAL</span></span><span style="color: #990000">(</span>boxptr<span style="color: #990000">)</span>
<a name="line293">0293: </a><span style="font-weight: bold"><span style="color: #000000">find_biggest_volume</span></span> <span style="color: #990000">(</span>boxptr boxlist<span style="color: #990000">,</span> <span style="color: #009900">int</span> numboxes<span style="color: #990000">)</span>
<a name="line294">0294: </a><span style="font-style: italic"><span style="color: #9A1900">/* Find the splittable box with the largest (scaled) volume */</span></span>
<a name="line295">0295: </a><span style="font-style: italic"><span style="color: #9A1900">/* Returns NULL if no splittable boxes remain */</span></span>
<a name="line296">0296: </a><span style="color: #FF0000">{</span>
<a name="line297">0297: </a>  <span style="font-weight: bold"><span style="color: #0000FF">register</span></span> boxptr boxp<span style="color: #990000">;</span>
<a name="line298">0298: </a>  <span style="font-weight: bold"><span style="color: #0000FF">register</span></span> <span style="color: #009900">int</span> i<span style="color: #990000">;</span>
<a name="line299">0299: </a>  <span style="font-weight: bold"><span style="color: #0000FF">register</span></span> INT32 maxv <span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">;</span>
<a name="line300">0300: </a>  boxptr which <span style="color: #990000">=</span> NULL<span style="color: #990000">;</span>
<a name="line301">0301: </a>  
<a name="line302">0302: </a>  <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> <span style="color: #990000">(</span>i <span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">,</span> boxp <span style="color: #990000">=</span> boxlist<span style="color: #990000">;</span> i <span style="color: #990000">&lt;</span> numboxes<span style="color: #990000">;</span> i<span style="color: #990000">+</span><span style="color: #990000">+</span><span style="color: #990000">,</span> boxp<span style="color: #990000">+</span><span style="color: #990000">+</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line303">0303: </a>    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>boxp<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>volume <span style="color: #990000">&gt;</span> maxv<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line304">0304: </a>      which <span style="color: #990000">=</span> boxp<span style="color: #990000">;</span>
<a name="line305">0305: </a>      maxv <span style="color: #990000">=</span> boxp<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>volume<span style="color: #990000">;</span>
<a name="line306">0306: </a>    <span style="color: #FF0000">}</span>
<a name="line307">0307: </a>  <span style="color: #FF0000">}</span>
<a name="line308">0308: </a>  <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> which<span style="color: #990000">;</span>
<a name="line309">0309: </a><span style="color: #FF0000">}</span>
<a name="line310">0310: </a>
<a name="line311">0311: </a>
<a name="line312">0312: </a><span style="font-weight: bold"><span style="color: #000000">LOCAL</span></span><span style="color: #990000">(</span><span style="color: #009900">void</span><span style="color: #990000">)</span>
<a name="line313">0313: </a><span style="font-weight: bold"><span style="color: #000000">update_box</span></span> <span style="color: #990000">(</span>j_decompress_ptr cinfo<span style="color: #990000">,</span> boxptr boxp<span style="color: #990000">)</span>
<a name="line314">0314: </a><span style="font-style: italic"><span style="color: #9A1900">/* Shrink the min/max bounds of a box to enclose only nonzero elements, */</span></span>
<a name="line315">0315: </a><span style="font-style: italic"><span style="color: #9A1900">/* and recompute its volume and population */</span></span>
<a name="line316">0316: </a><span style="color: #FF0000">{</span>
<a name="line317">0317: </a>  my_cquantize_ptr cquantize <span style="color: #990000">=</span> <span style="color: #990000">(</span>my_cquantize_ptr<span style="color: #990000">)</span> cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>cquantize<span style="color: #990000">;</span>
<a name="line318">0318: </a>  hist3d histogram <span style="color: #990000">=</span> cquantize<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>histogram<span style="color: #990000">;</span>
<a name="line319">0319: </a>  histptr histp<span style="color: #990000">;</span>
<a name="line320">0320: </a>  <span style="color: #009900">int</span> c0<span style="color: #990000">,</span>c1<span style="color: #990000">,</span>c2<span style="color: #990000">;</span>
<a name="line321">0321: </a>  <span style="color: #009900">int</span> c0min<span style="color: #990000">,</span>c0max<span style="color: #990000">,</span>c1min<span style="color: #990000">,</span>c1max<span style="color: #990000">,</span>c2min<span style="color: #990000">,</span>c2max<span style="color: #990000">;</span>
<a name="line322">0322: </a>  INT32 dist0<span style="color: #990000">,</span>dist1<span style="color: #990000">,</span>dist2<span style="color: #990000">;</span>
<a name="line323">0323: </a>  <span style="color: #009900">long</span> ccount<span style="color: #990000">;</span>
<a name="line324">0324: </a>  
<a name="line325">0325: </a>  c0min <span style="color: #990000">=</span> boxp<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>c0min<span style="color: #990000">;</span>  c0max <span style="color: #990000">=</span> boxp<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>c0max<span style="color: #990000">;</span>
<a name="line326">0326: </a>  c1min <span style="color: #990000">=</span> boxp<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>c1min<span style="color: #990000">;</span>  c1max <span style="color: #990000">=</span> boxp<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>c1max<span style="color: #990000">;</span>
<a name="line327">0327: </a>  c2min <span style="color: #990000">=</span> boxp<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>c2min<span style="color: #990000">;</span>  c2max <span style="color: #990000">=</span> boxp<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>c2max<span style="color: #990000">;</span>
<a name="line328">0328: </a>  
<a name="line329">0329: </a>  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>c0max <span style="color: #990000">&gt;</span> c0min<span style="color: #990000">)</span>
<a name="line330">0330: </a>    <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> <span style="color: #990000">(</span>c0 <span style="color: #990000">=</span> c0min<span style="color: #990000">;</span> c0 <span style="color: #990000">&lt;</span><span style="color: #990000">=</span> c0max<span style="color: #990000">;</span> c0<span style="color: #990000">+</span><span style="color: #990000">+</span><span style="color: #990000">)</span>
<a name="line331">0331: </a>      <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> <span style="color: #990000">(</span>c1 <span style="color: #990000">=</span> c1min<span style="color: #990000">;</span> c1 <span style="color: #990000">&lt;</span><span style="color: #990000">=</span> c1max<span style="color: #990000">;</span> c1<span style="color: #990000">+</span><span style="color: #990000">+</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line332">0332: </a>        histp <span style="color: #990000">=</span> <span style="color: #990000">&amp;</span> histogram<span style="color: #990000">[</span>c0<span style="color: #990000">]</span><span style="color: #990000">[</span>c1<span style="color: #990000">]</span><span style="color: #990000">[</span>c2min<span style="color: #990000">]</span><span style="color: #990000">;</span>
<a name="line333">0333: </a>        <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> <span style="color: #990000">(</span>c2 <span style="color: #990000">=</span> c2min<span style="color: #990000">;</span> c2 <span style="color: #990000">&lt;</span><span style="color: #990000">=</span> c2max<span style="color: #990000">;</span> c2<span style="color: #990000">+</span><span style="color: #990000">+</span><span style="color: #990000">)</span>
<a name="line334">0334: </a>          <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span><span style="color: #990000">*</span>histp<span style="color: #990000">+</span><span style="color: #990000">+</span> <span style="color: #990000">!</span><span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line335">0335: </a>            boxp<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>c0min <span style="color: #990000">=</span> c0min <span style="color: #990000">=</span> c0<span style="color: #990000">;</span>
<a name="line336">0336: </a>            <span style="font-weight: bold"><span style="color: #0000FF">goto</span></span> have_c0min<span style="color: #990000">;</span>
<a name="line337">0337: </a>          <span style="color: #FF0000">}</span>
<a name="line338">0338: </a>      <span style="color: #FF0000">}</span>
<a name="line339">0339: </a> have_c0min<span style="color: #990000">:</span>
<a name="line340">0340: </a>  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>c0max <span style="color: #990000">&gt;</span> c0min<span style="color: #990000">)</span>
<a name="line341">0341: </a>    <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> <span style="color: #990000">(</span>c0 <span style="color: #990000">=</span> c0max<span style="color: #990000">;</span> c0 <span style="color: #990000">&gt;</span><span style="color: #990000">=</span> c0min<span style="color: #990000">;</span> c0<span style="color: #990000">-</span><span style="color: #990000">-</span><span style="color: #990000">)</span>
<a name="line342">0342: </a>      <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> <span style="color: #990000">(</span>c1 <span style="color: #990000">=</span> c1min<span style="color: #990000">;</span> c1 <span style="color: #990000">&lt;</span><span style="color: #990000">=</span> c1max<span style="color: #990000">;</span> c1<span style="color: #990000">+</span><span style="color: #990000">+</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line343">0343: </a>        histp <span style="color: #990000">=</span> <span style="color: #990000">&amp;</span> histogram<span style="color: #990000">[</span>c0<span style="color: #990000">]</span><span style="color: #990000">[</span>c1<span style="color: #990000">]</span><span style="color: #990000">[</span>c2min<span style="color: #990000">]</span><span style="color: #990000">;</span>
<a name="line344">0344: </a>        <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> <span style="color: #990000">(</span>c2 <span style="color: #990000">=</span> c2min<span style="color: #990000">;</span> c2 <span style="color: #990000">&lt;</span><span style="color: #990000">=</span> c2max<span style="color: #990000">;</span> c2<span style="color: #990000">+</span><span style="color: #990000">+</span><span style="color: #990000">)</span>
<a name="line345">0345: </a>          <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span><span style="color: #990000">*</span>histp<span style="color: #990000">+</span><span style="color: #990000">+</span> <span style="color: #990000">!</span><span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line346">0346: </a>            boxp<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>c0max <span style="color: #990000">=</span> c0max <span style="color: #990000">=</span> c0<span style="color: #990000">;</span>
<a name="line347">0347: </a>            <span style="font-weight: bold"><span style="color: #0000FF">goto</span></span> have_c0max<span style="color: #990000">;</span>
<a name="line348">0348: </a>          <span style="color: #FF0000">}</span>
<a name="line349">0349: </a>      <span style="color: #FF0000">}</span>
<a name="line350">0350: </a> have_c0max<span style="color: #990000">:</span>
<a name="line351">0351: </a>  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>c1max <span style="color: #990000">&gt;</span> c1min<span style="color: #990000">)</span>
<a name="line352">0352: </a>    <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> <span style="color: #990000">(</span>c1 <span style="color: #990000">=</span> c1min<span style="color: #990000">;</span> c1 <span style="color: #990000">&lt;</span><span style="color: #990000">=</span> c1max<span style="color: #990000">;</span> c1<span style="color: #990000">+</span><span style="color: #990000">+</span><span style="color: #990000">)</span>
<a name="line353">0353: </a>      <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> <span style="color: #990000">(</span>c0 <span style="color: #990000">=</span> c0min<span style="color: #990000">;</span> c0 <span style="color: #990000">&lt;</span><span style="color: #990000">=</span> c0max<span style="color: #990000">;</span> c0<span style="color: #990000">+</span><span style="color: #990000">+</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line354">0354: </a>        histp <span style="color: #990000">=</span> <span style="color: #990000">&amp;</span> histogram<span style="color: #990000">[</span>c0<span style="color: #990000">]</span><span style="color: #990000">[</span>c1<span style="color: #990000">]</span><span style="color: #990000">[</span>c2min<span style="color: #990000">]</span><span style="color: #990000">;</span>
<a name="line355">0355: </a>        <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> <span style="color: #990000">(</span>c2 <span style="color: #990000">=</span> c2min<span style="color: #990000">;</span> c2 <span style="color: #990000">&lt;</span><span style="color: #990000">=</span> c2max<span style="color: #990000">;</span> c2<span style="color: #990000">+</span><span style="color: #990000">+</span><span style="color: #990000">)</span>
<a name="line356">0356: </a>          <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span><span style="color: #990000">*</span>histp<span style="color: #990000">+</span><span style="color: #990000">+</span> <span style="color: #990000">!</span><span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line357">0357: </a>            boxp<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>c1min <span style="color: #990000">=</span> c1min <span style="color: #990000">=</span> c1<span style="color: #990000">;</span>
<a name="line358">0358: </a>            <span style="font-weight: bold"><span style="color: #0000FF">goto</span></span> have_c1min<span style="color: #990000">;</span>
<a name="line359">0359: </a>          <span style="color: #FF0000">}</span>
<a name="line360">0360: </a>      <span style="color: #FF0000">}</span>
<a name="line361">0361: </a> have_c1min<span style="color: #990000">:</span>
<a name="line362">0362: </a>  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>c1max <span style="color: #990000">&gt;</span> c1min<span style="color: #990000">)</span>
<a name="line363">0363: </a>    <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> <span style="color: #990000">(</span>c1 <span style="color: #990000">=</span> c1max<span style="color: #990000">;</span> c1 <span style="color: #990000">&gt;</span><span style="color: #990000">=</span> c1min<span style="color: #990000">;</span> c1<span style="color: #990000">-</span><span style="color: #990000">-</span><span style="color: #990000">)</span>
<a name="line364">0364: </a>      <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> <span style="color: #990000">(</span>c0 <span style="color: #990000">=</span> c0min<span style="color: #990000">;</span> c0 <span style="color: #990000">&lt;</span><span style="color: #990000">=</span> c0max<span style="color: #990000">;</span> c0<span style="color: #990000">+</span><span style="color: #990000">+</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line365">0365: </a>        histp <span style="color: #990000">=</span> <span style="color: #990000">&amp;</span> histogram<span style="color: #990000">[</span>c0<span style="color: #990000">]</span><span style="color: #990000">[</span>c1<span style="color: #990000">]</span><span style="color: #990000">[</span>c2min<span style="color: #990000">]</span><span style="color: #990000">;</span>
<a name="line366">0366: </a>        <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> <span style="color: #990000">(</span>c2 <span style="color: #990000">=</span> c2min<span style="color: #990000">;</span> c2 <span style="color: #990000">&lt;</span><span style="color: #990000">=</span> c2max<span style="color: #990000">;</span> c2<span style="color: #990000">+</span><span style="color: #990000">+</span><span style="color: #990000">)</span>
<a name="line367">0367: </a>          <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span><span style="color: #990000">*</span>histp<span style="color: #990000">+</span><span style="color: #990000">+</span> <span style="color: #990000">!</span><span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line368">0368: </a>            boxp<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>c1max <span style="color: #990000">=</span> c1max <span style="color: #990000">=</span> c1<span style="color: #990000">;</span>
<a name="line369">0369: </a>            <span style="font-weight: bold"><span style="color: #0000FF">goto</span></span> have_c1max<span style="color: #990000">;</span>
<a name="line370">0370: </a>          <span style="color: #FF0000">}</span>
<a name="line371">0371: </a>      <span style="color: #FF0000">}</span>
<a name="line372">0372: </a> have_c1max<span style="color: #990000">:</span>
<a name="line373">0373: </a>  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>c2max <span style="color: #990000">&gt;</span> c2min<span style="color: #990000">)</span>
<a name="line374">0374: </a>    <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> <span style="color: #990000">(</span>c2 <span style="color: #990000">=</span> c2min<span style="color: #990000">;</span> c2 <span style="color: #990000">&lt;</span><span style="color: #990000">=</span> c2max<span style="color: #990000">;</span> c2<span style="color: #990000">+</span><span style="color: #990000">+</span><span style="color: #990000">)</span>
<a name="line375">0375: </a>      <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> <span style="color: #990000">(</span>c0 <span style="color: #990000">=</span> c0min<span style="color: #990000">;</span> c0 <span style="color: #990000">&lt;</span><span style="color: #990000">=</span> c0max<span style="color: #990000">;</span> c0<span style="color: #990000">+</span><span style="color: #990000">+</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line376">0376: </a>        histp <span style="color: #990000">=</span> <span style="color: #990000">&amp;</span> histogram<span style="color: #990000">[</span>c0<span style="color: #990000">]</span><span style="color: #990000">[</span>c1min<span style="color: #990000">]</span><span style="color: #990000">[</span>c2<span style="color: #990000">]</span><span style="color: #990000">;</span>
<a name="line377">0377: </a>        <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> <span style="color: #990000">(</span>c1 <span style="color: #990000">=</span> c1min<span style="color: #990000">;</span> c1 <span style="color: #990000">&lt;</span><span style="color: #990000">=</span> c1max<span style="color: #990000">;</span> c1<span style="color: #990000">+</span><span style="color: #990000">+</span><span style="color: #990000">,</span> histp <span style="color: #990000">+</span><span style="color: #990000">=</span> HIST_C2_ELEMS<span style="color: #990000">)</span>
<a name="line378">0378: </a>          <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span><span style="color: #990000">*</span>histp <span style="color: #990000">!</span><span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line379">0379: </a>            boxp<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>c2min <span style="color: #990000">=</span> c2min <span style="color: #990000">=</span> c2<span style="color: #990000">;</span>
<a name="line380">0380: </a>            <span style="font-weight: bold"><span style="color: #0000FF">goto</span></span> have_c2min<span style="color: #990000">;</span>
<a name="line381">0381: </a>          <span style="color: #FF0000">}</span>
<a name="line382">0382: </a>      <span style="color: #FF0000">}</span>
<a name="line383">0383: </a> have_c2min<span style="color: #990000">:</span>
<a name="line384">0384: </a>  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>c2max <span style="color: #990000">&gt;</span> c2min<span style="color: #990000">)</span>
<a name="line385">0385: </a>    <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> <span style="color: #990000">(</span>c2 <span style="color: #990000">=</span> c2max<span style="color: #990000">;</span> c2 <span style="color: #990000">&gt;</span><span style="color: #990000">=</span> c2min<span style="color: #990000">;</span> c2<span style="color: #990000">-</span><span style="color: #990000">-</span><span style="color: #990000">)</span>
<a name="line386">0386: </a>      <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> <span style="color: #990000">(</span>c0 <span style="color: #990000">=</span> c0min<span style="color: #990000">;</span> c0 <span style="color: #990000">&lt;</span><span style="color: #990000">=</span> c0max<span style="color: #990000">;</span> c0<span style="color: #990000">+</span><span style="color: #990000">+</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line387">0387: </a>        histp <span style="color: #990000">=</span> <span style="color: #990000">&amp;</span> histogram<span style="color: #990000">[</span>c0<span style="color: #990000">]</span><span style="color: #990000">[</span>c1min<span style="color: #990000">]</span><span style="color: #990000">[</span>c2<span style="color: #990000">]</span><span style="color: #990000">;</span>
<a name="line388">0388: </a>        <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> <span style="color: #990000">(</span>c1 <span style="color: #990000">=</span> c1min<span style="color: #990000">;</span> c1 <span style="color: #990000">&lt;</span><span style="color: #990000">=</span> c1max<span style="color: #990000">;</span> c1<span style="color: #990000">+</span><span style="color: #990000">+</span><span style="color: #990000">,</span> histp <span style="color: #990000">+</span><span style="color: #990000">=</span> HIST_C2_ELEMS<span style="color: #990000">)</span>
<a name="line389">0389: </a>          <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span><span style="color: #990000">*</span>histp <span style="color: #990000">!</span><span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line390">0390: </a>            boxp<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>c2max <span style="color: #990000">=</span> c2max <span style="color: #990000">=</span> c2<span style="color: #990000">;</span>
<a name="line391">0391: </a>            <span style="font-weight: bold"><span style="color: #0000FF">goto</span></span> have_c2max<span style="color: #990000">;</span>
<a name="line392">0392: </a>          <span style="color: #FF0000">}</span>
<a name="line393">0393: </a>      <span style="color: #FF0000">}</span>
<a name="line394">0394: </a> have_c2max<span style="color: #990000">:</span>
<a name="line395">0395: </a>
<a name="line396">0396: </a>  <span style="font-style: italic"><span style="color: #9A1900">/* Update box volume.</span></span>
<a name="line397">0397: </a><span style="font-style: italic"><span style="color: #9A1900">   * We use 2-norm rather than real volume here; this biases the method</span></span>
<a name="line398">0398: </a><span style="font-style: italic"><span style="color: #9A1900">   * against making long narrow boxes, and it has the side benefit that</span></span>
<a name="line399">0399: </a><span style="font-style: italic"><span style="color: #9A1900">   * a box is splittable iff norm &gt; 0.</span></span>
<a name="line400">0400: </a><span style="font-style: italic"><span style="color: #9A1900">   * Since the differences are expressed in histogram-cell units,</span></span>
<a name="line401">0401: </a><span style="font-style: italic"><span style="color: #9A1900">   * we have to shift back to JSAMPLE units to get consistent distances;</span></span>
<a name="line402">0402: </a><span style="font-style: italic"><span style="color: #9A1900">   * after which, we scale according to the selected distance scale factors.</span></span>
<a name="line403">0403: </a><span style="font-style: italic"><span style="color: #9A1900">   */</span></span>
<a name="line404">0404: </a>  dist0 <span style="color: #990000">=</span> <span style="color: #990000">(</span><span style="color: #990000">(</span>c0max <span style="color: #990000">-</span> c0min<span style="color: #990000">)</span> <span style="color: #990000">&lt;</span><span style="color: #990000">&lt;</span> C0_SHIFT<span style="color: #990000">)</span> <span style="color: #990000">*</span> C0_SCALE<span style="color: #990000">;</span>
<a name="line405">0405: </a>  dist1 <span style="color: #990000">=</span> <span style="color: #990000">(</span><span style="color: #990000">(</span>c1max <span style="color: #990000">-</span> c1min<span style="color: #990000">)</span> <span style="color: #990000">&lt;</span><span style="color: #990000">&lt;</span> C1_SHIFT<span style="color: #990000">)</span> <span style="color: #990000">*</span> C1_SCALE<span style="color: #990000">;</span>
<a name="line406">0406: </a>  dist2 <span style="color: #990000">=</span> <span style="color: #990000">(</span><span style="color: #990000">(</span>c2max <span style="color: #990000">-</span> c2min<span style="color: #990000">)</span> <span style="color: #990000">&lt;</span><span style="color: #990000">&lt;</span> C2_SHIFT<span style="color: #990000">)</span> <span style="color: #990000">*</span> C2_SCALE<span style="color: #990000">;</span>
<a name="line407">0407: </a>  boxp<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>volume <span style="color: #990000">=</span> dist0<span style="color: #990000">*</span>dist0 <span style="color: #990000">+</span> dist1<span style="color: #990000">*</span>dist1 <span style="color: #990000">+</span> dist2<span style="color: #990000">*</span>dist2<span style="color: #990000">;</span>
<a name="line408">0408: </a>  
<a name="line409">0409: </a>  <span style="font-style: italic"><span style="color: #9A1900">/* Now scan remaining volume of box and compute population */</span></span>
<a name="line410">0410: </a>  ccount <span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">;</span>
<a name="line411">0411: </a>  <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> <span style="color: #990000">(</span>c0 <span style="color: #990000">=</span> c0min<span style="color: #990000">;</span> c0 <span style="color: #990000">&lt;</span><span style="color: #990000">=</span> c0max<span style="color: #990000">;</span> c0<span style="color: #990000">+</span><span style="color: #990000">+</span><span style="color: #990000">)</span>
<a name="line412">0412: </a>    <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> <span style="color: #990000">(</span>c1 <span style="color: #990000">=</span> c1min<span style="color: #990000">;</span> c1 <span style="color: #990000">&lt;</span><span style="color: #990000">=</span> c1max<span style="color: #990000">;</span> c1<span style="color: #990000">+</span><span style="color: #990000">+</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line413">0413: </a>      histp <span style="color: #990000">=</span> <span style="color: #990000">&amp;</span> histogram<span style="color: #990000">[</span>c0<span style="color: #990000">]</span><span style="color: #990000">[</span>c1<span style="color: #990000">]</span><span style="color: #990000">[</span>c2min<span style="color: #990000">]</span><span style="color: #990000">;</span>
<a name="line414">0414: </a>      <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> <span style="color: #990000">(</span>c2 <span style="color: #990000">=</span> c2min<span style="color: #990000">;</span> c2 <span style="color: #990000">&lt;</span><span style="color: #990000">=</span> c2max<span style="color: #990000">;</span> c2<span style="color: #990000">+</span><span style="color: #990000">+</span><span style="color: #990000">,</span> histp<span style="color: #990000">+</span><span style="color: #990000">+</span><span style="color: #990000">)</span>
<a name="line415">0415: </a>        <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span><span style="color: #990000">*</span>histp <span style="color: #990000">!</span><span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line416">0416: </a>          ccount<span style="color: #990000">+</span><span style="color: #990000">+</span><span style="color: #990000">;</span>
<a name="line417">0417: </a>        <span style="color: #FF0000">}</span>
<a name="line418">0418: </a>    <span style="color: #FF0000">}</span>
<a name="line419">0419: </a>  boxp<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>colorcount <span style="color: #990000">=</span> ccount<span style="color: #990000">;</span>
<a name="line420">0420: </a><span style="color: #FF0000">}</span>
<a name="line421">0421: </a>
<a name="line422">0422: </a>
<a name="line423">0423: </a><span style="font-weight: bold"><span style="color: #000000">LOCAL</span></span><span style="color: #990000">(</span><span style="color: #009900">int</span><span style="color: #990000">)</span>
<a name="line424">0424: </a><span style="font-weight: bold"><span style="color: #000000">median_cut</span></span> <span style="color: #990000">(</span>j_decompress_ptr cinfo<span style="color: #990000">,</span> boxptr boxlist<span style="color: #990000">,</span> <span style="color: #009900">int</span> numboxes<span style="color: #990000">,</span>
<a name="line425">0425: </a>            <span style="color: #009900">int</span> desired_colors<span style="color: #990000">)</span>
<a name="line426">0426: </a><span style="font-style: italic"><span style="color: #9A1900">/* Repeatedly select and split the largest box until we have enough boxes */</span></span>
<a name="line427">0427: </a><span style="color: #FF0000">{</span>
<a name="line428">0428: </a>  <span style="color: #009900">int</span> n<span style="color: #990000">,</span>lb<span style="color: #990000">;</span>
<a name="line429">0429: </a>  <span style="color: #009900">int</span> c0<span style="color: #990000">,</span>c1<span style="color: #990000">,</span>c2<span style="color: #990000">,</span>cmax<span style="color: #990000">;</span>
<a name="line430">0430: </a>  <span style="font-weight: bold"><span style="color: #0000FF">register</span></span> boxptr b1<span style="color: #990000">,</span>b2<span style="color: #990000">;</span>
<a name="line431">0431: </a>
<a name="line432">0432: </a>  <span style="font-weight: bold"><span style="color: #0000FF">while</span></span> <span style="color: #990000">(</span>numboxes <span style="color: #990000">&lt;</span> desired_colors<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line433">0433: </a>    <span style="font-style: italic"><span style="color: #9A1900">/* Select box to split.</span></span>
<a name="line434">0434: </a><span style="font-style: italic"><span style="color: #9A1900">     * Current algorithm: by population for first half, then by volume.</span></span>
<a name="line435">0435: </a><span style="font-style: italic"><span style="color: #9A1900">     */</span></span>
<a name="line436">0436: </a>    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>numboxes<span style="color: #990000">*</span><span style="color: #993399">2</span> <span style="color: #990000">&lt;</span><span style="color: #990000">=</span> desired_colors<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line437">0437: </a>      b1 <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">find_biggest_color_pop</span></span><span style="color: #990000">(</span>boxlist<span style="color: #990000">,</span> numboxes<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line438">0438: </a>    <span style="color: #FF0000">}</span> <span style="font-weight: bold"><span style="color: #0000FF">else</span></span> <span style="color: #FF0000">{</span>
<a name="line439">0439: </a>      b1 <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">find_biggest_volume</span></span><span style="color: #990000">(</span>boxlist<span style="color: #990000">,</span> numboxes<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line440">0440: </a>    <span style="color: #FF0000">}</span>
<a name="line441">0441: </a>    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>b1 <span style="color: #990000">=</span><span style="color: #990000">=</span> NULL<span style="color: #990000">)</span>             <span style="font-style: italic"><span style="color: #9A1900">/* no splittable boxes left! */</span></span>
<a name="line442">0442: </a>      <span style="font-weight: bold"><span style="color: #0000FF">break</span></span><span style="color: #990000">;</span>
<a name="line443">0443: </a>    b2 <span style="color: #990000">=</span> <span style="color: #990000">&amp;</span>boxlist<span style="color: #990000">[</span>numboxes<span style="color: #990000">]</span><span style="color: #990000">;</span>    <span style="font-style: italic"><span style="color: #9A1900">/* where new box will go */</span></span>
<a name="line444">0444: </a>    <span style="font-style: italic"><span style="color: #9A1900">/* Copy the color bounds to the new box. */</span></span>
<a name="line445">0445: </a>    b2<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>c0max <span style="color: #990000">=</span> b1<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>c0max<span style="color: #990000">;</span> b2<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>c1max <span style="color: #990000">=</span> b1<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>c1max<span style="color: #990000">;</span> b2<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>c2max <span style="color: #990000">=</span> b1<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>c2max<span style="color: #990000">;</span>
<a name="line446">0446: </a>    b2<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>c0min <span style="color: #990000">=</span> b1<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>c0min<span style="color: #990000">;</span> b2<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>c1min <span style="color: #990000">=</span> b1<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>c1min<span style="color: #990000">;</span> b2<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>c2min <span style="color: #990000">=</span> b1<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>c2min<span style="color: #990000">;</span>
<a name="line447">0447: </a>    <span style="font-style: italic"><span style="color: #9A1900">/* Choose which axis to split the box on.</span></span>
<a name="line448">0448: </a><span style="font-style: italic"><span style="color: #9A1900">     * Current algorithm: longest scaled axis.</span></span>
<a name="line449">0449: </a><span style="font-style: italic"><span style="color: #9A1900">     * See notes in update_box about scaling distances.</span></span>
<a name="line450">0450: </a><span style="font-style: italic"><span style="color: #9A1900">     */</span></span>
<a name="line451">0451: </a>    c0 <span style="color: #990000">=</span> <span style="color: #990000">(</span><span style="color: #990000">(</span>b1<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>c0max <span style="color: #990000">-</span> b1<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>c0min<span style="color: #990000">)</span> <span style="color: #990000">&lt;</span><span style="color: #990000">&lt;</span> C0_SHIFT<span style="color: #990000">)</span> <span style="color: #990000">*</span> C0_SCALE<span style="color: #990000">;</span>
<a name="line452">0452: </a>    c1 <span style="color: #990000">=</span> <span style="color: #990000">(</span><span style="color: #990000">(</span>b1<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>c1max <span style="color: #990000">-</span> b1<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>c1min<span style="color: #990000">)</span> <span style="color: #990000">&lt;</span><span style="color: #990000">&lt;</span> C1_SHIFT<span style="color: #990000">)</span> <span style="color: #990000">*</span> C1_SCALE<span style="color: #990000">;</span>
<a name="line453">0453: </a>    c2 <span style="color: #990000">=</span> <span style="color: #990000">(</span><span style="color: #990000">(</span>b1<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>c2max <span style="color: #990000">-</span> b1<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>c2min<span style="color: #990000">)</span> <span style="color: #990000">&lt;</span><span style="color: #990000">&lt;</span> C2_SHIFT<span style="color: #990000">)</span> <span style="color: #990000">*</span> C2_SCALE<span style="color: #990000">;</span>
<a name="line454">0454: </a>    <span style="font-style: italic"><span style="color: #9A1900">/* We want to break any ties in favor of green, then red, blue last.</span></span>
<a name="line455">0455: </a><span style="font-style: italic"><span style="color: #9A1900">     * This code does the right thing for R,G,B or B,G,R color orders only.</span></span>
<a name="line456">0456: </a><span style="font-style: italic"><span style="color: #9A1900">     */</span></span>
<a name="line457">0457: </a><span style="font-weight: bold"><span style="color: #000080">#if</span></span> RGB_RED <span style="color: #990000">=</span><span style="color: #990000">=</span> <span style="color: #993399">0</span>
<a name="line458">0458: </a>    cmax <span style="color: #990000">=</span> c1<span style="color: #990000">;</span> n <span style="color: #990000">=</span> <span style="color: #993399">1</span><span style="color: #990000">;</span>
<a name="line459">0459: </a>    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>c0 <span style="color: #990000">&gt;</span> cmax<span style="color: #990000">)</span> <span style="color: #FF0000">{</span> cmax <span style="color: #990000">=</span> c0<span style="color: #990000">;</span> n <span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">;</span> <span style="color: #FF0000">}</span>
<a name="line460">0460: </a>    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>c2 <span style="color: #990000">&gt;</span> cmax<span style="color: #990000">)</span> <span style="color: #FF0000">{</span> n <span style="color: #990000">=</span> <span style="color: #993399">2</span><span style="color: #990000">;</span> <span style="color: #FF0000">}</span>
<a name="line461">0461: </a><span style="font-weight: bold"><span style="color: #000080">#else</span></span>
<a name="line462">0462: </a>    cmax <span style="color: #990000">=</span> c1<span style="color: #990000">;</span> n <span style="color: #990000">=</span> <span style="color: #993399">1</span><span style="color: #990000">;</span>
<a name="line463">0463: </a>    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>c2 <span style="color: #990000">&gt;</span> cmax<span style="color: #990000">)</span> <span style="color: #FF0000">{</span> cmax <span style="color: #990000">=</span> c2<span style="color: #990000">;</span> n <span style="color: #990000">=</span> <span style="color: #993399">2</span><span style="color: #990000">;</span> <span style="color: #FF0000">}</span>
<a name="line464">0464: </a>    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>c0 <span style="color: #990000">&gt;</span> cmax<span style="color: #990000">)</span> <span style="color: #FF0000">{</span> n <span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">;</span> <span style="color: #FF0000">}</span>
<a name="line465">0465: </a><span style="font-weight: bold"><span style="color: #000080">#endif</span></span>
<a name="line466">0466: </a>    <span style="font-style: italic"><span style="color: #9A1900">/* Choose split point along selected axis, and update box bounds.</span></span>
<a name="line467">0467: </a><span style="font-style: italic"><span style="color: #9A1900">     * Current algorithm: split at halfway point.</span></span>
<a name="line468">0468: </a><span style="font-style: italic"><span style="color: #9A1900">     * (Since the box has been shrunk to minimum volume,</span></span>
<a name="line469">0469: </a><span style="font-style: italic"><span style="color: #9A1900">     * any split will produce two nonempty subboxes.)</span></span>
<a name="line470">0470: </a><span style="font-style: italic"><span style="color: #9A1900">     * Note that lb value is max for lower box, so must be &lt; old max.</span></span>
<a name="line471">0471: </a><span style="font-style: italic"><span style="color: #9A1900">     */</span></span>
<a name="line472">0472: </a>    <span style="font-weight: bold"><span style="color: #0000FF">switch</span></span> <span style="color: #990000">(</span>n<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line473">0473: </a>    <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> <span style="color: #993399">0</span><span style="color: #990000">:</span>
<a name="line474">0474: </a>      lb <span style="color: #990000">=</span> <span style="color: #990000">(</span>b1<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>c0max <span style="color: #990000">+</span> b1<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>c0min<span style="color: #990000">)</span> <span style="color: #990000">/</span> <span style="color: #993399">2</span><span style="color: #990000">;</span>
<a name="line475">0475: </a>      b1<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>c0max <span style="color: #990000">=</span> lb<span style="color: #990000">;</span>
<a name="line476">0476: </a>      b2<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>c0min <span style="color: #990000">=</span> lb<span style="color: #990000">+</span><span style="color: #993399">1</span><span style="color: #990000">;</span>
<a name="line477">0477: </a>      <span style="font-weight: bold"><span style="color: #0000FF">break</span></span><span style="color: #990000">;</span>
<a name="line478">0478: </a>    <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> <span style="color: #993399">1</span><span style="color: #990000">:</span>
<a name="line479">0479: </a>      lb <span style="color: #990000">=</span> <span style="color: #990000">(</span>b1<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>c1max <span style="color: #990000">+</span> b1<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>c1min<span style="color: #990000">)</span> <span style="color: #990000">/</span> <span style="color: #993399">2</span><span style="color: #990000">;</span>
<a name="line480">0480: </a>      b1<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>c1max <span style="color: #990000">=</span> lb<span style="color: #990000">;</span>
<a name="line481">0481: </a>      b2<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>c1min <span style="color: #990000">=</span> lb<span style="color: #990000">+</span><span style="color: #993399">1</span><span style="color: #990000">;</span>
<a name="line482">0482: </a>      <span style="font-weight: bold"><span style="color: #0000FF">break</span></span><span style="color: #990000">;</span>
<a name="line483">0483: </a>    <span style="font-weight: bold"><span style="color: #0000FF">case</span></span> <span style="color: #993399">2</span><span style="color: #990000">:</span>
<a name="line484">0484: </a>      lb <span style="color: #990000">=</span> <span style="color: #990000">(</span>b1<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>c2max <span style="color: #990000">+</span> b1<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>c2min<span style="color: #990000">)</span> <span style="color: #990000">/</span> <span style="color: #993399">2</span><span style="color: #990000">;</span>
<a name="line485">0485: </a>      b1<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>c2max <span style="color: #990000">=</span> lb<span style="color: #990000">;</span>
<a name="line486">0486: </a>      b2<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>c2min <span style="color: #990000">=</span> lb<span style="color: #990000">+</span><span style="color: #993399">1</span><span style="color: #990000">;</span>
<a name="line487">0487: </a>      <span style="font-weight: bold"><span style="color: #0000FF">break</span></span><span style="color: #990000">;</span>
<a name="line488">0488: </a>    <span style="color: #FF0000">}</span>
<a name="line489">0489: </a>    <span style="font-style: italic"><span style="color: #9A1900">/* Update stats for boxes */</span></span>
<a name="line490">0490: </a>    <span style="font-weight: bold"><span style="color: #000000">update_box</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> b1<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line491">0491: </a>    <span style="font-weight: bold"><span style="color: #000000">update_box</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> b2<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line492">0492: </a>    numboxes<span style="color: #990000">+</span><span style="color: #990000">+</span><span style="color: #990000">;</span>
<a name="line493">0493: </a>  <span style="color: #FF0000">}</span>
<a name="line494">0494: </a>  <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> numboxes<span style="color: #990000">;</span>
<a name="line495">0495: </a><span style="color: #FF0000">}</span>
<a name="line496">0496: </a>
<a name="line497">0497: </a>
<a name="line498">0498: </a><span style="font-weight: bold"><span style="color: #000000">LOCAL</span></span><span style="color: #990000">(</span><span style="color: #009900">void</span><span style="color: #990000">)</span>
<a name="line499">0499: </a><span style="font-weight: bold"><span style="color: #000000">compute_color</span></span> <span style="color: #990000">(</span>j_decompress_ptr cinfo<span style="color: #990000">,</span> boxptr boxp<span style="color: #990000">,</span> <span style="color: #009900">int</span> icolor<span style="color: #990000">)</span>
<a name="line500">0500: </a><span style="font-style: italic"><span style="color: #9A1900">/* Compute representative color for a box, put it in colormap[icolor] */</span></span>
<a name="line501">0501: </a><span style="color: #FF0000">{</span>
<a name="line502">0502: </a>  <span style="font-style: italic"><span style="color: #9A1900">/* Current algorithm: mean weighted by pixels (not colors) */</span></span>
<a name="line503">0503: </a>  <span style="font-style: italic"><span style="color: #9A1900">/* Note it is important to get the rounding correct! */</span></span>
<a name="line504">0504: </a>  my_cquantize_ptr cquantize <span style="color: #990000">=</span> <span style="color: #990000">(</span>my_cquantize_ptr<span style="color: #990000">)</span> cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>cquantize<span style="color: #990000">;</span>
<a name="line505">0505: </a>  hist3d histogram <span style="color: #990000">=</span> cquantize<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>histogram<span style="color: #990000">;</span>
<a name="line506">0506: </a>  histptr histp<span style="color: #990000">;</span>
<a name="line507">0507: </a>  <span style="color: #009900">int</span> c0<span style="color: #990000">,</span>c1<span style="color: #990000">,</span>c2<span style="color: #990000">;</span>
<a name="line508">0508: </a>  <span style="color: #009900">int</span> c0min<span style="color: #990000">,</span>c0max<span style="color: #990000">,</span>c1min<span style="color: #990000">,</span>c1max<span style="color: #990000">,</span>c2min<span style="color: #990000">,</span>c2max<span style="color: #990000">;</span>
<a name="line509">0509: </a>  <span style="color: #009900">long</span> count<span style="color: #990000">;</span>
<a name="line510">0510: </a>  <span style="color: #009900">long</span> total <span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">;</span>
<a name="line511">0511: </a>  <span style="color: #009900">long</span> c0total <span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">;</span>
<a name="line512">0512: </a>  <span style="color: #009900">long</span> c1total <span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">;</span>
<a name="line513">0513: </a>  <span style="color: #009900">long</span> c2total <span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">;</span>
<a name="line514">0514: </a>  
<a name="line515">0515: </a>  c0min <span style="color: #990000">=</span> boxp<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>c0min<span style="color: #990000">;</span>  c0max <span style="color: #990000">=</span> boxp<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>c0max<span style="color: #990000">;</span>
<a name="line516">0516: </a>  c1min <span style="color: #990000">=</span> boxp<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>c1min<span style="color: #990000">;</span>  c1max <span style="color: #990000">=</span> boxp<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>c1max<span style="color: #990000">;</span>
<a name="line517">0517: </a>  c2min <span style="color: #990000">=</span> boxp<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>c2min<span style="color: #990000">;</span>  c2max <span style="color: #990000">=</span> boxp<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>c2max<span style="color: #990000">;</span>
<a name="line518">0518: </a>  
<a name="line519">0519: </a>  <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> <span style="color: #990000">(</span>c0 <span style="color: #990000">=</span> c0min<span style="color: #990000">;</span> c0 <span style="color: #990000">&lt;</span><span style="color: #990000">=</span> c0max<span style="color: #990000">;</span> c0<span style="color: #990000">+</span><span style="color: #990000">+</span><span style="color: #990000">)</span>
<a name="line520">0520: </a>    <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> <span style="color: #990000">(</span>c1 <span style="color: #990000">=</span> c1min<span style="color: #990000">;</span> c1 <span style="color: #990000">&lt;</span><span style="color: #990000">=</span> c1max<span style="color: #990000">;</span> c1<span style="color: #990000">+</span><span style="color: #990000">+</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line521">0521: </a>      histp <span style="color: #990000">=</span> <span style="color: #990000">&amp;</span> histogram<span style="color: #990000">[</span>c0<span style="color: #990000">]</span><span style="color: #990000">[</span>c1<span style="color: #990000">]</span><span style="color: #990000">[</span>c2min<span style="color: #990000">]</span><span style="color: #990000">;</span>
<a name="line522">0522: </a>      <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> <span style="color: #990000">(</span>c2 <span style="color: #990000">=</span> c2min<span style="color: #990000">;</span> c2 <span style="color: #990000">&lt;</span><span style="color: #990000">=</span> c2max<span style="color: #990000">;</span> c2<span style="color: #990000">+</span><span style="color: #990000">+</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line523">0523: </a>        <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span><span style="color: #990000">(</span>count <span style="color: #990000">=</span> <span style="color: #990000">*</span>histp<span style="color: #990000">+</span><span style="color: #990000">+</span><span style="color: #990000">)</span> <span style="color: #990000">!</span><span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line524">0524: </a>          total <span style="color: #990000">+</span><span style="color: #990000">=</span> count<span style="color: #990000">;</span>
<a name="line525">0525: </a>          c0total <span style="color: #990000">+</span><span style="color: #990000">=</span> <span style="color: #990000">(</span><span style="color: #990000">(</span>c0 <span style="color: #990000">&lt;</span><span style="color: #990000">&lt;</span> C0_SHIFT<span style="color: #990000">)</span> <span style="color: #990000">+</span> <span style="color: #990000">(</span><span style="color: #990000">(</span><span style="color: #993399">1</span><span style="color: #FF0000">&lt;&lt;C0_SHIFT)&gt;&gt;</span><span style="color: #993399">1</span><span style="color: #990000">)</span><span style="color: #990000">)</span> <span style="color: #990000">*</span> count<span style="color: #990000">;</span>
<a name="line526">0526: </a>          c1total <span style="color: #990000">+</span><span style="color: #990000">=</span> <span style="color: #990000">(</span><span style="color: #990000">(</span>c1 <span style="color: #990000">&lt;</span><span style="color: #990000">&lt;</span> C1_SHIFT<span style="color: #990000">)</span> <span style="color: #990000">+</span> <span style="color: #990000">(</span><span style="color: #990000">(</span><span style="color: #993399">1</span><span style="color: #FF0000">&lt;&lt;C1_SHIFT)&gt;&gt;</span><span style="color: #993399">1</span><span style="color: #990000">)</span><span style="color: #990000">)</span> <span style="color: #990000">*</span> count<span style="color: #990000">;</span>
<a name="line527">0527: </a>          c2total <span style="color: #990000">+</span><span style="color: #990000">=</span> <span style="color: #990000">(</span><span style="color: #990000">(</span>c2 <span style="color: #990000">&lt;</span><span style="color: #990000">&lt;</span> C2_SHIFT<span style="color: #990000">)</span> <span style="color: #990000">+</span> <span style="color: #990000">(</span><span style="color: #990000">(</span><span style="color: #993399">1</span><span style="color: #FF0000">&lt;&lt;C2_SHIFT)&gt;&gt;</span><span style="color: #993399">1</span><span style="color: #990000">)</span><span style="color: #990000">)</span> <span style="color: #990000">*</span> count<span style="color: #990000">;</span>
<a name="line528">0528: </a>        <span style="color: #FF0000">}</span>
<a name="line529">0529: </a>      <span style="color: #FF0000">}</span>
<a name="line530">0530: </a>    <span style="color: #FF0000">}</span>
<a name="line531">0531: </a>  
<a name="line532">0532: </a>  cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>colormap<span style="color: #990000">[</span><span style="color: #993399">0</span><span style="color: #990000">]</span><span style="color: #990000">[</span>icolor<span style="color: #990000">]</span> <span style="color: #990000">=</span> <span style="color: #990000">(</span>JSAMPLE<span style="color: #990000">)</span> <span style="color: #990000">(</span><span style="color: #990000">(</span>c0total <span style="color: #990000">+</span> <span style="color: #990000">(</span>total<span style="color: #990000">&gt;</span><span style="color: #990000">&gt;</span><span style="color: #993399">1</span><span style="color: #990000">)</span><span style="color: #990000">)</span> <span style="color: #990000">/</span> total<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line533">0533: </a>  cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>colormap<span style="color: #990000">[</span><span style="color: #993399">1</span><span style="color: #990000">]</span><span style="color: #990000">[</span>icolor<span style="color: #990000">]</span> <span style="color: #990000">=</span> <span style="color: #990000">(</span>JSAMPLE<span style="color: #990000">)</span> <span style="color: #990000">(</span><span style="color: #990000">(</span>c1total <span style="color: #990000">+</span> <span style="color: #990000">(</span>total<span style="color: #990000">&gt;</span><span style="color: #990000">&gt;</span><span style="color: #993399">1</span><span style="color: #990000">)</span><span style="color: #990000">)</span> <span style="color: #990000">/</span> total<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line534">0534: </a>  cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>colormap<span style="color: #990000">[</span><span style="color: #993399">2</span><span style="color: #990000">]</span><span style="color: #990000">[</span>icolor<span style="color: #990000">]</span> <span style="color: #990000">=</span> <span style="color: #990000">(</span>JSAMPLE<span style="color: #990000">)</span> <span style="color: #990000">(</span><span style="color: #990000">(</span>c2total <span style="color: #990000">+</span> <span style="color: #990000">(</span>total<span style="color: #990000">&gt;</span><span style="color: #990000">&gt;</span><span style="color: #993399">1</span><span style="color: #990000">)</span><span style="color: #990000">)</span> <span style="color: #990000">/</span> total<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line535">0535: </a><span style="color: #FF0000">}</span>
<a name="line536">0536: </a>
<a name="line537">0537: </a>
<a name="line538">0538: </a><span style="font-weight: bold"><span style="color: #000000">LOCAL</span></span><span style="color: #990000">(</span><span style="color: #009900">void</span><span style="color: #990000">)</span>
<a name="line539">0539: </a><span style="font-weight: bold"><span style="color: #000000">select_colors</span></span> <span style="color: #990000">(</span>j_decompress_ptr cinfo<span style="color: #990000">,</span> <span style="color: #009900">int</span> desired_colors<span style="color: #990000">)</span>
<a name="line540">0540: </a><span style="font-style: italic"><span style="color: #9A1900">/* Master routine for color selection */</span></span>
<a name="line541">0541: </a><span style="color: #FF0000">{</span>
<a name="line542">0542: </a>  boxptr boxlist<span style="color: #990000">;</span>
<a name="line543">0543: </a>  <span style="color: #009900">int</span> numboxes<span style="color: #990000">;</span>
<a name="line544">0544: </a>  <span style="color: #009900">int</span> i<span style="color: #990000">;</span>
<a name="line545">0545: </a>
<a name="line546">0546: </a>  <span style="font-style: italic"><span style="color: #9A1900">/* Allocate workspace for box list */</span></span>
<a name="line547">0547: </a>  boxlist <span style="color: #990000">=</span> <span style="color: #990000">(</span>boxptr<span style="color: #990000">)</span> <span style="color: #990000">(</span><span style="color: #990000">*</span>cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>mem<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>alloc_small<span style="color: #990000">)</span>
<a name="line548">0548: </a>    <span style="color: #990000">(</span><span style="color: #990000">(</span>j_common_ptr<span style="color: #990000">)</span> cinfo<span style="color: #990000">,</span> JPOOL_IMAGE<span style="color: #990000">,</span> desired_colors <span style="color: #990000">*</span> <span style="font-weight: bold"><span style="color: #000000">SIZEOF</span></span><span style="color: #990000">(</span>box<span style="color: #990000">)</span><span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line549">0549: </a>  <span style="font-style: italic"><span style="color: #9A1900">/* Initialize one box containing whole space */</span></span>
<a name="line550">0550: </a>  numboxes <span style="color: #990000">=</span> <span style="color: #993399">1</span><span style="color: #990000">;</span>
<a name="line551">0551: </a>  boxlist<span style="color: #990000">[</span><span style="color: #993399">0</span><span style="color: #990000">]</span><span style="color: #990000">.</span>c0min <span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">;</span>
<a name="line552">0552: </a>  boxlist<span style="color: #990000">[</span><span style="color: #993399">0</span><span style="color: #990000">]</span><span style="color: #990000">.</span>c0max <span style="color: #990000">=</span> MAXJSAMPLE <span style="color: #990000">&gt;</span><span style="color: #990000">&gt;</span> C0_SHIFT<span style="color: #990000">;</span>
<a name="line553">0553: </a>  boxlist<span style="color: #990000">[</span><span style="color: #993399">0</span><span style="color: #990000">]</span><span style="color: #990000">.</span>c1min <span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">;</span>
<a name="line554">0554: </a>  boxlist<span style="color: #990000">[</span><span style="color: #993399">0</span><span style="color: #990000">]</span><span style="color: #990000">.</span>c1max <span style="color: #990000">=</span> MAXJSAMPLE <span style="color: #990000">&gt;</span><span style="color: #990000">&gt;</span> C1_SHIFT<span style="color: #990000">;</span>
<a name="line555">0555: </a>  boxlist<span style="color: #990000">[</span><span style="color: #993399">0</span><span style="color: #990000">]</span><span style="color: #990000">.</span>c2min <span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">;</span>
<a name="line556">0556: </a>  boxlist<span style="color: #990000">[</span><span style="color: #993399">0</span><span style="color: #990000">]</span><span style="color: #990000">.</span>c2max <span style="color: #990000">=</span> MAXJSAMPLE <span style="color: #990000">&gt;</span><span style="color: #990000">&gt;</span> C2_SHIFT<span style="color: #990000">;</span>
<a name="line557">0557: </a>  <span style="font-style: italic"><span style="color: #9A1900">/* Shrink it to actually-used volume and set its statistics */</span></span>
<a name="line558">0558: </a>  <span style="font-weight: bold"><span style="color: #000000">update_box</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> <span style="color: #990000">&amp;</span> boxlist<span style="color: #990000">[</span><span style="color: #993399">0</span><span style="color: #990000">]</span><span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line559">0559: </a>  <span style="font-style: italic"><span style="color: #9A1900">/* Perform median-cut to produce final box list */</span></span>
<a name="line560">0560: </a>  numboxes <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">median_cut</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> boxlist<span style="color: #990000">,</span> numboxes<span style="color: #990000">,</span> desired_colors<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line561">0561: </a>  <span style="font-style: italic"><span style="color: #9A1900">/* Compute the representative color for each box, fill colormap */</span></span>
<a name="line562">0562: </a>  <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> <span style="color: #990000">(</span>i <span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">;</span> i <span style="color: #990000">&lt;</span> numboxes<span style="color: #990000">;</span> i<span style="color: #990000">+</span><span style="color: #990000">+</span><span style="color: #990000">)</span>
<a name="line563">0563: </a>    <span style="font-weight: bold"><span style="color: #000000">compute_color</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> <span style="color: #990000">&amp;</span> boxlist<span style="color: #990000">[</span>i<span style="color: #990000">]</span><span style="color: #990000">,</span> i<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line564">0564: </a>  cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>actual_number_of_colors <span style="color: #990000">=</span> numboxes<span style="color: #990000">;</span>
<a name="line565">0565: </a>  <span style="font-weight: bold"><span style="color: #000000">TRACEMS1</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> <span style="color: #993399">1</span><span style="color: #990000">,</span> JTRC_QUANT_SELECTED<span style="color: #990000">,</span> numboxes<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line566">0566: </a><span style="color: #FF0000">}</span>
<a name="line567">0567: </a>
<a name="line568">0568: </a>
<a name="line569">0569: </a><span style="font-style: italic"><span style="color: #9A1900">/*</span></span>
<a name="line570">0570: </a><span style="font-style: italic"><span style="color: #9A1900"> * These routines are concerned with the time-critical task of mapping input</span></span>
<a name="line571">0571: </a><span style="font-style: italic"><span style="color: #9A1900"> * colors to the nearest color in the selected colormap.</span></span>
<a name="line572">0572: </a><span style="font-style: italic"><span style="color: #9A1900"> *</span></span>
<a name="line573">0573: </a><span style="font-style: italic"><span style="color: #9A1900"> * We re-use the histogram space as an "inverse color map", essentially a</span></span>
<a name="line574">0574: </a><span style="font-style: italic"><span style="color: #9A1900"> * cache for the results of nearest-color searches.  All colors within a</span></span>
<a name="line575">0575: </a><span style="font-style: italic"><span style="color: #9A1900"> * histogram cell will be mapped to the same colormap entry, namely the one</span></span>
<a name="line576">0576: </a><span style="font-style: italic"><span style="color: #9A1900"> * closest to the cell's center.  This may not be quite the closest entry to</span></span>
<a name="line577">0577: </a><span style="font-style: italic"><span style="color: #9A1900"> * the actual input color, but it's almost as good.  A zero in the cache</span></span>
<a name="line578">0578: </a><span style="font-style: italic"><span style="color: #9A1900"> * indicates we haven't found the nearest color for that cell yet; the array</span></span>
<a name="line579">0579: </a><span style="font-style: italic"><span style="color: #9A1900"> * is cleared to zeroes before starting the mapping pass.  When we find the</span></span>
<a name="line580">0580: </a><span style="font-style: italic"><span style="color: #9A1900"> * nearest color for a cell, its colormap index plus one is recorded in the</span></span>
<a name="line581">0581: </a><span style="font-style: italic"><span style="color: #9A1900"> * cache for future use.  The pass2 scanning routines call fill_inverse_cmap</span></span>
<a name="line582">0582: </a><span style="font-style: italic"><span style="color: #9A1900"> * when they need to use an unfilled entry in the cache.</span></span>
<a name="line583">0583: </a><span style="font-style: italic"><span style="color: #9A1900"> *</span></span>
<a name="line584">0584: </a><span style="font-style: italic"><span style="color: #9A1900"> * Our method of efficiently finding nearest colors is based on the "locally</span></span>
<a name="line585">0585: </a><span style="font-style: italic"><span style="color: #9A1900"> * sorted search" idea described by Heckbert and on the incremental distance</span></span>
<a name="line586">0586: </a><span style="font-style: italic"><span style="color: #9A1900"> * calculation described by Spencer W. Thomas in chapter III.1 of Graphics</span></span>
<a name="line587">0587: </a><span style="font-style: italic"><span style="color: #9A1900"> * Gems II (James Arvo, ed.  Academic Press, 1991).  Thomas points out that</span></span>
<a name="line588">0588: </a><span style="font-style: italic"><span style="color: #9A1900"> * the distances from a given colormap entry to each cell of the histogram can</span></span>
<a name="line589">0589: </a><span style="font-style: italic"><span style="color: #9A1900"> * be computed quickly using an incremental method: the differences between</span></span>
<a name="line590">0590: </a><span style="font-style: italic"><span style="color: #9A1900"> * distances to adjacent cells themselves differ by a constant.  This allows a</span></span>
<a name="line591">0591: </a><span style="font-style: italic"><span style="color: #9A1900"> * fairly fast implementation of the "brute force" approach of computing the</span></span>
<a name="line592">0592: </a><span style="font-style: italic"><span style="color: #9A1900"> * distance from every colormap entry to every histogram cell.  Unfortunately,</span></span>
<a name="line593">0593: </a><span style="font-style: italic"><span style="color: #9A1900"> * it needs a work array to hold the best-distance-so-far for each histogram</span></span>
<a name="line594">0594: </a><span style="font-style: italic"><span style="color: #9A1900"> * cell (because the inner loop has to be over cells, not colormap entries).</span></span>
<a name="line595">0595: </a><span style="font-style: italic"><span style="color: #9A1900"> * The work array elements have to be INT32s, so the work array would need</span></span>
<a name="line596">0596: </a><span style="font-style: italic"><span style="color: #9A1900"> * 256Kb at our recommended precision.  This is not feasible in DOS machines.</span></span>
<a name="line597">0597: </a><span style="font-style: italic"><span style="color: #9A1900"> *</span></span>
<a name="line598">0598: </a><span style="font-style: italic"><span style="color: #9A1900"> * To get around these problems, we apply Thomas' method to compute the</span></span>
<a name="line599">0599: </a><span style="font-style: italic"><span style="color: #9A1900"> * nearest colors for only the cells within a small subbox of the histogram.</span></span>
<a name="line600">0600: </a><span style="font-style: italic"><span style="color: #9A1900"> * The work array need be only as big as the subbox, so the memory usage</span></span>
<a name="line601">0601: </a><span style="font-style: italic"><span style="color: #9A1900"> * problem is solved.  Furthermore, we need not fill subboxes that are never</span></span>
<a name="line602">0602: </a><span style="font-style: italic"><span style="color: #9A1900"> * referenced in pass2; many images use only part of the color gamut, so a</span></span>
<a name="line603">0603: </a><span style="font-style: italic"><span style="color: #9A1900"> * fair amount of work is saved.  An additional advantage of this</span></span>
<a name="line604">0604: </a><span style="font-style: italic"><span style="color: #9A1900"> * approach is that we can apply Heckbert's locality criterion to quickly</span></span>
<a name="line605">0605: </a><span style="font-style: italic"><span style="color: #9A1900"> * eliminate colormap entries that are far away from the subbox; typically</span></span>
<a name="line606">0606: </a><span style="font-style: italic"><span style="color: #9A1900"> * three-fourths of the colormap entries are rejected by Heckbert's criterion,</span></span>
<a name="line607">0607: </a><span style="font-style: italic"><span style="color: #9A1900"> * and we need not compute their distances to individual cells in the subbox.</span></span>
<a name="line608">0608: </a><span style="font-style: italic"><span style="color: #9A1900"> * The speed of this approach is heavily influenced by the subbox size: too</span></span>
<a name="line609">0609: </a><span style="font-style: italic"><span style="color: #9A1900"> * small means too much overhead, too big loses because Heckbert's criterion</span></span>
<a name="line610">0610: </a><span style="font-style: italic"><span style="color: #9A1900"> * can't eliminate as many colormap entries.  Empirically the best subbox</span></span>
<a name="line611">0611: </a><span style="font-style: italic"><span style="color: #9A1900"> * size seems to be about 1/512th of the histogram (1/8th in each direction).</span></span>
<a name="line612">0612: </a><span style="font-style: italic"><span style="color: #9A1900"> *</span></span>
<a name="line613">0613: </a><span style="font-style: italic"><span style="color: #9A1900"> * Thomas' article also describes a refined method which is asymptotically</span></span>
<a name="line614">0614: </a><span style="font-style: italic"><span style="color: #9A1900"> * faster than the brute-force method, but it is also far more complex and</span></span>
<a name="line615">0615: </a><span style="font-style: italic"><span style="color: #9A1900"> * cannot efficiently be applied to small subboxes.  It is therefore not</span></span>
<a name="line616">0616: </a><span style="font-style: italic"><span style="color: #9A1900"> * useful for programs intended to be portable to DOS machines.  On machines</span></span>
<a name="line617">0617: </a><span style="font-style: italic"><span style="color: #9A1900"> * with plenty of memory, filling the whole histogram in one shot with Thomas'</span></span>
<a name="line618">0618: </a><span style="font-style: italic"><span style="color: #9A1900"> * refined method might be faster than the present code --- but then again,</span></span>
<a name="line619">0619: </a><span style="font-style: italic"><span style="color: #9A1900"> * it might not be any faster, and it's certainly more complicated.</span></span>
<a name="line620">0620: </a><span style="font-style: italic"><span style="color: #9A1900"> */</span></span>
<a name="line621">0621: </a>
<a name="line622">0622: </a>
<a name="line623">0623: </a><span style="font-style: italic"><span style="color: #9A1900">/* log2(histogram cells in update box) for each axis; this can be adjusted */</span></span>
<a name="line624">0624: </a><span style="font-weight: bold"><span style="color: #000080">#define</span></span> <span style="font-weight: bold"><span style="color: #000000">BOX_C0_LOG</span></span>  <span style="color: #990000">(</span>HIST_C0_BITS<span style="color: #990000">-</span><span style="color: #993399">3</span><span style="color: #990000">)</span>
<a name="line625">0625: </a><span style="font-weight: bold"><span style="color: #000080">#define</span></span> <span style="font-weight: bold"><span style="color: #000000">BOX_C1_LOG</span></span>  <span style="color: #990000">(</span>HIST_C1_BITS<span style="color: #990000">-</span><span style="color: #993399">3</span><span style="color: #990000">)</span>
<a name="line626">0626: </a><span style="font-weight: bold"><span style="color: #000080">#define</span></span> <span style="font-weight: bold"><span style="color: #000000">BOX_C2_LOG</span></span>  <span style="color: #990000">(</span>HIST_C2_BITS<span style="color: #990000">-</span><span style="color: #993399">3</span><span style="color: #990000">)</span>
<a name="line627">0627: </a>
<a name="line628">0628: </a><span style="font-weight: bold"><span style="color: #000080">#define</span></span> <span style="font-weight: bold"><span style="color: #000000">BOX_C0_ELEMS</span></span>  <span style="color: #990000">(</span><span style="color: #993399">1</span><span style="color: #990000">&lt;</span><span style="color: #990000">&lt;</span>BOX_C0_LOG<span style="color: #990000">)</span> <span style="font-style: italic"><span style="color: #9A1900">/* # of hist cells in update box */</span></span>
<a name="line629">0629: </a><span style="font-weight: bold"><span style="color: #000080">#define</span></span> <span style="font-weight: bold"><span style="color: #000000">BOX_C1_ELEMS</span></span>  <span style="color: #990000">(</span><span style="color: #993399">1</span><span style="color: #990000">&lt;</span><span style="color: #990000">&lt;</span>BOX_C1_LOG<span style="color: #990000">)</span>
<a name="line630">0630: </a><span style="font-weight: bold"><span style="color: #000080">#define</span></span> <span style="font-weight: bold"><span style="color: #000000">BOX_C2_ELEMS</span></span>  <span style="color: #990000">(</span><span style="color: #993399">1</span><span style="color: #990000">&lt;</span><span style="color: #990000">&lt;</span>BOX_C2_LOG<span style="color: #990000">)</span>
<a name="line631">0631: </a>
<a name="line632">0632: </a><span style="font-weight: bold"><span style="color: #000080">#define</span></span> <span style="font-weight: bold"><span style="color: #000000">BOX_C0_SHIFT</span></span>  <span style="color: #990000">(</span>C0_SHIFT <span style="color: #990000">+</span> BOX_C0_LOG<span style="color: #990000">)</span>
<a name="line633">0633: </a><span style="font-weight: bold"><span style="color: #000080">#define</span></span> <span style="font-weight: bold"><span style="color: #000000">BOX_C1_SHIFT</span></span>  <span style="color: #990000">(</span>C1_SHIFT <span style="color: #990000">+</span> BOX_C1_LOG<span style="color: #990000">)</span>
<a name="line634">0634: </a><span style="font-weight: bold"><span style="color: #000080">#define</span></span> <span style="font-weight: bold"><span style="color: #000000">BOX_C2_SHIFT</span></span>  <span style="color: #990000">(</span>C2_SHIFT <span style="color: #990000">+</span> BOX_C2_LOG<span style="color: #990000">)</span>
<a name="line635">0635: </a>
<a name="line636">0636: </a>
<a name="line637">0637: </a><span style="font-style: italic"><span style="color: #9A1900">/*</span></span>
<a name="line638">0638: </a><span style="font-style: italic"><span style="color: #9A1900"> * The next three routines implement inverse colormap filling.  They could</span></span>
<a name="line639">0639: </a><span style="font-style: italic"><span style="color: #9A1900"> * all be folded into one big routine, but splitting them up this way saves</span></span>
<a name="line640">0640: </a><span style="font-style: italic"><span style="color: #9A1900"> * some stack space (the mindist[] and bestdist[] arrays need not coexist)</span></span>
<a name="line641">0641: </a><span style="font-style: italic"><span style="color: #9A1900"> * and may allow some compilers to produce better code by registerizing more</span></span>
<a name="line642">0642: </a><span style="font-style: italic"><span style="color: #9A1900"> * inner-loop variables.</span></span>
<a name="line643">0643: </a><span style="font-style: italic"><span style="color: #9A1900"> */</span></span>
<a name="line644">0644: </a>
<a name="line645">0645: </a><span style="font-weight: bold"><span style="color: #000000">LOCAL</span></span><span style="color: #990000">(</span><span style="color: #009900">int</span><span style="color: #990000">)</span>
<a name="line646">0646: </a><span style="font-weight: bold"><span style="color: #000000">find_nearby_colors</span></span> <span style="color: #990000">(</span>j_decompress_ptr cinfo<span style="color: #990000">,</span> <span style="color: #009900">int</span> minc0<span style="color: #990000">,</span> <span style="color: #009900">int</span> minc1<span style="color: #990000">,</span> <span style="color: #009900">int</span> minc2<span style="color: #990000">,</span>
<a name="line647">0647: </a>                    JSAMPLE colorlist<span style="color: #990000">[</span><span style="color: #990000">]</span><span style="color: #990000">)</span>
<a name="line648">0648: </a><span style="font-style: italic"><span style="color: #9A1900">/* Locate the colormap entries close enough to an update box to be candidates</span></span>
<a name="line649">0649: </a><span style="font-style: italic"><span style="color: #9A1900"> * for the nearest entry to some cell(s) in the update box.  The update box</span></span>
<a name="line650">0650: </a><span style="font-style: italic"><span style="color: #9A1900"> * is specified by the center coordinates of its first cell.  The number of</span></span>
<a name="line651">0651: </a><span style="font-style: italic"><span style="color: #9A1900"> * candidate colormap entries is returned, and their colormap indexes are</span></span>
<a name="line652">0652: </a><span style="font-style: italic"><span style="color: #9A1900"> * placed in colorlist[].</span></span>
<a name="line653">0653: </a><span style="font-style: italic"><span style="color: #9A1900"> * This routine uses Heckbert's "locally sorted search" criterion to select</span></span>
<a name="line654">0654: </a><span style="font-style: italic"><span style="color: #9A1900"> * the colors that need further consideration.</span></span>
<a name="line655">0655: </a><span style="font-style: italic"><span style="color: #9A1900"> */</span></span>
<a name="line656">0656: </a><span style="color: #FF0000">{</span>
<a name="line657">0657: </a>  <span style="color: #009900">int</span> numcolors <span style="color: #990000">=</span> cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>actual_number_of_colors<span style="color: #990000">;</span>
<a name="line658">0658: </a>  <span style="color: #009900">int</span> maxc0<span style="color: #990000">,</span> maxc1<span style="color: #990000">,</span> maxc2<span style="color: #990000">;</span>
<a name="line659">0659: </a>  <span style="color: #009900">int</span> centerc0<span style="color: #990000">,</span> centerc1<span style="color: #990000">,</span> centerc2<span style="color: #990000">;</span>
<a name="line660">0660: </a>  <span style="color: #009900">int</span> i<span style="color: #990000">,</span> x<span style="color: #990000">,</span> ncolors<span style="color: #990000">;</span>
<a name="line661">0661: </a>  INT32 minmaxdist<span style="color: #990000">,</span> min_dist<span style="color: #990000">,</span> max_dist<span style="color: #990000">,</span> tdist<span style="color: #990000">;</span>
<a name="line662">0662: </a>  INT32 mindist<span style="color: #990000">[</span>MAXNUMCOLORS<span style="color: #990000">]</span><span style="color: #990000">;</span>  <span style="font-style: italic"><span style="color: #9A1900">/* min distance to colormap entry i */</span></span>
<a name="line663">0663: </a>
<a name="line664">0664: </a>  <span style="font-style: italic"><span style="color: #9A1900">/* Compute true coordinates of update box's upper corner and center.</span></span>
<a name="line665">0665: </a><span style="font-style: italic"><span style="color: #9A1900">   * Actually we compute the coordinates of the center of the upper-corner</span></span>
<a name="line666">0666: </a><span style="font-style: italic"><span style="color: #9A1900">   * histogram cell, which are the upper bounds of the volume we care about.</span></span>
<a name="line667">0667: </a><span style="font-style: italic"><span style="color: #9A1900">   * Note that since "&gt;&gt;" rounds down, the "center" values may be closer to</span></span>
<a name="line668">0668: </a><span style="font-style: italic"><span style="color: #9A1900">   * min than to max; hence comparisons to them must be "&lt;=", not "&lt;".</span></span>
<a name="line669">0669: </a><span style="font-style: italic"><span style="color: #9A1900">   */</span></span>
<a name="line670">0670: </a>  maxc0 <span style="color: #990000">=</span> minc0 <span style="color: #990000">+</span> <span style="color: #990000">(</span><span style="color: #990000">(</span><span style="color: #993399">1</span> <span style="color: #990000">&lt;</span><span style="color: #990000">&lt;</span> BOX_C0_SHIFT<span style="color: #990000">)</span> <span style="color: #990000">-</span> <span style="color: #990000">(</span><span style="color: #993399">1</span> <span style="color: #990000">&lt;</span><span style="color: #990000">&lt;</span> C0_SHIFT<span style="color: #990000">)</span><span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line671">0671: </a>  centerc0 <span style="color: #990000">=</span> <span style="color: #990000">(</span>minc0 <span style="color: #990000">+</span> maxc0<span style="color: #990000">)</span> <span style="color: #990000">&gt;</span><span style="color: #990000">&gt;</span> <span style="color: #993399">1</span><span style="color: #990000">;</span>
<a name="line672">0672: </a>  maxc1 <span style="color: #990000">=</span> minc1 <span style="color: #990000">+</span> <span style="color: #990000">(</span><span style="color: #990000">(</span><span style="color: #993399">1</span> <span style="color: #990000">&lt;</span><span style="color: #990000">&lt;</span> BOX_C1_SHIFT<span style="color: #990000">)</span> <span style="color: #990000">-</span> <span style="color: #990000">(</span><span style="color: #993399">1</span> <span style="color: #990000">&lt;</span><span style="color: #990000">&lt;</span> C1_SHIFT<span style="color: #990000">)</span><span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line673">0673: </a>  centerc1 <span style="color: #990000">=</span> <span style="color: #990000">(</span>minc1 <span style="color: #990000">+</span> maxc1<span style="color: #990000">)</span> <span style="color: #990000">&gt;</span><span style="color: #990000">&gt;</span> <span style="color: #993399">1</span><span style="color: #990000">;</span>
<a name="line674">0674: </a>  maxc2 <span style="color: #990000">=</span> minc2 <span style="color: #990000">+</span> <span style="color: #990000">(</span><span style="color: #990000">(</span><span style="color: #993399">1</span> <span style="color: #990000">&lt;</span><span style="color: #990000">&lt;</span> BOX_C2_SHIFT<span style="color: #990000">)</span> <span style="color: #990000">-</span> <span style="color: #990000">(</span><span style="color: #993399">1</span> <span style="color: #990000">&lt;</span><span style="color: #990000">&lt;</span> C2_SHIFT<span style="color: #990000">)</span><span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line675">0675: </a>  centerc2 <span style="color: #990000">=</span> <span style="color: #990000">(</span>minc2 <span style="color: #990000">+</span> maxc2<span style="color: #990000">)</span> <span style="color: #990000">&gt;</span><span style="color: #990000">&gt;</span> <span style="color: #993399">1</span><span style="color: #990000">;</span>
<a name="line676">0676: </a>
<a name="line677">0677: </a>  <span style="font-style: italic"><span style="color: #9A1900">/* For each color in colormap, find:</span></span>
<a name="line678">0678: </a><span style="font-style: italic"><span style="color: #9A1900">   *  1. its minimum squared-distance to any point in the update box</span></span>
<a name="line679">0679: </a><span style="font-style: italic"><span style="color: #9A1900">   *     (zero if color is within update box);</span></span>
<a name="line680">0680: </a><span style="font-style: italic"><span style="color: #9A1900">   *  2. its maximum squared-distance to any point in the update box.</span></span>
<a name="line681">0681: </a><span style="font-style: italic"><span style="color: #9A1900">   * Both of these can be found by considering only the corners of the box.</span></span>
<a name="line682">0682: </a><span style="font-style: italic"><span style="color: #9A1900">   * We save the minimum distance for each color in mindist[];</span></span>
<a name="line683">0683: </a><span style="font-style: italic"><span style="color: #9A1900">   * only the smallest maximum distance is of interest.</span></span>
<a name="line684">0684: </a><span style="font-style: italic"><span style="color: #9A1900">   */</span></span>
<a name="line685">0685: </a>  minmaxdist <span style="color: #990000">=</span> <span style="color: #993399">0x7FFFFFFF</span>L<span style="color: #990000">;</span>
<a name="line686">0686: </a>
<a name="line687">0687: </a>  <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> <span style="color: #990000">(</span>i <span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">;</span> i <span style="color: #990000">&lt;</span> numcolors<span style="color: #990000">;</span> i<span style="color: #990000">+</span><span style="color: #990000">+</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line688">0688: </a>    <span style="font-style: italic"><span style="color: #9A1900">/* We compute the squared-c0-distance term, then add in the other two. */</span></span>
<a name="line689">0689: </a>    x <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">GETJSAMPLE</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>colormap<span style="color: #990000">[</span><span style="color: #993399">0</span><span style="color: #990000">]</span><span style="color: #990000">[</span>i<span style="color: #990000">]</span><span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line690">0690: </a>    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>x <span style="color: #990000">&lt;</span> minc0<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line691">0691: </a>      tdist <span style="color: #990000">=</span> <span style="color: #990000">(</span>x <span style="color: #990000">-</span> minc0<span style="color: #990000">)</span> <span style="color: #990000">*</span> C0_SCALE<span style="color: #990000">;</span>
<a name="line692">0692: </a>      min_dist <span style="color: #990000">=</span> tdist<span style="color: #990000">*</span>tdist<span style="color: #990000">;</span>
<a name="line693">0693: </a>      tdist <span style="color: #990000">=</span> <span style="color: #990000">(</span>x <span style="color: #990000">-</span> maxc0<span style="color: #990000">)</span> <span style="color: #990000">*</span> C0_SCALE<span style="color: #990000">;</span>
<a name="line694">0694: </a>      max_dist <span style="color: #990000">=</span> tdist<span style="color: #990000">*</span>tdist<span style="color: #990000">;</span>
<a name="line695">0695: </a>    <span style="color: #FF0000">}</span> <span style="font-weight: bold"><span style="color: #0000FF">else</span></span> <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>x <span style="color: #990000">&gt;</span> maxc0<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line696">0696: </a>      tdist <span style="color: #990000">=</span> <span style="color: #990000">(</span>x <span style="color: #990000">-</span> maxc0<span style="color: #990000">)</span> <span style="color: #990000">*</span> C0_SCALE<span style="color: #990000">;</span>
<a name="line697">0697: </a>      min_dist <span style="color: #990000">=</span> tdist<span style="color: #990000">*</span>tdist<span style="color: #990000">;</span>
<a name="line698">0698: </a>      tdist <span style="color: #990000">=</span> <span style="color: #990000">(</span>x <span style="color: #990000">-</span> minc0<span style="color: #990000">)</span> <span style="color: #990000">*</span> C0_SCALE<span style="color: #990000">;</span>
<a name="line699">0699: </a>      max_dist <span style="color: #990000">=</span> tdist<span style="color: #990000">*</span>tdist<span style="color: #990000">;</span>
<a name="line700">0700: </a>    <span style="color: #FF0000">}</span> <span style="font-weight: bold"><span style="color: #0000FF">else</span></span> <span style="color: #FF0000">{</span>
<a name="line701">0701: </a>      <span style="font-style: italic"><span style="color: #9A1900">/* within cell range so no contribution to min_dist */</span></span>
<a name="line702">0702: </a>      min_dist <span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">;</span>
<a name="line703">0703: </a>      <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>x <span style="color: #990000">&lt;</span><span style="color: #990000">=</span> centerc0<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line704">0704: </a>        tdist <span style="color: #990000">=</span> <span style="color: #990000">(</span>x <span style="color: #990000">-</span> maxc0<span style="color: #990000">)</span> <span style="color: #990000">*</span> C0_SCALE<span style="color: #990000">;</span>
<a name="line705">0705: </a>        max_dist <span style="color: #990000">=</span> tdist<span style="color: #990000">*</span>tdist<span style="color: #990000">;</span>
<a name="line706">0706: </a>      <span style="color: #FF0000">}</span> <span style="font-weight: bold"><span style="color: #0000FF">else</span></span> <span style="color: #FF0000">{</span>
<a name="line707">0707: </a>        tdist <span style="color: #990000">=</span> <span style="color: #990000">(</span>x <span style="color: #990000">-</span> minc0<span style="color: #990000">)</span> <span style="color: #990000">*</span> C0_SCALE<span style="color: #990000">;</span>
<a name="line708">0708: </a>        max_dist <span style="color: #990000">=</span> tdist<span style="color: #990000">*</span>tdist<span style="color: #990000">;</span>
<a name="line709">0709: </a>      <span style="color: #FF0000">}</span>
<a name="line710">0710: </a>    <span style="color: #FF0000">}</span>
<a name="line711">0711: </a>
<a name="line712">0712: </a>    x <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">GETJSAMPLE</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>colormap<span style="color: #990000">[</span><span style="color: #993399">1</span><span style="color: #990000">]</span><span style="color: #990000">[</span>i<span style="color: #990000">]</span><span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line713">0713: </a>    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>x <span style="color: #990000">&lt;</span> minc1<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line714">0714: </a>      tdist <span style="color: #990000">=</span> <span style="color: #990000">(</span>x <span style="color: #990000">-</span> minc1<span style="color: #990000">)</span> <span style="color: #990000">*</span> C1_SCALE<span style="color: #990000">;</span>
<a name="line715">0715: </a>      min_dist <span style="color: #990000">+</span><span style="color: #990000">=</span> tdist<span style="color: #990000">*</span>tdist<span style="color: #990000">;</span>
<a name="line716">0716: </a>      tdist <span style="color: #990000">=</span> <span style="color: #990000">(</span>x <span style="color: #990000">-</span> maxc1<span style="color: #990000">)</span> <span style="color: #990000">*</span> C1_SCALE<span style="color: #990000">;</span>
<a name="line717">0717: </a>      max_dist <span style="color: #990000">+</span><span style="color: #990000">=</span> tdist<span style="color: #990000">*</span>tdist<span style="color: #990000">;</span>
<a name="line718">0718: </a>    <span style="color: #FF0000">}</span> <span style="font-weight: bold"><span style="color: #0000FF">else</span></span> <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>x <span style="color: #990000">&gt;</span> maxc1<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line719">0719: </a>      tdist <span style="color: #990000">=</span> <span style="color: #990000">(</span>x <span style="color: #990000">-</span> maxc1<span style="color: #990000">)</span> <span style="color: #990000">*</span> C1_SCALE<span style="color: #990000">;</span>
<a name="line720">0720: </a>      min_dist <span style="color: #990000">+</span><span style="color: #990000">=</span> tdist<span style="color: #990000">*</span>tdist<span style="color: #990000">;</span>
<a name="line721">0721: </a>      tdist <span style="color: #990000">=</span> <span style="color: #990000">(</span>x <span style="color: #990000">-</span> minc1<span style="color: #990000">)</span> <span style="color: #990000">*</span> C1_SCALE<span style="color: #990000">;</span>
<a name="line722">0722: </a>      max_dist <span style="color: #990000">+</span><span style="color: #990000">=</span> tdist<span style="color: #990000">*</span>tdist<span style="color: #990000">;</span>
<a name="line723">0723: </a>    <span style="color: #FF0000">}</span> <span style="font-weight: bold"><span style="color: #0000FF">else</span></span> <span style="color: #FF0000">{</span>
<a name="line724">0724: </a>      <span style="font-style: italic"><span style="color: #9A1900">/* within cell range so no contribution to min_dist */</span></span>
<a name="line725">0725: </a>      <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>x <span style="color: #990000">&lt;</span><span style="color: #990000">=</span> centerc1<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line726">0726: </a>        tdist <span style="color: #990000">=</span> <span style="color: #990000">(</span>x <span style="color: #990000">-</span> maxc1<span style="color: #990000">)</span> <span style="color: #990000">*</span> C1_SCALE<span style="color: #990000">;</span>
<a name="line727">0727: </a>        max_dist <span style="color: #990000">+</span><span style="color: #990000">=</span> tdist<span style="color: #990000">*</span>tdist<span style="color: #990000">;</span>
<a name="line728">0728: </a>      <span style="color: #FF0000">}</span> <span style="font-weight: bold"><span style="color: #0000FF">else</span></span> <span style="color: #FF0000">{</span>
<a name="line729">0729: </a>        tdist <span style="color: #990000">=</span> <span style="color: #990000">(</span>x <span style="color: #990000">-</span> minc1<span style="color: #990000">)</span> <span style="color: #990000">*</span> C1_SCALE<span style="color: #990000">;</span>
<a name="line730">0730: </a>        max_dist <span style="color: #990000">+</span><span style="color: #990000">=</span> tdist<span style="color: #990000">*</span>tdist<span style="color: #990000">;</span>
<a name="line731">0731: </a>      <span style="color: #FF0000">}</span>
<a name="line732">0732: </a>    <span style="color: #FF0000">}</span>
<a name="line733">0733: </a>
<a name="line734">0734: </a>    x <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">GETJSAMPLE</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>colormap<span style="color: #990000">[</span><span style="color: #993399">2</span><span style="color: #990000">]</span><span style="color: #990000">[</span>i<span style="color: #990000">]</span><span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line735">0735: </a>    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>x <span style="color: #990000">&lt;</span> minc2<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line736">0736: </a>      tdist <span style="color: #990000">=</span> <span style="color: #990000">(</span>x <span style="color: #990000">-</span> minc2<span style="color: #990000">)</span> <span style="color: #990000">*</span> C2_SCALE<span style="color: #990000">;</span>
<a name="line737">0737: </a>      min_dist <span style="color: #990000">+</span><span style="color: #990000">=</span> tdist<span style="color: #990000">*</span>tdist<span style="color: #990000">;</span>
<a name="line738">0738: </a>      tdist <span style="color: #990000">=</span> <span style="color: #990000">(</span>x <span style="color: #990000">-</span> maxc2<span style="color: #990000">)</span> <span style="color: #990000">*</span> C2_SCALE<span style="color: #990000">;</span>
<a name="line739">0739: </a>      max_dist <span style="color: #990000">+</span><span style="color: #990000">=</span> tdist<span style="color: #990000">*</span>tdist<span style="color: #990000">;</span>
<a name="line740">0740: </a>    <span style="color: #FF0000">}</span> <span style="font-weight: bold"><span style="color: #0000FF">else</span></span> <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>x <span style="color: #990000">&gt;</span> maxc2<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line741">0741: </a>      tdist <span style="color: #990000">=</span> <span style="color: #990000">(</span>x <span style="color: #990000">-</span> maxc2<span style="color: #990000">)</span> <span style="color: #990000">*</span> C2_SCALE<span style="color: #990000">;</span>
<a name="line742">0742: </a>      min_dist <span style="color: #990000">+</span><span style="color: #990000">=</span> tdist<span style="color: #990000">*</span>tdist<span style="color: #990000">;</span>
<a name="line743">0743: </a>      tdist <span style="color: #990000">=</span> <span style="color: #990000">(</span>x <span style="color: #990000">-</span> minc2<span style="color: #990000">)</span> <span style="color: #990000">*</span> C2_SCALE<span style="color: #990000">;</span>
<a name="line744">0744: </a>      max_dist <span style="color: #990000">+</span><span style="color: #990000">=</span> tdist<span style="color: #990000">*</span>tdist<span style="color: #990000">;</span>
<a name="line745">0745: </a>    <span style="color: #FF0000">}</span> <span style="font-weight: bold"><span style="color: #0000FF">else</span></span> <span style="color: #FF0000">{</span>
<a name="line746">0746: </a>      <span style="font-style: italic"><span style="color: #9A1900">/* within cell range so no contribution to min_dist */</span></span>
<a name="line747">0747: </a>      <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>x <span style="color: #990000">&lt;</span><span style="color: #990000">=</span> centerc2<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line748">0748: </a>        tdist <span style="color: #990000">=</span> <span style="color: #990000">(</span>x <span style="color: #990000">-</span> maxc2<span style="color: #990000">)</span> <span style="color: #990000">*</span> C2_SCALE<span style="color: #990000">;</span>
<a name="line749">0749: </a>        max_dist <span style="color: #990000">+</span><span style="color: #990000">=</span> tdist<span style="color: #990000">*</span>tdist<span style="color: #990000">;</span>
<a name="line750">0750: </a>      <span style="color: #FF0000">}</span> <span style="font-weight: bold"><span style="color: #0000FF">else</span></span> <span style="color: #FF0000">{</span>
<a name="line751">0751: </a>        tdist <span style="color: #990000">=</span> <span style="color: #990000">(</span>x <span style="color: #990000">-</span> minc2<span style="color: #990000">)</span> <span style="color: #990000">*</span> C2_SCALE<span style="color: #990000">;</span>
<a name="line752">0752: </a>        max_dist <span style="color: #990000">+</span><span style="color: #990000">=</span> tdist<span style="color: #990000">*</span>tdist<span style="color: #990000">;</span>
<a name="line753">0753: </a>      <span style="color: #FF0000">}</span>
<a name="line754">0754: </a>    <span style="color: #FF0000">}</span>
<a name="line755">0755: </a>
<a name="line756">0756: </a>    mindist<span style="color: #990000">[</span>i<span style="color: #990000">]</span> <span style="color: #990000">=</span> min_dist<span style="color: #990000">;</span>      <span style="font-style: italic"><span style="color: #9A1900">/* save away the results */</span></span>
<a name="line757">0757: </a>    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>max_dist <span style="color: #990000">&lt;</span> minmaxdist<span style="color: #990000">)</span>
<a name="line758">0758: </a>      minmaxdist <span style="color: #990000">=</span> max_dist<span style="color: #990000">;</span>
<a name="line759">0759: </a>  <span style="color: #FF0000">}</span>
<a name="line760">0760: </a>
<a name="line761">0761: </a>  <span style="font-style: italic"><span style="color: #9A1900">/* Now we know that no cell in the update box is more than minmaxdist</span></span>
<a name="line762">0762: </a><span style="font-style: italic"><span style="color: #9A1900">   * away from some colormap entry.  Therefore, only colors that are</span></span>
<a name="line763">0763: </a><span style="font-style: italic"><span style="color: #9A1900">   * within minmaxdist of some part of the box need be considered.</span></span>
<a name="line764">0764: </a><span style="font-style: italic"><span style="color: #9A1900">   */</span></span>
<a name="line765">0765: </a>  ncolors <span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">;</span>
<a name="line766">0766: </a>  <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> <span style="color: #990000">(</span>i <span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">;</span> i <span style="color: #990000">&lt;</span> numcolors<span style="color: #990000">;</span> i<span style="color: #990000">+</span><span style="color: #990000">+</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line767">0767: </a>    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>mindist<span style="color: #990000">[</span>i<span style="color: #990000">]</span> <span style="color: #990000">&lt;</span><span style="color: #990000">=</span> minmaxdist<span style="color: #990000">)</span>
<a name="line768">0768: </a>      colorlist<span style="color: #990000">[</span>ncolors<span style="color: #990000">+</span><span style="color: #990000">+</span><span style="color: #990000">]</span> <span style="color: #990000">=</span> <span style="color: #990000">(</span>JSAMPLE<span style="color: #990000">)</span> i<span style="color: #990000">;</span>
<a name="line769">0769: </a>  <span style="color: #FF0000">}</span>
<a name="line770">0770: </a>  <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> ncolors<span style="color: #990000">;</span>
<a name="line771">0771: </a><span style="color: #FF0000">}</span>
<a name="line772">0772: </a>
<a name="line773">0773: </a>
<a name="line774">0774: </a><span style="font-weight: bold"><span style="color: #000000">LOCAL</span></span><span style="color: #990000">(</span><span style="color: #009900">void</span><span style="color: #990000">)</span>
<a name="line775">0775: </a><span style="font-weight: bold"><span style="color: #000000">find_best_colors</span></span> <span style="color: #990000">(</span>j_decompress_ptr cinfo<span style="color: #990000">,</span> <span style="color: #009900">int</span> minc0<span style="color: #990000">,</span> <span style="color: #009900">int</span> minc1<span style="color: #990000">,</span> <span style="color: #009900">int</span> minc2<span style="color: #990000">,</span>
<a name="line776">0776: </a>                  <span style="color: #009900">int</span> numcolors<span style="color: #990000">,</span> JSAMPLE colorlist<span style="color: #990000">[</span><span style="color: #990000">]</span><span style="color: #990000">,</span> JSAMPLE bestcolor<span style="color: #990000">[</span><span style="color: #990000">]</span><span style="color: #990000">)</span>
<a name="line777">0777: </a><span style="font-style: italic"><span style="color: #9A1900">/* Find the closest colormap entry for each cell in the update box,</span></span>
<a name="line778">0778: </a><span style="font-style: italic"><span style="color: #9A1900"> * given the list of candidate colors prepared by find_nearby_colors.</span></span>
<a name="line779">0779: </a><span style="font-style: italic"><span style="color: #9A1900"> * Return the indexes of the closest entries in the bestcolor[] array.</span></span>
<a name="line780">0780: </a><span style="font-style: italic"><span style="color: #9A1900"> * This routine uses Thomas' incremental distance calculation method to</span></span>
<a name="line781">0781: </a><span style="font-style: italic"><span style="color: #9A1900"> * find the distance from a colormap entry to successive cells in the box.</span></span>
<a name="line782">0782: </a><span style="font-style: italic"><span style="color: #9A1900"> */</span></span>
<a name="line783">0783: </a><span style="color: #FF0000">{</span>
<a name="line784">0784: </a>  <span style="color: #009900">int</span> ic0<span style="color: #990000">,</span> ic1<span style="color: #990000">,</span> ic2<span style="color: #990000">;</span>
<a name="line785">0785: </a>  <span style="color: #009900">int</span> i<span style="color: #990000">,</span> icolor<span style="color: #990000">;</span>
<a name="line786">0786: </a>  <span style="font-weight: bold"><span style="color: #0000FF">register</span></span> INT32 <span style="color: #990000">*</span> bptr<span style="color: #990000">;</span>        <span style="font-style: italic"><span style="color: #9A1900">/* pointer into bestdist[] array */</span></span>
<a name="line787">0787: </a>  JSAMPLE <span style="color: #990000">*</span> cptr<span style="color: #990000">;</span>               <span style="font-style: italic"><span style="color: #9A1900">/* pointer into bestcolor[] array */</span></span>
<a name="line788">0788: </a>  INT32 dist0<span style="color: #990000">,</span> dist1<span style="color: #990000">;</span>           <span style="font-style: italic"><span style="color: #9A1900">/* initial distance values */</span></span>
<a name="line789">0789: </a>  <span style="font-weight: bold"><span style="color: #0000FF">register</span></span> INT32 dist2<span style="color: #990000">;</span>         <span style="font-style: italic"><span style="color: #9A1900">/* current distance in inner loop */</span></span>
<a name="line790">0790: </a>  INT32 xx0<span style="color: #990000">,</span> xx1<span style="color: #990000">;</span>               <span style="font-style: italic"><span style="color: #9A1900">/* distance increments */</span></span>
<a name="line791">0791: </a>  <span style="font-weight: bold"><span style="color: #0000FF">register</span></span> INT32 xx2<span style="color: #990000">;</span>
<a name="line792">0792: </a>  INT32 inc0<span style="color: #990000">,</span> inc1<span style="color: #990000">,</span> inc2<span style="color: #990000">;</span>       <span style="font-style: italic"><span style="color: #9A1900">/* initial values for increments */</span></span>
<a name="line793">0793: </a>  <span style="font-style: italic"><span style="color: #9A1900">/* This array holds the distance to the nearest-so-far color for each cell */</span></span>
<a name="line794">0794: </a>  INT32 bestdist<span style="color: #990000">[</span>BOX_C0_ELEMS <span style="color: #990000">*</span> BOX_C1_ELEMS <span style="color: #990000">*</span> BOX_C2_ELEMS<span style="color: #990000">]</span><span style="color: #990000">;</span>
<a name="line795">0795: </a>
<a name="line796">0796: </a>  <span style="font-style: italic"><span style="color: #9A1900">/* Initialize best-distance for each cell of the update box */</span></span>
<a name="line797">0797: </a>  bptr <span style="color: #990000">=</span> bestdist<span style="color: #990000">;</span>
<a name="line798">0798: </a>  <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> <span style="color: #990000">(</span>i <span style="color: #990000">=</span> BOX_C0_ELEMS<span style="color: #990000">*</span>BOX_C1_ELEMS<span style="color: #990000">*</span>BOX_C2_ELEMS<span style="color: #990000">-</span><span style="color: #993399">1</span><span style="color: #990000">;</span> i <span style="color: #990000">&gt;</span><span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">;</span> i<span style="color: #990000">-</span><span style="color: #990000">-</span><span style="color: #990000">)</span>
<a name="line799">0799: </a>    <span style="color: #990000">*</span>bptr<span style="color: #990000">+</span><span style="color: #990000">+</span> <span style="color: #990000">=</span> <span style="color: #993399">0x7FFFFFFF</span>L<span style="color: #990000">;</span>
<a name="line800">0800: </a>  
<a name="line801">0801: </a>  <span style="font-style: italic"><span style="color: #9A1900">/* For each color selected by find_nearby_colors,</span></span>
<a name="line802">0802: </a><span style="font-style: italic"><span style="color: #9A1900">   * compute its distance to the center of each cell in the box.</span></span>
<a name="line803">0803: </a><span style="font-style: italic"><span style="color: #9A1900">   * If that's less than best-so-far, update best distance and color number.</span></span>
<a name="line804">0804: </a><span style="font-style: italic"><span style="color: #9A1900">   */</span></span>
<a name="line805">0805: </a>  
<a name="line806">0806: </a>  <span style="font-style: italic"><span style="color: #9A1900">/* Nominal steps between cell centers ("x" in Thomas article) */</span></span>
<a name="line807">0807: </a><span style="font-weight: bold"><span style="color: #000080">#define</span></span> <span style="font-weight: bold"><span style="color: #000000">STEP_C0</span></span>  <span style="color: #990000">(</span><span style="color: #990000">(</span><span style="color: #993399">1</span> <span style="color: #990000">&lt;</span><span style="color: #990000">&lt;</span> C0_SHIFT<span style="color: #990000">)</span> <span style="color: #990000">*</span> C0_SCALE<span style="color: #990000">)</span>
<a name="line808">0808: </a><span style="font-weight: bold"><span style="color: #000080">#define</span></span> <span style="font-weight: bold"><span style="color: #000000">STEP_C1</span></span>  <span style="color: #990000">(</span><span style="color: #990000">(</span><span style="color: #993399">1</span> <span style="color: #990000">&lt;</span><span style="color: #990000">&lt;</span> C1_SHIFT<span style="color: #990000">)</span> <span style="color: #990000">*</span> C1_SCALE<span style="color: #990000">)</span>
<a name="line809">0809: </a><span style="font-weight: bold"><span style="color: #000080">#define</span></span> <span style="font-weight: bold"><span style="color: #000000">STEP_C2</span></span>  <span style="color: #990000">(</span><span style="color: #990000">(</span><span style="color: #993399">1</span> <span style="color: #990000">&lt;</span><span style="color: #990000">&lt;</span> C2_SHIFT<span style="color: #990000">)</span> <span style="color: #990000">*</span> C2_SCALE<span style="color: #990000">)</span>
<a name="line810">0810: </a>  
<a name="line811">0811: </a>  <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> <span style="color: #990000">(</span>i <span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">;</span> i <span style="color: #990000">&lt;</span> numcolors<span style="color: #990000">;</span> i<span style="color: #990000">+</span><span style="color: #990000">+</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line812">0812: </a>    icolor <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">GETJSAMPLE</span></span><span style="color: #990000">(</span>colorlist<span style="color: #990000">[</span>i<span style="color: #990000">]</span><span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line813">0813: </a>    <span style="font-style: italic"><span style="color: #9A1900">/* Compute (square of) distance from minc0/c1/c2 to this color */</span></span>
<a name="line814">0814: </a>    inc0 <span style="color: #990000">=</span> <span style="color: #990000">(</span>minc0 <span style="color: #990000">-</span> <span style="font-weight: bold"><span style="color: #000000">GETJSAMPLE</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>colormap<span style="color: #990000">[</span><span style="color: #993399">0</span><span style="color: #990000">]</span><span style="color: #990000">[</span>icolor<span style="color: #990000">]</span><span style="color: #990000">)</span><span style="color: #990000">)</span> <span style="color: #990000">*</span> C0_SCALE<span style="color: #990000">;</span>
<a name="line815">0815: </a>    dist0 <span style="color: #990000">=</span> inc0<span style="color: #990000">*</span>inc0<span style="color: #990000">;</span>
<a name="line816">0816: </a>    inc1 <span style="color: #990000">=</span> <span style="color: #990000">(</span>minc1 <span style="color: #990000">-</span> <span style="font-weight: bold"><span style="color: #000000">GETJSAMPLE</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>colormap<span style="color: #990000">[</span><span style="color: #993399">1</span><span style="color: #990000">]</span><span style="color: #990000">[</span>icolor<span style="color: #990000">]</span><span style="color: #990000">)</span><span style="color: #990000">)</span> <span style="color: #990000">*</span> C1_SCALE<span style="color: #990000">;</span>
<a name="line817">0817: </a>    dist0 <span style="color: #990000">+</span><span style="color: #990000">=</span> inc1<span style="color: #990000">*</span>inc1<span style="color: #990000">;</span>
<a name="line818">0818: </a>    inc2 <span style="color: #990000">=</span> <span style="color: #990000">(</span>minc2 <span style="color: #990000">-</span> <span style="font-weight: bold"><span style="color: #000000">GETJSAMPLE</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>colormap<span style="color: #990000">[</span><span style="color: #993399">2</span><span style="color: #990000">]</span><span style="color: #990000">[</span>icolor<span style="color: #990000">]</span><span style="color: #990000">)</span><span style="color: #990000">)</span> <span style="color: #990000">*</span> C2_SCALE<span style="color: #990000">;</span>
<a name="line819">0819: </a>    dist0 <span style="color: #990000">+</span><span style="color: #990000">=</span> inc2<span style="color: #990000">*</span>inc2<span style="color: #990000">;</span>
<a name="line820">0820: </a>    <span style="font-style: italic"><span style="color: #9A1900">/* Form the initial difference increments */</span></span>
<a name="line821">0821: </a>    inc0 <span style="color: #990000">=</span> inc0 <span style="color: #990000">*</span> <span style="color: #990000">(</span><span style="color: #993399">2</span> <span style="color: #990000">*</span> STEP_C0<span style="color: #990000">)</span> <span style="color: #990000">+</span> STEP_C0 <span style="color: #990000">*</span> STEP_C0<span style="color: #990000">;</span>
<a name="line822">0822: </a>    inc1 <span style="color: #990000">=</span> inc1 <span style="color: #990000">*</span> <span style="color: #990000">(</span><span style="color: #993399">2</span> <span style="color: #990000">*</span> STEP_C1<span style="color: #990000">)</span> <span style="color: #990000">+</span> STEP_C1 <span style="color: #990000">*</span> STEP_C1<span style="color: #990000">;</span>
<a name="line823">0823: </a>    inc2 <span style="color: #990000">=</span> inc2 <span style="color: #990000">*</span> <span style="color: #990000">(</span><span style="color: #993399">2</span> <span style="color: #990000">*</span> STEP_C2<span style="color: #990000">)</span> <span style="color: #990000">+</span> STEP_C2 <span style="color: #990000">*</span> STEP_C2<span style="color: #990000">;</span>
<a name="line824">0824: </a>    <span style="font-style: italic"><span style="color: #9A1900">/* Now loop over all cells in box, updating distance per Thomas method */</span></span>
<a name="line825">0825: </a>    bptr <span style="color: #990000">=</span> bestdist<span style="color: #990000">;</span>
<a name="line826">0826: </a>    cptr <span style="color: #990000">=</span> bestcolor<span style="color: #990000">;</span>
<a name="line827">0827: </a>    xx0 <span style="color: #990000">=</span> inc0<span style="color: #990000">;</span>
<a name="line828">0828: </a>    <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> <span style="color: #990000">(</span>ic0 <span style="color: #990000">=</span> BOX_C0_ELEMS<span style="color: #990000">-</span><span style="color: #993399">1</span><span style="color: #990000">;</span> ic0 <span style="color: #990000">&gt;</span><span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">;</span> ic0<span style="color: #990000">-</span><span style="color: #990000">-</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line829">0829: </a>      dist1 <span style="color: #990000">=</span> dist0<span style="color: #990000">;</span>
<a name="line830">0830: </a>      xx1 <span style="color: #990000">=</span> inc1<span style="color: #990000">;</span>
<a name="line831">0831: </a>      <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> <span style="color: #990000">(</span>ic1 <span style="color: #990000">=</span> BOX_C1_ELEMS<span style="color: #990000">-</span><span style="color: #993399">1</span><span style="color: #990000">;</span> ic1 <span style="color: #990000">&gt;</span><span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">;</span> ic1<span style="color: #990000">-</span><span style="color: #990000">-</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line832">0832: </a>        dist2 <span style="color: #990000">=</span> dist1<span style="color: #990000">;</span>
<a name="line833">0833: </a>        xx2 <span style="color: #990000">=</span> inc2<span style="color: #990000">;</span>
<a name="line834">0834: </a>        <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> <span style="color: #990000">(</span>ic2 <span style="color: #990000">=</span> BOX_C2_ELEMS<span style="color: #990000">-</span><span style="color: #993399">1</span><span style="color: #990000">;</span> ic2 <span style="color: #990000">&gt;</span><span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">;</span> ic2<span style="color: #990000">-</span><span style="color: #990000">-</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line835">0835: </a>          <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>dist2 <span style="color: #990000">&lt;</span> <span style="color: #990000">*</span>bptr<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line836">0836: </a>            <span style="color: #990000">*</span>bptr <span style="color: #990000">=</span> dist2<span style="color: #990000">;</span>
<a name="line837">0837: </a>            <span style="color: #990000">*</span>cptr <span style="color: #990000">=</span> <span style="color: #990000">(</span>JSAMPLE<span style="color: #990000">)</span> icolor<span style="color: #990000">;</span>
<a name="line838">0838: </a>          <span style="color: #FF0000">}</span>
<a name="line839">0839: </a>          dist2 <span style="color: #990000">+</span><span style="color: #990000">=</span> xx2<span style="color: #990000">;</span>
<a name="line840">0840: </a>          xx2 <span style="color: #990000">+</span><span style="color: #990000">=</span> <span style="color: #993399">2</span> <span style="color: #990000">*</span> STEP_C2 <span style="color: #990000">*</span> STEP_C2<span style="color: #990000">;</span>
<a name="line841">0841: </a>          bptr<span style="color: #990000">+</span><span style="color: #990000">+</span><span style="color: #990000">;</span>
<a name="line842">0842: </a>          cptr<span style="color: #990000">+</span><span style="color: #990000">+</span><span style="color: #990000">;</span>
<a name="line843">0843: </a>        <span style="color: #FF0000">}</span>
<a name="line844">0844: </a>        dist1 <span style="color: #990000">+</span><span style="color: #990000">=</span> xx1<span style="color: #990000">;</span>
<a name="line845">0845: </a>        xx1 <span style="color: #990000">+</span><span style="color: #990000">=</span> <span style="color: #993399">2</span> <span style="color: #990000">*</span> STEP_C1 <span style="color: #990000">*</span> STEP_C1<span style="color: #990000">;</span>
<a name="line846">0846: </a>      <span style="color: #FF0000">}</span>
<a name="line847">0847: </a>      dist0 <span style="color: #990000">+</span><span style="color: #990000">=</span> xx0<span style="color: #990000">;</span>
<a name="line848">0848: </a>      xx0 <span style="color: #990000">+</span><span style="color: #990000">=</span> <span style="color: #993399">2</span> <span style="color: #990000">*</span> STEP_C0 <span style="color: #990000">*</span> STEP_C0<span style="color: #990000">;</span>
<a name="line849">0849: </a>    <span style="color: #FF0000">}</span>
<a name="line850">0850: </a>  <span style="color: #FF0000">}</span>
<a name="line851">0851: </a><span style="color: #FF0000">}</span>
<a name="line852">0852: </a>
<a name="line853">0853: </a>
<a name="line854">0854: </a><span style="font-weight: bold"><span style="color: #000000">LOCAL</span></span><span style="color: #990000">(</span><span style="color: #009900">void</span><span style="color: #990000">)</span>
<a name="line855">0855: </a><span style="font-weight: bold"><span style="color: #000000">fill_inverse_cmap</span></span> <span style="color: #990000">(</span>j_decompress_ptr cinfo<span style="color: #990000">,</span> <span style="color: #009900">int</span> c0<span style="color: #990000">,</span> <span style="color: #009900">int</span> c1<span style="color: #990000">,</span> <span style="color: #009900">int</span> c2<span style="color: #990000">)</span>
<a name="line856">0856: </a><span style="font-style: italic"><span style="color: #9A1900">/* Fill the inverse-colormap entries in the update box that contains */</span></span>
<a name="line857">0857: </a><span style="font-style: italic"><span style="color: #9A1900">/* histogram cell c0/c1/c2.  (Only that one cell MUST be filled, but */</span></span>
<a name="line858">0858: </a><span style="font-style: italic"><span style="color: #9A1900">/* we can fill as many others as we wish.) */</span></span>
<a name="line859">0859: </a><span style="color: #FF0000">{</span>
<a name="line860">0860: </a>  my_cquantize_ptr cquantize <span style="color: #990000">=</span> <span style="color: #990000">(</span>my_cquantize_ptr<span style="color: #990000">)</span> cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>cquantize<span style="color: #990000">;</span>
<a name="line861">0861: </a>  hist3d histogram <span style="color: #990000">=</span> cquantize<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>histogram<span style="color: #990000">;</span>
<a name="line862">0862: </a>  <span style="color: #009900">int</span> minc0<span style="color: #990000">,</span> minc1<span style="color: #990000">,</span> minc2<span style="color: #990000">;</span>      <span style="font-style: italic"><span style="color: #9A1900">/* lower left corner of update box */</span></span>
<a name="line863">0863: </a>  <span style="color: #009900">int</span> ic0<span style="color: #990000">,</span> ic1<span style="color: #990000">,</span> ic2<span style="color: #990000">;</span>
<a name="line864">0864: </a>  <span style="font-weight: bold"><span style="color: #0000FF">register</span></span> JSAMPLE <span style="color: #990000">*</span> cptr<span style="color: #990000">;</span>      <span style="font-style: italic"><span style="color: #9A1900">/* pointer into bestcolor[] array */</span></span>
<a name="line865">0865: </a>  <span style="font-weight: bold"><span style="color: #0000FF">register</span></span> histptr cachep<span style="color: #990000">;</span>      <span style="font-style: italic"><span style="color: #9A1900">/* pointer into main cache array */</span></span>
<a name="line866">0866: </a>  <span style="font-style: italic"><span style="color: #9A1900">/* This array lists the candidate colormap indexes. */</span></span>
<a name="line867">0867: </a>  JSAMPLE colorlist<span style="color: #990000">[</span>MAXNUMCOLORS<span style="color: #990000">]</span><span style="color: #990000">;</span>
<a name="line868">0868: </a>  <span style="color: #009900">int</span> numcolors<span style="color: #990000">;</span>                <span style="font-style: italic"><span style="color: #9A1900">/* number of candidate colors */</span></span>
<a name="line869">0869: </a>  <span style="font-style: italic"><span style="color: #9A1900">/* This array holds the actually closest colormap index for each cell. */</span></span>
<a name="line870">0870: </a>  JSAMPLE bestcolor<span style="color: #990000">[</span>BOX_C0_ELEMS <span style="color: #990000">*</span> BOX_C1_ELEMS <span style="color: #990000">*</span> BOX_C2_ELEMS<span style="color: #990000">]</span><span style="color: #990000">;</span>
<a name="line871">0871: </a>
<a name="line872">0872: </a>  <span style="font-style: italic"><span style="color: #9A1900">/* Convert cell coordinates to update box ID */</span></span>
<a name="line873">0873: </a>  c0 <span style="color: #990000">&gt;</span><span style="color: #990000">&gt;</span><span style="color: #990000">=</span> BOX_C0_LOG<span style="color: #990000">;</span>
<a name="line874">0874: </a>  c1 <span style="color: #990000">&gt;</span><span style="color: #990000">&gt;</span><span style="color: #990000">=</span> BOX_C1_LOG<span style="color: #990000">;</span>
<a name="line875">0875: </a>  c2 <span style="color: #990000">&gt;</span><span style="color: #990000">&gt;</span><span style="color: #990000">=</span> BOX_C2_LOG<span style="color: #990000">;</span>
<a name="line876">0876: </a>
<a name="line877">0877: </a>  <span style="font-style: italic"><span style="color: #9A1900">/* Compute true coordinates of update box's origin corner.</span></span>
<a name="line878">0878: </a><span style="font-style: italic"><span style="color: #9A1900">   * Actually we compute the coordinates of the center of the corner</span></span>
<a name="line879">0879: </a><span style="font-style: italic"><span style="color: #9A1900">   * histogram cell, which are the lower bounds of the volume we care about.</span></span>
<a name="line880">0880: </a><span style="font-style: italic"><span style="color: #9A1900">   */</span></span>
<a name="line881">0881: </a>  minc0 <span style="color: #990000">=</span> <span style="color: #990000">(</span>c0 <span style="color: #990000">&lt;</span><span style="color: #990000">&lt;</span> BOX_C0_SHIFT<span style="color: #990000">)</span> <span style="color: #990000">+</span> <span style="color: #990000">(</span><span style="color: #990000">(</span><span style="color: #993399">1</span> <span style="color: #990000">&lt;</span><span style="color: #990000">&lt;</span> C0_SHIFT<span style="color: #990000">)</span> <span style="color: #990000">&gt;</span><span style="color: #990000">&gt;</span> <span style="color: #993399">1</span><span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line882">0882: </a>  minc1 <span style="color: #990000">=</span> <span style="color: #990000">(</span>c1 <span style="color: #990000">&lt;</span><span style="color: #990000">&lt;</span> BOX_C1_SHIFT<span style="color: #990000">)</span> <span style="color: #990000">+</span> <span style="color: #990000">(</span><span style="color: #990000">(</span><span style="color: #993399">1</span> <span style="color: #990000">&lt;</span><span style="color: #990000">&lt;</span> C1_SHIFT<span style="color: #990000">)</span> <span style="color: #990000">&gt;</span><span style="color: #990000">&gt;</span> <span style="color: #993399">1</span><span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line883">0883: </a>  minc2 <span style="color: #990000">=</span> <span style="color: #990000">(</span>c2 <span style="color: #990000">&lt;</span><span style="color: #990000">&lt;</span> BOX_C2_SHIFT<span style="color: #990000">)</span> <span style="color: #990000">+</span> <span style="color: #990000">(</span><span style="color: #990000">(</span><span style="color: #993399">1</span> <span style="color: #990000">&lt;</span><span style="color: #990000">&lt;</span> C2_SHIFT<span style="color: #990000">)</span> <span style="color: #990000">&gt;</span><span style="color: #990000">&gt;</span> <span style="color: #993399">1</span><span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line884">0884: </a>  
<a name="line885">0885: </a>  <span style="font-style: italic"><span style="color: #9A1900">/* Determine which colormap entries are close enough to be candidates</span></span>
<a name="line886">0886: </a><span style="font-style: italic"><span style="color: #9A1900">   * for the nearest entry to some cell in the update box.</span></span>
<a name="line887">0887: </a><span style="font-style: italic"><span style="color: #9A1900">   */</span></span>
<a name="line888">0888: </a>  numcolors <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">find_nearby_colors</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> minc0<span style="color: #990000">,</span> minc1<span style="color: #990000">,</span> minc2<span style="color: #990000">,</span> colorlist<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line889">0889: </a>
<a name="line890">0890: </a>  <span style="font-style: italic"><span style="color: #9A1900">/* Determine the actually nearest colors. */</span></span>
<a name="line891">0891: </a>  <span style="font-weight: bold"><span style="color: #000000">find_best_colors</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> minc0<span style="color: #990000">,</span> minc1<span style="color: #990000">,</span> minc2<span style="color: #990000">,</span> numcolors<span style="color: #990000">,</span> colorlist<span style="color: #990000">,</span>
<a name="line892">0892: </a>                   bestcolor<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line893">0893: </a>
<a name="line894">0894: </a>  <span style="font-style: italic"><span style="color: #9A1900">/* Save the best color numbers (plus 1) in the main cache array */</span></span>
<a name="line895">0895: </a>  c0 <span style="color: #990000">&lt;</span><span style="color: #990000">&lt;</span><span style="color: #990000">=</span> BOX_C0_LOG<span style="color: #990000">;</span>            <span style="font-style: italic"><span style="color: #9A1900">/* convert ID back to base cell indexes */</span></span>
<a name="line896">0896: </a>  c1 <span style="color: #990000">&lt;</span><span style="color: #990000">&lt;</span><span style="color: #990000">=</span> BOX_C1_LOG<span style="color: #990000">;</span>
<a name="line897">0897: </a>  c2 <span style="color: #990000">&lt;</span><span style="color: #990000">&lt;</span><span style="color: #990000">=</span> BOX_C2_LOG<span style="color: #990000">;</span>
<a name="line898">0898: </a>  cptr <span style="color: #990000">=</span> bestcolor<span style="color: #990000">;</span>
<a name="line899">0899: </a>  <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> <span style="color: #990000">(</span>ic0 <span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">;</span> ic0 <span style="color: #990000">&lt;</span> BOX_C0_ELEMS<span style="color: #990000">;</span> ic0<span style="color: #990000">+</span><span style="color: #990000">+</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line900">0900: </a>    <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> <span style="color: #990000">(</span>ic1 <span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">;</span> ic1 <span style="color: #990000">&lt;</span> BOX_C1_ELEMS<span style="color: #990000">;</span> ic1<span style="color: #990000">+</span><span style="color: #990000">+</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line901">0901: </a>      cachep <span style="color: #990000">=</span> <span style="color: #990000">&amp;</span> histogram<span style="color: #990000">[</span>c0<span style="color: #990000">+</span>ic0<span style="color: #990000">]</span><span style="color: #990000">[</span>c1<span style="color: #990000">+</span>ic1<span style="color: #990000">]</span><span style="color: #990000">[</span>c2<span style="color: #990000">]</span><span style="color: #990000">;</span>
<a name="line902">0902: </a>      <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> <span style="color: #990000">(</span>ic2 <span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">;</span> ic2 <span style="color: #990000">&lt;</span> BOX_C2_ELEMS<span style="color: #990000">;</span> ic2<span style="color: #990000">+</span><span style="color: #990000">+</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line903">0903: </a>        <span style="color: #990000">*</span>cachep<span style="color: #990000">+</span><span style="color: #990000">+</span> <span style="color: #990000">=</span> <span style="color: #990000">(</span>histcell<span style="color: #990000">)</span> <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #000000">GETJSAMPLE</span></span><span style="color: #990000">(</span><span style="color: #990000">*</span>cptr<span style="color: #990000">+</span><span style="color: #990000">+</span><span style="color: #990000">)</span> <span style="color: #990000">+</span> <span style="color: #993399">1</span><span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line904">0904: </a>      <span style="color: #FF0000">}</span>
<a name="line905">0905: </a>    <span style="color: #FF0000">}</span>
<a name="line906">0906: </a>  <span style="color: #FF0000">}</span>
<a name="line907">0907: </a><span style="color: #FF0000">}</span>
<a name="line908">0908: </a>
<a name="line909">0909: </a>
<a name="line910">0910: </a><span style="font-style: italic"><span style="color: #9A1900">/*</span></span>
<a name="line911">0911: </a><span style="font-style: italic"><span style="color: #9A1900"> * Map some rows of pixels to the output colormapped representation.</span></span>
<a name="line912">0912: </a><span style="font-style: italic"><span style="color: #9A1900"> */</span></span>
<a name="line913">0913: </a>
<a name="line914">0914: </a><span style="font-weight: bold"><span style="color: #000000">METHODDEF</span></span><span style="color: #990000">(</span><span style="color: #009900">void</span><span style="color: #990000">)</span>
<a name="line915">0915: </a><span style="font-weight: bold"><span style="color: #000000">pass2_no_dither</span></span> <span style="color: #990000">(</span>j_decompress_ptr cinfo<span style="color: #990000">,</span>
<a name="line916">0916: </a>                 JSAMPARRAY input_buf<span style="color: #990000">,</span> JSAMPARRAY output_buf<span style="color: #990000">,</span> <span style="color: #009900">int</span> num_rows<span style="color: #990000">)</span>
<a name="line917">0917: </a><span style="font-style: italic"><span style="color: #9A1900">/* This version performs no dithering */</span></span>
<a name="line918">0918: </a><span style="color: #FF0000">{</span>
<a name="line919">0919: </a>  my_cquantize_ptr cquantize <span style="color: #990000">=</span> <span style="color: #990000">(</span>my_cquantize_ptr<span style="color: #990000">)</span> cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>cquantize<span style="color: #990000">;</span>
<a name="line920">0920: </a>  hist3d histogram <span style="color: #990000">=</span> cquantize<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>histogram<span style="color: #990000">;</span>
<a name="line921">0921: </a>  <span style="font-weight: bold"><span style="color: #0000FF">register</span></span> JSAMPROW inptr<span style="color: #990000">,</span> outptr<span style="color: #990000">;</span>
<a name="line922">0922: </a>  <span style="font-weight: bold"><span style="color: #0000FF">register</span></span> histptr cachep<span style="color: #990000">;</span>
<a name="line923">0923: </a>  <span style="font-weight: bold"><span style="color: #0000FF">register</span></span> <span style="color: #009900">int</span> c0<span style="color: #990000">,</span> c1<span style="color: #990000">,</span> c2<span style="color: #990000">;</span>
<a name="line924">0924: </a>  <span style="color: #009900">int</span> row<span style="color: #990000">;</span>
<a name="line925">0925: </a>  JDIMENSION col<span style="color: #990000">;</span>
<a name="line926">0926: </a>  JDIMENSION width <span style="color: #990000">=</span> cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>output_width<span style="color: #990000">;</span>
<a name="line927">0927: </a>
<a name="line928">0928: </a>  <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> <span style="color: #990000">(</span>row <span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">;</span> row <span style="color: #990000">&lt;</span> num_rows<span style="color: #990000">;</span> row<span style="color: #990000">+</span><span style="color: #990000">+</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line929">0929: </a>    inptr <span style="color: #990000">=</span> input_buf<span style="color: #990000">[</span>row<span style="color: #990000">]</span><span style="color: #990000">;</span>
<a name="line930">0930: </a>    outptr <span style="color: #990000">=</span> output_buf<span style="color: #990000">[</span>row<span style="color: #990000">]</span><span style="color: #990000">;</span>
<a name="line931">0931: </a>    <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> <span style="color: #990000">(</span>col <span style="color: #990000">=</span> width<span style="color: #990000">;</span> col <span style="color: #990000">&gt;</span> <span style="color: #993399">0</span><span style="color: #990000">;</span> col<span style="color: #990000">-</span><span style="color: #990000">-</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line932">0932: </a>      <span style="font-style: italic"><span style="color: #9A1900">/* get pixel value and index into the cache */</span></span>
<a name="line933">0933: </a>      c0 <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">GETJSAMPLE</span></span><span style="color: #990000">(</span><span style="color: #990000">*</span>inptr<span style="color: #990000">+</span><span style="color: #990000">+</span><span style="color: #990000">)</span> <span style="color: #990000">&gt;</span><span style="color: #990000">&gt;</span> C0_SHIFT<span style="color: #990000">;</span>
<a name="line934">0934: </a>      c1 <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">GETJSAMPLE</span></span><span style="color: #990000">(</span><span style="color: #990000">*</span>inptr<span style="color: #990000">+</span><span style="color: #990000">+</span><span style="color: #990000">)</span> <span style="color: #990000">&gt;</span><span style="color: #990000">&gt;</span> C1_SHIFT<span style="color: #990000">;</span>
<a name="line935">0935: </a>      c2 <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">GETJSAMPLE</span></span><span style="color: #990000">(</span><span style="color: #990000">*</span>inptr<span style="color: #990000">+</span><span style="color: #990000">+</span><span style="color: #990000">)</span> <span style="color: #990000">&gt;</span><span style="color: #990000">&gt;</span> C2_SHIFT<span style="color: #990000">;</span>
<a name="line936">0936: </a>      cachep <span style="color: #990000">=</span> <span style="color: #990000">&amp;</span> histogram<span style="color: #990000">[</span>c0<span style="color: #990000">]</span><span style="color: #990000">[</span>c1<span style="color: #990000">]</span><span style="color: #990000">[</span>c2<span style="color: #990000">]</span><span style="color: #990000">;</span>
<a name="line937">0937: </a>      <span style="font-style: italic"><span style="color: #9A1900">/* If we have not seen this color before, find nearest colormap entry */</span></span>
<a name="line938">0938: </a>      <span style="font-style: italic"><span style="color: #9A1900">/* and update the cache */</span></span>
<a name="line939">0939: </a>      <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span><span style="color: #990000">*</span>cachep <span style="color: #990000">=</span><span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">)</span>
<a name="line940">0940: </a>        <span style="font-weight: bold"><span style="color: #000000">fill_inverse_cmap</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> c0<span style="color: #990000">,</span>c1<span style="color: #990000">,</span>c2<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line941">0941: </a>      <span style="font-style: italic"><span style="color: #9A1900">/* Now emit the colormap index for this cell */</span></span>
<a name="line942">0942: </a>      <span style="color: #990000">*</span>outptr<span style="color: #990000">+</span><span style="color: #990000">+</span> <span style="color: #990000">=</span> <span style="color: #990000">(</span>JSAMPLE<span style="color: #990000">)</span> <span style="color: #990000">(</span><span style="color: #990000">*</span>cachep <span style="color: #990000">-</span> <span style="color: #993399">1</span><span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line943">0943: </a>    <span style="color: #FF0000">}</span>
<a name="line944">0944: </a>  <span style="color: #FF0000">}</span>
<a name="line945">0945: </a><span style="color: #FF0000">}</span>
<a name="line946">0946: </a>
<a name="line947">0947: </a>
<a name="line948">0948: </a><span style="font-weight: bold"><span style="color: #000000">METHODDEF</span></span><span style="color: #990000">(</span><span style="color: #009900">void</span><span style="color: #990000">)</span>
<a name="line949">0949: </a><span style="font-weight: bold"><span style="color: #000000">pass2_fs_dither</span></span> <span style="color: #990000">(</span>j_decompress_ptr cinfo<span style="color: #990000">,</span>
<a name="line950">0950: </a>                 JSAMPARRAY input_buf<span style="color: #990000">,</span> JSAMPARRAY output_buf<span style="color: #990000">,</span> <span style="color: #009900">int</span> num_rows<span style="color: #990000">)</span>
<a name="line951">0951: </a><span style="font-style: italic"><span style="color: #9A1900">/* This version performs Floyd-Steinberg dithering */</span></span>
<a name="line952">0952: </a><span style="color: #FF0000">{</span>
<a name="line953">0953: </a>  my_cquantize_ptr cquantize <span style="color: #990000">=</span> <span style="color: #990000">(</span>my_cquantize_ptr<span style="color: #990000">)</span> cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>cquantize<span style="color: #990000">;</span>
<a name="line954">0954: </a>  hist3d histogram <span style="color: #990000">=</span> cquantize<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>histogram<span style="color: #990000">;</span>
<a name="line955">0955: </a>  <span style="font-weight: bold"><span style="color: #0000FF">register</span></span> LOCFSERROR cur0<span style="color: #990000">,</span> cur1<span style="color: #990000">,</span> cur2<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">/* current error or pixel value */</span></span>
<a name="line956">0956: </a>  LOCFSERROR belowerr0<span style="color: #990000">,</span> belowerr1<span style="color: #990000">,</span> belowerr2<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">/* error for pixel below cur */</span></span>
<a name="line957">0957: </a>  LOCFSERROR bpreverr0<span style="color: #990000">,</span> bpreverr1<span style="color: #990000">,</span> bpreverr2<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">/* error for below/prev col */</span></span>
<a name="line958">0958: </a>  <span style="font-weight: bold"><span style="color: #0000FF">register</span></span> FSERRPTR errorptr<span style="color: #990000">;</span>   <span style="font-style: italic"><span style="color: #9A1900">/* =&gt; fserrors[] at column before current */</span></span>
<a name="line959">0959: </a>  JSAMPROW inptr<span style="color: #990000">;</span>               <span style="font-style: italic"><span style="color: #9A1900">/* =&gt; current input pixel */</span></span>
<a name="line960">0960: </a>  JSAMPROW outptr<span style="color: #990000">;</span>              <span style="font-style: italic"><span style="color: #9A1900">/* =&gt; current output pixel */</span></span>
<a name="line961">0961: </a>  histptr cachep<span style="color: #990000">;</span>
<a name="line962">0962: </a>  <span style="color: #009900">int</span> dir<span style="color: #990000">;</span>                      <span style="font-style: italic"><span style="color: #9A1900">/* +1 or -1 depending on direction */</span></span>
<a name="line963">0963: </a>  <span style="color: #009900">int</span> dir3<span style="color: #990000">;</span>                     <span style="font-style: italic"><span style="color: #9A1900">/* 3*dir, for advancing inptr &amp; errorptr */</span></span>
<a name="line964">0964: </a>  <span style="color: #009900">int</span> row<span style="color: #990000">;</span>
<a name="line965">0965: </a>  JDIMENSION col<span style="color: #990000">;</span>
<a name="line966">0966: </a>  JDIMENSION width <span style="color: #990000">=</span> cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>output_width<span style="color: #990000">;</span>
<a name="line967">0967: </a>  JSAMPLE <span style="color: #990000">*</span>range_limit <span style="color: #990000">=</span> cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>sample_range_limit<span style="color: #990000">;</span>
<a name="line968">0968: </a>  <span style="color: #009900">int</span> <span style="color: #990000">*</span>error_limit <span style="color: #990000">=</span> cquantize<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>error_limiter<span style="color: #990000">;</span>
<a name="line969">0969: </a>  JSAMPROW colormap0 <span style="color: #990000">=</span> cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>colormap<span style="color: #990000">[</span><span style="color: #993399">0</span><span style="color: #990000">]</span><span style="color: #990000">;</span>
<a name="line970">0970: </a>  JSAMPROW colormap1 <span style="color: #990000">=</span> cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>colormap<span style="color: #990000">[</span><span style="color: #993399">1</span><span style="color: #990000">]</span><span style="color: #990000">;</span>
<a name="line971">0971: </a>  JSAMPROW colormap2 <span style="color: #990000">=</span> cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>colormap<span style="color: #990000">[</span><span style="color: #993399">2</span><span style="color: #990000">]</span><span style="color: #990000">;</span>
<a name="line972">0972: </a>  SHIFT_TEMPS
<a name="line973">0973: </a>
<a name="line974">0974: </a>  <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> <span style="color: #990000">(</span>row <span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">;</span> row <span style="color: #990000">&lt;</span> num_rows<span style="color: #990000">;</span> row<span style="color: #990000">+</span><span style="color: #990000">+</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line975">0975: </a>    inptr <span style="color: #990000">=</span> input_buf<span style="color: #990000">[</span>row<span style="color: #990000">]</span><span style="color: #990000">;</span>
<a name="line976">0976: </a>    outptr <span style="color: #990000">=</span> output_buf<span style="color: #990000">[</span>row<span style="color: #990000">]</span><span style="color: #990000">;</span>
<a name="line977">0977: </a>    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>cquantize<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>on_odd_row<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line978">0978: </a>      <span style="font-style: italic"><span style="color: #9A1900">/* work right to left in this row */</span></span>
<a name="line979">0979: </a>      inptr <span style="color: #990000">+</span><span style="color: #990000">=</span> <span style="color: #990000">(</span>width<span style="color: #990000">-</span><span style="color: #993399">1</span><span style="color: #990000">)</span> <span style="color: #990000">*</span> <span style="color: #993399">3</span><span style="color: #990000">;</span>   <span style="font-style: italic"><span style="color: #9A1900">/* so point to rightmost pixel */</span></span>
<a name="line980">0980: </a>      outptr <span style="color: #990000">+</span><span style="color: #990000">=</span> width<span style="color: #990000">-</span><span style="color: #993399">1</span><span style="color: #990000">;</span>
<a name="line981">0981: </a>      dir <span style="color: #990000">=</span> <span style="color: #990000">-</span><span style="color: #993399">1</span><span style="color: #990000">;</span>
<a name="line982">0982: </a>      dir3 <span style="color: #990000">=</span> <span style="color: #990000">-</span><span style="color: #993399">3</span><span style="color: #990000">;</span>
<a name="line983">0983: </a>      errorptr <span style="color: #990000">=</span> cquantize<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>fserrors <span style="color: #990000">+</span> <span style="color: #990000">(</span>width<span style="color: #990000">+</span><span style="color: #993399">1</span><span style="color: #990000">)</span><span style="color: #990000">*</span><span style="color: #993399">3</span><span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">/* =&gt; entry after last column */</span></span>
<a name="line984">0984: </a>      cquantize<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>on_odd_row <span style="color: #990000">=</span> FALSE<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">/* flip for next time */</span></span>
<a name="line985">0985: </a>    <span style="color: #FF0000">}</span> <span style="font-weight: bold"><span style="color: #0000FF">else</span></span> <span style="color: #FF0000">{</span>
<a name="line986">0986: </a>      <span style="font-style: italic"><span style="color: #9A1900">/* work left to right in this row */</span></span>
<a name="line987">0987: </a>      dir <span style="color: #990000">=</span> <span style="color: #993399">1</span><span style="color: #990000">;</span>
<a name="line988">0988: </a>      dir3 <span style="color: #990000">=</span> <span style="color: #993399">3</span><span style="color: #990000">;</span>
<a name="line989">0989: </a>      errorptr <span style="color: #990000">=</span> cquantize<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>fserrors<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">/* =&gt; entry before first real column */</span></span>
<a name="line990">0990: </a>      cquantize<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>on_odd_row <span style="color: #990000">=</span> TRUE<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">/* flip for next time */</span></span>
<a name="line991">0991: </a>    <span style="color: #FF0000">}</span>
<a name="line992">0992: </a>    <span style="font-style: italic"><span style="color: #9A1900">/* Preset error values: no error propagated to first pixel from left */</span></span>
<a name="line993">0993: </a>    cur0 <span style="color: #990000">=</span> cur1 <span style="color: #990000">=</span> cur2 <span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">;</span>
<a name="line994">0994: </a>    <span style="font-style: italic"><span style="color: #9A1900">/* and no error propagated to row below yet */</span></span>
<a name="line995">0995: </a>    belowerr0 <span style="color: #990000">=</span> belowerr1 <span style="color: #990000">=</span> belowerr2 <span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">;</span>
<a name="line996">0996: </a>    bpreverr0 <span style="color: #990000">=</span> bpreverr1 <span style="color: #990000">=</span> bpreverr2 <span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">;</span>
<a name="line997">0997: </a>
<a name="line998">0998: </a>    <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> <span style="color: #990000">(</span>col <span style="color: #990000">=</span> width<span style="color: #990000">;</span> col <span style="color: #990000">&gt;</span> <span style="color: #993399">0</span><span style="color: #990000">;</span> col<span style="color: #990000">-</span><span style="color: #990000">-</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line999">0999: </a>      <span style="font-style: italic"><span style="color: #9A1900">/* curN holds the error propagated from the previous pixel on the</span></span>
<a name="line1000">1000: </a><span style="font-style: italic"><span style="color: #9A1900">       * current line.  Add the error propagated from the previous line</span></span>
<a name="line1001">1001: </a><span style="font-style: italic"><span style="color: #9A1900">       * to form the complete error correction term for this pixel, and</span></span>
<a name="line1002">1002: </a><span style="font-style: italic"><span style="color: #9A1900">       * round the error term (which is expressed * 16) to an integer.</span></span>
<a name="line1003">1003: </a><span style="font-style: italic"><span style="color: #9A1900">       * RIGHT_SHIFT rounds towards minus infinity, so adding 8 is correct</span></span>
<a name="line1004">1004: </a><span style="font-style: italic"><span style="color: #9A1900">       * for either sign of the error value.</span></span>
<a name="line1005">1005: </a><span style="font-style: italic"><span style="color: #9A1900">       * Note: errorptr points to *previous* column's array entry.</span></span>
<a name="line1006">1006: </a><span style="font-style: italic"><span style="color: #9A1900">       */</span></span>
<a name="line1007">1007: </a>      cur0 <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">RIGHT_SHIFT</span></span><span style="color: #990000">(</span>cur0 <span style="color: #990000">+</span> errorptr<span style="color: #990000">[</span>dir3<span style="color: #990000">+</span><span style="color: #993399">0</span><span style="color: #990000">]</span> <span style="color: #990000">+</span> <span style="color: #993399">8</span><span style="color: #990000">,</span> <span style="color: #993399">4</span><span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line1008">1008: </a>      cur1 <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">RIGHT_SHIFT</span></span><span style="color: #990000">(</span>cur1 <span style="color: #990000">+</span> errorptr<span style="color: #990000">[</span>dir3<span style="color: #990000">+</span><span style="color: #993399">1</span><span style="color: #990000">]</span> <span style="color: #990000">+</span> <span style="color: #993399">8</span><span style="color: #990000">,</span> <span style="color: #993399">4</span><span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line1009">1009: </a>      cur2 <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">RIGHT_SHIFT</span></span><span style="color: #990000">(</span>cur2 <span style="color: #990000">+</span> errorptr<span style="color: #990000">[</span>dir3<span style="color: #990000">+</span><span style="color: #993399">2</span><span style="color: #990000">]</span> <span style="color: #990000">+</span> <span style="color: #993399">8</span><span style="color: #990000">,</span> <span style="color: #993399">4</span><span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line1010">1010: </a>      <span style="font-style: italic"><span style="color: #9A1900">/* Limit the error using transfer function set by init_error_limit.</span></span>
<a name="line1011">1011: </a><span style="font-style: italic"><span style="color: #9A1900">       * See comments with init_error_limit for rationale.</span></span>
<a name="line1012">1012: </a><span style="font-style: italic"><span style="color: #9A1900">       */</span></span>
<a name="line1013">1013: </a>      cur0 <span style="color: #990000">=</span> error_limit<span style="color: #990000">[</span>cur0<span style="color: #990000">]</span><span style="color: #990000">;</span>
<a name="line1014">1014: </a>      cur1 <span style="color: #990000">=</span> error_limit<span style="color: #990000">[</span>cur1<span style="color: #990000">]</span><span style="color: #990000">;</span>
<a name="line1015">1015: </a>      cur2 <span style="color: #990000">=</span> error_limit<span style="color: #990000">[</span>cur2<span style="color: #990000">]</span><span style="color: #990000">;</span>
<a name="line1016">1016: </a>      <span style="font-style: italic"><span style="color: #9A1900">/* Form pixel value + error, and range-limit to 0..MAXJSAMPLE.</span></span>
<a name="line1017">1017: </a><span style="font-style: italic"><span style="color: #9A1900">       * The maximum error is +- MAXJSAMPLE (or less with error limiting);</span></span>
<a name="line1018">1018: </a><span style="font-style: italic"><span style="color: #9A1900">       * this sets the required size of the range_limit array.</span></span>
<a name="line1019">1019: </a><span style="font-style: italic"><span style="color: #9A1900">       */</span></span>
<a name="line1020">1020: </a>      cur0 <span style="color: #990000">+</span><span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">GETJSAMPLE</span></span><span style="color: #990000">(</span>inptr<span style="color: #990000">[</span><span style="color: #993399">0</span><span style="color: #990000">]</span><span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line1021">1021: </a>      cur1 <span style="color: #990000">+</span><span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">GETJSAMPLE</span></span><span style="color: #990000">(</span>inptr<span style="color: #990000">[</span><span style="color: #993399">1</span><span style="color: #990000">]</span><span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line1022">1022: </a>      cur2 <span style="color: #990000">+</span><span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">GETJSAMPLE</span></span><span style="color: #990000">(</span>inptr<span style="color: #990000">[</span><span style="color: #993399">2</span><span style="color: #990000">]</span><span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line1023">1023: </a>      cur0 <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">GETJSAMPLE</span></span><span style="color: #990000">(</span>range_limit<span style="color: #990000">[</span>cur0<span style="color: #990000">]</span><span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line1024">1024: </a>      cur1 <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">GETJSAMPLE</span></span><span style="color: #990000">(</span>range_limit<span style="color: #990000">[</span>cur1<span style="color: #990000">]</span><span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line1025">1025: </a>      cur2 <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">GETJSAMPLE</span></span><span style="color: #990000">(</span>range_limit<span style="color: #990000">[</span>cur2<span style="color: #990000">]</span><span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line1026">1026: </a>      <span style="font-style: italic"><span style="color: #9A1900">/* Index into the cache with adjusted pixel value */</span></span>
<a name="line1027">1027: </a>      cachep <span style="color: #990000">=</span> <span style="color: #990000">&amp;</span> histogram<span style="color: #990000">[</span>cur0<span style="color: #990000">&gt;</span><span style="color: #990000">&gt;</span>C0_SHIFT<span style="color: #990000">]</span><span style="color: #990000">[</span>cur1<span style="color: #990000">&gt;</span><span style="color: #990000">&gt;</span>C1_SHIFT<span style="color: #990000">]</span><span style="color: #990000">[</span>cur2<span style="color: #990000">&gt;</span><span style="color: #990000">&gt;</span>C2_SHIFT<span style="color: #990000">]</span><span style="color: #990000">;</span>
<a name="line1028">1028: </a>      <span style="font-style: italic"><span style="color: #9A1900">/* If we have not seen this color before, find nearest colormap */</span></span>
<a name="line1029">1029: </a>      <span style="font-style: italic"><span style="color: #9A1900">/* entry and update the cache */</span></span>
<a name="line1030">1030: </a>      <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span><span style="color: #990000">*</span>cachep <span style="color: #990000">=</span><span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">)</span>
<a name="line1031">1031: </a>        <span style="font-weight: bold"><span style="color: #000000">fill_inverse_cmap</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> cur0<span style="color: #990000">&gt;</span><span style="color: #990000">&gt;</span>C0_SHIFT<span style="color: #990000">,</span>cur1<span style="color: #990000">&gt;</span><span style="color: #990000">&gt;</span>C1_SHIFT<span style="color: #990000">,</span>cur2<span style="color: #990000">&gt;</span><span style="color: #990000">&gt;</span>C2_SHIFT<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line1032">1032: </a>      <span style="font-style: italic"><span style="color: #9A1900">/* Now emit the colormap index for this cell */</span></span>
<a name="line1033">1033: </a>      <span style="color: #FF0000">{</span> <span style="font-weight: bold"><span style="color: #0000FF">register</span></span> <span style="color: #009900">int</span> pixcode <span style="color: #990000">=</span> <span style="color: #990000">*</span>cachep <span style="color: #990000">-</span> <span style="color: #993399">1</span><span style="color: #990000">;</span>
<a name="line1034">1034: </a>        <span style="color: #990000">*</span>outptr <span style="color: #990000">=</span> <span style="color: #990000">(</span>JSAMPLE<span style="color: #990000">)</span> pixcode<span style="color: #990000">;</span>
<a name="line1035">1035: </a>        <span style="font-style: italic"><span style="color: #9A1900">/* Compute representation error for this pixel */</span></span>
<a name="line1036">1036: </a>        cur0 <span style="color: #990000">-</span><span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">GETJSAMPLE</span></span><span style="color: #990000">(</span>colormap0<span style="color: #990000">[</span>pixcode<span style="color: #990000">]</span><span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line1037">1037: </a>        cur1 <span style="color: #990000">-</span><span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">GETJSAMPLE</span></span><span style="color: #990000">(</span>colormap1<span style="color: #990000">[</span>pixcode<span style="color: #990000">]</span><span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line1038">1038: </a>        cur2 <span style="color: #990000">-</span><span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">GETJSAMPLE</span></span><span style="color: #990000">(</span>colormap2<span style="color: #990000">[</span>pixcode<span style="color: #990000">]</span><span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line1039">1039: </a>      <span style="color: #FF0000">}</span>
<a name="line1040">1040: </a>      <span style="font-style: italic"><span style="color: #9A1900">/* Compute error fractions to be propagated to adjacent pixels.</span></span>
<a name="line1041">1041: </a><span style="font-style: italic"><span style="color: #9A1900">       * Add these into the running sums, and simultaneously shift the</span></span>
<a name="line1042">1042: </a><span style="font-style: italic"><span style="color: #9A1900">       * next-line error sums left by 1 column.</span></span>
<a name="line1043">1043: </a><span style="font-style: italic"><span style="color: #9A1900">       */</span></span>
<a name="line1044">1044: </a>      <span style="color: #FF0000">{</span> <span style="font-weight: bold"><span style="color: #0000FF">register</span></span> LOCFSERROR bnexterr<span style="color: #990000">,</span> delta<span style="color: #990000">;</span>
<a name="line1045">1045: </a>
<a name="line1046">1046: </a>        bnexterr <span style="color: #990000">=</span> cur0<span style="color: #990000">;</span>        <span style="font-style: italic"><span style="color: #9A1900">/* Process component 0 */</span></span>
<a name="line1047">1047: </a>        delta <span style="color: #990000">=</span> cur0 <span style="color: #990000">*</span> <span style="color: #993399">2</span><span style="color: #990000">;</span>
<a name="line1048">1048: </a>        cur0 <span style="color: #990000">+</span><span style="color: #990000">=</span> delta<span style="color: #990000">;</span>          <span style="font-style: italic"><span style="color: #9A1900">/* form error * 3 */</span></span>
<a name="line1049">1049: </a>        errorptr<span style="color: #990000">[</span><span style="color: #993399">0</span><span style="color: #990000">]</span> <span style="color: #990000">=</span> <span style="color: #990000">(</span>FSERROR<span style="color: #990000">)</span> <span style="color: #990000">(</span>bpreverr0 <span style="color: #990000">+</span> cur0<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line1050">1050: </a>        cur0 <span style="color: #990000">+</span><span style="color: #990000">=</span> delta<span style="color: #990000">;</span>          <span style="font-style: italic"><span style="color: #9A1900">/* form error * 5 */</span></span>
<a name="line1051">1051: </a>        bpreverr0 <span style="color: #990000">=</span> belowerr0 <span style="color: #990000">+</span> cur0<span style="color: #990000">;</span>
<a name="line1052">1052: </a>        belowerr0 <span style="color: #990000">=</span> bnexterr<span style="color: #990000">;</span>
<a name="line1053">1053: </a>        cur0 <span style="color: #990000">+</span><span style="color: #990000">=</span> delta<span style="color: #990000">;</span>          <span style="font-style: italic"><span style="color: #9A1900">/* form error * 7 */</span></span>
<a name="line1054">1054: </a>        bnexterr <span style="color: #990000">=</span> cur1<span style="color: #990000">;</span>        <span style="font-style: italic"><span style="color: #9A1900">/* Process component 1 */</span></span>
<a name="line1055">1055: </a>        delta <span style="color: #990000">=</span> cur1 <span style="color: #990000">*</span> <span style="color: #993399">2</span><span style="color: #990000">;</span>
<a name="line1056">1056: </a>        cur1 <span style="color: #990000">+</span><span style="color: #990000">=</span> delta<span style="color: #990000">;</span>          <span style="font-style: italic"><span style="color: #9A1900">/* form error * 3 */</span></span>
<a name="line1057">1057: </a>        errorptr<span style="color: #990000">[</span><span style="color: #993399">1</span><span style="color: #990000">]</span> <span style="color: #990000">=</span> <span style="color: #990000">(</span>FSERROR<span style="color: #990000">)</span> <span style="color: #990000">(</span>bpreverr1 <span style="color: #990000">+</span> cur1<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line1058">1058: </a>        cur1 <span style="color: #990000">+</span><span style="color: #990000">=</span> delta<span style="color: #990000">;</span>          <span style="font-style: italic"><span style="color: #9A1900">/* form error * 5 */</span></span>
<a name="line1059">1059: </a>        bpreverr1 <span style="color: #990000">=</span> belowerr1 <span style="color: #990000">+</span> cur1<span style="color: #990000">;</span>
<a name="line1060">1060: </a>        belowerr1 <span style="color: #990000">=</span> bnexterr<span style="color: #990000">;</span>
<a name="line1061">1061: </a>        cur1 <span style="color: #990000">+</span><span style="color: #990000">=</span> delta<span style="color: #990000">;</span>          <span style="font-style: italic"><span style="color: #9A1900">/* form error * 7 */</span></span>
<a name="line1062">1062: </a>        bnexterr <span style="color: #990000">=</span> cur2<span style="color: #990000">;</span>        <span style="font-style: italic"><span style="color: #9A1900">/* Process component 2 */</span></span>
<a name="line1063">1063: </a>        delta <span style="color: #990000">=</span> cur2 <span style="color: #990000">*</span> <span style="color: #993399">2</span><span style="color: #990000">;</span>
<a name="line1064">1064: </a>        cur2 <span style="color: #990000">+</span><span style="color: #990000">=</span> delta<span style="color: #990000">;</span>          <span style="font-style: italic"><span style="color: #9A1900">/* form error * 3 */</span></span>
<a name="line1065">1065: </a>        errorptr<span style="color: #990000">[</span><span style="color: #993399">2</span><span style="color: #990000">]</span> <span style="color: #990000">=</span> <span style="color: #990000">(</span>FSERROR<span style="color: #990000">)</span> <span style="color: #990000">(</span>bpreverr2 <span style="color: #990000">+</span> cur2<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line1066">1066: </a>        cur2 <span style="color: #990000">+</span><span style="color: #990000">=</span> delta<span style="color: #990000">;</span>          <span style="font-style: italic"><span style="color: #9A1900">/* form error * 5 */</span></span>
<a name="line1067">1067: </a>        bpreverr2 <span style="color: #990000">=</span> belowerr2 <span style="color: #990000">+</span> cur2<span style="color: #990000">;</span>
<a name="line1068">1068: </a>        belowerr2 <span style="color: #990000">=</span> bnexterr<span style="color: #990000">;</span>
<a name="line1069">1069: </a>        cur2 <span style="color: #990000">+</span><span style="color: #990000">=</span> delta<span style="color: #990000">;</span>          <span style="font-style: italic"><span style="color: #9A1900">/* form error * 7 */</span></span>
<a name="line1070">1070: </a>      <span style="color: #FF0000">}</span>
<a name="line1071">1071: </a>      <span style="font-style: italic"><span style="color: #9A1900">/* At this point curN contains the 7/16 error value to be propagated</span></span>
<a name="line1072">1072: </a><span style="font-style: italic"><span style="color: #9A1900">       * to the next pixel on the current line, and all the errors for the</span></span>
<a name="line1073">1073: </a><span style="font-style: italic"><span style="color: #9A1900">       * next line have been shifted over.  We are therefore ready to move on.</span></span>
<a name="line1074">1074: </a><span style="font-style: italic"><span style="color: #9A1900">       */</span></span>
<a name="line1075">1075: </a>      inptr <span style="color: #990000">+</span><span style="color: #990000">=</span> dir3<span style="color: #990000">;</span>            <span style="font-style: italic"><span style="color: #9A1900">/* Advance pixel pointers to next column */</span></span>
<a name="line1076">1076: </a>      outptr <span style="color: #990000">+</span><span style="color: #990000">=</span> dir<span style="color: #990000">;</span>
<a name="line1077">1077: </a>      errorptr <span style="color: #990000">+</span><span style="color: #990000">=</span> dir3<span style="color: #990000">;</span>         <span style="font-style: italic"><span style="color: #9A1900">/* advance errorptr to current column */</span></span>
<a name="line1078">1078: </a>    <span style="color: #FF0000">}</span>
<a name="line1079">1079: </a>    <span style="font-style: italic"><span style="color: #9A1900">/* Post-loop cleanup: we must unload the final error values into the</span></span>
<a name="line1080">1080: </a><span style="font-style: italic"><span style="color: #9A1900">     * final fserrors[] entry.  Note we need not unload belowerrN because</span></span>
<a name="line1081">1081: </a><span style="font-style: italic"><span style="color: #9A1900">     * it is for the dummy column before or after the actual array.</span></span>
<a name="line1082">1082: </a><span style="font-style: italic"><span style="color: #9A1900">     */</span></span>
<a name="line1083">1083: </a>    errorptr<span style="color: #990000">[</span><span style="color: #993399">0</span><span style="color: #990000">]</span> <span style="color: #990000">=</span> <span style="color: #990000">(</span>FSERROR<span style="color: #990000">)</span> bpreverr0<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">/* unload prev errs into array */</span></span>
<a name="line1084">1084: </a>    errorptr<span style="color: #990000">[</span><span style="color: #993399">1</span><span style="color: #990000">]</span> <span style="color: #990000">=</span> <span style="color: #990000">(</span>FSERROR<span style="color: #990000">)</span> bpreverr1<span style="color: #990000">;</span>
<a name="line1085">1085: </a>    errorptr<span style="color: #990000">[</span><span style="color: #993399">2</span><span style="color: #990000">]</span> <span style="color: #990000">=</span> <span style="color: #990000">(</span>FSERROR<span style="color: #990000">)</span> bpreverr2<span style="color: #990000">;</span>
<a name="line1086">1086: </a>  <span style="color: #FF0000">}</span>
<a name="line1087">1087: </a><span style="color: #FF0000">}</span>
<a name="line1088">1088: </a>
<a name="line1089">1089: </a>
<a name="line1090">1090: </a><span style="font-style: italic"><span style="color: #9A1900">/*</span></span>
<a name="line1091">1091: </a><span style="font-style: italic"><span style="color: #9A1900"> * Initialize the error-limiting transfer function (lookup table).</span></span>
<a name="line1092">1092: </a><span style="font-style: italic"><span style="color: #9A1900"> * The raw F-S error computation can potentially compute error values of up to</span></span>
<a name="line1093">1093: </a><span style="font-style: italic"><span style="color: #9A1900"> * +- MAXJSAMPLE.  But we want the maximum correction applied to a pixel to be</span></span>
<a name="line1094">1094: </a><span style="font-style: italic"><span style="color: #9A1900"> * much less, otherwise obviously wrong pixels will be created.  (Typical</span></span>
<a name="line1095">1095: </a><span style="font-style: italic"><span style="color: #9A1900"> * effects include weird fringes at color-area boundaries, isolated bright</span></span>
<a name="line1096">1096: </a><span style="font-style: italic"><span style="color: #9A1900"> * pixels in a dark area, etc.)  The standard advice for avoiding this problem</span></span>
<a name="line1097">1097: </a><span style="font-style: italic"><span style="color: #9A1900"> * is to ensure that the "corners" of the color cube are allocated as output</span></span>
<a name="line1098">1098: </a><span style="font-style: italic"><span style="color: #9A1900"> * colors; then repeated errors in the same direction cannot cause cascading</span></span>
<a name="line1099">1099: </a><span style="font-style: italic"><span style="color: #9A1900"> * error buildup.  However, that only prevents the error from getting</span></span>
<a name="line1100">1100: </a><span style="font-style: italic"><span style="color: #9A1900"> * completely out of hand; Aaron Giles reports that error limiting improves</span></span>
<a name="line1101">1101: </a><span style="font-style: italic"><span style="color: #9A1900"> * the results even with corner colors allocated.</span></span>
<a name="line1102">1102: </a><span style="font-style: italic"><span style="color: #9A1900"> * A simple clamping of the error values to about +- MAXJSAMPLE/8 works pretty</span></span>
<a name="line1103">1103: </a><span style="font-style: italic"><span style="color: #9A1900"> * well, but the smoother transfer function used below is even better.  Thanks</span></span>
<a name="line1104">1104: </a><span style="font-style: italic"><span style="color: #9A1900"> * to Aaron Giles for this idea.</span></span>
<a name="line1105">1105: </a><span style="font-style: italic"><span style="color: #9A1900"> */</span></span>
<a name="line1106">1106: </a>
<a name="line1107">1107: </a><span style="font-weight: bold"><span style="color: #000000">LOCAL</span></span><span style="color: #990000">(</span><span style="color: #009900">void</span><span style="color: #990000">)</span>
<a name="line1108">1108: </a><span style="font-weight: bold"><span style="color: #000000">init_error_limit</span></span> <span style="color: #990000">(</span>j_decompress_ptr cinfo<span style="color: #990000">)</span>
<a name="line1109">1109: </a><span style="font-style: italic"><span style="color: #9A1900">/* Allocate and fill in the error_limiter table */</span></span>
<a name="line1110">1110: </a><span style="color: #FF0000">{</span>
<a name="line1111">1111: </a>  my_cquantize_ptr cquantize <span style="color: #990000">=</span> <span style="color: #990000">(</span>my_cquantize_ptr<span style="color: #990000">)</span> cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>cquantize<span style="color: #990000">;</span>
<a name="line1112">1112: </a>  <span style="color: #009900">int</span> <span style="color: #990000">*</span> table<span style="color: #990000">;</span>
<a name="line1113">1113: </a>  <span style="color: #009900">int</span> in<span style="color: #990000">,</span> out<span style="color: #990000">;</span>
<a name="line1114">1114: </a>
<a name="line1115">1115: </a>  table <span style="color: #990000">=</span> <span style="color: #990000">(</span><span style="color: #009900">int</span> <span style="color: #990000">*</span><span style="color: #990000">)</span> <span style="color: #990000">(</span><span style="color: #990000">*</span>cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>mem<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>alloc_small<span style="color: #990000">)</span>
<a name="line1116">1116: </a>    <span style="color: #990000">(</span><span style="color: #990000">(</span>j_common_ptr<span style="color: #990000">)</span> cinfo<span style="color: #990000">,</span> JPOOL_IMAGE<span style="color: #990000">,</span> <span style="color: #990000">(</span>MAXJSAMPLE<span style="color: #990000">*</span><span style="color: #993399">2</span><span style="color: #990000">+</span><span style="color: #993399">1</span><span style="color: #990000">)</span> <span style="color: #990000">*</span> <span style="font-weight: bold"><span style="color: #000000">SIZEOF</span></span><span style="color: #990000">(</span><span style="color: #009900">int</span><span style="color: #990000">)</span><span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line1117">1117: </a>  table <span style="color: #990000">+</span><span style="color: #990000">=</span> MAXJSAMPLE<span style="color: #990000">;</span>          <span style="font-style: italic"><span style="color: #9A1900">/* so can index -MAXJSAMPLE .. +MAXJSAMPLE */</span></span>
<a name="line1118">1118: </a>  cquantize<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>error_limiter <span style="color: #990000">=</span> table<span style="color: #990000">;</span>
<a name="line1119">1119: </a>
<a name="line1120">1120: </a><span style="font-weight: bold"><span style="color: #000080">#define</span></span> <span style="font-weight: bold"><span style="color: #000000">STEPSIZE</span></span> <span style="color: #990000">(</span><span style="color: #990000">(</span>MAXJSAMPLE<span style="color: #990000">+</span><span style="color: #993399">1</span><span style="color: #990000">)</span><span style="color: #990000">/</span><span style="color: #993399">16</span><span style="color: #990000">)</span>
<a name="line1121">1121: </a>  <span style="font-style: italic"><span style="color: #9A1900">/* Map errors 1:1 up to +- MAXJSAMPLE/16 */</span></span>
<a name="line1122">1122: </a>  out <span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">;</span>
<a name="line1123">1123: </a>  <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> <span style="color: #990000">(</span>in <span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">;</span> in <span style="color: #990000">&lt;</span> STEPSIZE<span style="color: #990000">;</span> in<span style="color: #990000">+</span><span style="color: #990000">+</span><span style="color: #990000">,</span> out<span style="color: #990000">+</span><span style="color: #990000">+</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line1124">1124: </a>    table<span style="color: #990000">[</span>in<span style="color: #990000">]</span> <span style="color: #990000">=</span> out<span style="color: #990000">;</span> table<span style="color: #990000">[</span><span style="color: #990000">-</span>in<span style="color: #990000">]</span> <span style="color: #990000">=</span> <span style="color: #990000">-</span>out<span style="color: #990000">;</span>
<a name="line1125">1125: </a>  <span style="color: #FF0000">}</span>
<a name="line1126">1126: </a>  <span style="font-style: italic"><span style="color: #9A1900">/* Map errors 1:2 up to +- 3*MAXJSAMPLE/16 */</span></span>
<a name="line1127">1127: </a>  <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> <span style="color: #990000">(</span><span style="color: #990000">;</span> in <span style="color: #990000">&lt;</span> STEPSIZE<span style="color: #990000">*</span><span style="color: #993399">3</span><span style="color: #990000">;</span> in<span style="color: #990000">+</span><span style="color: #990000">+</span><span style="color: #990000">,</span> out <span style="color: #990000">+</span><span style="color: #990000">=</span> <span style="color: #990000">(</span>in<span style="color: #990000">&amp;</span><span style="color: #993399">1</span><span style="color: #990000">)</span> <span style="color: #990000">?</span> <span style="color: #993399">0</span> <span style="color: #990000">:</span> <span style="color: #993399">1</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line1128">1128: </a>    table<span style="color: #990000">[</span>in<span style="color: #990000">]</span> <span style="color: #990000">=</span> out<span style="color: #990000">;</span> table<span style="color: #990000">[</span><span style="color: #990000">-</span>in<span style="color: #990000">]</span> <span style="color: #990000">=</span> <span style="color: #990000">-</span>out<span style="color: #990000">;</span>
<a name="line1129">1129: </a>  <span style="color: #FF0000">}</span>
<a name="line1130">1130: </a>  <span style="font-style: italic"><span style="color: #9A1900">/* Clamp the rest to final out value (which is (MAXJSAMPLE+1)/8) */</span></span>
<a name="line1131">1131: </a>  <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> <span style="color: #990000">(</span><span style="color: #990000">;</span> in <span style="color: #990000">&lt;</span><span style="color: #990000">=</span> MAXJSAMPLE<span style="color: #990000">;</span> in<span style="color: #990000">+</span><span style="color: #990000">+</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line1132">1132: </a>    table<span style="color: #990000">[</span>in<span style="color: #990000">]</span> <span style="color: #990000">=</span> out<span style="color: #990000">;</span> table<span style="color: #990000">[</span><span style="color: #990000">-</span>in<span style="color: #990000">]</span> <span style="color: #990000">=</span> <span style="color: #990000">-</span>out<span style="color: #990000">;</span>
<a name="line1133">1133: </a>  <span style="color: #FF0000">}</span>
<a name="line1134">1134: </a><span style="font-weight: bold"><span style="color: #000080">#undef</span></span> STEPSIZE
<a name="line1135">1135: </a><span style="color: #FF0000">}</span>
<a name="line1136">1136: </a>
<a name="line1137">1137: </a>
<a name="line1138">1138: </a><span style="font-style: italic"><span style="color: #9A1900">/*</span></span>
<a name="line1139">1139: </a><span style="font-style: italic"><span style="color: #9A1900"> * Finish up at the end of each pass.</span></span>
<a name="line1140">1140: </a><span style="font-style: italic"><span style="color: #9A1900"> */</span></span>
<a name="line1141">1141: </a>
<a name="line1142">1142: </a><span style="font-weight: bold"><span style="color: #000000">METHODDEF</span></span><span style="color: #990000">(</span><span style="color: #009900">void</span><span style="color: #990000">)</span>
<a name="line1143">1143: </a><span style="font-weight: bold"><span style="color: #000000">finish_pass1</span></span> <span style="color: #990000">(</span>j_decompress_ptr cinfo<span style="color: #990000">)</span>
<a name="line1144">1144: </a><span style="color: #FF0000">{</span>
<a name="line1145">1145: </a>  my_cquantize_ptr cquantize <span style="color: #990000">=</span> <span style="color: #990000">(</span>my_cquantize_ptr<span style="color: #990000">)</span> cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>cquantize<span style="color: #990000">;</span>
<a name="line1146">1146: </a>
<a name="line1147">1147: </a>  <span style="font-style: italic"><span style="color: #9A1900">/* Select the representative colors and fill in cinfo-&gt;colormap */</span></span>
<a name="line1148">1148: </a>  cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>colormap <span style="color: #990000">=</span> cquantize<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>sv_colormap<span style="color: #990000">;</span>
<a name="line1149">1149: </a>  <span style="font-weight: bold"><span style="color: #000000">select_colors</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> cquantize<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>desired<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line1150">1150: </a>  <span style="font-style: italic"><span style="color: #9A1900">/* Force next pass to zero the color index table */</span></span>
<a name="line1151">1151: </a>  cquantize<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>needs_zeroed <span style="color: #990000">=</span> TRUE<span style="color: #990000">;</span>
<a name="line1152">1152: </a><span style="color: #FF0000">}</span>
<a name="line1153">1153: </a>
<a name="line1154">1154: </a>
<a name="line1155">1155: </a><span style="font-weight: bold"><span style="color: #000000">METHODDEF</span></span><span style="color: #990000">(</span><span style="color: #009900">void</span><span style="color: #990000">)</span>
<a name="line1156">1156: </a><span style="font-weight: bold"><span style="color: #000000">finish_pass2</span></span> <span style="color: #990000">(</span>j_decompress_ptr cinfo<span style="color: #990000">)</span>
<a name="line1157">1157: </a><span style="color: #FF0000">{</span>
<a name="line1158">1158: </a>  <span style="font-style: italic"><span style="color: #9A1900">/* no work */</span></span>
<a name="line1159">1159: </a><span style="color: #FF0000">}</span>
<a name="line1160">1160: </a>
<a name="line1161">1161: </a>
<a name="line1162">1162: </a><span style="font-style: italic"><span style="color: #9A1900">/*</span></span>
<a name="line1163">1163: </a><span style="font-style: italic"><span style="color: #9A1900"> * Initialize for each processing pass.</span></span>
<a name="line1164">1164: </a><span style="font-style: italic"><span style="color: #9A1900"> */</span></span>
<a name="line1165">1165: </a>
<a name="line1166">1166: </a><span style="font-weight: bold"><span style="color: #000000">METHODDEF</span></span><span style="color: #990000">(</span><span style="color: #009900">void</span><span style="color: #990000">)</span>
<a name="line1167">1167: </a><span style="font-weight: bold"><span style="color: #000000">start_pass_2_quant</span></span> <span style="color: #990000">(</span>j_decompress_ptr cinfo<span style="color: #990000">,</span> boolean is_pre_scan<span style="color: #990000">)</span>
<a name="line1168">1168: </a><span style="color: #FF0000">{</span>
<a name="line1169">1169: </a>  my_cquantize_ptr cquantize <span style="color: #990000">=</span> <span style="color: #990000">(</span>my_cquantize_ptr<span style="color: #990000">)</span> cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>cquantize<span style="color: #990000">;</span>
<a name="line1170">1170: </a>  hist3d histogram <span style="color: #990000">=</span> cquantize<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>histogram<span style="color: #990000">;</span>
<a name="line1171">1171: </a>  <span style="color: #009900">int</span> i<span style="color: #990000">;</span>
<a name="line1172">1172: </a>
<a name="line1173">1173: </a>  <span style="font-style: italic"><span style="color: #9A1900">/* Only F-S dithering or no dithering is supported. */</span></span>
<a name="line1174">1174: </a>  <span style="font-style: italic"><span style="color: #9A1900">/* If user asks for ordered dither, give him F-S. */</span></span>
<a name="line1175">1175: </a>  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>dither_mode <span style="color: #990000">!</span><span style="color: #990000">=</span> JDITHER_NONE<span style="color: #990000">)</span>
<a name="line1176">1176: </a>    cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>dither_mode <span style="color: #990000">=</span> JDITHER_FS<span style="color: #990000">;</span>
<a name="line1177">1177: </a>
<a name="line1178">1178: </a>  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>is_pre_scan<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line1179">1179: </a>    <span style="font-style: italic"><span style="color: #9A1900">/* Set up method pointers */</span></span>
<a name="line1180">1180: </a>    cquantize<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>pub<span style="color: #990000">.</span>color_quantize <span style="color: #990000">=</span> prescan_quantize<span style="color: #990000">;</span>
<a name="line1181">1181: </a>    cquantize<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>pub<span style="color: #990000">.</span>finish_pass <span style="color: #990000">=</span> finish_pass1<span style="color: #990000">;</span>
<a name="line1182">1182: </a>    cquantize<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>needs_zeroed <span style="color: #990000">=</span> TRUE<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">/* Always zero histogram */</span></span>
<a name="line1183">1183: </a>  <span style="color: #FF0000">}</span> <span style="font-weight: bold"><span style="color: #0000FF">else</span></span> <span style="color: #FF0000">{</span>
<a name="line1184">1184: </a>    <span style="font-style: italic"><span style="color: #9A1900">/* Set up method pointers */</span></span>
<a name="line1185">1185: </a>    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>dither_mode <span style="color: #990000">=</span><span style="color: #990000">=</span> JDITHER_FS<span style="color: #990000">)</span>
<a name="line1186">1186: </a>      cquantize<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>pub<span style="color: #990000">.</span>color_quantize <span style="color: #990000">=</span> pass2_fs_dither<span style="color: #990000">;</span>
<a name="line1187">1187: </a>    <span style="font-weight: bold"><span style="color: #0000FF">else</span></span>
<a name="line1188">1188: </a>      cquantize<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>pub<span style="color: #990000">.</span>color_quantize <span style="color: #990000">=</span> pass2_no_dither<span style="color: #990000">;</span>
<a name="line1189">1189: </a>    cquantize<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>pub<span style="color: #990000">.</span>finish_pass <span style="color: #990000">=</span> finish_pass2<span style="color: #990000">;</span>
<a name="line1190">1190: </a>
<a name="line1191">1191: </a>    <span style="font-style: italic"><span style="color: #9A1900">/* Make sure color count is acceptable */</span></span>
<a name="line1192">1192: </a>    i <span style="color: #990000">=</span> cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>actual_number_of_colors<span style="color: #990000">;</span>
<a name="line1193">1193: </a>    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>i <span style="color: #990000">&lt;</span> <span style="color: #993399">1</span><span style="color: #990000">)</span>
<a name="line1194">1194: </a>      <span style="font-weight: bold"><span style="color: #000000">ERREXIT1</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> JERR_QUANT_FEW_COLORS<span style="color: #990000">,</span> <span style="color: #993399">1</span><span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line1195">1195: </a>    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>i <span style="color: #990000">&gt;</span> MAXNUMCOLORS<span style="color: #990000">)</span>
<a name="line1196">1196: </a>      <span style="font-weight: bold"><span style="color: #000000">ERREXIT1</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> JERR_QUANT_MANY_COLORS<span style="color: #990000">,</span> MAXNUMCOLORS<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line1197">1197: </a>
<a name="line1198">1198: </a>    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>dither_mode <span style="color: #990000">=</span><span style="color: #990000">=</span> JDITHER_FS<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line1199">1199: </a>      size_t arraysize <span style="color: #990000">=</span> <span style="color: #990000">(</span>size_t<span style="color: #990000">)</span> <span style="color: #990000">(</span><span style="color: #990000">(</span>cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>output_width <span style="color: #990000">+</span> <span style="color: #993399">2</span><span style="color: #990000">)</span> <span style="color: #990000">*</span>
<a name="line1200">1200: </a>                                   <span style="color: #990000">(</span><span style="color: #993399">3</span> <span style="color: #990000">*</span> <span style="font-weight: bold"><span style="color: #000000">SIZEOF</span></span><span style="color: #990000">(</span>FSERROR<span style="color: #990000">)</span><span style="color: #990000">)</span><span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line1201">1201: </a>      <span style="font-style: italic"><span style="color: #9A1900">/* Allocate Floyd-Steinberg workspace if we didn't already. */</span></span>
<a name="line1202">1202: </a>      <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>cquantize<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>fserrors <span style="color: #990000">=</span><span style="color: #990000">=</span> NULL<span style="color: #990000">)</span>
<a name="line1203">1203: </a>        cquantize<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>fserrors <span style="color: #990000">=</span> <span style="color: #990000">(</span>FSERRPTR<span style="color: #990000">)</span> <span style="color: #990000">(</span><span style="color: #990000">*</span>cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>mem<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>alloc_large<span style="color: #990000">)</span>
<a name="line1204">1204: </a>          <span style="color: #990000">(</span><span style="color: #990000">(</span>j_common_ptr<span style="color: #990000">)</span> cinfo<span style="color: #990000">,</span> JPOOL_IMAGE<span style="color: #990000">,</span> arraysize<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line1205">1205: </a>      <span style="font-style: italic"><span style="color: #9A1900">/* Initialize the propagated errors to zero. */</span></span>
<a name="line1206">1206: </a>      <span style="font-weight: bold"><span style="color: #000000">jzero_far</span></span><span style="color: #990000">(</span><span style="color: #990000">(</span><span style="color: #009900">void</span> FAR <span style="color: #990000">*</span><span style="color: #990000">)</span> cquantize<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>fserrors<span style="color: #990000">,</span> arraysize<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line1207">1207: </a>      <span style="font-style: italic"><span style="color: #9A1900">/* Make the error-limit table if we didn't already. */</span></span>
<a name="line1208">1208: </a>      <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>cquantize<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>error_limiter <span style="color: #990000">=</span><span style="color: #990000">=</span> NULL<span style="color: #990000">)</span>
<a name="line1209">1209: </a>        <span style="font-weight: bold"><span style="color: #000000">init_error_limit</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line1210">1210: </a>      cquantize<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>on_odd_row <span style="color: #990000">=</span> FALSE<span style="color: #990000">;</span>
<a name="line1211">1211: </a>    <span style="color: #FF0000">}</span>
<a name="line1212">1212: </a>
<a name="line1213">1213: </a>  <span style="color: #FF0000">}</span>
<a name="line1214">1214: </a>  <span style="font-style: italic"><span style="color: #9A1900">/* Zero the histogram or inverse color map, if necessary */</span></span>
<a name="line1215">1215: </a>  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>cquantize<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>needs_zeroed<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line1216">1216: </a>    <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> <span style="color: #990000">(</span>i <span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">;</span> i <span style="color: #990000">&lt;</span> HIST_C0_ELEMS<span style="color: #990000">;</span> i<span style="color: #990000">+</span><span style="color: #990000">+</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line1217">1217: </a>      <span style="font-weight: bold"><span style="color: #000000">jzero_far</span></span><span style="color: #990000">(</span><span style="color: #990000">(</span><span style="color: #009900">void</span> FAR <span style="color: #990000">*</span><span style="color: #990000">)</span> histogram<span style="color: #990000">[</span>i<span style="color: #990000">]</span><span style="color: #990000">,</span>
<a name="line1218">1218: </a>                HIST_C1_ELEMS<span style="color: #990000">*</span>HIST_C2_ELEMS <span style="color: #990000">*</span> <span style="font-weight: bold"><span style="color: #000000">SIZEOF</span></span><span style="color: #990000">(</span>histcell<span style="color: #990000">)</span><span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line1219">1219: </a>    <span style="color: #FF0000">}</span>
<a name="line1220">1220: </a>    cquantize<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>needs_zeroed <span style="color: #990000">=</span> FALSE<span style="color: #990000">;</span>
<a name="line1221">1221: </a>  <span style="color: #FF0000">}</span>
<a name="line1222">1222: </a><span style="color: #FF0000">}</span>
<a name="line1223">1223: </a>
<a name="line1224">1224: </a>
<a name="line1225">1225: </a><span style="font-style: italic"><span style="color: #9A1900">/*</span></span>
<a name="line1226">1226: </a><span style="font-style: italic"><span style="color: #9A1900"> * Switch to a new external colormap between output passes.</span></span>
<a name="line1227">1227: </a><span style="font-style: italic"><span style="color: #9A1900"> */</span></span>
<a name="line1228">1228: </a>
<a name="line1229">1229: </a><span style="font-weight: bold"><span style="color: #000000">METHODDEF</span></span><span style="color: #990000">(</span><span style="color: #009900">void</span><span style="color: #990000">)</span>
<a name="line1230">1230: </a><span style="font-weight: bold"><span style="color: #000000">new_color_map_2_quant</span></span> <span style="color: #990000">(</span>j_decompress_ptr cinfo<span style="color: #990000">)</span>
<a name="line1231">1231: </a><span style="color: #FF0000">{</span>
<a name="line1232">1232: </a>  my_cquantize_ptr cquantize <span style="color: #990000">=</span> <span style="color: #990000">(</span>my_cquantize_ptr<span style="color: #990000">)</span> cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>cquantize<span style="color: #990000">;</span>
<a name="line1233">1233: </a>
<a name="line1234">1234: </a>  <span style="font-style: italic"><span style="color: #9A1900">/* Reset the inverse color map */</span></span>
<a name="line1235">1235: </a>  cquantize<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>needs_zeroed <span style="color: #990000">=</span> TRUE<span style="color: #990000">;</span>
<a name="line1236">1236: </a><span style="color: #FF0000">}</span>
<a name="line1237">1237: </a>
<a name="line1238">1238: </a>
<a name="line1239">1239: </a><span style="font-style: italic"><span style="color: #9A1900">/*</span></span>
<a name="line1240">1240: </a><span style="font-style: italic"><span style="color: #9A1900"> * Module initialization routine for 2-pass color quantization.</span></span>
<a name="line1241">1241: </a><span style="font-style: italic"><span style="color: #9A1900"> */</span></span>
<a name="line1242">1242: </a>
<a name="line1243">1243: </a><span style="font-weight: bold"><span style="color: #000000">GLOBAL</span></span><span style="color: #990000">(</span><span style="color: #009900">void</span><span style="color: #990000">)</span>
<a name="line1244">1244: </a><span style="font-weight: bold"><span style="color: #000000">jinit_2pass_quantizer</span></span> <span style="color: #990000">(</span>j_decompress_ptr cinfo<span style="color: #990000">)</span>
<a name="line1245">1245: </a><span style="color: #FF0000">{</span>
<a name="line1246">1246: </a>  my_cquantize_ptr cquantize<span style="color: #990000">;</span>
<a name="line1247">1247: </a>  <span style="color: #009900">int</span> i<span style="color: #990000">;</span>
<a name="line1248">1248: </a>
<a name="line1249">1249: </a>  cquantize <span style="color: #990000">=</span> <span style="color: #990000">(</span>my_cquantize_ptr<span style="color: #990000">)</span>
<a name="line1250">1250: </a>    <span style="color: #990000">(</span><span style="color: #990000">*</span>cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>mem<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>alloc_small<span style="color: #990000">)</span> <span style="color: #990000">(</span><span style="color: #990000">(</span>j_common_ptr<span style="color: #990000">)</span> cinfo<span style="color: #990000">,</span> JPOOL_IMAGE<span style="color: #990000">,</span>
<a name="line1251">1251: </a>                                <span style="font-weight: bold"><span style="color: #000000">SIZEOF</span></span><span style="color: #990000">(</span>my_cquantizer<span style="color: #990000">)</span><span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line1252">1252: </a>  cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>cquantize <span style="color: #990000">=</span> <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">struct</span></span> jpeg_color_quantizer <span style="color: #990000">*</span><span style="color: #990000">)</span> cquantize<span style="color: #990000">;</span>
<a name="line1253">1253: </a>  cquantize<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>pub<span style="color: #990000">.</span>start_pass <span style="color: #990000">=</span> start_pass_2_quant<span style="color: #990000">;</span>
<a name="line1254">1254: </a>  cquantize<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>pub<span style="color: #990000">.</span>new_color_map <span style="color: #990000">=</span> new_color_map_2_quant<span style="color: #990000">;</span>
<a name="line1255">1255: </a>  cquantize<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>fserrors <span style="color: #990000">=</span> NULL<span style="color: #990000">;</span>   <span style="font-style: italic"><span style="color: #9A1900">/* flag optional arrays not allocated */</span></span>
<a name="line1256">1256: </a>  cquantize<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>error_limiter <span style="color: #990000">=</span> NULL<span style="color: #990000">;</span>
<a name="line1257">1257: </a>
<a name="line1258">1258: </a>  <span style="font-style: italic"><span style="color: #9A1900">/* Make sure jdmaster didn't give me a case I can't handle */</span></span>
<a name="line1259">1259: </a>  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>out_color_components <span style="color: #990000">!</span><span style="color: #990000">=</span> <span style="color: #993399">3</span><span style="color: #990000">)</span>
<a name="line1260">1260: </a>    <span style="font-weight: bold"><span style="color: #000000">ERREXIT</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> JERR_NOTIMPL<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line1261">1261: </a>
<a name="line1262">1262: </a>  <span style="font-style: italic"><span style="color: #9A1900">/* Allocate the histogram/inverse colormap storage */</span></span>
<a name="line1263">1263: </a>  cquantize<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>histogram <span style="color: #990000">=</span> <span style="color: #990000">(</span>hist3d<span style="color: #990000">)</span> <span style="color: #990000">(</span><span style="color: #990000">*</span>cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>mem<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>alloc_small<span style="color: #990000">)</span>
<a name="line1264">1264: </a>    <span style="color: #990000">(</span><span style="color: #990000">(</span>j_common_ptr<span style="color: #990000">)</span> cinfo<span style="color: #990000">,</span> JPOOL_IMAGE<span style="color: #990000">,</span> HIST_C0_ELEMS <span style="color: #990000">*</span> <span style="font-weight: bold"><span style="color: #000000">SIZEOF</span></span><span style="color: #990000">(</span>hist2d<span style="color: #990000">)</span><span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line1265">1265: </a>  <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> <span style="color: #990000">(</span>i <span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">;</span> i <span style="color: #990000">&lt;</span> HIST_C0_ELEMS<span style="color: #990000">;</span> i<span style="color: #990000">+</span><span style="color: #990000">+</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line1266">1266: </a>    cquantize<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>histogram<span style="color: #990000">[</span>i<span style="color: #990000">]</span> <span style="color: #990000">=</span> <span style="color: #990000">(</span>hist2d<span style="color: #990000">)</span> <span style="color: #990000">(</span><span style="color: #990000">*</span>cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>mem<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>alloc_large<span style="color: #990000">)</span>
<a name="line1267">1267: </a>      <span style="color: #990000">(</span><span style="color: #990000">(</span>j_common_ptr<span style="color: #990000">)</span> cinfo<span style="color: #990000">,</span> JPOOL_IMAGE<span style="color: #990000">,</span>
<a name="line1268">1268: </a>       HIST_C1_ELEMS<span style="color: #990000">*</span>HIST_C2_ELEMS <span style="color: #990000">*</span> <span style="font-weight: bold"><span style="color: #000000">SIZEOF</span></span><span style="color: #990000">(</span>histcell<span style="color: #990000">)</span><span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line1269">1269: </a>  <span style="color: #FF0000">}</span>
<a name="line1270">1270: </a>  cquantize<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>needs_zeroed <span style="color: #990000">=</span> TRUE<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">/* histogram is garbage now */</span></span>
<a name="line1271">1271: </a>
<a name="line1272">1272: </a>  <span style="font-style: italic"><span style="color: #9A1900">/* Allocate storage for the completed colormap, if required.</span></span>
<a name="line1273">1273: </a><span style="font-style: italic"><span style="color: #9A1900">   * We do this now since it is FAR storage and may affect</span></span>
<a name="line1274">1274: </a><span style="font-style: italic"><span style="color: #9A1900">   * the memory manager's space calculations.</span></span>
<a name="line1275">1275: </a><span style="font-style: italic"><span style="color: #9A1900">   */</span></span>
<a name="line1276">1276: </a>  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>enable_2pass_quant<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line1277">1277: </a>    <span style="font-style: italic"><span style="color: #9A1900">/* Make sure color count is acceptable */</span></span>
<a name="line1278">1278: </a>    <span style="color: #009900">int</span> desired <span style="color: #990000">=</span> cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>desired_number_of_colors<span style="color: #990000">;</span>
<a name="line1279">1279: </a>    <span style="font-style: italic"><span style="color: #9A1900">/* Lower bound on # of colors ... somewhat arbitrary as long as &gt; 0 */</span></span>
<a name="line1280">1280: </a>    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>desired <span style="color: #990000">&lt;</span> <span style="color: #993399">8</span><span style="color: #990000">)</span>
<a name="line1281">1281: </a>      <span style="font-weight: bold"><span style="color: #000000">ERREXIT1</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> JERR_QUANT_FEW_COLORS<span style="color: #990000">,</span> <span style="color: #993399">8</span><span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line1282">1282: </a>    <span style="font-style: italic"><span style="color: #9A1900">/* Make sure colormap indexes can be represented by JSAMPLEs */</span></span>
<a name="line1283">1283: </a>    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>desired <span style="color: #990000">&gt;</span> MAXNUMCOLORS<span style="color: #990000">)</span>
<a name="line1284">1284: </a>      <span style="font-weight: bold"><span style="color: #000000">ERREXIT1</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> JERR_QUANT_MANY_COLORS<span style="color: #990000">,</span> MAXNUMCOLORS<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line1285">1285: </a>    cquantize<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>sv_colormap <span style="color: #990000">=</span> <span style="color: #990000">(</span><span style="color: #990000">*</span>cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>mem<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>alloc_sarray<span style="color: #990000">)</span>
<a name="line1286">1286: </a>      <span style="color: #990000">(</span><span style="color: #990000">(</span>j_common_ptr<span style="color: #990000">)</span> cinfo<span style="color: #990000">,</span>JPOOL_IMAGE<span style="color: #990000">,</span> <span style="color: #990000">(</span>JDIMENSION<span style="color: #990000">)</span> desired<span style="color: #990000">,</span> <span style="color: #990000">(</span>JDIMENSION<span style="color: #990000">)</span> <span style="color: #993399">3</span><span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line1287">1287: </a>    cquantize<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>desired <span style="color: #990000">=</span> desired<span style="color: #990000">;</span>
<a name="line1288">1288: </a>  <span style="color: #FF0000">}</span> <span style="font-weight: bold"><span style="color: #0000FF">else</span></span>
<a name="line1289">1289: </a>    cquantize<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>sv_colormap <span style="color: #990000">=</span> NULL<span style="color: #990000">;</span>
<a name="line1290">1290: </a>
<a name="line1291">1291: </a>  <span style="font-style: italic"><span style="color: #9A1900">/* Only F-S dithering or no dithering is supported. */</span></span>
<a name="line1292">1292: </a>  <span style="font-style: italic"><span style="color: #9A1900">/* If user asks for ordered dither, give him F-S. */</span></span>
<a name="line1293">1293: </a>  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>dither_mode <span style="color: #990000">!</span><span style="color: #990000">=</span> JDITHER_NONE<span style="color: #990000">)</span>
<a name="line1294">1294: </a>    cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>dither_mode <span style="color: #990000">=</span> JDITHER_FS<span style="color: #990000">;</span>
<a name="line1295">1295: </a>
<a name="line1296">1296: </a>  <span style="font-style: italic"><span style="color: #9A1900">/* Allocate Floyd-Steinberg workspace if necessary.</span></span>
<a name="line1297">1297: </a><span style="font-style: italic"><span style="color: #9A1900">   * This isn't really needed until pass 2, but again it is FAR storage.</span></span>
<a name="line1298">1298: </a><span style="font-style: italic"><span style="color: #9A1900">   * Although we will cope with a later change in dither_mode,</span></span>
<a name="line1299">1299: </a><span style="font-style: italic"><span style="color: #9A1900">   * we do not promise to honor max_memory_to_use if dither_mode changes.</span></span>
<a name="line1300">1300: </a><span style="font-style: italic"><span style="color: #9A1900">   */</span></span>
<a name="line1301">1301: </a>  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>dither_mode <span style="color: #990000">=</span><span style="color: #990000">=</span> JDITHER_FS<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line1302">1302: </a>    cquantize<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>fserrors <span style="color: #990000">=</span> <span style="color: #990000">(</span>FSERRPTR<span style="color: #990000">)</span> <span style="color: #990000">(</span><span style="color: #990000">*</span>cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>mem<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>alloc_large<span style="color: #990000">)</span>
<a name="line1303">1303: </a>      <span style="color: #990000">(</span><span style="color: #990000">(</span>j_common_ptr<span style="color: #990000">)</span> cinfo<span style="color: #990000">,</span> JPOOL_IMAGE<span style="color: #990000">,</span>
<a name="line1304">1304: </a>       <span style="color: #990000">(</span>size_t<span style="color: #990000">)</span> <span style="color: #990000">(</span><span style="color: #990000">(</span>cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>output_width <span style="color: #990000">+</span> <span style="color: #993399">2</span><span style="color: #990000">)</span> <span style="color: #990000">*</span> <span style="color: #990000">(</span><span style="color: #993399">3</span> <span style="color: #990000">*</span> <span style="font-weight: bold"><span style="color: #000000">SIZEOF</span></span><span style="color: #990000">(</span>FSERROR<span style="color: #990000">)</span><span style="color: #990000">)</span><span style="color: #990000">)</span><span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line1305">1305: </a>    <span style="font-style: italic"><span style="color: #9A1900">/* Might as well create the error-limiting table too. */</span></span>
<a name="line1306">1306: </a>    <span style="font-weight: bold"><span style="color: #000000">init_error_limit</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line1307">1307: </a>  <span style="color: #FF0000">}</span>
<a name="line1308">1308: </a><span style="color: #FF0000">}</span>
<a name="line1309">1309: </a>
<a name="line1310">1310: </a><span style="font-weight: bold"><span style="color: #000080">#endif</span></span> <span style="font-style: italic"><span style="color: #9A1900">/* QUANT_2PASS_SUPPORTED */</span></span>
</tt>
</pre>
</body>
</html>
