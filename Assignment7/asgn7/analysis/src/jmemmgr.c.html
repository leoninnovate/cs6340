<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
<head>
<meta http-equiv="Content-Type"
content="text/html; charset=iso-8859-1" />
<meta name="GENERATOR" content="GNU source-highlight 1.9
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite" />
<title>../src/jmemmgr.c</title>
</head>
<body style="background-color: #FFFFFF; color: #000000; a: #0000EE; a.visited: #551A8B; a.active: #FF0000">
<pre>
<tt>
<a name="line1">0001: </a><span style="font-style: italic"><span style="color: #9A1900">/*</span></span>
<a name="line2">0002: </a><span style="font-style: italic"><span style="color: #9A1900"> * jmemmgr.c</span></span>
<a name="line3">0003: </a><span style="font-style: italic"><span style="color: #9A1900"> *</span></span>
<a name="line4">0004: </a><span style="font-style: italic"><span style="color: #9A1900"> * Copyright (C) 1991-1997, Thomas G. Lane.</span></span>
<a name="line5">0005: </a><span style="font-style: italic"><span style="color: #9A1900"> * This file is part of the Independent JPEG Group's software.</span></span>
<a name="line6">0006: </a><span style="font-style: italic"><span style="color: #9A1900"> * For conditions of distribution and use, see the accompanying README file.</span></span>
<a name="line7">0007: </a><span style="font-style: italic"><span style="color: #9A1900"> *</span></span>
<a name="line8">0008: </a><span style="font-style: italic"><span style="color: #9A1900"> * This file contains the JPEG system-independent memory management</span></span>
<a name="line9">0009: </a><span style="font-style: italic"><span style="color: #9A1900"> * routines.  This code is usable across a wide variety of machines; most</span></span>
<a name="line10">0010: </a><span style="font-style: italic"><span style="color: #9A1900"> * of the system dependencies have been isolated in a separate file.</span></span>
<a name="line11">0011: </a><span style="font-style: italic"><span style="color: #9A1900"> * The major functions provided here are:</span></span>
<a name="line12">0012: </a><span style="font-style: italic"><span style="color: #9A1900"> *   * pool-based allocation and freeing of memory;</span></span>
<a name="line13">0013: </a><span style="font-style: italic"><span style="color: #9A1900"> *   * policy decisions about how to divide available memory among the</span></span>
<a name="line14">0014: </a><span style="font-style: italic"><span style="color: #9A1900"> *     virtual arrays;</span></span>
<a name="line15">0015: </a><span style="font-style: italic"><span style="color: #9A1900"> *   * control logic for swapping virtual arrays between main memory and</span></span>
<a name="line16">0016: </a><span style="font-style: italic"><span style="color: #9A1900"> *     backing storage.</span></span>
<a name="line17">0017: </a><span style="font-style: italic"><span style="color: #9A1900"> * The separate system-dependent file provides the actual backing-storage</span></span>
<a name="line18">0018: </a><span style="font-style: italic"><span style="color: #9A1900"> * access code, and it contains the policy decision about how much total</span></span>
<a name="line19">0019: </a><span style="font-style: italic"><span style="color: #9A1900"> * main memory to use.</span></span>
<a name="line20">0020: </a><span style="font-style: italic"><span style="color: #9A1900"> * This file is system-dependent in the sense that some of its functions</span></span>
<a name="line21">0021: </a><span style="font-style: italic"><span style="color: #9A1900"> * are unnecessary in some systems.  For example, if there is enough virtual</span></span>
<a name="line22">0022: </a><span style="font-style: italic"><span style="color: #9A1900"> * memory so that backing storage will never be used, much of the virtual</span></span>
<a name="line23">0023: </a><span style="font-style: italic"><span style="color: #9A1900"> * array control logic could be removed.  (Of course, if you have that much</span></span>
<a name="line24">0024: </a><span style="font-style: italic"><span style="color: #9A1900"> * memory then you shouldn't care about a little bit of unused code...)</span></span>
<a name="line25">0025: </a><span style="font-style: italic"><span style="color: #9A1900"> */</span></span>
<a name="line26">0026: </a>
<a name="line27">0027: </a><span style="font-weight: bold"><span style="color: #000080">#define</span></span> JPEG_INTERNALS
<a name="line28">0028: </a><span style="font-weight: bold"><span style="color: #000080">#define</span></span> AM_MEMORY_MANAGER       <span style="font-style: italic"><span style="color: #9A1900">/* we define jvirt_Xarray_control structs */</span></span>
<a name="line29">0029: </a><span style="font-weight: bold"><span style="color: #000080">#include</span></span> <span style="color: #FF0000">"jinclude.h"</span>
<a name="line30">0030: </a><span style="font-weight: bold"><span style="color: #000080">#include</span></span> <span style="color: #FF0000">"jpeglib.h"</span>
<a name="line31">0031: </a><span style="font-weight: bold"><span style="color: #000080">#include</span></span> <span style="color: #FF0000">"jmemsys.h"</span>              <span style="font-style: italic"><span style="color: #9A1900">/* import the system-dependent declarations */</span></span>
<a name="line32">0032: </a>
<a name="line33">0033: </a><span style="font-weight: bold"><span style="color: #000080">#ifndef</span></span> NO_GETENV
<a name="line34">0034: </a><span style="font-weight: bold"><span style="color: #000080">#ifndef</span></span> HAVE_STDLIB_H           <span style="font-style: italic"><span style="color: #9A1900">/* &lt;stdlib.h&gt; should declare getenv() */</span></span>
<a name="line35">0035: </a><span style="font-weight: bold"><span style="color: #0000FF">extern</span></span> <span style="color: #009900">char</span> <span style="color: #990000">*</span> getenv <span style="font-weight: bold"><span style="color: #000000">JPP</span></span><span style="color: #990000">(</span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">const</span></span> <span style="color: #009900">char</span> <span style="color: #990000">*</span> name<span style="color: #990000">)</span><span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line36">0036: </a><span style="font-weight: bold"><span style="color: #000080">#endif</span></span>
<a name="line37">0037: </a><span style="font-weight: bold"><span style="color: #000080">#endif</span></span>
<a name="line38">0038: </a>
<a name="line39">0039: </a>
<a name="line40">0040: </a><span style="font-style: italic"><span style="color: #9A1900">/*</span></span>
<a name="line41">0041: </a><span style="font-style: italic"><span style="color: #9A1900"> * Some important notes:</span></span>
<a name="line42">0042: </a><span style="font-style: italic"><span style="color: #9A1900"> *   The allocation routines provided here must never return NULL.</span></span>
<a name="line43">0043: </a><span style="font-style: italic"><span style="color: #9A1900"> *   They should exit to error_exit if unsuccessful.</span></span>
<a name="line44">0044: </a><span style="font-style: italic"><span style="color: #9A1900"> *</span></span>
<a name="line45">0045: </a><span style="font-style: italic"><span style="color: #9A1900"> *   It's not a good idea to try to merge the sarray and barray routines,</span></span>
<a name="line46">0046: </a><span style="font-style: italic"><span style="color: #9A1900"> *   even though they are textually almost the same, because samples are</span></span>
<a name="line47">0047: </a><span style="font-style: italic"><span style="color: #9A1900"> *   usually stored as bytes while coefficients are shorts or ints.  Thus,</span></span>
<a name="line48">0048: </a><span style="font-style: italic"><span style="color: #9A1900"> *   in machines where byte pointers have a different representation from</span></span>
<a name="line49">0049: </a><span style="font-style: italic"><span style="color: #9A1900"> *   word pointers, the resulting machine code could not be the same.</span></span>
<a name="line50">0050: </a><span style="font-style: italic"><span style="color: #9A1900"> */</span></span>
<a name="line51">0051: </a>
<a name="line52">0052: </a>
<a name="line53">0053: </a><span style="font-style: italic"><span style="color: #9A1900">/*</span></span>
<a name="line54">0054: </a><span style="font-style: italic"><span style="color: #9A1900"> * Many machines require storage alignment: longs must start on 4-byte</span></span>
<a name="line55">0055: </a><span style="font-style: italic"><span style="color: #9A1900"> * boundaries, doubles on 8-byte boundaries, etc.  On such machines, malloc()</span></span>
<a name="line56">0056: </a><span style="font-style: italic"><span style="color: #9A1900"> * always returns pointers that are multiples of the worst-case alignment</span></span>
<a name="line57">0057: </a><span style="font-style: italic"><span style="color: #9A1900"> * requirement, and we had better do so too.</span></span>
<a name="line58">0058: </a><span style="font-style: italic"><span style="color: #9A1900"> * There isn't any really portable way to determine the worst-case alignment</span></span>
<a name="line59">0059: </a><span style="font-style: italic"><span style="color: #9A1900"> * requirement.  This module assumes that the alignment requirement is</span></span>
<a name="line60">0060: </a><span style="font-style: italic"><span style="color: #9A1900"> * multiples of sizeof(ALIGN_TYPE).</span></span>
<a name="line61">0061: </a><span style="font-style: italic"><span style="color: #9A1900"> * By default, we define ALIGN_TYPE as double.  This is necessary on some</span></span>
<a name="line62">0062: </a><span style="font-style: italic"><span style="color: #9A1900"> * workstations (where doubles really do need 8-byte alignment) and will work</span></span>
<a name="line63">0063: </a><span style="font-style: italic"><span style="color: #9A1900"> * fine on nearly everything.  If your machine has lesser alignment needs,</span></span>
<a name="line64">0064: </a><span style="font-style: italic"><span style="color: #9A1900"> * you can save a few bytes by making ALIGN_TYPE smaller.</span></span>
<a name="line65">0065: </a><span style="font-style: italic"><span style="color: #9A1900"> * The only place I know of where this will NOT work is certain Macintosh</span></span>
<a name="line66">0066: </a><span style="font-style: italic"><span style="color: #9A1900"> * 680x0 compilers that define double as a 10-byte IEEE extended float.</span></span>
<a name="line67">0067: </a><span style="font-style: italic"><span style="color: #9A1900"> * Doing 10-byte alignment is counterproductive because longwords won't be</span></span>
<a name="line68">0068: </a><span style="font-style: italic"><span style="color: #9A1900"> * aligned well.  Put "#define ALIGN_TYPE long" in jconfig.h if you have</span></span>
<a name="line69">0069: </a><span style="font-style: italic"><span style="color: #9A1900"> * such a compiler.</span></span>
<a name="line70">0070: </a><span style="font-style: italic"><span style="color: #9A1900"> */</span></span>
<a name="line71">0071: </a>
<a name="line72">0072: </a><span style="font-weight: bold"><span style="color: #000080">#ifndef</span></span> ALIGN_TYPE              <span style="font-style: italic"><span style="color: #9A1900">/* so can override from jconfig.h */</span></span>
<a name="line73">0073: </a><span style="font-weight: bold"><span style="color: #000080">#define</span></span> ALIGN_TYPE  <span style="color: #009900">double</span>
<a name="line74">0074: </a><span style="font-weight: bold"><span style="color: #000080">#endif</span></span>
<a name="line75">0075: </a>
<a name="line76">0076: </a>
<a name="line77">0077: </a><span style="font-style: italic"><span style="color: #9A1900">/*</span></span>
<a name="line78">0078: </a><span style="font-style: italic"><span style="color: #9A1900"> * We allocate objects from "pools", where each pool is gotten with a single</span></span>
<a name="line79">0079: </a><span style="font-style: italic"><span style="color: #9A1900"> * request to jpeg_get_small() or jpeg_get_large().  There is no per-object</span></span>
<a name="line80">0080: </a><span style="font-style: italic"><span style="color: #9A1900"> * overhead within a pool, except for alignment padding.  Each pool has a</span></span>
<a name="line81">0081: </a><span style="font-style: italic"><span style="color: #9A1900"> * header with a link to the next pool of the same class.</span></span>
<a name="line82">0082: </a><span style="font-style: italic"><span style="color: #9A1900"> * Small and large pool headers are identical except that the latter's</span></span>
<a name="line83">0083: </a><span style="font-style: italic"><span style="color: #9A1900"> * link pointer must be FAR on 80x86 machines.</span></span>
<a name="line84">0084: </a><span style="font-style: italic"><span style="color: #9A1900"> * Notice that the "real" header fields are union'ed with a dummy ALIGN_TYPE</span></span>
<a name="line85">0085: </a><span style="font-style: italic"><span style="color: #9A1900"> * field.  This forces the compiler to make SIZEOF(small_pool_hdr) a multiple</span></span>
<a name="line86">0086: </a><span style="font-style: italic"><span style="color: #9A1900"> * of the alignment requirement of ALIGN_TYPE.</span></span>
<a name="line87">0087: </a><span style="font-style: italic"><span style="color: #9A1900"> */</span></span>
<a name="line88">0088: </a>
<a name="line89">0089: </a><span style="font-weight: bold"><span style="color: #0000FF">typedef</span></span> <span style="font-weight: bold"><span style="color: #0000FF">union</span></span> small_pool_struct <span style="color: #990000">*</span> small_pool_ptr<span style="color: #990000">;</span>
<a name="line90">0090: </a>
<a name="line91">0091: </a><span style="font-weight: bold"><span style="color: #0000FF">typedef</span></span> <span style="font-weight: bold"><span style="color: #0000FF">union</span></span> small_pool_struct <span style="color: #FF0000">{</span>
<a name="line92">0092: </a>  <span style="font-weight: bold"><span style="color: #0000FF">struct</span></span> <span style="color: #FF0000">{</span>
<a name="line93">0093: </a>    small_pool_ptr next<span style="color: #990000">;</span>        <span style="font-style: italic"><span style="color: #9A1900">/* next in list of pools */</span></span>
<a name="line94">0094: </a>    size_t bytes_used<span style="color: #990000">;</span>          <span style="font-style: italic"><span style="color: #9A1900">/* how many bytes already used within pool */</span></span>
<a name="line95">0095: </a>    size_t bytes_left<span style="color: #990000">;</span>          <span style="font-style: italic"><span style="color: #9A1900">/* bytes still available in this pool */</span></span>
<a name="line96">0096: </a>  <span style="color: #FF0000">}</span> hdr<span style="color: #990000">;</span>
<a name="line97">0097: </a>  ALIGN_TYPE dummy<span style="color: #990000">;</span>             <span style="font-style: italic"><span style="color: #9A1900">/* included in union to ensure alignment */</span></span>
<a name="line98">0098: </a><span style="color: #FF0000">}</span> small_pool_hdr<span style="color: #990000">;</span>
<a name="line99">0099: </a>
<a name="line100">0100: </a><span style="font-weight: bold"><span style="color: #0000FF">typedef</span></span> <span style="font-weight: bold"><span style="color: #0000FF">union</span></span> large_pool_struct FAR <span style="color: #990000">*</span> large_pool_ptr<span style="color: #990000">;</span>
<a name="line101">0101: </a>
<a name="line102">0102: </a><span style="font-weight: bold"><span style="color: #0000FF">typedef</span></span> <span style="font-weight: bold"><span style="color: #0000FF">union</span></span> large_pool_struct <span style="color: #FF0000">{</span>
<a name="line103">0103: </a>  <span style="font-weight: bold"><span style="color: #0000FF">struct</span></span> <span style="color: #FF0000">{</span>
<a name="line104">0104: </a>    large_pool_ptr next<span style="color: #990000">;</span>        <span style="font-style: italic"><span style="color: #9A1900">/* next in list of pools */</span></span>
<a name="line105">0105: </a>    size_t bytes_used<span style="color: #990000">;</span>          <span style="font-style: italic"><span style="color: #9A1900">/* how many bytes already used within pool */</span></span>
<a name="line106">0106: </a>    size_t bytes_left<span style="color: #990000">;</span>          <span style="font-style: italic"><span style="color: #9A1900">/* bytes still available in this pool */</span></span>
<a name="line107">0107: </a>  <span style="color: #FF0000">}</span> hdr<span style="color: #990000">;</span>
<a name="line108">0108: </a>  ALIGN_TYPE dummy<span style="color: #990000">;</span>             <span style="font-style: italic"><span style="color: #9A1900">/* included in union to ensure alignment */</span></span>
<a name="line109">0109: </a><span style="color: #FF0000">}</span> large_pool_hdr<span style="color: #990000">;</span>
<a name="line110">0110: </a>
<a name="line111">0111: </a>
<a name="line112">0112: </a><span style="font-style: italic"><span style="color: #9A1900">/*</span></span>
<a name="line113">0113: </a><span style="font-style: italic"><span style="color: #9A1900"> * Here is the full definition of a memory manager object.</span></span>
<a name="line114">0114: </a><span style="font-style: italic"><span style="color: #9A1900"> */</span></span>
<a name="line115">0115: </a>
<a name="line116">0116: </a><span style="font-weight: bold"><span style="color: #0000FF">typedef</span></span> <span style="font-weight: bold"><span style="color: #0000FF">struct</span></span> <span style="color: #FF0000">{</span>
<a name="line117">0117: </a>  <span style="font-weight: bold"><span style="color: #0000FF">struct</span></span> jpeg_memory_mgr pub<span style="color: #990000">;</span>   <span style="font-style: italic"><span style="color: #9A1900">/* public fields */</span></span>
<a name="line118">0118: </a>
<a name="line119">0119: </a>  <span style="font-style: italic"><span style="color: #9A1900">/* Each pool identifier (lifetime class) names a linked list of pools. */</span></span>
<a name="line120">0120: </a>  small_pool_ptr small_list<span style="color: #990000">[</span>JPOOL_NUMPOOLS<span style="color: #990000">]</span><span style="color: #990000">;</span>
<a name="line121">0121: </a>  large_pool_ptr large_list<span style="color: #990000">[</span>JPOOL_NUMPOOLS<span style="color: #990000">]</span><span style="color: #990000">;</span>
<a name="line122">0122: </a>
<a name="line123">0123: </a>  <span style="font-style: italic"><span style="color: #9A1900">/* Since we only have one lifetime class of virtual arrays, only one</span></span>
<a name="line124">0124: </a><span style="font-style: italic"><span style="color: #9A1900">   * linked list is necessary (for each datatype).  Note that the virtual</span></span>
<a name="line125">0125: </a><span style="font-style: italic"><span style="color: #9A1900">   * array control blocks being linked together are actually stored somewhere</span></span>
<a name="line126">0126: </a><span style="font-style: italic"><span style="color: #9A1900">   * in the small-pool list.</span></span>
<a name="line127">0127: </a><span style="font-style: italic"><span style="color: #9A1900">   */</span></span>
<a name="line128">0128: </a>  jvirt_sarray_ptr virt_sarray_list<span style="color: #990000">;</span>
<a name="line129">0129: </a>  jvirt_barray_ptr virt_barray_list<span style="color: #990000">;</span>
<a name="line130">0130: </a>
<a name="line131">0131: </a>  <span style="font-style: italic"><span style="color: #9A1900">/* This counts total space obtained from jpeg_get_small/large */</span></span>
<a name="line132">0132: </a>  <span style="color: #009900">long</span> total_space_allocated<span style="color: #990000">;</span>
<a name="line133">0133: </a>
<a name="line134">0134: </a>  <span style="font-style: italic"><span style="color: #9A1900">/* alloc_sarray and alloc_barray set this value for use by virtual</span></span>
<a name="line135">0135: </a><span style="font-style: italic"><span style="color: #9A1900">   * array routines.</span></span>
<a name="line136">0136: </a><span style="font-style: italic"><span style="color: #9A1900">   */</span></span>
<a name="line137">0137: </a>  JDIMENSION last_rowsperchunk<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">/* from most recent alloc_sarray/barray */</span></span>
<a name="line138">0138: </a><span style="color: #FF0000">}</span> my_memory_mgr<span style="color: #990000">;</span>
<a name="line139">0139: </a>
<a name="line140">0140: </a><span style="font-weight: bold"><span style="color: #0000FF">typedef</span></span> my_memory_mgr <span style="color: #990000">*</span> my_mem_ptr<span style="color: #990000">;</span>
<a name="line141">0141: </a>
<a name="line142">0142: </a>
<a name="line143">0143: </a><span style="font-style: italic"><span style="color: #9A1900">/*</span></span>
<a name="line144">0144: </a><span style="font-style: italic"><span style="color: #9A1900"> * The control blocks for virtual arrays.</span></span>
<a name="line145">0145: </a><span style="font-style: italic"><span style="color: #9A1900"> * Note that these blocks are allocated in the "small" pool area.</span></span>
<a name="line146">0146: </a><span style="font-style: italic"><span style="color: #9A1900"> * System-dependent info for the associated backing store (if any) is hidden</span></span>
<a name="line147">0147: </a><span style="font-style: italic"><span style="color: #9A1900"> * inside the backing_store_info struct.</span></span>
<a name="line148">0148: </a><span style="font-style: italic"><span style="color: #9A1900"> */</span></span>
<a name="line149">0149: </a>
<a name="line150">0150: </a><span style="font-weight: bold"><span style="color: #0000FF">struct</span></span> jvirt_sarray_control <span style="color: #FF0000">{</span>
<a name="line151">0151: </a>  JSAMPARRAY mem_buffer<span style="color: #990000">;</span>        <span style="font-style: italic"><span style="color: #9A1900">/* =&gt; the in-memory buffer */</span></span>
<a name="line152">0152: </a>  JDIMENSION rows_in_array<span style="color: #990000">;</span>     <span style="font-style: italic"><span style="color: #9A1900">/* total virtual array height */</span></span>
<a name="line153">0153: </a>  JDIMENSION samplesperrow<span style="color: #990000">;</span>     <span style="font-style: italic"><span style="color: #9A1900">/* width of array (and of memory buffer) */</span></span>
<a name="line154">0154: </a>  JDIMENSION maxaccess<span style="color: #990000">;</span>         <span style="font-style: italic"><span style="color: #9A1900">/* max rows accessed by access_virt_sarray */</span></span>
<a name="line155">0155: </a>  JDIMENSION rows_in_mem<span style="color: #990000">;</span>       <span style="font-style: italic"><span style="color: #9A1900">/* height of memory buffer */</span></span>
<a name="line156">0156: </a>  JDIMENSION rowsperchunk<span style="color: #990000">;</span>      <span style="font-style: italic"><span style="color: #9A1900">/* allocation chunk size in mem_buffer */</span></span>
<a name="line157">0157: </a>  JDIMENSION cur_start_row<span style="color: #990000">;</span>     <span style="font-style: italic"><span style="color: #9A1900">/* first logical row # in the buffer */</span></span>
<a name="line158">0158: </a>  JDIMENSION first_undef_row<span style="color: #990000">;</span>   <span style="font-style: italic"><span style="color: #9A1900">/* row # of first uninitialized row */</span></span>
<a name="line159">0159: </a>  boolean pre_zero<span style="color: #990000">;</span>             <span style="font-style: italic"><span style="color: #9A1900">/* pre-zero mode requested? */</span></span>
<a name="line160">0160: </a>  boolean dirty<span style="color: #990000">;</span>                <span style="font-style: italic"><span style="color: #9A1900">/* do current buffer contents need written? */</span></span>
<a name="line161">0161: </a>  boolean b_s_open<span style="color: #990000">;</span>             <span style="font-style: italic"><span style="color: #9A1900">/* is backing-store data valid? */</span></span>
<a name="line162">0162: </a>  jvirt_sarray_ptr next<span style="color: #990000">;</span>        <span style="font-style: italic"><span style="color: #9A1900">/* link to next virtual sarray control block */</span></span>
<a name="line163">0163: </a>  backing_store_info b_s_info<span style="color: #990000">;</span>  <span style="font-style: italic"><span style="color: #9A1900">/* System-dependent control info */</span></span>
<a name="line164">0164: </a><span style="color: #FF0000">}</span><span style="color: #990000">;</span>
<a name="line165">0165: </a>
<a name="line166">0166: </a><span style="font-weight: bold"><span style="color: #0000FF">struct</span></span> jvirt_barray_control <span style="color: #FF0000">{</span>
<a name="line167">0167: </a>  JBLOCKARRAY mem_buffer<span style="color: #990000">;</span>       <span style="font-style: italic"><span style="color: #9A1900">/* =&gt; the in-memory buffer */</span></span>
<a name="line168">0168: </a>  JDIMENSION rows_in_array<span style="color: #990000">;</span>     <span style="font-style: italic"><span style="color: #9A1900">/* total virtual array height */</span></span>
<a name="line169">0169: </a>  JDIMENSION blocksperrow<span style="color: #990000">;</span>      <span style="font-style: italic"><span style="color: #9A1900">/* width of array (and of memory buffer) */</span></span>
<a name="line170">0170: </a>  JDIMENSION maxaccess<span style="color: #990000">;</span>         <span style="font-style: italic"><span style="color: #9A1900">/* max rows accessed by access_virt_barray */</span></span>
<a name="line171">0171: </a>  JDIMENSION rows_in_mem<span style="color: #990000">;</span>       <span style="font-style: italic"><span style="color: #9A1900">/* height of memory buffer */</span></span>
<a name="line172">0172: </a>  JDIMENSION rowsperchunk<span style="color: #990000">;</span>      <span style="font-style: italic"><span style="color: #9A1900">/* allocation chunk size in mem_buffer */</span></span>
<a name="line173">0173: </a>  JDIMENSION cur_start_row<span style="color: #990000">;</span>     <span style="font-style: italic"><span style="color: #9A1900">/* first logical row # in the buffer */</span></span>
<a name="line174">0174: </a>  JDIMENSION first_undef_row<span style="color: #990000">;</span>   <span style="font-style: italic"><span style="color: #9A1900">/* row # of first uninitialized row */</span></span>
<a name="line175">0175: </a>  boolean pre_zero<span style="color: #990000">;</span>             <span style="font-style: italic"><span style="color: #9A1900">/* pre-zero mode requested? */</span></span>
<a name="line176">0176: </a>  boolean dirty<span style="color: #990000">;</span>                <span style="font-style: italic"><span style="color: #9A1900">/* do current buffer contents need written? */</span></span>
<a name="line177">0177: </a>  boolean b_s_open<span style="color: #990000">;</span>             <span style="font-style: italic"><span style="color: #9A1900">/* is backing-store data valid? */</span></span>
<a name="line178">0178: </a>  jvirt_barray_ptr next<span style="color: #990000">;</span>        <span style="font-style: italic"><span style="color: #9A1900">/* link to next virtual barray control block */</span></span>
<a name="line179">0179: </a>  backing_store_info b_s_info<span style="color: #990000">;</span>  <span style="font-style: italic"><span style="color: #9A1900">/* System-dependent control info */</span></span>
<a name="line180">0180: </a><span style="color: #FF0000">}</span><span style="color: #990000">;</span>
<a name="line181">0181: </a>
<a name="line182">0182: </a>
<a name="line183">0183: </a><span style="font-weight: bold"><span style="color: #000080">#ifdef</span></span> MEM_STATS                <span style="font-style: italic"><span style="color: #9A1900">/* optional extra stuff for statistics */</span></span>
<a name="line184">0184: </a>
<a name="line185">0185: </a><span style="font-weight: bold"><span style="color: #000000">LOCAL</span></span><span style="color: #990000">(</span><span style="color: #009900">void</span><span style="color: #990000">)</span>
<a name="line186">0186: </a><span style="font-weight: bold"><span style="color: #000000">print_mem_stats</span></span> <span style="color: #990000">(</span>j_common_ptr cinfo<span style="color: #990000">,</span> <span style="color: #009900">int</span> pool_id<span style="color: #990000">)</span>
<a name="line187">0187: </a><span style="color: #FF0000">{</span>
<a name="line188">0188: </a>  my_mem_ptr mem <span style="color: #990000">=</span> <span style="color: #990000">(</span>my_mem_ptr<span style="color: #990000">)</span> cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>mem<span style="color: #990000">;</span>
<a name="line189">0189: </a>  small_pool_ptr shdr_ptr<span style="color: #990000">;</span>
<a name="line190">0190: </a>  large_pool_ptr lhdr_ptr<span style="color: #990000">;</span>
<a name="line191">0191: </a>
<a name="line192">0192: </a>  <span style="font-style: italic"><span style="color: #9A1900">/* Since this is only a debugging stub, we can cheat a little by using</span></span>
<a name="line193">0193: </a><span style="font-style: italic"><span style="color: #9A1900">   * fprintf directly rather than going through the trace message code.</span></span>
<a name="line194">0194: </a><span style="font-style: italic"><span style="color: #9A1900">   * This is helpful because message parm array can't handle longs.</span></span>
<a name="line195">0195: </a><span style="font-style: italic"><span style="color: #9A1900">   */</span></span>
<a name="line196">0196: </a>  <span style="font-weight: bold"><span style="color: #000000">fprintf</span></span><span style="color: #990000">(</span>stderr<span style="color: #990000">,</span> <span style="color: #FF0000">"Freeing pool %d, total space = %ld\n"</span><span style="color: #990000">,</span>
<a name="line197">0197: </a>          pool_id<span style="color: #990000">,</span> mem<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>total_space_allocated<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line198">0198: </a>
<a name="line199">0199: </a>  <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> <span style="color: #990000">(</span>lhdr_ptr <span style="color: #990000">=</span> mem<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>large_list<span style="color: #990000">[</span>pool_id<span style="color: #990000">]</span><span style="color: #990000">;</span> lhdr_ptr <span style="color: #990000">!</span><span style="color: #990000">=</span> NULL<span style="color: #990000">;</span>
<a name="line200">0200: </a>       lhdr_ptr <span style="color: #990000">=</span> lhdr_ptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>hdr<span style="color: #990000">.</span>next<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line201">0201: </a>    <span style="font-weight: bold"><span style="color: #000000">fprintf</span></span><span style="color: #990000">(</span>stderr<span style="color: #990000">,</span> <span style="color: #FF0000">"  Large chunk used %ld\n"</span><span style="color: #990000">,</span>
<a name="line202">0202: </a>            <span style="color: #990000">(</span><span style="color: #009900">long</span><span style="color: #990000">)</span> lhdr_ptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>hdr<span style="color: #990000">.</span>bytes_used<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line203">0203: </a>  <span style="color: #FF0000">}</span>
<a name="line204">0204: </a>
<a name="line205">0205: </a>  <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> <span style="color: #990000">(</span>shdr_ptr <span style="color: #990000">=</span> mem<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>small_list<span style="color: #990000">[</span>pool_id<span style="color: #990000">]</span><span style="color: #990000">;</span> shdr_ptr <span style="color: #990000">!</span><span style="color: #990000">=</span> NULL<span style="color: #990000">;</span>
<a name="line206">0206: </a>       shdr_ptr <span style="color: #990000">=</span> shdr_ptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>hdr<span style="color: #990000">.</span>next<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line207">0207: </a>    <span style="font-weight: bold"><span style="color: #000000">fprintf</span></span><span style="color: #990000">(</span>stderr<span style="color: #990000">,</span> <span style="color: #FF0000">"  Small chunk used %ld free %ld\n"</span><span style="color: #990000">,</span>
<a name="line208">0208: </a>            <span style="color: #990000">(</span><span style="color: #009900">long</span><span style="color: #990000">)</span> shdr_ptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>hdr<span style="color: #990000">.</span>bytes_used<span style="color: #990000">,</span>
<a name="line209">0209: </a>            <span style="color: #990000">(</span><span style="color: #009900">long</span><span style="color: #990000">)</span> shdr_ptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>hdr<span style="color: #990000">.</span>bytes_left<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line210">0210: </a>  <span style="color: #FF0000">}</span>
<a name="line211">0211: </a><span style="color: #FF0000">}</span>
<a name="line212">0212: </a>
<a name="line213">0213: </a><span style="font-weight: bold"><span style="color: #000080">#endif</span></span> <span style="font-style: italic"><span style="color: #9A1900">/* MEM_STATS */</span></span>
<a name="line214">0214: </a>
<a name="line215">0215: </a>
<a name="line216">0216: </a><span style="font-weight: bold"><span style="color: #000000">LOCAL</span></span><span style="color: #990000">(</span><span style="color: #009900">void</span><span style="color: #990000">)</span>
<a name="line217">0217: </a><span style="font-weight: bold"><span style="color: #000000">out_of_memory</span></span> <span style="color: #990000">(</span>j_common_ptr cinfo<span style="color: #990000">,</span> <span style="color: #009900">int</span> which<span style="color: #990000">)</span>
<a name="line218">0218: </a><span style="font-style: italic"><span style="color: #9A1900">/* Report an out-of-memory error and stop execution */</span></span>
<a name="line219">0219: </a><span style="font-style: italic"><span style="color: #9A1900">/* If we compiled MEM_STATS support, report alloc requests before dying */</span></span>
<a name="line220">0220: </a><span style="color: #FF0000">{</span>
<a name="line221">0221: </a><span style="font-weight: bold"><span style="color: #000080">#ifdef</span></span> MEM_STATS
<a name="line222">0222: </a>  cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>err<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>trace_level <span style="color: #990000">=</span> <span style="color: #993399">2</span><span style="color: #990000">;</span>  <span style="font-style: italic"><span style="color: #9A1900">/* force self_destruct to report stats */</span></span>
<a name="line223">0223: </a><span style="font-weight: bold"><span style="color: #000080">#endif</span></span>
<a name="line224">0224: </a>  <span style="font-weight: bold"><span style="color: #000000">ERREXIT1</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> JERR_OUT_OF_MEMORY<span style="color: #990000">,</span> which<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line225">0225: </a><span style="color: #FF0000">}</span>
<a name="line226">0226: </a>
<a name="line227">0227: </a>
<a name="line228">0228: </a><span style="font-style: italic"><span style="color: #9A1900">/*</span></span>
<a name="line229">0229: </a><span style="font-style: italic"><span style="color: #9A1900"> * Allocation of "small" objects.</span></span>
<a name="line230">0230: </a><span style="font-style: italic"><span style="color: #9A1900"> *</span></span>
<a name="line231">0231: </a><span style="font-style: italic"><span style="color: #9A1900"> * For these, we use pooled storage.  When a new pool must be created,</span></span>
<a name="line232">0232: </a><span style="font-style: italic"><span style="color: #9A1900"> * we try to get enough space for the current request plus a "slop" factor,</span></span>
<a name="line233">0233: </a><span style="font-style: italic"><span style="color: #9A1900"> * where the slop will be the amount of leftover space in the new pool.</span></span>
<a name="line234">0234: </a><span style="font-style: italic"><span style="color: #9A1900"> * The speed vs. space tradeoff is largely determined by the slop values.</span></span>
<a name="line235">0235: </a><span style="font-style: italic"><span style="color: #9A1900"> * A different slop value is provided for each pool class (lifetime),</span></span>
<a name="line236">0236: </a><span style="font-style: italic"><span style="color: #9A1900"> * and we also distinguish the first pool of a class from later ones.</span></span>
<a name="line237">0237: </a><span style="font-style: italic"><span style="color: #9A1900"> * NOTE: the values given work fairly well on both 16- and 32-bit-int</span></span>
<a name="line238">0238: </a><span style="font-style: italic"><span style="color: #9A1900"> * machines, but may be too small if longs are 64 bits or more.</span></span>
<a name="line239">0239: </a><span style="font-style: italic"><span style="color: #9A1900"> */</span></span>
<a name="line240">0240: </a>
<a name="line241">0241: </a><span style="font-weight: bold"><span style="color: #0000FF">static</span></span> <span style="font-weight: bold"><span style="color: #0000FF">const</span></span> size_t first_pool_slop<span style="color: #990000">[</span>JPOOL_NUMPOOLS<span style="color: #990000">]</span> <span style="color: #990000">=</span> 
<a name="line242">0242: </a><span style="color: #FF0000">{</span>
<a name="line243">0243: </a>        <span style="color: #993399">1600</span><span style="color: #990000">,</span>                   <span style="font-style: italic"><span style="color: #9A1900">/* first PERMANENT pool */</span></span>
<a name="line244">0244: </a>        <span style="color: #993399">16000</span>                   <span style="font-style: italic"><span style="color: #9A1900">/* first IMAGE pool */</span></span>
<a name="line245">0245: </a><span style="color: #FF0000">}</span><span style="color: #990000">;</span>
<a name="line246">0246: </a>
<a name="line247">0247: </a><span style="font-weight: bold"><span style="color: #0000FF">static</span></span> <span style="font-weight: bold"><span style="color: #0000FF">const</span></span> size_t extra_pool_slop<span style="color: #990000">[</span>JPOOL_NUMPOOLS<span style="color: #990000">]</span> <span style="color: #990000">=</span> 
<a name="line248">0248: </a><span style="color: #FF0000">{</span>
<a name="line249">0249: </a>        <span style="color: #993399">0</span><span style="color: #990000">,</span>                      <span style="font-style: italic"><span style="color: #9A1900">/* additional PERMANENT pools */</span></span>
<a name="line250">0250: </a>        <span style="color: #993399">5000</span>                    <span style="font-style: italic"><span style="color: #9A1900">/* additional IMAGE pools */</span></span>
<a name="line251">0251: </a><span style="color: #FF0000">}</span><span style="color: #990000">;</span>
<a name="line252">0252: </a>
<a name="line253">0253: </a><span style="font-weight: bold"><span style="color: #000080">#define</span></span> MIN_SLOP  <span style="color: #993399">50</span>            <span style="font-style: italic"><span style="color: #9A1900">/* greater than 0 to avoid futile looping */</span></span>
<a name="line254">0254: </a>
<a name="line255">0255: </a>
<a name="line256">0256: </a><span style="font-weight: bold"><span style="color: #000000">METHODDEF</span></span><span style="color: #990000">(</span><span style="color: #009900">void</span> <span style="color: #990000">*</span><span style="color: #990000">)</span>
<a name="line257">0257: </a><span style="font-weight: bold"><span style="color: #000000">alloc_small</span></span> <span style="color: #990000">(</span>j_common_ptr cinfo<span style="color: #990000">,</span> <span style="color: #009900">int</span> pool_id<span style="color: #990000">,</span> size_t sizeofobject<span style="color: #990000">)</span>
<a name="line258">0258: </a><span style="font-style: italic"><span style="color: #9A1900">/* Allocate a "small" object */</span></span>
<a name="line259">0259: </a><span style="color: #FF0000">{</span>
<a name="line260">0260: </a>  my_mem_ptr mem <span style="color: #990000">=</span> <span style="color: #990000">(</span>my_mem_ptr<span style="color: #990000">)</span> cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>mem<span style="color: #990000">;</span>
<a name="line261">0261: </a>  small_pool_ptr hdr_ptr<span style="color: #990000">,</span> prev_hdr_ptr<span style="color: #990000">;</span>
<a name="line262">0262: </a>  <span style="color: #009900">char</span> <span style="color: #990000">*</span> data_ptr<span style="color: #990000">;</span>
<a name="line263">0263: </a>  size_t odd_bytes<span style="color: #990000">,</span> min_request<span style="color: #990000">,</span> slop<span style="color: #990000">;</span>
<a name="line264">0264: </a>
<a name="line265">0265: </a>  <span style="font-style: italic"><span style="color: #9A1900">/* Check for unsatisfiable request (do now to ensure no overflow below) */</span></span>
<a name="line266">0266: </a>  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>sizeofobject <span style="color: #990000">&gt;</span> <span style="color: #990000">(</span>size_t<span style="color: #990000">)</span> <span style="color: #990000">(</span>MAX_ALLOC_CHUNK<span style="color: #990000">-</span><span style="font-weight: bold"><span style="color: #000000">SIZEOF</span></span><span style="color: #990000">(</span>small_pool_hdr<span style="color: #990000">)</span><span style="color: #990000">)</span><span style="color: #990000">)</span>
<a name="line267">0267: </a>    <span style="font-weight: bold"><span style="color: #000000">out_of_memory</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> <span style="color: #993399">1</span><span style="color: #990000">)</span><span style="color: #990000">;</span>    <span style="font-style: italic"><span style="color: #9A1900">/* request exceeds malloc's ability */</span></span>
<a name="line268">0268: </a>
<a name="line269">0269: </a>  <span style="font-style: italic"><span style="color: #9A1900">/* Round up the requested size to a multiple of SIZEOF(ALIGN_TYPE) */</span></span>
<a name="line270">0270: </a>  odd_bytes <span style="color: #990000">=</span> sizeofobject <span style="color: #990000">%</span> <span style="font-weight: bold"><span style="color: #000000">SIZEOF</span></span><span style="color: #990000">(</span>ALIGN_TYPE<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line271">0271: </a>  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>odd_bytes <span style="color: #990000">&gt;</span> <span style="color: #993399">0</span><span style="color: #990000">)</span>
<a name="line272">0272: </a>    sizeofobject <span style="color: #990000">+</span><span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">SIZEOF</span></span><span style="color: #990000">(</span>ALIGN_TYPE<span style="color: #990000">)</span> <span style="color: #990000">-</span> odd_bytes<span style="color: #990000">;</span>
<a name="line273">0273: </a>
<a name="line274">0274: </a>  <span style="font-style: italic"><span style="color: #9A1900">/* See if space is available in any existing pool */</span></span>
<a name="line275">0275: </a>  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>pool_id <span style="color: #990000">&lt;</span> <span style="color: #993399">0</span> <span style="color: #990000">|</span><span style="color: #990000">|</span> pool_id <span style="color: #990000">&gt;</span><span style="color: #990000">=</span> JPOOL_NUMPOOLS<span style="color: #990000">)</span>
<a name="line276">0276: </a>    <span style="font-weight: bold"><span style="color: #000000">ERREXIT1</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> JERR_BAD_POOL_ID<span style="color: #990000">,</span> pool_id<span style="color: #990000">)</span><span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">/* safety check */</span></span>
<a name="line277">0277: </a>  prev_hdr_ptr <span style="color: #990000">=</span> NULL<span style="color: #990000">;</span>
<a name="line278">0278: </a>  hdr_ptr <span style="color: #990000">=</span> mem<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>small_list<span style="color: #990000">[</span>pool_id<span style="color: #990000">]</span><span style="color: #990000">;</span>
<a name="line279">0279: </a>  <span style="font-weight: bold"><span style="color: #0000FF">while</span></span> <span style="color: #990000">(</span>hdr_ptr <span style="color: #990000">!</span><span style="color: #990000">=</span> NULL<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line280">0280: </a>    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>hdr_ptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>hdr<span style="color: #990000">.</span>bytes_left <span style="color: #990000">&gt;</span><span style="color: #990000">=</span> sizeofobject<span style="color: #990000">)</span>
<a name="line281">0281: </a>      <span style="font-weight: bold"><span style="color: #0000FF">break</span></span><span style="color: #990000">;</span>                    <span style="font-style: italic"><span style="color: #9A1900">/* found pool with enough space */</span></span>
<a name="line282">0282: </a>    prev_hdr_ptr <span style="color: #990000">=</span> hdr_ptr<span style="color: #990000">;</span>
<a name="line283">0283: </a>    hdr_ptr <span style="color: #990000">=</span> hdr_ptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>hdr<span style="color: #990000">.</span>next<span style="color: #990000">;</span>
<a name="line284">0284: </a>  <span style="color: #FF0000">}</span>
<a name="line285">0285: </a>
<a name="line286">0286: </a>  <span style="font-style: italic"><span style="color: #9A1900">/* Time to make a new pool? */</span></span>
<a name="line287">0287: </a>  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>hdr_ptr <span style="color: #990000">=</span><span style="color: #990000">=</span> NULL<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line288">0288: </a>    <span style="font-style: italic"><span style="color: #9A1900">/* min_request is what we need now, slop is what will be leftover */</span></span>
<a name="line289">0289: </a>    min_request <span style="color: #990000">=</span> sizeofobject <span style="color: #990000">+</span> <span style="font-weight: bold"><span style="color: #000000">SIZEOF</span></span><span style="color: #990000">(</span>small_pool_hdr<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line290">0290: </a>    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>prev_hdr_ptr <span style="color: #990000">=</span><span style="color: #990000">=</span> NULL<span style="color: #990000">)</span>   <span style="font-style: italic"><span style="color: #9A1900">/* first pool in class? */</span></span>
<a name="line291">0291: </a>      slop <span style="color: #990000">=</span> first_pool_slop<span style="color: #990000">[</span>pool_id<span style="color: #990000">]</span><span style="color: #990000">;</span>
<a name="line292">0292: </a>    <span style="font-weight: bold"><span style="color: #0000FF">else</span></span>
<a name="line293">0293: </a>      slop <span style="color: #990000">=</span> extra_pool_slop<span style="color: #990000">[</span>pool_id<span style="color: #990000">]</span><span style="color: #990000">;</span>
<a name="line294">0294: </a>    <span style="font-style: italic"><span style="color: #9A1900">/* Don't ask for more than MAX_ALLOC_CHUNK */</span></span>
<a name="line295">0295: </a>    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>slop <span style="color: #990000">&gt;</span> <span style="color: #990000">(</span>size_t<span style="color: #990000">)</span> <span style="color: #990000">(</span>MAX_ALLOC_CHUNK<span style="color: #990000">-</span>min_request<span style="color: #990000">)</span><span style="color: #990000">)</span>
<a name="line296">0296: </a>      slop <span style="color: #990000">=</span> <span style="color: #990000">(</span>size_t<span style="color: #990000">)</span> <span style="color: #990000">(</span>MAX_ALLOC_CHUNK<span style="color: #990000">-</span>min_request<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line297">0297: </a>    <span style="font-style: italic"><span style="color: #9A1900">/* Try to get space, if fail reduce slop and try again */</span></span>
<a name="line298">0298: </a>    <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> <span style="color: #990000">(</span><span style="color: #990000">;</span><span style="color: #990000">;</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line299">0299: </a>      hdr_ptr <span style="color: #990000">=</span> <span style="color: #990000">(</span>small_pool_ptr<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #000000">jpeg_get_small</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> min_request <span style="color: #990000">+</span> slop<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line300">0300: </a>      <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>hdr_ptr <span style="color: #990000">!</span><span style="color: #990000">=</span> NULL<span style="color: #990000">)</span>
<a name="line301">0301: </a>        <span style="font-weight: bold"><span style="color: #0000FF">break</span></span><span style="color: #990000">;</span>
<a name="line302">0302: </a>      slop <span style="color: #990000">/</span><span style="color: #990000">=</span> <span style="color: #993399">2</span><span style="color: #990000">;</span>
<a name="line303">0303: </a>      <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>slop <span style="color: #990000">&lt;</span> MIN_SLOP<span style="color: #990000">)</span>      <span style="font-style: italic"><span style="color: #9A1900">/* give up when it gets real small */</span></span>
<a name="line304">0304: </a>        <span style="font-weight: bold"><span style="color: #000000">out_of_memory</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> <span style="color: #993399">2</span><span style="color: #990000">)</span><span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">/* jpeg_get_small failed */</span></span>
<a name="line305">0305: </a>    <span style="color: #FF0000">}</span>
<a name="line306">0306: </a>    mem<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>total_space_allocated <span style="color: #990000">+</span><span style="color: #990000">=</span> min_request <span style="color: #990000">+</span> slop<span style="color: #990000">;</span>
<a name="line307">0307: </a>    <span style="font-style: italic"><span style="color: #9A1900">/* Success, initialize the new pool header and add to end of list */</span></span>
<a name="line308">0308: </a>    hdr_ptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>hdr<span style="color: #990000">.</span>next <span style="color: #990000">=</span> NULL<span style="color: #990000">;</span>
<a name="line309">0309: </a>    hdr_ptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>hdr<span style="color: #990000">.</span>bytes_used <span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">;</span>
<a name="line310">0310: </a>    hdr_ptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>hdr<span style="color: #990000">.</span>bytes_left <span style="color: #990000">=</span> sizeofobject <span style="color: #990000">+</span> slop<span style="color: #990000">;</span>
<a name="line311">0311: </a>    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>prev_hdr_ptr <span style="color: #990000">=</span><span style="color: #990000">=</span> NULL<span style="color: #990000">)</span>   <span style="font-style: italic"><span style="color: #9A1900">/* first pool in class? */</span></span>
<a name="line312">0312: </a>      mem<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>small_list<span style="color: #990000">[</span>pool_id<span style="color: #990000">]</span> <span style="color: #990000">=</span> hdr_ptr<span style="color: #990000">;</span>
<a name="line313">0313: </a>    <span style="font-weight: bold"><span style="color: #0000FF">else</span></span>
<a name="line314">0314: </a>      prev_hdr_ptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>hdr<span style="color: #990000">.</span>next <span style="color: #990000">=</span> hdr_ptr<span style="color: #990000">;</span>
<a name="line315">0315: </a>  <span style="color: #FF0000">}</span>
<a name="line316">0316: </a>
<a name="line317">0317: </a>  <span style="font-style: italic"><span style="color: #9A1900">/* OK, allocate the object from the current pool */</span></span>
<a name="line318">0318: </a>  data_ptr <span style="color: #990000">=</span> <span style="color: #990000">(</span><span style="color: #009900">char</span> <span style="color: #990000">*</span><span style="color: #990000">)</span> <span style="color: #990000">(</span>hdr_ptr <span style="color: #990000">+</span> <span style="color: #993399">1</span><span style="color: #990000">)</span><span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">/* point to first data byte in pool */</span></span>
<a name="line319">0319: </a>  data_ptr <span style="color: #990000">+</span><span style="color: #990000">=</span> hdr_ptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>hdr<span style="color: #990000">.</span>bytes_used<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">/* point to place for object */</span></span>
<a name="line320">0320: </a>  hdr_ptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>hdr<span style="color: #990000">.</span>bytes_used <span style="color: #990000">+</span><span style="color: #990000">=</span> sizeofobject<span style="color: #990000">;</span>
<a name="line321">0321: </a>  hdr_ptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>hdr<span style="color: #990000">.</span>bytes_left <span style="color: #990000">-</span><span style="color: #990000">=</span> sizeofobject<span style="color: #990000">;</span>
<a name="line322">0322: </a>
<a name="line323">0323: </a>  <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="color: #990000">(</span><span style="color: #009900">void</span> <span style="color: #990000">*</span><span style="color: #990000">)</span> data_ptr<span style="color: #990000">;</span>
<a name="line324">0324: </a><span style="color: #FF0000">}</span>
<a name="line325">0325: </a>
<a name="line326">0326: </a>
<a name="line327">0327: </a><span style="font-style: italic"><span style="color: #9A1900">/*</span></span>
<a name="line328">0328: </a><span style="font-style: italic"><span style="color: #9A1900"> * Allocation of "large" objects.</span></span>
<a name="line329">0329: </a><span style="font-style: italic"><span style="color: #9A1900"> *</span></span>
<a name="line330">0330: </a><span style="font-style: italic"><span style="color: #9A1900"> * The external semantics of these are the same as "small" objects,</span></span>
<a name="line331">0331: </a><span style="font-style: italic"><span style="color: #9A1900"> * except that FAR pointers are used on 80x86.  However the pool</span></span>
<a name="line332">0332: </a><span style="font-style: italic"><span style="color: #9A1900"> * management heuristics are quite different.  We assume that each</span></span>
<a name="line333">0333: </a><span style="font-style: italic"><span style="color: #9A1900"> * request is large enough that it may as well be passed directly to</span></span>
<a name="line334">0334: </a><span style="font-style: italic"><span style="color: #9A1900"> * jpeg_get_large; the pool management just links everything together</span></span>
<a name="line335">0335: </a><span style="font-style: italic"><span style="color: #9A1900"> * so that we can free it all on demand.</span></span>
<a name="line336">0336: </a><span style="font-style: italic"><span style="color: #9A1900"> * Note: the major use of "large" objects is in JSAMPARRAY and JBLOCKARRAY</span></span>
<a name="line337">0337: </a><span style="font-style: italic"><span style="color: #9A1900"> * structures.  The routines that create these structures (see below)</span></span>
<a name="line338">0338: </a><span style="font-style: italic"><span style="color: #9A1900"> * deliberately bunch rows together to ensure a large request size.</span></span>
<a name="line339">0339: </a><span style="font-style: italic"><span style="color: #9A1900"> */</span></span>
<a name="line340">0340: </a>
<a name="line341">0341: </a><span style="font-weight: bold"><span style="color: #000000">METHODDEF</span></span><span style="color: #990000">(</span><span style="color: #009900">void</span> FAR <span style="color: #990000">*</span><span style="color: #990000">)</span>
<a name="line342">0342: </a><span style="font-weight: bold"><span style="color: #000000">alloc_large</span></span> <span style="color: #990000">(</span>j_common_ptr cinfo<span style="color: #990000">,</span> <span style="color: #009900">int</span> pool_id<span style="color: #990000">,</span> size_t sizeofobject<span style="color: #990000">)</span>
<a name="line343">0343: </a><span style="font-style: italic"><span style="color: #9A1900">/* Allocate a "large" object */</span></span>
<a name="line344">0344: </a><span style="color: #FF0000">{</span>
<a name="line345">0345: </a>  my_mem_ptr mem <span style="color: #990000">=</span> <span style="color: #990000">(</span>my_mem_ptr<span style="color: #990000">)</span> cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>mem<span style="color: #990000">;</span>
<a name="line346">0346: </a>  large_pool_ptr hdr_ptr<span style="color: #990000">;</span>
<a name="line347">0347: </a>  size_t odd_bytes<span style="color: #990000">;</span>
<a name="line348">0348: </a>
<a name="line349">0349: </a>  <span style="font-style: italic"><span style="color: #9A1900">/* Check for unsatisfiable request (do now to ensure no overflow below) */</span></span>
<a name="line350">0350: </a>  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>sizeofobject <span style="color: #990000">&gt;</span> <span style="color: #990000">(</span>size_t<span style="color: #990000">)</span> <span style="color: #990000">(</span>MAX_ALLOC_CHUNK<span style="color: #990000">-</span><span style="font-weight: bold"><span style="color: #000000">SIZEOF</span></span><span style="color: #990000">(</span>large_pool_hdr<span style="color: #990000">)</span><span style="color: #990000">)</span><span style="color: #990000">)</span>
<a name="line351">0351: </a>    <span style="font-weight: bold"><span style="color: #000000">out_of_memory</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> <span style="color: #993399">3</span><span style="color: #990000">)</span><span style="color: #990000">;</span>    <span style="font-style: italic"><span style="color: #9A1900">/* request exceeds malloc's ability */</span></span>
<a name="line352">0352: </a>
<a name="line353">0353: </a>  <span style="font-style: italic"><span style="color: #9A1900">/* Round up the requested size to a multiple of SIZEOF(ALIGN_TYPE) */</span></span>
<a name="line354">0354: </a>  odd_bytes <span style="color: #990000">=</span> sizeofobject <span style="color: #990000">%</span> <span style="font-weight: bold"><span style="color: #000000">SIZEOF</span></span><span style="color: #990000">(</span>ALIGN_TYPE<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line355">0355: </a>  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>odd_bytes <span style="color: #990000">&gt;</span> <span style="color: #993399">0</span><span style="color: #990000">)</span>
<a name="line356">0356: </a>    sizeofobject <span style="color: #990000">+</span><span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">SIZEOF</span></span><span style="color: #990000">(</span>ALIGN_TYPE<span style="color: #990000">)</span> <span style="color: #990000">-</span> odd_bytes<span style="color: #990000">;</span>
<a name="line357">0357: </a>
<a name="line358">0358: </a>  <span style="font-style: italic"><span style="color: #9A1900">/* Always make a new pool */</span></span>
<a name="line359">0359: </a>  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>pool_id <span style="color: #990000">&lt;</span> <span style="color: #993399">0</span> <span style="color: #990000">|</span><span style="color: #990000">|</span> pool_id <span style="color: #990000">&gt;</span><span style="color: #990000">=</span> JPOOL_NUMPOOLS<span style="color: #990000">)</span>
<a name="line360">0360: </a>    <span style="font-weight: bold"><span style="color: #000000">ERREXIT1</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> JERR_BAD_POOL_ID<span style="color: #990000">,</span> pool_id<span style="color: #990000">)</span><span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">/* safety check */</span></span>
<a name="line361">0361: </a>
<a name="line362">0362: </a>  hdr_ptr <span style="color: #990000">=</span> <span style="color: #990000">(</span>large_pool_ptr<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #000000">jpeg_get_large</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> sizeofobject <span style="color: #990000">+</span>
<a name="line363">0363: </a>                                            <span style="font-weight: bold"><span style="color: #000000">SIZEOF</span></span><span style="color: #990000">(</span>large_pool_hdr<span style="color: #990000">)</span><span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line364">0364: </a>  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>hdr_ptr <span style="color: #990000">=</span><span style="color: #990000">=</span> NULL<span style="color: #990000">)</span>
<a name="line365">0365: </a>    <span style="font-weight: bold"><span style="color: #000000">out_of_memory</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> <span style="color: #993399">4</span><span style="color: #990000">)</span><span style="color: #990000">;</span>    <span style="font-style: italic"><span style="color: #9A1900">/* jpeg_get_large failed */</span></span>
<a name="line366">0366: </a>  mem<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>total_space_allocated <span style="color: #990000">+</span><span style="color: #990000">=</span> sizeofobject <span style="color: #990000">+</span> <span style="font-weight: bold"><span style="color: #000000">SIZEOF</span></span><span style="color: #990000">(</span>large_pool_hdr<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line367">0367: </a>
<a name="line368">0368: </a>  <span style="font-style: italic"><span style="color: #9A1900">/* Success, initialize the new pool header and add to list */</span></span>
<a name="line369">0369: </a>  hdr_ptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>hdr<span style="color: #990000">.</span>next <span style="color: #990000">=</span> mem<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>large_list<span style="color: #990000">[</span>pool_id<span style="color: #990000">]</span><span style="color: #990000">;</span>
<a name="line370">0370: </a>  <span style="font-style: italic"><span style="color: #9A1900">/* We maintain space counts in each pool header for statistical purposes,</span></span>
<a name="line371">0371: </a><span style="font-style: italic"><span style="color: #9A1900">   * even though they are not needed for allocation.</span></span>
<a name="line372">0372: </a><span style="font-style: italic"><span style="color: #9A1900">   */</span></span>
<a name="line373">0373: </a>  hdr_ptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>hdr<span style="color: #990000">.</span>bytes_used <span style="color: #990000">=</span> sizeofobject<span style="color: #990000">;</span>
<a name="line374">0374: </a>  hdr_ptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>hdr<span style="color: #990000">.</span>bytes_left <span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">;</span>
<a name="line375">0375: </a>  mem<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>large_list<span style="color: #990000">[</span>pool_id<span style="color: #990000">]</span> <span style="color: #990000">=</span> hdr_ptr<span style="color: #990000">;</span>
<a name="line376">0376: </a>
<a name="line377">0377: </a>  <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="color: #990000">(</span><span style="color: #009900">void</span> FAR <span style="color: #990000">*</span><span style="color: #990000">)</span> <span style="color: #990000">(</span>hdr_ptr <span style="color: #990000">+</span> <span style="color: #993399">1</span><span style="color: #990000">)</span><span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">/* point to first data byte in pool */</span></span>
<a name="line378">0378: </a><span style="color: #FF0000">}</span>
<a name="line379">0379: </a>
<a name="line380">0380: </a>
<a name="line381">0381: </a><span style="font-style: italic"><span style="color: #9A1900">/*</span></span>
<a name="line382">0382: </a><span style="font-style: italic"><span style="color: #9A1900"> * Creation of 2-D sample arrays.</span></span>
<a name="line383">0383: </a><span style="font-style: italic"><span style="color: #9A1900"> * The pointers are in near heap, the samples themselves in FAR heap.</span></span>
<a name="line384">0384: </a><span style="font-style: italic"><span style="color: #9A1900"> *</span></span>
<a name="line385">0385: </a><span style="font-style: italic"><span style="color: #9A1900"> * To minimize allocation overhead and to allow I/O of large contiguous</span></span>
<a name="line386">0386: </a><span style="font-style: italic"><span style="color: #9A1900"> * blocks, we allocate the sample rows in groups of as many rows as possible</span></span>
<a name="line387">0387: </a><span style="font-style: italic"><span style="color: #9A1900"> * without exceeding MAX_ALLOC_CHUNK total bytes per allocation request.</span></span>
<a name="line388">0388: </a><span style="font-style: italic"><span style="color: #9A1900"> * NB: the virtual array control routines, later in this file, know about</span></span>
<a name="line389">0389: </a><span style="font-style: italic"><span style="color: #9A1900"> * this chunking of rows.  The rowsperchunk value is left in the mem manager</span></span>
<a name="line390">0390: </a><span style="font-style: italic"><span style="color: #9A1900"> * object so that it can be saved away if this sarray is the workspace for</span></span>
<a name="line391">0391: </a><span style="font-style: italic"><span style="color: #9A1900"> * a virtual array.</span></span>
<a name="line392">0392: </a><span style="font-style: italic"><span style="color: #9A1900"> */</span></span>
<a name="line393">0393: </a>
<a name="line394">0394: </a><span style="font-weight: bold"><span style="color: #000000">METHODDEF</span></span><span style="color: #990000">(</span>JSAMPARRAY<span style="color: #990000">)</span>
<a name="line395">0395: </a><span style="font-weight: bold"><span style="color: #000000">alloc_sarray</span></span> <span style="color: #990000">(</span>j_common_ptr cinfo<span style="color: #990000">,</span> <span style="color: #009900">int</span> pool_id<span style="color: #990000">,</span>
<a name="line396">0396: </a>              JDIMENSION samplesperrow<span style="color: #990000">,</span> JDIMENSION numrows<span style="color: #990000">)</span>
<a name="line397">0397: </a><span style="font-style: italic"><span style="color: #9A1900">/* Allocate a 2-D sample array */</span></span>
<a name="line398">0398: </a><span style="color: #FF0000">{</span>
<a name="line399">0399: </a>  my_mem_ptr mem <span style="color: #990000">=</span> <span style="color: #990000">(</span>my_mem_ptr<span style="color: #990000">)</span> cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>mem<span style="color: #990000">;</span>
<a name="line400">0400: </a>  JSAMPARRAY result<span style="color: #990000">;</span>
<a name="line401">0401: </a>  JSAMPROW workspace<span style="color: #990000">;</span>
<a name="line402">0402: </a>  JDIMENSION rowsperchunk<span style="color: #990000">,</span> currow<span style="color: #990000">,</span> i<span style="color: #990000">;</span>
<a name="line403">0403: </a>  <span style="color: #009900">long</span> ltemp<span style="color: #990000">;</span>
<a name="line404">0404: </a>
<a name="line405">0405: </a>  <span style="font-style: italic"><span style="color: #9A1900">/* Calculate max # of rows allowed in one allocation chunk */</span></span>
<a name="line406">0406: </a>  ltemp <span style="color: #990000">=</span> <span style="color: #990000">(</span>MAX_ALLOC_CHUNK<span style="color: #990000">-</span><span style="font-weight: bold"><span style="color: #000000">SIZEOF</span></span><span style="color: #990000">(</span>large_pool_hdr<span style="color: #990000">)</span><span style="color: #990000">)</span> <span style="color: #990000">/</span>
<a name="line407">0407: </a>          <span style="color: #990000">(</span><span style="color: #990000">(</span><span style="color: #009900">long</span><span style="color: #990000">)</span> samplesperrow <span style="color: #990000">*</span> <span style="font-weight: bold"><span style="color: #000000">SIZEOF</span></span><span style="color: #990000">(</span>JSAMPLE<span style="color: #990000">)</span><span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line408">0408: </a>  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>ltemp <span style="color: #990000">&lt;</span><span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">)</span>
<a name="line409">0409: </a>    <span style="font-weight: bold"><span style="color: #000000">ERREXIT</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> JERR_WIDTH_OVERFLOW<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line410">0410: </a>  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>ltemp <span style="color: #990000">&lt;</span> <span style="color: #990000">(</span><span style="color: #009900">long</span><span style="color: #990000">)</span> numrows<span style="color: #990000">)</span>
<a name="line411">0411: </a>    rowsperchunk <span style="color: #990000">=</span> <span style="color: #990000">(</span>JDIMENSION<span style="color: #990000">)</span> ltemp<span style="color: #990000">;</span>
<a name="line412">0412: </a>  <span style="font-weight: bold"><span style="color: #0000FF">else</span></span>
<a name="line413">0413: </a>    rowsperchunk <span style="color: #990000">=</span> numrows<span style="color: #990000">;</span>
<a name="line414">0414: </a>  mem<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>last_rowsperchunk <span style="color: #990000">=</span> rowsperchunk<span style="color: #990000">;</span>
<a name="line415">0415: </a>
<a name="line416">0416: </a>  <span style="font-style: italic"><span style="color: #9A1900">/* Get space for row pointers (small object) */</span></span>
<a name="line417">0417: </a>  result <span style="color: #990000">=</span> <span style="color: #990000">(</span>JSAMPARRAY<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #000000">alloc_small</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> pool_id<span style="color: #990000">,</span>
<a name="line418">0418: </a>                                    <span style="color: #990000">(</span>size_t<span style="color: #990000">)</span> <span style="color: #990000">(</span>numrows <span style="color: #990000">*</span> <span style="font-weight: bold"><span style="color: #000000">SIZEOF</span></span><span style="color: #990000">(</span>JSAMPROW<span style="color: #990000">)</span><span style="color: #990000">)</span><span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line419">0419: </a>
<a name="line420">0420: </a>  <span style="font-style: italic"><span style="color: #9A1900">/* Get the rows themselves (large objects) */</span></span>
<a name="line421">0421: </a>  currow <span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">;</span>
<a name="line422">0422: </a>  <span style="font-weight: bold"><span style="color: #0000FF">while</span></span> <span style="color: #990000">(</span>currow <span style="color: #990000">&lt;</span> numrows<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line423">0423: </a>    rowsperchunk <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">MIN</span></span><span style="color: #990000">(</span>rowsperchunk<span style="color: #990000">,</span> numrows <span style="color: #990000">-</span> currow<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line424">0424: </a>    workspace <span style="color: #990000">=</span> <span style="color: #990000">(</span>JSAMPROW<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #000000">alloc_large</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> pool_id<span style="color: #990000">,</span>
<a name="line425">0425: </a>        <span style="color: #990000">(</span>size_t<span style="color: #990000">)</span> <span style="color: #990000">(</span><span style="color: #990000">(</span>size_t<span style="color: #990000">)</span> rowsperchunk <span style="color: #990000">*</span> <span style="color: #990000">(</span>size_t<span style="color: #990000">)</span> samplesperrow
<a name="line426">0426: </a>                  <span style="color: #990000">*</span> <span style="font-weight: bold"><span style="color: #000000">SIZEOF</span></span><span style="color: #990000">(</span>JSAMPLE<span style="color: #990000">)</span><span style="color: #990000">)</span><span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line427">0427: </a>    <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> <span style="color: #990000">(</span>i <span style="color: #990000">=</span> rowsperchunk<span style="color: #990000">;</span> i <span style="color: #990000">&gt;</span> <span style="color: #993399">0</span><span style="color: #990000">;</span> i<span style="color: #990000">-</span><span style="color: #990000">-</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line428">0428: </a>      result<span style="color: #990000">[</span>currow<span style="color: #990000">+</span><span style="color: #990000">+</span><span style="color: #990000">]</span> <span style="color: #990000">=</span> workspace<span style="color: #990000">;</span>
<a name="line429">0429: </a>      workspace <span style="color: #990000">+</span><span style="color: #990000">=</span> samplesperrow<span style="color: #990000">;</span>
<a name="line430">0430: </a>    <span style="color: #FF0000">}</span>
<a name="line431">0431: </a>  <span style="color: #FF0000">}</span>
<a name="line432">0432: </a>
<a name="line433">0433: </a>  <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> result<span style="color: #990000">;</span>
<a name="line434">0434: </a><span style="color: #FF0000">}</span>
<a name="line435">0435: </a>
<a name="line436">0436: </a>
<a name="line437">0437: </a><span style="font-style: italic"><span style="color: #9A1900">/*</span></span>
<a name="line438">0438: </a><span style="font-style: italic"><span style="color: #9A1900"> * Creation of 2-D coefficient-block arrays.</span></span>
<a name="line439">0439: </a><span style="font-style: italic"><span style="color: #9A1900"> * This is essentially the same as the code for sample arrays, above.</span></span>
<a name="line440">0440: </a><span style="font-style: italic"><span style="color: #9A1900"> */</span></span>
<a name="line441">0441: </a>
<a name="line442">0442: </a><span style="font-weight: bold"><span style="color: #000000">METHODDEF</span></span><span style="color: #990000">(</span>JBLOCKARRAY<span style="color: #990000">)</span>
<a name="line443">0443: </a><span style="font-weight: bold"><span style="color: #000000">alloc_barray</span></span> <span style="color: #990000">(</span>j_common_ptr cinfo<span style="color: #990000">,</span> <span style="color: #009900">int</span> pool_id<span style="color: #990000">,</span>
<a name="line444">0444: </a>              JDIMENSION blocksperrow<span style="color: #990000">,</span> JDIMENSION numrows<span style="color: #990000">)</span>
<a name="line445">0445: </a><span style="font-style: italic"><span style="color: #9A1900">/* Allocate a 2-D coefficient-block array */</span></span>
<a name="line446">0446: </a><span style="color: #FF0000">{</span>
<a name="line447">0447: </a>  my_mem_ptr mem <span style="color: #990000">=</span> <span style="color: #990000">(</span>my_mem_ptr<span style="color: #990000">)</span> cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>mem<span style="color: #990000">;</span>
<a name="line448">0448: </a>  JBLOCKARRAY result<span style="color: #990000">;</span>
<a name="line449">0449: </a>  JBLOCKROW workspace<span style="color: #990000">;</span>
<a name="line450">0450: </a>  JDIMENSION rowsperchunk<span style="color: #990000">,</span> currow<span style="color: #990000">,</span> i<span style="color: #990000">;</span>
<a name="line451">0451: </a>  <span style="color: #009900">long</span> ltemp<span style="color: #990000">;</span>
<a name="line452">0452: </a>
<a name="line453">0453: </a>  <span style="font-style: italic"><span style="color: #9A1900">/* Calculate max # of rows allowed in one allocation chunk */</span></span>
<a name="line454">0454: </a>  ltemp <span style="color: #990000">=</span> <span style="color: #990000">(</span>MAX_ALLOC_CHUNK<span style="color: #990000">-</span><span style="font-weight: bold"><span style="color: #000000">SIZEOF</span></span><span style="color: #990000">(</span>large_pool_hdr<span style="color: #990000">)</span><span style="color: #990000">)</span> <span style="color: #990000">/</span>
<a name="line455">0455: </a>          <span style="color: #990000">(</span><span style="color: #990000">(</span><span style="color: #009900">long</span><span style="color: #990000">)</span> blocksperrow <span style="color: #990000">*</span> <span style="font-weight: bold"><span style="color: #000000">SIZEOF</span></span><span style="color: #990000">(</span>JBLOCK<span style="color: #990000">)</span><span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line456">0456: </a>  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>ltemp <span style="color: #990000">&lt;</span><span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">)</span>
<a name="line457">0457: </a>    <span style="font-weight: bold"><span style="color: #000000">ERREXIT</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> JERR_WIDTH_OVERFLOW<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line458">0458: </a>  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>ltemp <span style="color: #990000">&lt;</span> <span style="color: #990000">(</span><span style="color: #009900">long</span><span style="color: #990000">)</span> numrows<span style="color: #990000">)</span>
<a name="line459">0459: </a>    rowsperchunk <span style="color: #990000">=</span> <span style="color: #990000">(</span>JDIMENSION<span style="color: #990000">)</span> ltemp<span style="color: #990000">;</span>
<a name="line460">0460: </a>  <span style="font-weight: bold"><span style="color: #0000FF">else</span></span>
<a name="line461">0461: </a>    rowsperchunk <span style="color: #990000">=</span> numrows<span style="color: #990000">;</span>
<a name="line462">0462: </a>  mem<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>last_rowsperchunk <span style="color: #990000">=</span> rowsperchunk<span style="color: #990000">;</span>
<a name="line463">0463: </a>
<a name="line464">0464: </a>  <span style="font-style: italic"><span style="color: #9A1900">/* Get space for row pointers (small object) */</span></span>
<a name="line465">0465: </a>  result <span style="color: #990000">=</span> <span style="color: #990000">(</span>JBLOCKARRAY<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #000000">alloc_small</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> pool_id<span style="color: #990000">,</span>
<a name="line466">0466: </a>                                     <span style="color: #990000">(</span>size_t<span style="color: #990000">)</span> <span style="color: #990000">(</span>numrows <span style="color: #990000">*</span> <span style="font-weight: bold"><span style="color: #000000">SIZEOF</span></span><span style="color: #990000">(</span>JBLOCKROW<span style="color: #990000">)</span><span style="color: #990000">)</span><span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line467">0467: </a>
<a name="line468">0468: </a>  <span style="font-style: italic"><span style="color: #9A1900">/* Get the rows themselves (large objects) */</span></span>
<a name="line469">0469: </a>  currow <span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">;</span>
<a name="line470">0470: </a>  <span style="font-weight: bold"><span style="color: #0000FF">while</span></span> <span style="color: #990000">(</span>currow <span style="color: #990000">&lt;</span> numrows<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line471">0471: </a>    rowsperchunk <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">MIN</span></span><span style="color: #990000">(</span>rowsperchunk<span style="color: #990000">,</span> numrows <span style="color: #990000">-</span> currow<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line472">0472: </a>    workspace <span style="color: #990000">=</span> <span style="color: #990000">(</span>JBLOCKROW<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #000000">alloc_large</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> pool_id<span style="color: #990000">,</span>
<a name="line473">0473: </a>        <span style="color: #990000">(</span>size_t<span style="color: #990000">)</span> <span style="color: #990000">(</span><span style="color: #990000">(</span>size_t<span style="color: #990000">)</span> rowsperchunk <span style="color: #990000">*</span> <span style="color: #990000">(</span>size_t<span style="color: #990000">)</span> blocksperrow
<a name="line474">0474: </a>                  <span style="color: #990000">*</span> <span style="font-weight: bold"><span style="color: #000000">SIZEOF</span></span><span style="color: #990000">(</span>JBLOCK<span style="color: #990000">)</span><span style="color: #990000">)</span><span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line475">0475: </a>    <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> <span style="color: #990000">(</span>i <span style="color: #990000">=</span> rowsperchunk<span style="color: #990000">;</span> i <span style="color: #990000">&gt;</span> <span style="color: #993399">0</span><span style="color: #990000">;</span> i<span style="color: #990000">-</span><span style="color: #990000">-</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line476">0476: </a>      result<span style="color: #990000">[</span>currow<span style="color: #990000">+</span><span style="color: #990000">+</span><span style="color: #990000">]</span> <span style="color: #990000">=</span> workspace<span style="color: #990000">;</span>
<a name="line477">0477: </a>      workspace <span style="color: #990000">+</span><span style="color: #990000">=</span> blocksperrow<span style="color: #990000">;</span>
<a name="line478">0478: </a>    <span style="color: #FF0000">}</span>
<a name="line479">0479: </a>  <span style="color: #FF0000">}</span>
<a name="line480">0480: </a>
<a name="line481">0481: </a>  <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> result<span style="color: #990000">;</span>
<a name="line482">0482: </a><span style="color: #FF0000">}</span>
<a name="line483">0483: </a>
<a name="line484">0484: </a>
<a name="line485">0485: </a><span style="font-style: italic"><span style="color: #9A1900">/*</span></span>
<a name="line486">0486: </a><span style="font-style: italic"><span style="color: #9A1900"> * About virtual array management:</span></span>
<a name="line487">0487: </a><span style="font-style: italic"><span style="color: #9A1900"> *</span></span>
<a name="line488">0488: </a><span style="font-style: italic"><span style="color: #9A1900"> * The above "normal" array routines are only used to allocate strip buffers</span></span>
<a name="line489">0489: </a><span style="font-style: italic"><span style="color: #9A1900"> * (as wide as the image, but just a few rows high).  Full-image-sized buffers</span></span>
<a name="line490">0490: </a><span style="font-style: italic"><span style="color: #9A1900"> * are handled as "virtual" arrays.  The array is still accessed a strip at a</span></span>
<a name="line491">0491: </a><span style="font-style: italic"><span style="color: #9A1900"> * time, but the memory manager must save the whole array for repeated</span></span>
<a name="line492">0492: </a><span style="font-style: italic"><span style="color: #9A1900"> * accesses.  The intended implementation is that there is a strip buffer in</span></span>
<a name="line493">0493: </a><span style="font-style: italic"><span style="color: #9A1900"> * memory (as high as is possible given the desired memory limit), plus a</span></span>
<a name="line494">0494: </a><span style="font-style: italic"><span style="color: #9A1900"> * backing file that holds the rest of the array.</span></span>
<a name="line495">0495: </a><span style="font-style: italic"><span style="color: #9A1900"> *</span></span>
<a name="line496">0496: </a><span style="font-style: italic"><span style="color: #9A1900"> * The request_virt_array routines are told the total size of the image and</span></span>
<a name="line497">0497: </a><span style="font-style: italic"><span style="color: #9A1900"> * the maximum number of rows that will be accessed at once.  The in-memory</span></span>
<a name="line498">0498: </a><span style="font-style: italic"><span style="color: #9A1900"> * buffer must be at least as large as the maxaccess value.</span></span>
<a name="line499">0499: </a><span style="font-style: italic"><span style="color: #9A1900"> *</span></span>
<a name="line500">0500: </a><span style="font-style: italic"><span style="color: #9A1900"> * The request routines create control blocks but not the in-memory buffers.</span></span>
<a name="line501">0501: </a><span style="font-style: italic"><span style="color: #9A1900"> * That is postponed until realize_virt_arrays is called.  At that time the</span></span>
<a name="line502">0502: </a><span style="font-style: italic"><span style="color: #9A1900"> * total amount of space needed is known (approximately, anyway), so free</span></span>
<a name="line503">0503: </a><span style="font-style: italic"><span style="color: #9A1900"> * memory can be divided up fairly.</span></span>
<a name="line504">0504: </a><span style="font-style: italic"><span style="color: #9A1900"> *</span></span>
<a name="line505">0505: </a><span style="font-style: italic"><span style="color: #9A1900"> * The access_virt_array routines are responsible for making a specific strip</span></span>
<a name="line506">0506: </a><span style="font-style: italic"><span style="color: #9A1900"> * area accessible (after reading or writing the backing file, if necessary).</span></span>
<a name="line507">0507: </a><span style="font-style: italic"><span style="color: #9A1900"> * Note that the access routines are told whether the caller intends to modify</span></span>
<a name="line508">0508: </a><span style="font-style: italic"><span style="color: #9A1900"> * the accessed strip; during a read-only pass this saves having to rewrite</span></span>
<a name="line509">0509: </a><span style="font-style: italic"><span style="color: #9A1900"> * data to disk.  The access routines are also responsible for pre-zeroing</span></span>
<a name="line510">0510: </a><span style="font-style: italic"><span style="color: #9A1900"> * any newly accessed rows, if pre-zeroing was requested.</span></span>
<a name="line511">0511: </a><span style="font-style: italic"><span style="color: #9A1900"> *</span></span>
<a name="line512">0512: </a><span style="font-style: italic"><span style="color: #9A1900"> * In current usage, the access requests are usually for nonoverlapping</span></span>
<a name="line513">0513: </a><span style="font-style: italic"><span style="color: #9A1900"> * strips; that is, successive access start_row numbers differ by exactly</span></span>
<a name="line514">0514: </a><span style="font-style: italic"><span style="color: #9A1900"> * num_rows = maxaccess.  This means we can get good performance with simple</span></span>
<a name="line515">0515: </a><span style="font-style: italic"><span style="color: #9A1900"> * buffer dump/reload logic, by making the in-memory buffer be a multiple</span></span>
<a name="line516">0516: </a><span style="font-style: italic"><span style="color: #9A1900"> * of the access height; then there will never be accesses across bufferload</span></span>
<a name="line517">0517: </a><span style="font-style: italic"><span style="color: #9A1900"> * boundaries.  The code will still work with overlapping access requests,</span></span>
<a name="line518">0518: </a><span style="font-style: italic"><span style="color: #9A1900"> * but it doesn't handle bufferload overlaps very efficiently.</span></span>
<a name="line519">0519: </a><span style="font-style: italic"><span style="color: #9A1900"> */</span></span>
<a name="line520">0520: </a>
<a name="line521">0521: </a>
<a name="line522">0522: </a><span style="font-weight: bold"><span style="color: #000000">METHODDEF</span></span><span style="color: #990000">(</span>jvirt_sarray_ptr<span style="color: #990000">)</span>
<a name="line523">0523: </a><span style="font-weight: bold"><span style="color: #000000">request_virt_sarray</span></span> <span style="color: #990000">(</span>j_common_ptr cinfo<span style="color: #990000">,</span> <span style="color: #009900">int</span> pool_id<span style="color: #990000">,</span> boolean pre_zero<span style="color: #990000">,</span>
<a name="line524">0524: </a>                     JDIMENSION samplesperrow<span style="color: #990000">,</span> JDIMENSION numrows<span style="color: #990000">,</span>
<a name="line525">0525: </a>                     JDIMENSION maxaccess<span style="color: #990000">)</span>
<a name="line526">0526: </a><span style="font-style: italic"><span style="color: #9A1900">/* Request a virtual 2-D sample array */</span></span>
<a name="line527">0527: </a><span style="color: #FF0000">{</span>
<a name="line528">0528: </a>  my_mem_ptr mem <span style="color: #990000">=</span> <span style="color: #990000">(</span>my_mem_ptr<span style="color: #990000">)</span> cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>mem<span style="color: #990000">;</span>
<a name="line529">0529: </a>  jvirt_sarray_ptr result<span style="color: #990000">;</span>
<a name="line530">0530: </a>
<a name="line531">0531: </a>  <span style="font-style: italic"><span style="color: #9A1900">/* Only IMAGE-lifetime virtual arrays are currently supported */</span></span>
<a name="line532">0532: </a>  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>pool_id <span style="color: #990000">!</span><span style="color: #990000">=</span> JPOOL_IMAGE<span style="color: #990000">)</span>
<a name="line533">0533: </a>    <span style="font-weight: bold"><span style="color: #000000">ERREXIT1</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> JERR_BAD_POOL_ID<span style="color: #990000">,</span> pool_id<span style="color: #990000">)</span><span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">/* safety check */</span></span>
<a name="line534">0534: </a>
<a name="line535">0535: </a>  <span style="font-style: italic"><span style="color: #9A1900">/* get control block */</span></span>
<a name="line536">0536: </a>  result <span style="color: #990000">=</span> <span style="color: #990000">(</span>jvirt_sarray_ptr<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #000000">alloc_small</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> pool_id<span style="color: #990000">,</span>
<a name="line537">0537: </a>                                          <span style="font-weight: bold"><span style="color: #000000">SIZEOF</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">struct</span></span> jvirt_sarray_control<span style="color: #990000">)</span><span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line538">0538: </a>
<a name="line539">0539: </a>  result<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>mem_buffer <span style="color: #990000">=</span> NULL<span style="color: #990000">;</span>    <span style="font-style: italic"><span style="color: #9A1900">/* marks array not yet realized */</span></span>
<a name="line540">0540: </a>  result<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>rows_in_array <span style="color: #990000">=</span> numrows<span style="color: #990000">;</span>
<a name="line541">0541: </a>  result<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>samplesperrow <span style="color: #990000">=</span> samplesperrow<span style="color: #990000">;</span>
<a name="line542">0542: </a>  result<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>maxaccess <span style="color: #990000">=</span> maxaccess<span style="color: #990000">;</span>
<a name="line543">0543: </a>  result<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>pre_zero <span style="color: #990000">=</span> pre_zero<span style="color: #990000">;</span>
<a name="line544">0544: </a>  result<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>b_s_open <span style="color: #990000">=</span> FALSE<span style="color: #990000">;</span>     <span style="font-style: italic"><span style="color: #9A1900">/* no associated backing-store object */</span></span>
<a name="line545">0545: </a>  result<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>next <span style="color: #990000">=</span> mem<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>virt_sarray_list<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">/* add to list of virtual arrays */</span></span>
<a name="line546">0546: </a>  mem<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>virt_sarray_list <span style="color: #990000">=</span> result<span style="color: #990000">;</span>
<a name="line547">0547: </a>
<a name="line548">0548: </a>  <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> result<span style="color: #990000">;</span>
<a name="line549">0549: </a><span style="color: #FF0000">}</span>
<a name="line550">0550: </a>
<a name="line551">0551: </a>
<a name="line552">0552: </a><span style="font-weight: bold"><span style="color: #000000">METHODDEF</span></span><span style="color: #990000">(</span>jvirt_barray_ptr<span style="color: #990000">)</span>
<a name="line553">0553: </a><span style="font-weight: bold"><span style="color: #000000">request_virt_barray</span></span> <span style="color: #990000">(</span>j_common_ptr cinfo<span style="color: #990000">,</span> <span style="color: #009900">int</span> pool_id<span style="color: #990000">,</span> boolean pre_zero<span style="color: #990000">,</span>
<a name="line554">0554: </a>                     JDIMENSION blocksperrow<span style="color: #990000">,</span> JDIMENSION numrows<span style="color: #990000">,</span>
<a name="line555">0555: </a>                     JDIMENSION maxaccess<span style="color: #990000">)</span>
<a name="line556">0556: </a><span style="font-style: italic"><span style="color: #9A1900">/* Request a virtual 2-D coefficient-block array */</span></span>
<a name="line557">0557: </a><span style="color: #FF0000">{</span>
<a name="line558">0558: </a>  my_mem_ptr mem <span style="color: #990000">=</span> <span style="color: #990000">(</span>my_mem_ptr<span style="color: #990000">)</span> cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>mem<span style="color: #990000">;</span>
<a name="line559">0559: </a>  jvirt_barray_ptr result<span style="color: #990000">;</span>
<a name="line560">0560: </a>
<a name="line561">0561: </a>  <span style="font-style: italic"><span style="color: #9A1900">/* Only IMAGE-lifetime virtual arrays are currently supported */</span></span>
<a name="line562">0562: </a>  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>pool_id <span style="color: #990000">!</span><span style="color: #990000">=</span> JPOOL_IMAGE<span style="color: #990000">)</span>
<a name="line563">0563: </a>    <span style="font-weight: bold"><span style="color: #000000">ERREXIT1</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> JERR_BAD_POOL_ID<span style="color: #990000">,</span> pool_id<span style="color: #990000">)</span><span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">/* safety check */</span></span>
<a name="line564">0564: </a>
<a name="line565">0565: </a>  <span style="font-style: italic"><span style="color: #9A1900">/* get control block */</span></span>
<a name="line566">0566: </a>  result <span style="color: #990000">=</span> <span style="color: #990000">(</span>jvirt_barray_ptr<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #000000">alloc_small</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> pool_id<span style="color: #990000">,</span>
<a name="line567">0567: </a>                                          <span style="font-weight: bold"><span style="color: #000000">SIZEOF</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">struct</span></span> jvirt_barray_control<span style="color: #990000">)</span><span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line568">0568: </a>
<a name="line569">0569: </a>  result<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>mem_buffer <span style="color: #990000">=</span> NULL<span style="color: #990000">;</span>    <span style="font-style: italic"><span style="color: #9A1900">/* marks array not yet realized */</span></span>
<a name="line570">0570: </a>  result<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>rows_in_array <span style="color: #990000">=</span> numrows<span style="color: #990000">;</span>
<a name="line571">0571: </a>  result<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>blocksperrow <span style="color: #990000">=</span> blocksperrow<span style="color: #990000">;</span>
<a name="line572">0572: </a>  result<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>maxaccess <span style="color: #990000">=</span> maxaccess<span style="color: #990000">;</span>
<a name="line573">0573: </a>  result<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>pre_zero <span style="color: #990000">=</span> pre_zero<span style="color: #990000">;</span>
<a name="line574">0574: </a>  result<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>b_s_open <span style="color: #990000">=</span> FALSE<span style="color: #990000">;</span>     <span style="font-style: italic"><span style="color: #9A1900">/* no associated backing-store object */</span></span>
<a name="line575">0575: </a>  result<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>next <span style="color: #990000">=</span> mem<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>virt_barray_list<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">/* add to list of virtual arrays */</span></span>
<a name="line576">0576: </a>  mem<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>virt_barray_list <span style="color: #990000">=</span> result<span style="color: #990000">;</span>
<a name="line577">0577: </a>
<a name="line578">0578: </a>  <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> result<span style="color: #990000">;</span>
<a name="line579">0579: </a><span style="color: #FF0000">}</span>
<a name="line580">0580: </a>
<a name="line581">0581: </a>
<a name="line582">0582: </a><span style="font-weight: bold"><span style="color: #000000">METHODDEF</span></span><span style="color: #990000">(</span><span style="color: #009900">void</span><span style="color: #990000">)</span>
<a name="line583">0583: </a><span style="font-weight: bold"><span style="color: #000000">realize_virt_arrays</span></span> <span style="color: #990000">(</span>j_common_ptr cinfo<span style="color: #990000">)</span>
<a name="line584">0584: </a><span style="font-style: italic"><span style="color: #9A1900">/* Allocate the in-memory buffers for any unrealized virtual arrays */</span></span>
<a name="line585">0585: </a><span style="color: #FF0000">{</span>
<a name="line586">0586: </a>  my_mem_ptr mem <span style="color: #990000">=</span> <span style="color: #990000">(</span>my_mem_ptr<span style="color: #990000">)</span> cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>mem<span style="color: #990000">;</span>
<a name="line587">0587: </a>  <span style="color: #009900">long</span> space_per_minheight<span style="color: #990000">,</span> maximum_space<span style="color: #990000">,</span> avail_mem<span style="color: #990000">;</span>
<a name="line588">0588: </a>  <span style="color: #009900">long</span> minheights<span style="color: #990000">,</span> max_minheights<span style="color: #990000">;</span>
<a name="line589">0589: </a>  jvirt_sarray_ptr sptr<span style="color: #990000">;</span>
<a name="line590">0590: </a>  jvirt_barray_ptr bptr<span style="color: #990000">;</span>
<a name="line591">0591: </a>
<a name="line592">0592: </a>  <span style="font-style: italic"><span style="color: #9A1900">/* Compute the minimum space needed (maxaccess rows in each buffer)</span></span>
<a name="line593">0593: </a><span style="font-style: italic"><span style="color: #9A1900">   * and the maximum space needed (full image height in each buffer).</span></span>
<a name="line594">0594: </a><span style="font-style: italic"><span style="color: #9A1900">   * These may be of use to the system-dependent jpeg_mem_available routine.</span></span>
<a name="line595">0595: </a><span style="font-style: italic"><span style="color: #9A1900">   */</span></span>
<a name="line596">0596: </a>  space_per_minheight <span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">;</span>
<a name="line597">0597: </a>  maximum_space <span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">;</span>
<a name="line598">0598: </a>  <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> <span style="color: #990000">(</span>sptr <span style="color: #990000">=</span> mem<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>virt_sarray_list<span style="color: #990000">;</span> sptr <span style="color: #990000">!</span><span style="color: #990000">=</span> NULL<span style="color: #990000">;</span> sptr <span style="color: #990000">=</span> sptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>next<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line599">0599: </a>    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>sptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>mem_buffer <span style="color: #990000">=</span><span style="color: #990000">=</span> NULL<span style="color: #990000">)</span> <span style="color: #FF0000">{</span> <span style="font-style: italic"><span style="color: #9A1900">/* if not realized yet */</span></span>
<a name="line600">0600: </a>      space_per_minheight <span style="color: #990000">+</span><span style="color: #990000">=</span> <span style="color: #990000">(</span><span style="color: #009900">long</span><span style="color: #990000">)</span> sptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>maxaccess <span style="color: #990000">*</span>
<a name="line601">0601: </a>                             <span style="color: #990000">(</span><span style="color: #009900">long</span><span style="color: #990000">)</span> sptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>samplesperrow <span style="color: #990000">*</span> <span style="font-weight: bold"><span style="color: #000000">SIZEOF</span></span><span style="color: #990000">(</span>JSAMPLE<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line602">0602: </a>      maximum_space <span style="color: #990000">+</span><span style="color: #990000">=</span> <span style="color: #990000">(</span><span style="color: #009900">long</span><span style="color: #990000">)</span> sptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>rows_in_array <span style="color: #990000">*</span>
<a name="line603">0603: </a>                       <span style="color: #990000">(</span><span style="color: #009900">long</span><span style="color: #990000">)</span> sptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>samplesperrow <span style="color: #990000">*</span> <span style="font-weight: bold"><span style="color: #000000">SIZEOF</span></span><span style="color: #990000">(</span>JSAMPLE<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line604">0604: </a>    <span style="color: #FF0000">}</span>
<a name="line605">0605: </a>  <span style="color: #FF0000">}</span>
<a name="line606">0606: </a>  <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> <span style="color: #990000">(</span>bptr <span style="color: #990000">=</span> mem<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>virt_barray_list<span style="color: #990000">;</span> bptr <span style="color: #990000">!</span><span style="color: #990000">=</span> NULL<span style="color: #990000">;</span> bptr <span style="color: #990000">=</span> bptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>next<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line607">0607: </a>    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>bptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>mem_buffer <span style="color: #990000">=</span><span style="color: #990000">=</span> NULL<span style="color: #990000">)</span> <span style="color: #FF0000">{</span> <span style="font-style: italic"><span style="color: #9A1900">/* if not realized yet */</span></span>
<a name="line608">0608: </a>      space_per_minheight <span style="color: #990000">+</span><span style="color: #990000">=</span> <span style="color: #990000">(</span><span style="color: #009900">long</span><span style="color: #990000">)</span> bptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>maxaccess <span style="color: #990000">*</span>
<a name="line609">0609: </a>                             <span style="color: #990000">(</span><span style="color: #009900">long</span><span style="color: #990000">)</span> bptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>blocksperrow <span style="color: #990000">*</span> <span style="font-weight: bold"><span style="color: #000000">SIZEOF</span></span><span style="color: #990000">(</span>JBLOCK<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line610">0610: </a>      maximum_space <span style="color: #990000">+</span><span style="color: #990000">=</span> <span style="color: #990000">(</span><span style="color: #009900">long</span><span style="color: #990000">)</span> bptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>rows_in_array <span style="color: #990000">*</span>
<a name="line611">0611: </a>                       <span style="color: #990000">(</span><span style="color: #009900">long</span><span style="color: #990000">)</span> bptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>blocksperrow <span style="color: #990000">*</span> <span style="font-weight: bold"><span style="color: #000000">SIZEOF</span></span><span style="color: #990000">(</span>JBLOCK<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line612">0612: </a>    <span style="color: #FF0000">}</span>
<a name="line613">0613: </a>  <span style="color: #FF0000">}</span>
<a name="line614">0614: </a>
<a name="line615">0615: </a>  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>space_per_minheight <span style="color: #990000">&lt;</span><span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">)</span>
<a name="line616">0616: </a>    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span><span style="color: #990000">;</span>                     <span style="font-style: italic"><span style="color: #9A1900">/* no unrealized arrays, no work */</span></span>
<a name="line617">0617: </a>
<a name="line618">0618: </a>  <span style="font-style: italic"><span style="color: #9A1900">/* Determine amount of memory to actually use; this is system-dependent. */</span></span>
<a name="line619">0619: </a>  avail_mem <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">jpeg_mem_available</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> space_per_minheight<span style="color: #990000">,</span> maximum_space<span style="color: #990000">,</span>
<a name="line620">0620: </a>                                 mem<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>total_space_allocated<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line621">0621: </a>
<a name="line622">0622: </a>  <span style="font-style: italic"><span style="color: #9A1900">/* If the maximum space needed is available, make all the buffers full</span></span>
<a name="line623">0623: </a><span style="font-style: italic"><span style="color: #9A1900">   * height; otherwise parcel it out with the same number of minheights</span></span>
<a name="line624">0624: </a><span style="font-style: italic"><span style="color: #9A1900">   * in each buffer.</span></span>
<a name="line625">0625: </a><span style="font-style: italic"><span style="color: #9A1900">   */</span></span>
<a name="line626">0626: </a>  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>avail_mem <span style="color: #990000">&gt;</span><span style="color: #990000">=</span> maximum_space<span style="color: #990000">)</span>
<a name="line627">0627: </a>    max_minheights <span style="color: #990000">=</span> <span style="color: #993399">1000000000</span>L<span style="color: #990000">;</span>
<a name="line628">0628: </a>  <span style="font-weight: bold"><span style="color: #0000FF">else</span></span> <span style="color: #FF0000">{</span>
<a name="line629">0629: </a>    max_minheights <span style="color: #990000">=</span> avail_mem <span style="color: #990000">/</span> space_per_minheight<span style="color: #990000">;</span>
<a name="line630">0630: </a>    <span style="font-style: italic"><span style="color: #9A1900">/* If there doesn't seem to be enough space, try to get the minimum</span></span>
<a name="line631">0631: </a><span style="font-style: italic"><span style="color: #9A1900">     * anyway.  This allows a "stub" implementation of jpeg_mem_available().</span></span>
<a name="line632">0632: </a><span style="font-style: italic"><span style="color: #9A1900">     */</span></span>
<a name="line633">0633: </a>    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>max_minheights <span style="color: #990000">&lt;</span><span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">)</span>
<a name="line634">0634: </a>      max_minheights <span style="color: #990000">=</span> <span style="color: #993399">1</span><span style="color: #990000">;</span>
<a name="line635">0635: </a>  <span style="color: #FF0000">}</span>
<a name="line636">0636: </a>
<a name="line637">0637: </a>  <span style="font-style: italic"><span style="color: #9A1900">/* Allocate the in-memory buffers and initialize backing store as needed. */</span></span>
<a name="line638">0638: </a>
<a name="line639">0639: </a>  <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> <span style="color: #990000">(</span>sptr <span style="color: #990000">=</span> mem<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>virt_sarray_list<span style="color: #990000">;</span> sptr <span style="color: #990000">!</span><span style="color: #990000">=</span> NULL<span style="color: #990000">;</span> sptr <span style="color: #990000">=</span> sptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>next<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line640">0640: </a>    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>sptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>mem_buffer <span style="color: #990000">=</span><span style="color: #990000">=</span> NULL<span style="color: #990000">)</span> <span style="color: #FF0000">{</span> <span style="font-style: italic"><span style="color: #9A1900">/* if not realized yet */</span></span>
<a name="line641">0641: </a>      minheights <span style="color: #990000">=</span> <span style="color: #990000">(</span><span style="color: #990000">(</span><span style="color: #009900">long</span><span style="color: #990000">)</span> sptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>rows_in_array <span style="color: #990000">-</span> <span style="color: #993399">1</span>L<span style="color: #990000">)</span> <span style="color: #990000">/</span> sptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>maxaccess <span style="color: #990000">+</span> <span style="color: #993399">1</span>L<span style="color: #990000">;</span>
<a name="line642">0642: </a>      <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>minheights <span style="color: #990000">&lt;</span><span style="color: #990000">=</span> max_minheights<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line643">0643: </a>        <span style="font-style: italic"><span style="color: #9A1900">/* This buffer fits in memory */</span></span>
<a name="line644">0644: </a>        sptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>rows_in_mem <span style="color: #990000">=</span> sptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>rows_in_array<span style="color: #990000">;</span>
<a name="line645">0645: </a>      <span style="color: #FF0000">}</span> <span style="font-weight: bold"><span style="color: #0000FF">else</span></span> <span style="color: #FF0000">{</span>
<a name="line646">0646: </a>        <span style="font-style: italic"><span style="color: #9A1900">/* It doesn't fit in memory, create backing store. */</span></span>
<a name="line647">0647: </a>        sptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>rows_in_mem <span style="color: #990000">=</span> <span style="color: #990000">(</span>JDIMENSION<span style="color: #990000">)</span> <span style="color: #990000">(</span>max_minheights <span style="color: #990000">*</span> sptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>maxaccess<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line648">0648: </a>        <span style="font-weight: bold"><span style="color: #000000">jpeg_open_backing_store</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> <span style="color: #990000">&amp;</span> sptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>b_s_info<span style="color: #990000">,</span>
<a name="line649">0649: </a>                                <span style="color: #990000">(</span><span style="color: #009900">long</span><span style="color: #990000">)</span> sptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>rows_in_array <span style="color: #990000">*</span>
<a name="line650">0650: </a>                                <span style="color: #990000">(</span><span style="color: #009900">long</span><span style="color: #990000">)</span> sptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>samplesperrow <span style="color: #990000">*</span>
<a name="line651">0651: </a>                                <span style="color: #990000">(</span><span style="color: #009900">long</span><span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #000000">SIZEOF</span></span><span style="color: #990000">(</span>JSAMPLE<span style="color: #990000">)</span><span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line652">0652: </a>        sptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>b_s_open <span style="color: #990000">=</span> TRUE<span style="color: #990000">;</span>
<a name="line653">0653: </a>      <span style="color: #FF0000">}</span>
<a name="line654">0654: </a>      sptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>mem_buffer <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">alloc_sarray</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> JPOOL_IMAGE<span style="color: #990000">,</span>
<a name="line655">0655: </a>                                      sptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>samplesperrow<span style="color: #990000">,</span> sptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>rows_in_mem<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line656">0656: </a>      sptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>rowsperchunk <span style="color: #990000">=</span> mem<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>last_rowsperchunk<span style="color: #990000">;</span>
<a name="line657">0657: </a>      sptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>cur_start_row <span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">;</span>
<a name="line658">0658: </a>      sptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>first_undef_row <span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">;</span>
<a name="line659">0659: </a>      sptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>dirty <span style="color: #990000">=</span> FALSE<span style="color: #990000">;</span>
<a name="line660">0660: </a>    <span style="color: #FF0000">}</span>
<a name="line661">0661: </a>  <span style="color: #FF0000">}</span>
<a name="line662">0662: </a>
<a name="line663">0663: </a>  <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> <span style="color: #990000">(</span>bptr <span style="color: #990000">=</span> mem<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>virt_barray_list<span style="color: #990000">;</span> bptr <span style="color: #990000">!</span><span style="color: #990000">=</span> NULL<span style="color: #990000">;</span> bptr <span style="color: #990000">=</span> bptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>next<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line664">0664: </a>    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>bptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>mem_buffer <span style="color: #990000">=</span><span style="color: #990000">=</span> NULL<span style="color: #990000">)</span> <span style="color: #FF0000">{</span> <span style="font-style: italic"><span style="color: #9A1900">/* if not realized yet */</span></span>
<a name="line665">0665: </a>      minheights <span style="color: #990000">=</span> <span style="color: #990000">(</span><span style="color: #990000">(</span><span style="color: #009900">long</span><span style="color: #990000">)</span> bptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>rows_in_array <span style="color: #990000">-</span> <span style="color: #993399">1</span>L<span style="color: #990000">)</span> <span style="color: #990000">/</span> bptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>maxaccess <span style="color: #990000">+</span> <span style="color: #993399">1</span>L<span style="color: #990000">;</span>
<a name="line666">0666: </a>      <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>minheights <span style="color: #990000">&lt;</span><span style="color: #990000">=</span> max_minheights<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line667">0667: </a>        <span style="font-style: italic"><span style="color: #9A1900">/* This buffer fits in memory */</span></span>
<a name="line668">0668: </a>        bptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>rows_in_mem <span style="color: #990000">=</span> bptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>rows_in_array<span style="color: #990000">;</span>
<a name="line669">0669: </a>      <span style="color: #FF0000">}</span> <span style="font-weight: bold"><span style="color: #0000FF">else</span></span> <span style="color: #FF0000">{</span>
<a name="line670">0670: </a>        <span style="font-style: italic"><span style="color: #9A1900">/* It doesn't fit in memory, create backing store. */</span></span>
<a name="line671">0671: </a>        bptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>rows_in_mem <span style="color: #990000">=</span> <span style="color: #990000">(</span>JDIMENSION<span style="color: #990000">)</span> <span style="color: #990000">(</span>max_minheights <span style="color: #990000">*</span> bptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>maxaccess<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line672">0672: </a>        <span style="font-weight: bold"><span style="color: #000000">jpeg_open_backing_store</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> <span style="color: #990000">&amp;</span> bptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>b_s_info<span style="color: #990000">,</span>
<a name="line673">0673: </a>                                <span style="color: #990000">(</span><span style="color: #009900">long</span><span style="color: #990000">)</span> bptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>rows_in_array <span style="color: #990000">*</span>
<a name="line674">0674: </a>                                <span style="color: #990000">(</span><span style="color: #009900">long</span><span style="color: #990000">)</span> bptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>blocksperrow <span style="color: #990000">*</span>
<a name="line675">0675: </a>                                <span style="color: #990000">(</span><span style="color: #009900">long</span><span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #000000">SIZEOF</span></span><span style="color: #990000">(</span>JBLOCK<span style="color: #990000">)</span><span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line676">0676: </a>        bptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>b_s_open <span style="color: #990000">=</span> TRUE<span style="color: #990000">;</span>
<a name="line677">0677: </a>      <span style="color: #FF0000">}</span>
<a name="line678">0678: </a>      bptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>mem_buffer <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">alloc_barray</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> JPOOL_IMAGE<span style="color: #990000">,</span>
<a name="line679">0679: </a>                                      bptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>blocksperrow<span style="color: #990000">,</span> bptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>rows_in_mem<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line680">0680: </a>      bptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>rowsperchunk <span style="color: #990000">=</span> mem<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>last_rowsperchunk<span style="color: #990000">;</span>
<a name="line681">0681: </a>      bptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>cur_start_row <span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">;</span>
<a name="line682">0682: </a>      bptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>first_undef_row <span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">;</span>
<a name="line683">0683: </a>      bptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>dirty <span style="color: #990000">=</span> FALSE<span style="color: #990000">;</span>
<a name="line684">0684: </a>    <span style="color: #FF0000">}</span>
<a name="line685">0685: </a>  <span style="color: #FF0000">}</span>
<a name="line686">0686: </a><span style="color: #FF0000">}</span>
<a name="line687">0687: </a>
<a name="line688">0688: </a>
<a name="line689">0689: </a><span style="font-weight: bold"><span style="color: #000000">LOCAL</span></span><span style="color: #990000">(</span><span style="color: #009900">void</span><span style="color: #990000">)</span>
<a name="line690">0690: </a><span style="font-weight: bold"><span style="color: #000000">do_sarray_io</span></span> <span style="color: #990000">(</span>j_common_ptr cinfo<span style="color: #990000">,</span> jvirt_sarray_ptr ptr<span style="color: #990000">,</span> boolean writing<span style="color: #990000">)</span>
<a name="line691">0691: </a><span style="font-style: italic"><span style="color: #9A1900">/* Do backing store read or write of a virtual sample array */</span></span>
<a name="line692">0692: </a><span style="color: #FF0000">{</span>
<a name="line693">0693: </a>  <span style="color: #009900">long</span> bytesperrow<span style="color: #990000">,</span> file_offset<span style="color: #990000">,</span> byte_count<span style="color: #990000">,</span> rows<span style="color: #990000">,</span> thisrow<span style="color: #990000">,</span> i<span style="color: #990000">;</span>
<a name="line694">0694: </a>
<a name="line695">0695: </a>  bytesperrow <span style="color: #990000">=</span> <span style="color: #990000">(</span><span style="color: #009900">long</span><span style="color: #990000">)</span> ptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>samplesperrow <span style="color: #990000">*</span> <span style="font-weight: bold"><span style="color: #000000">SIZEOF</span></span><span style="color: #990000">(</span>JSAMPLE<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line696">0696: </a>  file_offset <span style="color: #990000">=</span> ptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>cur_start_row <span style="color: #990000">*</span> bytesperrow<span style="color: #990000">;</span>
<a name="line697">0697: </a>  <span style="font-style: italic"><span style="color: #9A1900">/* Loop to read or write each allocation chunk in mem_buffer */</span></span>
<a name="line698">0698: </a>  <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> <span style="color: #990000">(</span>i <span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">;</span> i <span style="color: #990000">&lt;</span> <span style="color: #990000">(</span><span style="color: #009900">long</span><span style="color: #990000">)</span> ptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>rows_in_mem<span style="color: #990000">;</span> i <span style="color: #990000">+</span><span style="color: #990000">=</span> ptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>rowsperchunk<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line699">0699: </a>    <span style="font-style: italic"><span style="color: #9A1900">/* One chunk, but check for short chunk at end of buffer */</span></span>
<a name="line700">0700: </a>    rows <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">MIN</span></span><span style="color: #990000">(</span><span style="color: #990000">(</span><span style="color: #009900">long</span><span style="color: #990000">)</span> ptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>rowsperchunk<span style="color: #990000">,</span> <span style="color: #990000">(</span><span style="color: #009900">long</span><span style="color: #990000">)</span> ptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>rows_in_mem <span style="color: #990000">-</span> i<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line701">0701: </a>    <span style="font-style: italic"><span style="color: #9A1900">/* Transfer no more than is currently defined */</span></span>
<a name="line702">0702: </a>    thisrow <span style="color: #990000">=</span> <span style="color: #990000">(</span><span style="color: #009900">long</span><span style="color: #990000">)</span> ptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>cur_start_row <span style="color: #990000">+</span> i<span style="color: #990000">;</span>
<a name="line703">0703: </a>    rows <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">MIN</span></span><span style="color: #990000">(</span>rows<span style="color: #990000">,</span> <span style="color: #990000">(</span><span style="color: #009900">long</span><span style="color: #990000">)</span> ptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>first_undef_row <span style="color: #990000">-</span> thisrow<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line704">0704: </a>    <span style="font-style: italic"><span style="color: #9A1900">/* Transfer no more than fits in file */</span></span>
<a name="line705">0705: </a>    rows <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">MIN</span></span><span style="color: #990000">(</span>rows<span style="color: #990000">,</span> <span style="color: #990000">(</span><span style="color: #009900">long</span><span style="color: #990000">)</span> ptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>rows_in_array <span style="color: #990000">-</span> thisrow<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line706">0706: </a>    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>rows <span style="color: #990000">&lt;</span><span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">)</span>              <span style="font-style: italic"><span style="color: #9A1900">/* this chunk might be past end of file! */</span></span>
<a name="line707">0707: </a>      <span style="font-weight: bold"><span style="color: #0000FF">break</span></span><span style="color: #990000">;</span>
<a name="line708">0708: </a>    byte_count <span style="color: #990000">=</span> rows <span style="color: #990000">*</span> bytesperrow<span style="color: #990000">;</span>
<a name="line709">0709: </a>    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>writing<span style="color: #990000">)</span>
<a name="line710">0710: </a>      <span style="color: #990000">(</span><span style="color: #990000">*</span>ptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>b_s_info<span style="color: #990000">.</span>write_backing_store<span style="color: #990000">)</span> <span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> <span style="color: #990000">&amp;</span> ptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>b_s_info<span style="color: #990000">,</span>
<a name="line711">0711: </a>                                            <span style="color: #990000">(</span><span style="color: #009900">void</span> FAR <span style="color: #990000">*</span><span style="color: #990000">)</span> ptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>mem_buffer<span style="color: #990000">[</span>i<span style="color: #990000">]</span><span style="color: #990000">,</span>
<a name="line712">0712: </a>                                            file_offset<span style="color: #990000">,</span> byte_count<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line713">0713: </a>    <span style="font-weight: bold"><span style="color: #0000FF">else</span></span>
<a name="line714">0714: </a>      <span style="color: #990000">(</span><span style="color: #990000">*</span>ptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>b_s_info<span style="color: #990000">.</span>read_backing_store<span style="color: #990000">)</span> <span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> <span style="color: #990000">&amp;</span> ptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>b_s_info<span style="color: #990000">,</span>
<a name="line715">0715: </a>                                           <span style="color: #990000">(</span><span style="color: #009900">void</span> FAR <span style="color: #990000">*</span><span style="color: #990000">)</span> ptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>mem_buffer<span style="color: #990000">[</span>i<span style="color: #990000">]</span><span style="color: #990000">,</span>
<a name="line716">0716: </a>                                           file_offset<span style="color: #990000">,</span> byte_count<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line717">0717: </a>    file_offset <span style="color: #990000">+</span><span style="color: #990000">=</span> byte_count<span style="color: #990000">;</span>
<a name="line718">0718: </a>  <span style="color: #FF0000">}</span>
<a name="line719">0719: </a><span style="color: #FF0000">}</span>
<a name="line720">0720: </a>
<a name="line721">0721: </a>
<a name="line722">0722: </a><span style="font-weight: bold"><span style="color: #000000">LOCAL</span></span><span style="color: #990000">(</span><span style="color: #009900">void</span><span style="color: #990000">)</span>
<a name="line723">0723: </a><span style="font-weight: bold"><span style="color: #000000">do_barray_io</span></span> <span style="color: #990000">(</span>j_common_ptr cinfo<span style="color: #990000">,</span> jvirt_barray_ptr ptr<span style="color: #990000">,</span> boolean writing<span style="color: #990000">)</span>
<a name="line724">0724: </a><span style="font-style: italic"><span style="color: #9A1900">/* Do backing store read or write of a virtual coefficient-block array */</span></span>
<a name="line725">0725: </a><span style="color: #FF0000">{</span>
<a name="line726">0726: </a>  <span style="color: #009900">long</span> bytesperrow<span style="color: #990000">,</span> file_offset<span style="color: #990000">,</span> byte_count<span style="color: #990000">,</span> rows<span style="color: #990000">,</span> thisrow<span style="color: #990000">,</span> i<span style="color: #990000">;</span>
<a name="line727">0727: </a>
<a name="line728">0728: </a>  bytesperrow <span style="color: #990000">=</span> <span style="color: #990000">(</span><span style="color: #009900">long</span><span style="color: #990000">)</span> ptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>blocksperrow <span style="color: #990000">*</span> <span style="font-weight: bold"><span style="color: #000000">SIZEOF</span></span><span style="color: #990000">(</span>JBLOCK<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line729">0729: </a>  file_offset <span style="color: #990000">=</span> ptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>cur_start_row <span style="color: #990000">*</span> bytesperrow<span style="color: #990000">;</span>
<a name="line730">0730: </a>  <span style="font-style: italic"><span style="color: #9A1900">/* Loop to read or write each allocation chunk in mem_buffer */</span></span>
<a name="line731">0731: </a>  <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> <span style="color: #990000">(</span>i <span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">;</span> i <span style="color: #990000">&lt;</span> <span style="color: #990000">(</span><span style="color: #009900">long</span><span style="color: #990000">)</span> ptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>rows_in_mem<span style="color: #990000">;</span> i <span style="color: #990000">+</span><span style="color: #990000">=</span> ptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>rowsperchunk<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line732">0732: </a>    <span style="font-style: italic"><span style="color: #9A1900">/* One chunk, but check for short chunk at end of buffer */</span></span>
<a name="line733">0733: </a>    rows <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">MIN</span></span><span style="color: #990000">(</span><span style="color: #990000">(</span><span style="color: #009900">long</span><span style="color: #990000">)</span> ptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>rowsperchunk<span style="color: #990000">,</span> <span style="color: #990000">(</span><span style="color: #009900">long</span><span style="color: #990000">)</span> ptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>rows_in_mem <span style="color: #990000">-</span> i<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line734">0734: </a>    <span style="font-style: italic"><span style="color: #9A1900">/* Transfer no more than is currently defined */</span></span>
<a name="line735">0735: </a>    thisrow <span style="color: #990000">=</span> <span style="color: #990000">(</span><span style="color: #009900">long</span><span style="color: #990000">)</span> ptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>cur_start_row <span style="color: #990000">+</span> i<span style="color: #990000">;</span>
<a name="line736">0736: </a>    rows <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">MIN</span></span><span style="color: #990000">(</span>rows<span style="color: #990000">,</span> <span style="color: #990000">(</span><span style="color: #009900">long</span><span style="color: #990000">)</span> ptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>first_undef_row <span style="color: #990000">-</span> thisrow<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line737">0737: </a>    <span style="font-style: italic"><span style="color: #9A1900">/* Transfer no more than fits in file */</span></span>
<a name="line738">0738: </a>    rows <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">MIN</span></span><span style="color: #990000">(</span>rows<span style="color: #990000">,</span> <span style="color: #990000">(</span><span style="color: #009900">long</span><span style="color: #990000">)</span> ptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>rows_in_array <span style="color: #990000">-</span> thisrow<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line739">0739: </a>    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>rows <span style="color: #990000">&lt;</span><span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">)</span>              <span style="font-style: italic"><span style="color: #9A1900">/* this chunk might be past end of file! */</span></span>
<a name="line740">0740: </a>      <span style="font-weight: bold"><span style="color: #0000FF">break</span></span><span style="color: #990000">;</span>
<a name="line741">0741: </a>    byte_count <span style="color: #990000">=</span> rows <span style="color: #990000">*</span> bytesperrow<span style="color: #990000">;</span>
<a name="line742">0742: </a>    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>writing<span style="color: #990000">)</span>
<a name="line743">0743: </a>      <span style="color: #990000">(</span><span style="color: #990000">*</span>ptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>b_s_info<span style="color: #990000">.</span>write_backing_store<span style="color: #990000">)</span> <span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> <span style="color: #990000">&amp;</span> ptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>b_s_info<span style="color: #990000">,</span>
<a name="line744">0744: </a>                                            <span style="color: #990000">(</span><span style="color: #009900">void</span> FAR <span style="color: #990000">*</span><span style="color: #990000">)</span> ptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>mem_buffer<span style="color: #990000">[</span>i<span style="color: #990000">]</span><span style="color: #990000">,</span>
<a name="line745">0745: </a>                                            file_offset<span style="color: #990000">,</span> byte_count<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line746">0746: </a>    <span style="font-weight: bold"><span style="color: #0000FF">else</span></span>
<a name="line747">0747: </a>      <span style="color: #990000">(</span><span style="color: #990000">*</span>ptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>b_s_info<span style="color: #990000">.</span>read_backing_store<span style="color: #990000">)</span> <span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> <span style="color: #990000">&amp;</span> ptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>b_s_info<span style="color: #990000">,</span>
<a name="line748">0748: </a>                                           <span style="color: #990000">(</span><span style="color: #009900">void</span> FAR <span style="color: #990000">*</span><span style="color: #990000">)</span> ptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>mem_buffer<span style="color: #990000">[</span>i<span style="color: #990000">]</span><span style="color: #990000">,</span>
<a name="line749">0749: </a>                                           file_offset<span style="color: #990000">,</span> byte_count<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line750">0750: </a>    file_offset <span style="color: #990000">+</span><span style="color: #990000">=</span> byte_count<span style="color: #990000">;</span>
<a name="line751">0751: </a>  <span style="color: #FF0000">}</span>
<a name="line752">0752: </a><span style="color: #FF0000">}</span>
<a name="line753">0753: </a>
<a name="line754">0754: </a>
<a name="line755">0755: </a><span style="font-weight: bold"><span style="color: #000000">METHODDEF</span></span><span style="color: #990000">(</span>JSAMPARRAY<span style="color: #990000">)</span>
<a name="line756">0756: </a><span style="font-weight: bold"><span style="color: #000000">access_virt_sarray</span></span> <span style="color: #990000">(</span>j_common_ptr cinfo<span style="color: #990000">,</span> jvirt_sarray_ptr ptr<span style="color: #990000">,</span>
<a name="line757">0757: </a>                    JDIMENSION start_row<span style="color: #990000">,</span> JDIMENSION num_rows<span style="color: #990000">,</span>
<a name="line758">0758: </a>                    boolean writable<span style="color: #990000">)</span>
<a name="line759">0759: </a><span style="font-style: italic"><span style="color: #9A1900">/* Access the part of a virtual sample array starting at start_row */</span></span>
<a name="line760">0760: </a><span style="font-style: italic"><span style="color: #9A1900">/* and extending for num_rows rows.  writable is true if  */</span></span>
<a name="line761">0761: </a><span style="font-style: italic"><span style="color: #9A1900">/* caller intends to modify the accessed area. */</span></span>
<a name="line762">0762: </a><span style="color: #FF0000">{</span>
<a name="line763">0763: </a>  JDIMENSION end_row <span style="color: #990000">=</span> start_row <span style="color: #990000">+</span> num_rows<span style="color: #990000">;</span>
<a name="line764">0764: </a>  JDIMENSION undef_row<span style="color: #990000">;</span>
<a name="line765">0765: </a>
<a name="line766">0766: </a>  <span style="font-style: italic"><span style="color: #9A1900">/* debugging check */</span></span>
<a name="line767">0767: </a>  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>end_row <span style="color: #990000">&gt;</span> ptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>rows_in_array <span style="color: #990000">|</span><span style="color: #990000">|</span> num_rows <span style="color: #990000">&gt;</span> ptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>maxaccess <span style="color: #990000">|</span><span style="color: #990000">|</span>
<a name="line768">0768: </a>      ptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>mem_buffer <span style="color: #990000">=</span><span style="color: #990000">=</span> NULL<span style="color: #990000">)</span>
<a name="line769">0769: </a>    <span style="font-weight: bold"><span style="color: #000000">ERREXIT</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> JERR_BAD_VIRTUAL_ACCESS<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line770">0770: </a>
<a name="line771">0771: </a>  <span style="font-style: italic"><span style="color: #9A1900">/* Make the desired part of the virtual array accessible */</span></span>
<a name="line772">0772: </a>  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>start_row <span style="color: #990000">&lt;</span> ptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>cur_start_row <span style="color: #990000">|</span><span style="color: #990000">|</span>
<a name="line773">0773: </a>      end_row <span style="color: #990000">&gt;</span> ptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>cur_start_row<span style="color: #990000">+</span>ptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>rows_in_mem<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line774">0774: </a>    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span><span style="color: #990000">!</span> ptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>b_s_open<span style="color: #990000">)</span>
<a name="line775">0775: </a>      <span style="font-weight: bold"><span style="color: #000000">ERREXIT</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> JERR_VIRTUAL_BUG<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line776">0776: </a>    <span style="font-style: italic"><span style="color: #9A1900">/* Flush old buffer contents if necessary */</span></span>
<a name="line777">0777: </a>    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>ptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>dirty<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line778">0778: </a>      <span style="font-weight: bold"><span style="color: #000000">do_sarray_io</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> ptr<span style="color: #990000">,</span> TRUE<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line779">0779: </a>      ptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>dirty <span style="color: #990000">=</span> FALSE<span style="color: #990000">;</span>
<a name="line780">0780: </a>    <span style="color: #FF0000">}</span>
<a name="line781">0781: </a>    <span style="font-style: italic"><span style="color: #9A1900">/* Decide what part of virtual array to access.</span></span>
<a name="line782">0782: </a><span style="font-style: italic"><span style="color: #9A1900">     * Algorithm: if target address &gt; current window, assume forward scan,</span></span>
<a name="line783">0783: </a><span style="font-style: italic"><span style="color: #9A1900">     * load starting at target address.  If target address &lt; current window,</span></span>
<a name="line784">0784: </a><span style="font-style: italic"><span style="color: #9A1900">     * assume backward scan, load so that target area is top of window.</span></span>
<a name="line785">0785: </a><span style="font-style: italic"><span style="color: #9A1900">     * Note that when switching from forward write to forward read, will have</span></span>
<a name="line786">0786: </a><span style="font-style: italic"><span style="color: #9A1900">     * start_row = 0, so the limiting case applies and we load from 0 anyway.</span></span>
<a name="line787">0787: </a><span style="font-style: italic"><span style="color: #9A1900">     */</span></span>
<a name="line788">0788: </a>    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>start_row <span style="color: #990000">&gt;</span> ptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>cur_start_row<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line789">0789: </a>      ptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>cur_start_row <span style="color: #990000">=</span> start_row<span style="color: #990000">;</span>
<a name="line790">0790: </a>    <span style="color: #FF0000">}</span> <span style="font-weight: bold"><span style="color: #0000FF">else</span></span> <span style="color: #FF0000">{</span>
<a name="line791">0791: </a>      <span style="font-style: italic"><span style="color: #9A1900">/* use long arithmetic here to avoid overflow &amp; unsigned problems */</span></span>
<a name="line792">0792: </a>      <span style="color: #009900">long</span> ltemp<span style="color: #990000">;</span>
<a name="line793">0793: </a>
<a name="line794">0794: </a>      ltemp <span style="color: #990000">=</span> <span style="color: #990000">(</span><span style="color: #009900">long</span><span style="color: #990000">)</span> end_row <span style="color: #990000">-</span> <span style="color: #990000">(</span><span style="color: #009900">long</span><span style="color: #990000">)</span> ptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>rows_in_mem<span style="color: #990000">;</span>
<a name="line795">0795: </a>      <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>ltemp <span style="color: #990000">&lt;</span> <span style="color: #993399">0</span><span style="color: #990000">)</span>
<a name="line796">0796: </a>        ltemp <span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">;</span>              <span style="font-style: italic"><span style="color: #9A1900">/* don't fall off front end of file */</span></span>
<a name="line797">0797: </a>      ptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>cur_start_row <span style="color: #990000">=</span> <span style="color: #990000">(</span>JDIMENSION<span style="color: #990000">)</span> ltemp<span style="color: #990000">;</span>
<a name="line798">0798: </a>    <span style="color: #FF0000">}</span>
<a name="line799">0799: </a>    <span style="font-style: italic"><span style="color: #9A1900">/* Read in the selected part of the array.</span></span>
<a name="line800">0800: </a><span style="font-style: italic"><span style="color: #9A1900">     * During the initial write pass, we will do no actual read</span></span>
<a name="line801">0801: </a><span style="font-style: italic"><span style="color: #9A1900">     * because the selected part is all undefined.</span></span>
<a name="line802">0802: </a><span style="font-style: italic"><span style="color: #9A1900">     */</span></span>
<a name="line803">0803: </a>    <span style="font-weight: bold"><span style="color: #000000">do_sarray_io</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> ptr<span style="color: #990000">,</span> FALSE<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line804">0804: </a>  <span style="color: #FF0000">}</span>
<a name="line805">0805: </a>  <span style="font-style: italic"><span style="color: #9A1900">/* Ensure the accessed part of the array is defined; prezero if needed.</span></span>
<a name="line806">0806: </a><span style="font-style: italic"><span style="color: #9A1900">   * To improve locality of access, we only prezero the part of the array</span></span>
<a name="line807">0807: </a><span style="font-style: italic"><span style="color: #9A1900">   * that the caller is about to access, not the entire in-memory array.</span></span>
<a name="line808">0808: </a><span style="font-style: italic"><span style="color: #9A1900">   */</span></span>
<a name="line809">0809: </a>  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>ptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>first_undef_row <span style="color: #990000">&lt;</span> end_row<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line810">0810: </a>    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>ptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>first_undef_row <span style="color: #990000">&lt;</span> start_row<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line811">0811: </a>      <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>writable<span style="color: #990000">)</span>             <span style="font-style: italic"><span style="color: #9A1900">/* writer skipped over a section of array */</span></span>
<a name="line812">0812: </a>        <span style="font-weight: bold"><span style="color: #000000">ERREXIT</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> JERR_BAD_VIRTUAL_ACCESS<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line813">0813: </a>      undef_row <span style="color: #990000">=</span> start_row<span style="color: #990000">;</span>    <span style="font-style: italic"><span style="color: #9A1900">/* but reader is allowed to read ahead */</span></span>
<a name="line814">0814: </a>    <span style="color: #FF0000">}</span> <span style="font-weight: bold"><span style="color: #0000FF">else</span></span> <span style="color: #FF0000">{</span>
<a name="line815">0815: </a>      undef_row <span style="color: #990000">=</span> ptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>first_undef_row<span style="color: #990000">;</span>
<a name="line816">0816: </a>    <span style="color: #FF0000">}</span>
<a name="line817">0817: </a>    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>writable<span style="color: #990000">)</span>
<a name="line818">0818: </a>      ptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>first_undef_row <span style="color: #990000">=</span> end_row<span style="color: #990000">;</span>
<a name="line819">0819: </a>    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>ptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>pre_zero<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line820">0820: </a>      size_t bytesperrow <span style="color: #990000">=</span> <span style="color: #990000">(</span>size_t<span style="color: #990000">)</span> ptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>samplesperrow <span style="color: #990000">*</span> <span style="font-weight: bold"><span style="color: #000000">SIZEOF</span></span><span style="color: #990000">(</span>JSAMPLE<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line821">0821: </a>      undef_row <span style="color: #990000">-</span><span style="color: #990000">=</span> ptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>cur_start_row<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">/* make indexes relative to buffer */</span></span>
<a name="line822">0822: </a>      end_row <span style="color: #990000">-</span><span style="color: #990000">=</span> ptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>cur_start_row<span style="color: #990000">;</span>
<a name="line823">0823: </a>      <span style="font-weight: bold"><span style="color: #0000FF">while</span></span> <span style="color: #990000">(</span>undef_row <span style="color: #990000">&lt;</span> end_row<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line824">0824: </a>        <span style="font-weight: bold"><span style="color: #000000">jzero_far</span></span><span style="color: #990000">(</span><span style="color: #990000">(</span><span style="color: #009900">void</span> FAR <span style="color: #990000">*</span><span style="color: #990000">)</span> ptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>mem_buffer<span style="color: #990000">[</span>undef_row<span style="color: #990000">]</span><span style="color: #990000">,</span> bytesperrow<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line825">0825: </a>        undef_row<span style="color: #990000">+</span><span style="color: #990000">+</span><span style="color: #990000">;</span>
<a name="line826">0826: </a>      <span style="color: #FF0000">}</span>
<a name="line827">0827: </a>    <span style="color: #FF0000">}</span> <span style="font-weight: bold"><span style="color: #0000FF">else</span></span> <span style="color: #FF0000">{</span>
<a name="line828">0828: </a>      <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span><span style="color: #990000">!</span> writable<span style="color: #990000">)</span>           <span style="font-style: italic"><span style="color: #9A1900">/* reader looking at undefined data */</span></span>
<a name="line829">0829: </a>        <span style="font-weight: bold"><span style="color: #000000">ERREXIT</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> JERR_BAD_VIRTUAL_ACCESS<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line830">0830: </a>    <span style="color: #FF0000">}</span>
<a name="line831">0831: </a>  <span style="color: #FF0000">}</span>
<a name="line832">0832: </a>  <span style="font-style: italic"><span style="color: #9A1900">/* Flag the buffer dirty if caller will write in it */</span></span>
<a name="line833">0833: </a>  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>writable<span style="color: #990000">)</span>
<a name="line834">0834: </a>    ptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>dirty <span style="color: #990000">=</span> TRUE<span style="color: #990000">;</span>
<a name="line835">0835: </a>  <span style="font-style: italic"><span style="color: #9A1900">/* Return address of proper part of the buffer */</span></span>
<a name="line836">0836: </a>  <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> ptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>mem_buffer <span style="color: #990000">+</span> <span style="color: #990000">(</span>start_row <span style="color: #990000">-</span> ptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>cur_start_row<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line837">0837: </a><span style="color: #FF0000">}</span>
<a name="line838">0838: </a>
<a name="line839">0839: </a>
<a name="line840">0840: </a><span style="font-weight: bold"><span style="color: #000000">METHODDEF</span></span><span style="color: #990000">(</span>JBLOCKARRAY<span style="color: #990000">)</span>
<a name="line841">0841: </a><span style="font-weight: bold"><span style="color: #000000">access_virt_barray</span></span> <span style="color: #990000">(</span>j_common_ptr cinfo<span style="color: #990000">,</span> jvirt_barray_ptr ptr<span style="color: #990000">,</span>
<a name="line842">0842: </a>                    JDIMENSION start_row<span style="color: #990000">,</span> JDIMENSION num_rows<span style="color: #990000">,</span>
<a name="line843">0843: </a>                    boolean writable<span style="color: #990000">)</span>
<a name="line844">0844: </a><span style="font-style: italic"><span style="color: #9A1900">/* Access the part of a virtual block array starting at start_row */</span></span>
<a name="line845">0845: </a><span style="font-style: italic"><span style="color: #9A1900">/* and extending for num_rows rows.  writable is true if  */</span></span>
<a name="line846">0846: </a><span style="font-style: italic"><span style="color: #9A1900">/* caller intends to modify the accessed area. */</span></span>
<a name="line847">0847: </a><span style="color: #FF0000">{</span>
<a name="line848">0848: </a>  JDIMENSION end_row <span style="color: #990000">=</span> start_row <span style="color: #990000">+</span> num_rows<span style="color: #990000">;</span>
<a name="line849">0849: </a>  JDIMENSION undef_row<span style="color: #990000">;</span>
<a name="line850">0850: </a>
<a name="line851">0851: </a>  <span style="font-style: italic"><span style="color: #9A1900">/* debugging check */</span></span>
<a name="line852">0852: </a>  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>end_row <span style="color: #990000">&gt;</span> ptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>rows_in_array <span style="color: #990000">|</span><span style="color: #990000">|</span> num_rows <span style="color: #990000">&gt;</span> ptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>maxaccess <span style="color: #990000">|</span><span style="color: #990000">|</span>
<a name="line853">0853: </a>      ptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>mem_buffer <span style="color: #990000">=</span><span style="color: #990000">=</span> NULL<span style="color: #990000">)</span>
<a name="line854">0854: </a>    <span style="font-weight: bold"><span style="color: #000000">ERREXIT</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> JERR_BAD_VIRTUAL_ACCESS<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line855">0855: </a>
<a name="line856">0856: </a>  <span style="font-style: italic"><span style="color: #9A1900">/* Make the desired part of the virtual array accessible */</span></span>
<a name="line857">0857: </a>  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>start_row <span style="color: #990000">&lt;</span> ptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>cur_start_row <span style="color: #990000">|</span><span style="color: #990000">|</span>
<a name="line858">0858: </a>      end_row <span style="color: #990000">&gt;</span> ptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>cur_start_row<span style="color: #990000">+</span>ptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>rows_in_mem<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line859">0859: </a>    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span><span style="color: #990000">!</span> ptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>b_s_open<span style="color: #990000">)</span>
<a name="line860">0860: </a>      <span style="font-weight: bold"><span style="color: #000000">ERREXIT</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> JERR_VIRTUAL_BUG<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line861">0861: </a>    <span style="font-style: italic"><span style="color: #9A1900">/* Flush old buffer contents if necessary */</span></span>
<a name="line862">0862: </a>    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>ptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>dirty<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line863">0863: </a>      <span style="font-weight: bold"><span style="color: #000000">do_barray_io</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> ptr<span style="color: #990000">,</span> TRUE<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line864">0864: </a>      ptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>dirty <span style="color: #990000">=</span> FALSE<span style="color: #990000">;</span>
<a name="line865">0865: </a>    <span style="color: #FF0000">}</span>
<a name="line866">0866: </a>    <span style="font-style: italic"><span style="color: #9A1900">/* Decide what part of virtual array to access.</span></span>
<a name="line867">0867: </a><span style="font-style: italic"><span style="color: #9A1900">     * Algorithm: if target address &gt; current window, assume forward scan,</span></span>
<a name="line868">0868: </a><span style="font-style: italic"><span style="color: #9A1900">     * load starting at target address.  If target address &lt; current window,</span></span>
<a name="line869">0869: </a><span style="font-style: italic"><span style="color: #9A1900">     * assume backward scan, load so that target area is top of window.</span></span>
<a name="line870">0870: </a><span style="font-style: italic"><span style="color: #9A1900">     * Note that when switching from forward write to forward read, will have</span></span>
<a name="line871">0871: </a><span style="font-style: italic"><span style="color: #9A1900">     * start_row = 0, so the limiting case applies and we load from 0 anyway.</span></span>
<a name="line872">0872: </a><span style="font-style: italic"><span style="color: #9A1900">     */</span></span>
<a name="line873">0873: </a>    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>start_row <span style="color: #990000">&gt;</span> ptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>cur_start_row<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line874">0874: </a>      ptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>cur_start_row <span style="color: #990000">=</span> start_row<span style="color: #990000">;</span>
<a name="line875">0875: </a>    <span style="color: #FF0000">}</span> <span style="font-weight: bold"><span style="color: #0000FF">else</span></span> <span style="color: #FF0000">{</span>
<a name="line876">0876: </a>      <span style="font-style: italic"><span style="color: #9A1900">/* use long arithmetic here to avoid overflow &amp; unsigned problems */</span></span>
<a name="line877">0877: </a>      <span style="color: #009900">long</span> ltemp<span style="color: #990000">;</span>
<a name="line878">0878: </a>
<a name="line879">0879: </a>      ltemp <span style="color: #990000">=</span> <span style="color: #990000">(</span><span style="color: #009900">long</span><span style="color: #990000">)</span> end_row <span style="color: #990000">-</span> <span style="color: #990000">(</span><span style="color: #009900">long</span><span style="color: #990000">)</span> ptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>rows_in_mem<span style="color: #990000">;</span>
<a name="line880">0880: </a>      <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>ltemp <span style="color: #990000">&lt;</span> <span style="color: #993399">0</span><span style="color: #990000">)</span>
<a name="line881">0881: </a>        ltemp <span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">;</span>              <span style="font-style: italic"><span style="color: #9A1900">/* don't fall off front end of file */</span></span>
<a name="line882">0882: </a>      ptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>cur_start_row <span style="color: #990000">=</span> <span style="color: #990000">(</span>JDIMENSION<span style="color: #990000">)</span> ltemp<span style="color: #990000">;</span>
<a name="line883">0883: </a>    <span style="color: #FF0000">}</span>
<a name="line884">0884: </a>    <span style="font-style: italic"><span style="color: #9A1900">/* Read in the selected part of the array.</span></span>
<a name="line885">0885: </a><span style="font-style: italic"><span style="color: #9A1900">     * During the initial write pass, we will do no actual read</span></span>
<a name="line886">0886: </a><span style="font-style: italic"><span style="color: #9A1900">     * because the selected part is all undefined.</span></span>
<a name="line887">0887: </a><span style="font-style: italic"><span style="color: #9A1900">     */</span></span>
<a name="line888">0888: </a>    <span style="font-weight: bold"><span style="color: #000000">do_barray_io</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> ptr<span style="color: #990000">,</span> FALSE<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line889">0889: </a>  <span style="color: #FF0000">}</span>
<a name="line890">0890: </a>  <span style="font-style: italic"><span style="color: #9A1900">/* Ensure the accessed part of the array is defined; prezero if needed.</span></span>
<a name="line891">0891: </a><span style="font-style: italic"><span style="color: #9A1900">   * To improve locality of access, we only prezero the part of the array</span></span>
<a name="line892">0892: </a><span style="font-style: italic"><span style="color: #9A1900">   * that the caller is about to access, not the entire in-memory array.</span></span>
<a name="line893">0893: </a><span style="font-style: italic"><span style="color: #9A1900">   */</span></span>
<a name="line894">0894: </a>  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>ptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>first_undef_row <span style="color: #990000">&lt;</span> end_row<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line895">0895: </a>    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>ptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>first_undef_row <span style="color: #990000">&lt;</span> start_row<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line896">0896: </a>      <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>writable<span style="color: #990000">)</span>             <span style="font-style: italic"><span style="color: #9A1900">/* writer skipped over a section of array */</span></span>
<a name="line897">0897: </a>        <span style="font-weight: bold"><span style="color: #000000">ERREXIT</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> JERR_BAD_VIRTUAL_ACCESS<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line898">0898: </a>      undef_row <span style="color: #990000">=</span> start_row<span style="color: #990000">;</span>    <span style="font-style: italic"><span style="color: #9A1900">/* but reader is allowed to read ahead */</span></span>
<a name="line899">0899: </a>    <span style="color: #FF0000">}</span> <span style="font-weight: bold"><span style="color: #0000FF">else</span></span> <span style="color: #FF0000">{</span>
<a name="line900">0900: </a>      undef_row <span style="color: #990000">=</span> ptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>first_undef_row<span style="color: #990000">;</span>
<a name="line901">0901: </a>    <span style="color: #FF0000">}</span>
<a name="line902">0902: </a>    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>writable<span style="color: #990000">)</span>
<a name="line903">0903: </a>      ptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>first_undef_row <span style="color: #990000">=</span> end_row<span style="color: #990000">;</span>
<a name="line904">0904: </a>    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>ptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>pre_zero<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line905">0905: </a>      size_t bytesperrow <span style="color: #990000">=</span> <span style="color: #990000">(</span>size_t<span style="color: #990000">)</span> ptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>blocksperrow <span style="color: #990000">*</span> <span style="font-weight: bold"><span style="color: #000000">SIZEOF</span></span><span style="color: #990000">(</span>JBLOCK<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line906">0906: </a>      undef_row <span style="color: #990000">-</span><span style="color: #990000">=</span> ptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>cur_start_row<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">/* make indexes relative to buffer */</span></span>
<a name="line907">0907: </a>      end_row <span style="color: #990000">-</span><span style="color: #990000">=</span> ptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>cur_start_row<span style="color: #990000">;</span>
<a name="line908">0908: </a>      <span style="font-weight: bold"><span style="color: #0000FF">while</span></span> <span style="color: #990000">(</span>undef_row <span style="color: #990000">&lt;</span> end_row<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line909">0909: </a>        <span style="font-weight: bold"><span style="color: #000000">jzero_far</span></span><span style="color: #990000">(</span><span style="color: #990000">(</span><span style="color: #009900">void</span> FAR <span style="color: #990000">*</span><span style="color: #990000">)</span> ptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>mem_buffer<span style="color: #990000">[</span>undef_row<span style="color: #990000">]</span><span style="color: #990000">,</span> bytesperrow<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line910">0910: </a>        undef_row<span style="color: #990000">+</span><span style="color: #990000">+</span><span style="color: #990000">;</span>
<a name="line911">0911: </a>      <span style="color: #FF0000">}</span>
<a name="line912">0912: </a>    <span style="color: #FF0000">}</span> <span style="font-weight: bold"><span style="color: #0000FF">else</span></span> <span style="color: #FF0000">{</span>
<a name="line913">0913: </a>      <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span><span style="color: #990000">!</span> writable<span style="color: #990000">)</span>           <span style="font-style: italic"><span style="color: #9A1900">/* reader looking at undefined data */</span></span>
<a name="line914">0914: </a>        <span style="font-weight: bold"><span style="color: #000000">ERREXIT</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> JERR_BAD_VIRTUAL_ACCESS<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line915">0915: </a>    <span style="color: #FF0000">}</span>
<a name="line916">0916: </a>  <span style="color: #FF0000">}</span>
<a name="line917">0917: </a>  <span style="font-style: italic"><span style="color: #9A1900">/* Flag the buffer dirty if caller will write in it */</span></span>
<a name="line918">0918: </a>  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>writable<span style="color: #990000">)</span>
<a name="line919">0919: </a>    ptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>dirty <span style="color: #990000">=</span> TRUE<span style="color: #990000">;</span>
<a name="line920">0920: </a>  <span style="font-style: italic"><span style="color: #9A1900">/* Return address of proper part of the buffer */</span></span>
<a name="line921">0921: </a>  <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> ptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>mem_buffer <span style="color: #990000">+</span> <span style="color: #990000">(</span>start_row <span style="color: #990000">-</span> ptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>cur_start_row<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line922">0922: </a><span style="color: #FF0000">}</span>
<a name="line923">0923: </a>
<a name="line924">0924: </a>
<a name="line925">0925: </a><span style="font-style: italic"><span style="color: #9A1900">/*</span></span>
<a name="line926">0926: </a><span style="font-style: italic"><span style="color: #9A1900"> * Release all objects belonging to a specified pool.</span></span>
<a name="line927">0927: </a><span style="font-style: italic"><span style="color: #9A1900"> */</span></span>
<a name="line928">0928: </a>
<a name="line929">0929: </a><span style="font-weight: bold"><span style="color: #000000">METHODDEF</span></span><span style="color: #990000">(</span><span style="color: #009900">void</span><span style="color: #990000">)</span>
<a name="line930">0930: </a><span style="font-weight: bold"><span style="color: #000000">free_pool</span></span> <span style="color: #990000">(</span>j_common_ptr cinfo<span style="color: #990000">,</span> <span style="color: #009900">int</span> pool_id<span style="color: #990000">)</span>
<a name="line931">0931: </a><span style="color: #FF0000">{</span>
<a name="line932">0932: </a>  my_mem_ptr mem <span style="color: #990000">=</span> <span style="color: #990000">(</span>my_mem_ptr<span style="color: #990000">)</span> cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>mem<span style="color: #990000">;</span>
<a name="line933">0933: </a>  small_pool_ptr shdr_ptr<span style="color: #990000">;</span>
<a name="line934">0934: </a>  large_pool_ptr lhdr_ptr<span style="color: #990000">;</span>
<a name="line935">0935: </a>  size_t space_freed<span style="color: #990000">;</span>
<a name="line936">0936: </a>
<a name="line937">0937: </a>  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>pool_id <span style="color: #990000">&lt;</span> <span style="color: #993399">0</span> <span style="color: #990000">|</span><span style="color: #990000">|</span> pool_id <span style="color: #990000">&gt;</span><span style="color: #990000">=</span> JPOOL_NUMPOOLS<span style="color: #990000">)</span>
<a name="line938">0938: </a>    <span style="font-weight: bold"><span style="color: #000000">ERREXIT1</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> JERR_BAD_POOL_ID<span style="color: #990000">,</span> pool_id<span style="color: #990000">)</span><span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">/* safety check */</span></span>
<a name="line939">0939: </a>
<a name="line940">0940: </a><span style="font-weight: bold"><span style="color: #000080">#ifdef</span></span> MEM_STATS
<a name="line941">0941: </a>  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>err<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>trace_level <span style="color: #990000">&gt;</span> <span style="color: #993399">1</span><span style="color: #990000">)</span>
<a name="line942">0942: </a>    <span style="font-weight: bold"><span style="color: #000000">print_mem_stats</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> pool_id<span style="color: #990000">)</span><span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">/* print pool's memory usage statistics */</span></span>
<a name="line943">0943: </a><span style="font-weight: bold"><span style="color: #000080">#endif</span></span>
<a name="line944">0944: </a>
<a name="line945">0945: </a>  <span style="font-style: italic"><span style="color: #9A1900">/* If freeing IMAGE pool, close any virtual arrays first */</span></span>
<a name="line946">0946: </a>  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>pool_id <span style="color: #990000">=</span><span style="color: #990000">=</span> JPOOL_IMAGE<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line947">0947: </a>    jvirt_sarray_ptr sptr<span style="color: #990000">;</span>
<a name="line948">0948: </a>    jvirt_barray_ptr bptr<span style="color: #990000">;</span>
<a name="line949">0949: </a>
<a name="line950">0950: </a>    <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> <span style="color: #990000">(</span>sptr <span style="color: #990000">=</span> mem<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>virt_sarray_list<span style="color: #990000">;</span> sptr <span style="color: #990000">!</span><span style="color: #990000">=</span> NULL<span style="color: #990000">;</span> sptr <span style="color: #990000">=</span> sptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>next<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line951">0951: </a>      <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>sptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>b_s_open<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>     <span style="font-style: italic"><span style="color: #9A1900">/* there may be no backing store */</span></span>
<a name="line952">0952: </a>        sptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>b_s_open <span style="color: #990000">=</span> FALSE<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">/* prevent recursive close if error */</span></span>
<a name="line953">0953: </a>        <span style="color: #990000">(</span><span style="color: #990000">*</span>sptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>b_s_info<span style="color: #990000">.</span>close_backing_store<span style="color: #990000">)</span> <span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> <span style="color: #990000">&amp;</span> sptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>b_s_info<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line954">0954: </a>      <span style="color: #FF0000">}</span>
<a name="line955">0955: </a>    <span style="color: #FF0000">}</span>
<a name="line956">0956: </a>    mem<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>virt_sarray_list <span style="color: #990000">=</span> NULL<span style="color: #990000">;</span>
<a name="line957">0957: </a>    <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> <span style="color: #990000">(</span>bptr <span style="color: #990000">=</span> mem<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>virt_barray_list<span style="color: #990000">;</span> bptr <span style="color: #990000">!</span><span style="color: #990000">=</span> NULL<span style="color: #990000">;</span> bptr <span style="color: #990000">=</span> bptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>next<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line958">0958: </a>      <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>bptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>b_s_open<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>     <span style="font-style: italic"><span style="color: #9A1900">/* there may be no backing store */</span></span>
<a name="line959">0959: </a>        bptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>b_s_open <span style="color: #990000">=</span> FALSE<span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">/* prevent recursive close if error */</span></span>
<a name="line960">0960: </a>        <span style="color: #990000">(</span><span style="color: #990000">*</span>bptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>b_s_info<span style="color: #990000">.</span>close_backing_store<span style="color: #990000">)</span> <span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> <span style="color: #990000">&amp;</span> bptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>b_s_info<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line961">0961: </a>      <span style="color: #FF0000">}</span>
<a name="line962">0962: </a>    <span style="color: #FF0000">}</span>
<a name="line963">0963: </a>    mem<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>virt_barray_list <span style="color: #990000">=</span> NULL<span style="color: #990000">;</span>
<a name="line964">0964: </a>  <span style="color: #FF0000">}</span>
<a name="line965">0965: </a>
<a name="line966">0966: </a>  <span style="font-style: italic"><span style="color: #9A1900">/* Release large objects */</span></span>
<a name="line967">0967: </a>  lhdr_ptr <span style="color: #990000">=</span> mem<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>large_list<span style="color: #990000">[</span>pool_id<span style="color: #990000">]</span><span style="color: #990000">;</span>
<a name="line968">0968: </a>  mem<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>large_list<span style="color: #990000">[</span>pool_id<span style="color: #990000">]</span> <span style="color: #990000">=</span> NULL<span style="color: #990000">;</span>
<a name="line969">0969: </a>
<a name="line970">0970: </a>  <span style="font-weight: bold"><span style="color: #0000FF">while</span></span> <span style="color: #990000">(</span>lhdr_ptr <span style="color: #990000">!</span><span style="color: #990000">=</span> NULL<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line971">0971: </a>    large_pool_ptr next_lhdr_ptr <span style="color: #990000">=</span> lhdr_ptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>hdr<span style="color: #990000">.</span>next<span style="color: #990000">;</span>
<a name="line972">0972: </a>    space_freed <span style="color: #990000">=</span> lhdr_ptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>hdr<span style="color: #990000">.</span>bytes_used <span style="color: #990000">+</span>
<a name="line973">0973: </a>                  lhdr_ptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>hdr<span style="color: #990000">.</span>bytes_left <span style="color: #990000">+</span>
<a name="line974">0974: </a>                  <span style="font-weight: bold"><span style="color: #000000">SIZEOF</span></span><span style="color: #990000">(</span>large_pool_hdr<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line975">0975: </a>    <span style="font-weight: bold"><span style="color: #000000">jpeg_free_large</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> <span style="color: #990000">(</span><span style="color: #009900">void</span> FAR <span style="color: #990000">*</span><span style="color: #990000">)</span> lhdr_ptr<span style="color: #990000">,</span> space_freed<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line976">0976: </a>    mem<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>total_space_allocated <span style="color: #990000">-</span><span style="color: #990000">=</span> space_freed<span style="color: #990000">;</span>
<a name="line977">0977: </a>    lhdr_ptr <span style="color: #990000">=</span> next_lhdr_ptr<span style="color: #990000">;</span>
<a name="line978">0978: </a>  <span style="color: #FF0000">}</span>
<a name="line979">0979: </a>
<a name="line980">0980: </a>  <span style="font-style: italic"><span style="color: #9A1900">/* Release small objects */</span></span>
<a name="line981">0981: </a>  shdr_ptr <span style="color: #990000">=</span> mem<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>small_list<span style="color: #990000">[</span>pool_id<span style="color: #990000">]</span><span style="color: #990000">;</span>
<a name="line982">0982: </a>  mem<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>small_list<span style="color: #990000">[</span>pool_id<span style="color: #990000">]</span> <span style="color: #990000">=</span> NULL<span style="color: #990000">;</span>
<a name="line983">0983: </a>
<a name="line984">0984: </a>  <span style="font-weight: bold"><span style="color: #0000FF">while</span></span> <span style="color: #990000">(</span>shdr_ptr <span style="color: #990000">!</span><span style="color: #990000">=</span> NULL<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line985">0985: </a>    small_pool_ptr next_shdr_ptr <span style="color: #990000">=</span> shdr_ptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>hdr<span style="color: #990000">.</span>next<span style="color: #990000">;</span>
<a name="line986">0986: </a>    space_freed <span style="color: #990000">=</span> shdr_ptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>hdr<span style="color: #990000">.</span>bytes_used <span style="color: #990000">+</span>
<a name="line987">0987: </a>                  shdr_ptr<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>hdr<span style="color: #990000">.</span>bytes_left <span style="color: #990000">+</span>
<a name="line988">0988: </a>                  <span style="font-weight: bold"><span style="color: #000000">SIZEOF</span></span><span style="color: #990000">(</span>small_pool_hdr<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line989">0989: </a>    <span style="font-weight: bold"><span style="color: #000000">jpeg_free_small</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> <span style="color: #990000">(</span><span style="color: #009900">void</span> <span style="color: #990000">*</span><span style="color: #990000">)</span> shdr_ptr<span style="color: #990000">,</span> space_freed<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line990">0990: </a>    mem<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>total_space_allocated <span style="color: #990000">-</span><span style="color: #990000">=</span> space_freed<span style="color: #990000">;</span>
<a name="line991">0991: </a>    shdr_ptr <span style="color: #990000">=</span> next_shdr_ptr<span style="color: #990000">;</span>
<a name="line992">0992: </a>  <span style="color: #FF0000">}</span>
<a name="line993">0993: </a><span style="color: #FF0000">}</span>
<a name="line994">0994: </a>
<a name="line995">0995: </a>
<a name="line996">0996: </a><span style="font-style: italic"><span style="color: #9A1900">/*</span></span>
<a name="line997">0997: </a><span style="font-style: italic"><span style="color: #9A1900"> * Close up shop entirely.</span></span>
<a name="line998">0998: </a><span style="font-style: italic"><span style="color: #9A1900"> * Note that this cannot be called unless cinfo-&gt;mem is non-NULL.</span></span>
<a name="line999">0999: </a><span style="font-style: italic"><span style="color: #9A1900"> */</span></span>
<a name="line1000">1000: </a>
<a name="line1001">1001: </a><span style="font-weight: bold"><span style="color: #000000">METHODDEF</span></span><span style="color: #990000">(</span><span style="color: #009900">void</span><span style="color: #990000">)</span>
<a name="line1002">1002: </a><span style="font-weight: bold"><span style="color: #000000">self_destruct</span></span> <span style="color: #990000">(</span>j_common_ptr cinfo<span style="color: #990000">)</span>
<a name="line1003">1003: </a><span style="color: #FF0000">{</span>
<a name="line1004">1004: </a>  <span style="color: #009900">int</span> pool<span style="color: #990000">;</span>
<a name="line1005">1005: </a>
<a name="line1006">1006: </a>  <span style="font-style: italic"><span style="color: #9A1900">/* Close all backing store, release all memory.</span></span>
<a name="line1007">1007: </a><span style="font-style: italic"><span style="color: #9A1900">   * Releasing pools in reverse order might help avoid fragmentation</span></span>
<a name="line1008">1008: </a><span style="font-style: italic"><span style="color: #9A1900">   * with some (brain-damaged) malloc libraries.</span></span>
<a name="line1009">1009: </a><span style="font-style: italic"><span style="color: #9A1900">   */</span></span>
<a name="line1010">1010: </a>  <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> <span style="color: #990000">(</span>pool <span style="color: #990000">=</span> JPOOL_NUMPOOLS<span style="color: #990000">-</span><span style="color: #993399">1</span><span style="color: #990000">;</span> pool <span style="color: #990000">&gt;</span><span style="color: #990000">=</span> JPOOL_PERMANENT<span style="color: #990000">;</span> pool<span style="color: #990000">-</span><span style="color: #990000">-</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line1011">1011: </a>    <span style="font-weight: bold"><span style="color: #000000">free_pool</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> pool<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line1012">1012: </a>  <span style="color: #FF0000">}</span>
<a name="line1013">1013: </a>
<a name="line1014">1014: </a>  <span style="font-style: italic"><span style="color: #9A1900">/* Release the memory manager control block too. */</span></span>
<a name="line1015">1015: </a>  <span style="font-weight: bold"><span style="color: #000000">jpeg_free_small</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> <span style="color: #990000">(</span><span style="color: #009900">void</span> <span style="color: #990000">*</span><span style="color: #990000">)</span> cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>mem<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #000000">SIZEOF</span></span><span style="color: #990000">(</span>my_memory_mgr<span style="color: #990000">)</span><span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line1016">1016: </a>  cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>mem <span style="color: #990000">=</span> NULL<span style="color: #990000">;</span>            <span style="font-style: italic"><span style="color: #9A1900">/* ensures I will be called only once */</span></span>
<a name="line1017">1017: </a>
<a name="line1018">1018: </a>  <span style="font-weight: bold"><span style="color: #000000">jpeg_mem_term</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">)</span><span style="color: #990000">;</span>         <span style="font-style: italic"><span style="color: #9A1900">/* system-dependent cleanup */</span></span>
<a name="line1019">1019: </a><span style="color: #FF0000">}</span>
<a name="line1020">1020: </a>
<a name="line1021">1021: </a>
<a name="line1022">1022: </a><span style="font-style: italic"><span style="color: #9A1900">/*</span></span>
<a name="line1023">1023: </a><span style="font-style: italic"><span style="color: #9A1900"> * Memory manager initialization.</span></span>
<a name="line1024">1024: </a><span style="font-style: italic"><span style="color: #9A1900"> * When this is called, only the error manager pointer is valid in cinfo!</span></span>
<a name="line1025">1025: </a><span style="font-style: italic"><span style="color: #9A1900"> */</span></span>
<a name="line1026">1026: </a>
<a name="line1027">1027: </a><span style="font-weight: bold"><span style="color: #000000">GLOBAL</span></span><span style="color: #990000">(</span><span style="color: #009900">void</span><span style="color: #990000">)</span>
<a name="line1028">1028: </a><span style="font-weight: bold"><span style="color: #000000">jinit_memory_mgr</span></span> <span style="color: #990000">(</span>j_common_ptr cinfo<span style="color: #990000">)</span>
<a name="line1029">1029: </a><span style="color: #FF0000">{</span>
<a name="line1030">1030: </a>  my_mem_ptr mem<span style="color: #990000">;</span>
<a name="line1031">1031: </a>  <span style="color: #009900">long</span> max_to_use<span style="color: #990000">;</span>
<a name="line1032">1032: </a>  <span style="color: #009900">int</span> pool<span style="color: #990000">;</span>
<a name="line1033">1033: </a>  size_t test_mac<span style="color: #990000">;</span>
<a name="line1034">1034: </a>
<a name="line1035">1035: </a>  cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>mem <span style="color: #990000">=</span> NULL<span style="color: #990000">;</span>            <span style="font-style: italic"><span style="color: #9A1900">/* for safety if init fails */</span></span>
<a name="line1036">1036: </a>
<a name="line1037">1037: </a>  <span style="font-style: italic"><span style="color: #9A1900">/* Check for configuration errors.</span></span>
<a name="line1038">1038: </a><span style="font-style: italic"><span style="color: #9A1900">   * SIZEOF(ALIGN_TYPE) should be a power of 2; otherwise, it probably</span></span>
<a name="line1039">1039: </a><span style="font-style: italic"><span style="color: #9A1900">   * doesn't reflect any real hardware alignment requirement.</span></span>
<a name="line1040">1040: </a><span style="font-style: italic"><span style="color: #9A1900">   * The test is a little tricky: for X&gt;0, X and X-1 have no one-bits</span></span>
<a name="line1041">1041: </a><span style="font-style: italic"><span style="color: #9A1900">   * in common if and only if X is a power of 2, ie has only one one-bit.</span></span>
<a name="line1042">1042: </a><span style="font-style: italic"><span style="color: #9A1900">   * Some compilers may give an "unreachable code" warning here; ignore it.</span></span>
<a name="line1043">1043: </a><span style="font-style: italic"><span style="color: #9A1900">   */</span></span>
<a name="line1044">1044: </a>  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #000000">SIZEOF</span></span><span style="color: #990000">(</span>ALIGN_TYPE<span style="color: #990000">)</span> <span style="color: #990000">&amp;</span> <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #000000">SIZEOF</span></span><span style="color: #990000">(</span>ALIGN_TYPE<span style="color: #990000">)</span><span style="color: #990000">-</span><span style="color: #993399">1</span><span style="color: #990000">)</span><span style="color: #990000">)</span> <span style="color: #990000">!</span><span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">)</span>
<a name="line1045">1045: </a>    <span style="font-weight: bold"><span style="color: #000000">ERREXIT</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> JERR_BAD_ALIGN_TYPE<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line1046">1046: </a>  <span style="font-style: italic"><span style="color: #9A1900">/* MAX_ALLOC_CHUNK must be representable as type size_t, and must be</span></span>
<a name="line1047">1047: </a><span style="font-style: italic"><span style="color: #9A1900">   * a multiple of SIZEOF(ALIGN_TYPE).</span></span>
<a name="line1048">1048: </a><span style="font-style: italic"><span style="color: #9A1900">   * Again, an "unreachable code" warning may be ignored here.</span></span>
<a name="line1049">1049: </a><span style="font-style: italic"><span style="color: #9A1900">   * But a "constant too large" warning means you need to fix MAX_ALLOC_CHUNK.</span></span>
<a name="line1050">1050: </a><span style="font-style: italic"><span style="color: #9A1900">   */</span></span>
<a name="line1051">1051: </a>  test_mac <span style="color: #990000">=</span> <span style="color: #990000">(</span>size_t<span style="color: #990000">)</span> MAX_ALLOC_CHUNK<span style="color: #990000">;</span>
<a name="line1052">1052: </a>  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span><span style="color: #990000">(</span><span style="color: #009900">long</span><span style="color: #990000">)</span> test_mac <span style="color: #990000">!</span><span style="color: #990000">=</span> MAX_ALLOC_CHUNK <span style="color: #990000">|</span><span style="color: #990000">|</span>
<a name="line1053">1053: </a>      <span style="color: #990000">(</span>MAX_ALLOC_CHUNK <span style="color: #990000">%</span> <span style="font-weight: bold"><span style="color: #000000">SIZEOF</span></span><span style="color: #990000">(</span>ALIGN_TYPE<span style="color: #990000">)</span><span style="color: #990000">)</span> <span style="color: #990000">!</span><span style="color: #990000">=</span> <span style="color: #993399">0</span><span style="color: #990000">)</span>
<a name="line1054">1054: </a>    <span style="font-weight: bold"><span style="color: #000000">ERREXIT</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> JERR_BAD_ALLOC_CHUNK<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line1055">1055: </a>
<a name="line1056">1056: </a>  max_to_use <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">jpeg_mem_init</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">)</span><span style="color: #990000">;</span> <span style="font-style: italic"><span style="color: #9A1900">/* system-dependent initialization */</span></span>
<a name="line1057">1057: </a>
<a name="line1058">1058: </a>  <span style="font-style: italic"><span style="color: #9A1900">/* Attempt to allocate memory manager's control block */</span></span>
<a name="line1059">1059: </a>  mem <span style="color: #990000">=</span> <span style="color: #990000">(</span>my_mem_ptr<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #000000">jpeg_get_small</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #000000">SIZEOF</span></span><span style="color: #990000">(</span>my_memory_mgr<span style="color: #990000">)</span><span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line1060">1060: </a>
<a name="line1061">1061: </a>  <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>mem <span style="color: #990000">=</span><span style="color: #990000">=</span> NULL<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line1062">1062: </a>    <span style="font-weight: bold"><span style="color: #000000">jpeg_mem_term</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">)</span><span style="color: #990000">;</span>       <span style="font-style: italic"><span style="color: #9A1900">/* system-dependent cleanup */</span></span>
<a name="line1063">1063: </a>    <span style="font-weight: bold"><span style="color: #000000">ERREXIT1</span></span><span style="color: #990000">(</span>cinfo<span style="color: #990000">,</span> JERR_OUT_OF_MEMORY<span style="color: #990000">,</span> <span style="color: #993399">0</span><span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line1064">1064: </a>  <span style="color: #FF0000">}</span>
<a name="line1065">1065: </a>
<a name="line1066">1066: </a>  <span style="font-style: italic"><span style="color: #9A1900">/* OK, fill in the method pointers */</span></span>
<a name="line1067">1067: </a>  mem<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>pub<span style="color: #990000">.</span>alloc_small <span style="color: #990000">=</span> alloc_small<span style="color: #990000">;</span>
<a name="line1068">1068: </a>  mem<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>pub<span style="color: #990000">.</span>alloc_large <span style="color: #990000">=</span> alloc_large<span style="color: #990000">;</span>
<a name="line1069">1069: </a>  mem<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>pub<span style="color: #990000">.</span>alloc_sarray <span style="color: #990000">=</span> alloc_sarray<span style="color: #990000">;</span>
<a name="line1070">1070: </a>  mem<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>pub<span style="color: #990000">.</span>alloc_barray <span style="color: #990000">=</span> alloc_barray<span style="color: #990000">;</span>
<a name="line1071">1071: </a>  mem<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>pub<span style="color: #990000">.</span>request_virt_sarray <span style="color: #990000">=</span> request_virt_sarray<span style="color: #990000">;</span>
<a name="line1072">1072: </a>  mem<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>pub<span style="color: #990000">.</span>request_virt_barray <span style="color: #990000">=</span> request_virt_barray<span style="color: #990000">;</span>
<a name="line1073">1073: </a>  mem<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>pub<span style="color: #990000">.</span>realize_virt_arrays <span style="color: #990000">=</span> realize_virt_arrays<span style="color: #990000">;</span>
<a name="line1074">1074: </a>  mem<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>pub<span style="color: #990000">.</span>access_virt_sarray <span style="color: #990000">=</span> access_virt_sarray<span style="color: #990000">;</span>
<a name="line1075">1075: </a>  mem<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>pub<span style="color: #990000">.</span>access_virt_barray <span style="color: #990000">=</span> access_virt_barray<span style="color: #990000">;</span>
<a name="line1076">1076: </a>  mem<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>pub<span style="color: #990000">.</span>free_pool <span style="color: #990000">=</span> free_pool<span style="color: #990000">;</span>
<a name="line1077">1077: </a>  mem<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>pub<span style="color: #990000">.</span>self_destruct <span style="color: #990000">=</span> self_destruct<span style="color: #990000">;</span>
<a name="line1078">1078: </a>
<a name="line1079">1079: </a>  <span style="font-style: italic"><span style="color: #9A1900">/* Make MAX_ALLOC_CHUNK accessible to other modules */</span></span>
<a name="line1080">1080: </a>  mem<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>pub<span style="color: #990000">.</span>max_alloc_chunk <span style="color: #990000">=</span> MAX_ALLOC_CHUNK<span style="color: #990000">;</span>
<a name="line1081">1081: </a>
<a name="line1082">1082: </a>  <span style="font-style: italic"><span style="color: #9A1900">/* Initialize working state */</span></span>
<a name="line1083">1083: </a>  mem<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>pub<span style="color: #990000">.</span>max_memory_to_use <span style="color: #990000">=</span> max_to_use<span style="color: #990000">;</span>
<a name="line1084">1084: </a>
<a name="line1085">1085: </a>  <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> <span style="color: #990000">(</span>pool <span style="color: #990000">=</span> JPOOL_NUMPOOLS<span style="color: #990000">-</span><span style="color: #993399">1</span><span style="color: #990000">;</span> pool <span style="color: #990000">&gt;</span><span style="color: #990000">=</span> JPOOL_PERMANENT<span style="color: #990000">;</span> pool<span style="color: #990000">-</span><span style="color: #990000">-</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line1086">1086: </a>    mem<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>small_list<span style="color: #990000">[</span>pool<span style="color: #990000">]</span> <span style="color: #990000">=</span> NULL<span style="color: #990000">;</span>
<a name="line1087">1087: </a>    mem<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>large_list<span style="color: #990000">[</span>pool<span style="color: #990000">]</span> <span style="color: #990000">=</span> NULL<span style="color: #990000">;</span>
<a name="line1088">1088: </a>  <span style="color: #FF0000">}</span>
<a name="line1089">1089: </a>  mem<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>virt_sarray_list <span style="color: #990000">=</span> NULL<span style="color: #990000">;</span>
<a name="line1090">1090: </a>  mem<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>virt_barray_list <span style="color: #990000">=</span> NULL<span style="color: #990000">;</span>
<a name="line1091">1091: </a>
<a name="line1092">1092: </a>  mem<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>total_space_allocated <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">SIZEOF</span></span><span style="color: #990000">(</span>my_memory_mgr<span style="color: #990000">)</span><span style="color: #990000">;</span>
<a name="line1093">1093: </a>
<a name="line1094">1094: </a>  <span style="font-style: italic"><span style="color: #9A1900">/* Declare ourselves open for business */</span></span>
<a name="line1095">1095: </a>  cinfo<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>mem <span style="color: #990000">=</span> <span style="color: #990000">&amp;</span> mem<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>pub<span style="color: #990000">;</span>
<a name="line1096">1096: </a>
<a name="line1097">1097: </a>  <span style="font-style: italic"><span style="color: #9A1900">/* Check for an environment variable JPEGMEM; if found, override the</span></span>
<a name="line1098">1098: </a><span style="font-style: italic"><span style="color: #9A1900">   * default max_memory setting from jpeg_mem_init.  Note that the</span></span>
<a name="line1099">1099: </a><span style="font-style: italic"><span style="color: #9A1900">   * surrounding application may again override this value.</span></span>
<a name="line1100">1100: </a><span style="font-style: italic"><span style="color: #9A1900">   * If your system doesn't support getenv(), define NO_GETENV to disable</span></span>
<a name="line1101">1101: </a><span style="font-style: italic"><span style="color: #9A1900">   * this feature.</span></span>
<a name="line1102">1102: </a><span style="font-style: italic"><span style="color: #9A1900">   */</span></span>
<a name="line1103">1103: </a><span style="font-weight: bold"><span style="color: #000080">#ifndef</span></span> NO_GETENV
<a name="line1104">1104: </a>  <span style="color: #FF0000">{</span> <span style="color: #009900">char</span> <span style="color: #990000">*</span> memenv<span style="color: #990000">;</span>
<a name="line1105">1105: </a>
<a name="line1106">1106: </a>    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span><span style="color: #990000">(</span>memenv <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">getenv</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"JPEGMEM"</span><span style="color: #990000">)</span><span style="color: #990000">)</span> <span style="color: #990000">!</span><span style="color: #990000">=</span> NULL<span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line1107">1107: </a>      <span style="color: #009900">char</span> ch <span style="color: #990000">=</span> <span style="color: #FF0000">'x'</span><span style="color: #990000">;</span>
<a name="line1108">1108: </a>
<a name="line1109">1109: </a>      <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #000000">sscanf</span></span><span style="color: #990000">(</span>memenv<span style="color: #990000">,</span> <span style="color: #FF0000">"%ld%c"</span><span style="color: #990000">,</span> <span style="color: #990000">&amp;</span>max_to_use<span style="color: #990000">,</span> <span style="color: #990000">&amp;</span>ch<span style="color: #990000">)</span> <span style="color: #990000">&gt;</span> <span style="color: #993399">0</span><span style="color: #990000">)</span> <span style="color: #FF0000">{</span>
<a name="line1110">1110: </a>        <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">(</span>ch <span style="color: #990000">=</span><span style="color: #990000">=</span> <span style="color: #FF0000">'m'</span> <span style="color: #990000">|</span><span style="color: #990000">|</span> ch <span style="color: #990000">=</span><span style="color: #990000">=</span> <span style="color: #FF0000">'M'</span><span style="color: #990000">)</span>
<a name="line1111">1111: </a>          max_to_use <span style="color: #990000">*</span><span style="color: #990000">=</span> <span style="color: #993399">1000</span>L<span style="color: #990000">;</span>
<a name="line1112">1112: </a>        mem<span style="color: #990000">-</span><span style="color: #990000">&gt;</span>pub<span style="color: #990000">.</span>max_memory_to_use <span style="color: #990000">=</span> max_to_use <span style="color: #990000">*</span> <span style="color: #993399">1000</span>L<span style="color: #990000">;</span>
<a name="line1113">1113: </a>      <span style="color: #FF0000">}</span>
<a name="line1114">1114: </a>    <span style="color: #FF0000">}</span>
<a name="line1115">1115: </a>  <span style="color: #FF0000">}</span>
<a name="line1116">1116: </a><span style="font-weight: bold"><span style="color: #000080">#endif</span></span>
<a name="line1117">1117: </a>
<a name="line1118">1118: </a><span style="color: #FF0000">}</span>
</tt>
</pre>
</body>
</html>
